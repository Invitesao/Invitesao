<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Eventos - Gerenciador</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">


    <!-- Notifica√ß√µes -->
    <div id="notifications" class="fixed top-4 right-4 z-40 space-y-2"></div>

    <!-- Tela de Login -->
    <div id="login-screen" class="hidden fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Sistema de Eventos</h1>
                <p class="text-gray-600 mt-2">Fa√ßa login para continuar</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usu√°rio</label>
                    <input type="text" id="login-username" placeholder="Digite seu nome de usu√°rio"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="login-password" placeholder="Digite sua senha"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="handleLogin()" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                    Entrar
                </button>
                <button onclick="showRegister()" 
                        class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">
                    Solicitar Conta de Usu√°rio
                </button>
            </div>
        </div>
    </div>

    <!-- Tela de Registro -->
    <div id="register-screen" class="hidden fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Solicitar Conta de Usu√°rio</h1>
                <p class="text-gray-600 mt-2">Sua solicita√ß√£o ser√° analisada pelo administrador</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                    <input type="text" id="register-name" placeholder="Seu nome completo"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usu√°rio</label>
                    <input type="text" id="register-username" placeholder="admin"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Telefone</label>
                    <input type="tel" id="register-phone" placeholder="(11) 99999-9999"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="register-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="handleRegister()" 
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors">
                    Enviar Solicita√ß√£o
                </button>
                <button onclick="showLogin()" 
                        class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">
                    Voltar ao Login
                </button>
            </div>
        </div>
    </div>

    <!-- Painel de Usu√°rio -->
    <div id="user-panel" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Meus Eventos</h1>
                        <p class="text-gray-600">Crie e gerencie seus eventos</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-name" class="text-gray-700"></span>
                        <div id="admin-mode-indicator" class="hidden bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                            üëë Modo Admin
                        </div>
                        <button id="back-to-admin" onclick="backToAdmin()" 
                                class="hidden bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                            ‚Üê Voltar ao Admin
                        </button>
                        <button onclick="logout()" 
                                class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Configura√ß√µes da Conta -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Configura√ß√µes da Conta</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                        <input type="text" id="user-settings-name" placeholder="Seu nome"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usu√°rio</label>
                        <input type="text" id="user-settings-username" placeholder="Seu username"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                        <input type="tel" id="user-settings-phone" placeholder="(11) 99999-9999"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nova Senha</label>
                        <input type="password" id="user-settings-password" placeholder="Digite nova senha"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
                        <input type="password" id="user-settings-confirm-password" placeholder="Confirme a nova senha"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <button onclick="updateUserSettings()" 
                        class="mt-6 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
                    Salvar Altera√ß√µes
                </button>
            </div>

            <!-- Criar Evento -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Criar Novo Evento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Evento *</label>
                        <input type="text" id="event-name" placeholder="Ex: Festa de Anivers√°rio"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data e Hora *</label>
                        <input type="datetime-local" id="event-date"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Local</label>
                        <input type="text" id="event-location" placeholder="Ex: Sal√£o de Festas"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                        <input type="text" id="event-address" placeholder="Endere√ßo completo (opcional)"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                    <textarea id="event-description" rows="3" placeholder="Detalhes sobre o evento (opcional)"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <!-- Op√ß√µes do Evento -->
                <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Op√ß√µes do Evento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="allow-companions" checked class="mr-3 text-blue-600">
                            <span class="text-gray-700">Permitir acompanhantes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="show-location" checked class="mr-3 text-blue-600">
                            <span class="text-gray-700">Mostrar local</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="show-address" checked class="mr-3 text-blue-600">
                            <span class="text-gray-700">Mostrar endere√ßo</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="enable-messages" checked class="mr-3 text-blue-600">
                            <span class="text-gray-700">Habilitar mural de recados</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="enable-gifts" class="mr-3 text-blue-600">
                            <span class="text-gray-700">Habilitar lista de presentes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="enable-bank-transfer" class="mr-3 text-blue-600">
                            <span class="text-gray-700">Mostrar dados banc√°rios para transfer√™ncia</span>
                        </label>
                    </div>
                </div>
                
                <!-- Configura√ß√µes de Presentes -->
                <div id="gifts-config" class="mt-6 bg-gray-50 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Configura√ß√£o de Presentes</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lista de Presentes (um por linha)</label>
                            <textarea id="gifts-list" rows="6" placeholder="Ex:&#10;Jogo de panelas&#10;Liquidificador&#10;Conjunto de toalhas&#10;Micro-ondas"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantas pessoas podem escolher o mesmo presente?</label>
                            <input type="number" id="gifts-max-selection" value="1" min="1" max="10"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Configura√ß√µes de Transfer√™ncia Banc√°ria -->
                <div id="bank-config" class="mt-6 bg-gray-50 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados Banc√°rios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">IBAN</label>
                            <input type="text" id="bank-iban" placeholder="PT50 0000 0000 0000 0000 0000 0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Titular da Conta</label>
                            <input type="text" id="bank-holder" placeholder="Nome do titular"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem Personalizada (opcional)</label>
                            <textarea id="bank-message" rows="3" placeholder="Ex: Gostar√≠amos que nos presenteasse com uma transfer√™ncia banc√°ria. Obrigado!"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero para Envio de Comprovantes</label>
                            <input type="tel" id="support-phone" placeholder="(11) 99999-9999"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-sm text-gray-500 mt-1">Os convidados enviar√£o os comprovantes de transfer√™ncia para este n√∫mero</p>
                        </div>
                    </div>
                </div>
                
                <button onclick="createNewEvent()" 
                        class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    Criar Evento
                </button>
            </div>

            <!-- Meus Eventos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Meus Eventos</h2>
                <div id="user-events-list" class="space-y-4">
                    <!-- Eventos ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Painel Admin -->
    <div id="admin-panel" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Painel Administrativo</h1>
                        <p class="text-gray-600">Gerencie seus eventos e confirma√ß√µes</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="admin-name" class="text-gray-700"></span>
                        <button onclick="logout()" 
                                class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Configura√ß√µes da Conta -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Configura√ß√µes da Conta</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                        <input type="text" id="settings-name" placeholder="Seu nome"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usu√°rio</label>
                        <input type="text" id="settings-username" placeholder="Seu username"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                        <input type="tel" id="settings-phone" placeholder="(11) 99999-9999"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nova Senha</label>
                        <input type="password" id="settings-password" placeholder="Digite nova senha"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
                        <input type="password" id="settings-confirm-password" placeholder="Confirme a nova senha"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <button onclick="updateSettings()" 
                        class="mt-6 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
                    Salvar Altera√ß√µes
                </button>
            </div>

            <!-- Painel de Controle Admin -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Painel de Controle</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-yellow-600" id="pending-requests-count">0</div>
                        <div class="text-yellow-800 font-medium">Solicita√ß√µes Pendentes</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-blue-600" id="total-users">0</div>
                        <div class="text-blue-800 font-medium">Total de Usu√°rios</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-green-600" id="total-events">0</div>
                        <div class="text-green-800 font-medium">Total de Eventos</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-purple-600" id="total-confirmations">0</div>
                        <div class="text-purple-800 font-medium">Total de Confirma√ß√µes</div>
                    </div>
                </div>
            </div>

            <!-- Solicita√ß√µes Pendentes -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Solicita√ß√µes de Conta Pendentes</h2>
                <div id="pending-requests" class="space-y-4">
                    <!-- Solicita√ß√µes ser√£o carregadas aqui -->
                </div>
            </div>

            <!-- Gerenciar Usu√°rios -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Gerenciar Usu√°rios</h2>
                <div id="users-list" class="space-y-4">
                    <!-- Usu√°rios ser√£o carregados aqui -->
                </div>
            </div>

            <!-- Relat√≥rios de Eventos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Relat√≥rios de Eventos</h2>
                <div id="events-reports" class="space-y-4">
                    <!-- Relat√≥rios ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- P√°gina de Confirma√ß√£o do Convidado -->
    <div id="guest-confirmation" class="hidden">
        <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex items-center justify-center px-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full fade-in">
                <div id="event-details" class="text-center mb-8">
                    <!-- Detalhes do evento ser√£o carregados aqui -->
                </div>
                
                <!-- Contagem Regressiva -->
                <div id="countdown-section" class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-6 mb-8 text-center">
                    <div id="countdown" class="grid grid-cols-4 gap-4 text-center">
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div id="days" class="text-2xl font-bold text-purple-600">0</div>
                            <div class="text-sm text-gray-600">Dias</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div id="hours" class="text-2xl font-bold text-purple-600">0</div>
                            <div class="text-sm text-gray-600">Horas</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div id="minutes" class="text-2xl font-bold text-purple-600">0</div>
                            <div class="text-sm text-gray-600">Minutos</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div id="seconds" class="text-2xl font-bold text-purple-600">0</div>
                            <div class="text-sm text-gray-600">Segundos</div>
                        </div>
                    </div>
                </div>
                
                <div id="confirmation-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seu Nome</label>
                        <input type="text" id="guest-name" placeholder="Digite seu nome completo"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div id="companion-section" class="hidden">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Acompanhante</label>
                            <button type="button" onclick="removeCompanion()" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                ‚úï Remover
                            </button>
                        </div>
                        <input type="text" id="companion-name" placeholder="Nome do seu acompanhante (opcional)"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div id="add-companion-section" class="hidden">
                        <button type="button" onclick="addCompanion()" 
                                class="w-full bg-blue-100 text-blue-700 py-2 px-4 rounded-md hover:bg-blue-200 transition-colors border-2 border-dashed border-blue-300">
                            + Adicionar Acompanhante
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-4">Confirma√ß√£o de Presen√ßa</label>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="radio" name="attendance" value="confirmed" class="mr-3 text-green-600">
                                <span class="text-green-600 font-medium">‚úì Confirmo minha presen√ßa</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="attendance" value="declined" class="mr-3 text-red-600">
                                <span class="text-red-600 font-medium">‚úó N√£o poderei comparecer</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes (opcional)</label>
                        <textarea id="guest-notes" rows="3" placeholder="Alguma observa√ß√£o especial..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                    </div>
                    
                    <button onclick="submitConfirmation()" 
                            class="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 transition-colors font-medium">
                        Confirmar Presen√ßa
                    </button>
                </div>
                
                <!-- Lista de Presentes -->
                <div id="gifts-section" class="mt-8 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üéÅ Lista de Presentes</h3>
                    <div id="gifts-list-display" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <!-- Lista de presentes ser√° carregada aqui -->
                    </div>
                </div>
                
                <!-- Transfer√™ncia Banc√°ria -->
                <div id="bank-transfer-section" class="mt-8 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üí≥ Transfer√™ncia Banc√°ria</h3>
                    <div id="bank-transfer-message" class="mb-4 text-gray-700">
                        <!-- Mensagem personalizada ser√° carregada aqui -->
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IBAN:</label>
                                <div class="flex">
                                    <input type="text" id="display-iban" readonly 
                                           class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md text-sm">
                                    <button onclick="copyIban()" 
                                            class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700 transition-colors">
                                        Copiar
                                    </button>
                                </div>
                                <div id="receipt-section" class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-md hidden">
                                    <p class="text-sm text-yellow-800 mb-2">
                                        <strong>üì± Ap√≥s fazer a transfer√™ncia, envie o comprovante para:</strong>
                                    </p>
                                    <div class="flex items-center space-x-2">
                                        <span id="support-phone-display" class="font-mono text-sm bg-white px-2 py-1 rounded border"></span>
                                        <button onclick="openWhatsApp()" 
                                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors">
                                            üì± Abrir WhatsApp
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Titular:</label>
                                <input type="text" id="display-holder" readonly 
                                       class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mural de Recados -->
                <div id="messages-section" class="mt-8 bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üí¨ Mural de Recados</h3>
                    <div id="messages-board" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                        <!-- Mensagens ser√£o carregadas aqui -->
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex space-x-2">
                            <input type="text" id="message-input" placeholder="Deixe um recado para os outros convidados..."
                                   onkeypress="if(event.key==='Enter') postMessage()"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <button onclick="postMessage()" 
                                    class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                                Enviar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="confirmation-success" class="hidden text-center">
                    <div class="text-green-600 text-6xl mb-4">‚úì</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Obrigado!</h3>
                    <p class="text-gray-600 mb-2 text-lg">Sua resposta foi enviada com sucesso.</p>
                    <p class="text-gray-500 mb-6">Agradecemos por confirmar sua presen√ßa!</p>
                    <div class="space-y-3">
                        <button onclick="editConfirmation()" 
                                class="w-full bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors">
                            ‚úèÔ∏è Editar Resposta
                        </button>
                        <div class="text-sm text-gray-500">
                            Voc√™ pode editar sua resposta a qualquer momento
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela de Aguardando Aprova√ß√£o -->
    <div id="pending-approval" class="hidden fixed inset-0 bg-gradient-to-br from-yellow-50 to-orange-100 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4 text-center fade-in">
            <div class="text-yellow-600 text-6xl mb-4">‚è≥</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Aguardando Aprova√ß√£o</h2>
            <p class="text-gray-600 mb-6">Sua solicita√ß√£o de conta foi enviada para o administrador. Voc√™ receber√° uma resposta em breve.</p>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-blue-800 text-sm">
                    <strong>Dados enviados:</strong><br>
                    Nome: <span id="pending-name"></span><br>
                    Usu√°rio: <span id="pending-username"></span><br>
                    Telefone: <span id="pending-phone"></span>
                </p>
            </div>
            <button onclick="checkApprovalStatus()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors mr-3">
                Verificar Status
            </button>
            <button onclick="showLogin()" 
                    class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors">
                Voltar ao Login
            </button>
        </div>
    </div>

    <!-- P√°gina de Erro -->
    <div id="error-page" class="hidden">
        <div class="min-h-screen bg-gradient-to-br from-red-50 to-orange-100 flex items-center justify-center px-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center fade-in">
                <div class="text-red-600 text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Acesso Negado</h2>
                <p class="text-gray-600 mb-6">Voc√™ n√£o tem permiss√£o para acessar este link ou o evento n√£o foi encontrado.</p>
                <button onclick="goHome()" 
                        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    Voltar ao In√≠cio
                </button>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let currentUser = null;
        let currentEvent = null;
        let currentGuest = null;

        // Inicializar Supabase automaticamente
        function initializeSupabase() {
            const url = 'https://jqdrxvnnbkeepdnrzndv.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxZHJ4dm5uYmtlZXBkbnJ6bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDk5NTAsImV4cCI6MjA3MTU4NTk1MH0.k0sGvCvzZra3up5RTlJqFDu8FleeYvBr8EGqf5q-G3Q';
            
            try {
                supabase = window.supabase.createClient(url, key);
                checkAuthState();
                createDefaultAdmin(); // Criar admin padr√£o se n√£o existir
            } catch (error) {
                showNotification('Erro ao conectar com Supabase: ' + error.message, 'error');
            }
        }

        // Criar admin padr√£o
        async function createDefaultAdmin() {
            try {
                // Verificar se o admin j√° existe
                const { data: existingAdmin } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', 'Invites')
                    .maybeSingle();
                
                if (!existingAdmin) {
                    // Criar admin padr√£o
                    await supabase
                        .from('users')
                        .insert([{
                            name: 'Administrador',
                            username: 'Invites',
                            password: '#Invites2025@!!1995',
                            role: 'admin',
                            active: true,
                            created_at: new Date().toISOString()
                        }]);
                    
                    console.log('Admin padr√£o criado com sucesso!');
                }
            } catch (error) {
                console.log('Erro ao criar admin padr√£o:', error.message);
            }
        }

        // Verificar estado de autentica√ß√£o
        async function checkAuthState() {
            if (!supabase) return;
            
            // Verificar se h√° usu√°rio salvo no localStorage
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                // Verificar se est√° em modo admin
                const isAdminMode = localStorage.getItem('adminMode') === 'true';
                const savedOriginalAdmin = localStorage.getItem('originalAdmin');
                
                if (isAdminMode && savedOriginalAdmin) {
                    originalAdmin = JSON.parse(savedOriginalAdmin);
                    showUserPanel(); // Vai mostrar com indicadores de admin
                } else if (currentUser.role === 'admin') {
                    showAdminPanel();
                } else {
                    showUserPanel();
                }
                return;
            }
            
            // Verificar se √© um link de convidado
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');
            const hasCompanion = urlParams.get('acompanhante') === 'true';
            
            if (eventId) {
                loadGuestPage(eventId, hasCompanion);
            } else {
                showLogin();
            }
        }

        // Mostrar notifica√ß√£o
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification px-4 py-3 rounded-md text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Telas
        function showLogin() {
            hideAllScreens();
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function showRegister() {
            hideAllScreens();
            document.getElementById('register-screen').classList.remove('hidden');
        }

        function showAdminPanel() {
            hideAllScreens();
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('admin-name').textContent = currentUser.name || currentUser.username;
            loadAccountSettings();
            loadDashboardStats();
            loadPendingRequests();
            loadUsers();
            loadEventReports();
        }

        function showUserPanel() {
            hideAllScreens();
            document.getElementById('user-panel').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.name || currentUser.username;
            loadUserAccountSettings();
            loadUserEvents();
            
            // Verificar se est√° em modo admin
            const isAdminMode = localStorage.getItem('adminMode') === 'true';
            if (isAdminMode) {
                showAdminModeIndicators();
                
                // Adicionar aviso visual no painel
                const adminWarning = document.createElement('div');
                adminWarning.id = 'admin-warning';
                adminWarning.className = 'bg-purple-100 border border-purple-300 text-purple-800 px-4 py-3 rounded-lg mb-6';
                adminWarning.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üëë</span>
                        <div>
                            <p class="font-semibold">Modo Administrador Ativo</p>
                            <p class="text-sm">Voc√™ est√° visualizando e pode editar a conta de: <strong>${currentUser.name}</strong></p>
                            <p class="text-xs mt-1">Todas as altera√ß√µes ser√£o salvas na conta deste usu√°rio.</p>
                        </div>
                    </div>
                `;
                
                // Remover aviso anterior se existir
                const existingWarning = document.getElementById('admin-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                // Adicionar aviso no in√≠cio do conte√∫do
                const userPanelContent = document.querySelector('#user-panel .max-w-7xl');
                userPanelContent.insertBefore(adminWarning, userPanelContent.firstChild);
            } else {
                hideAdminModeIndicators();
                // Remover aviso se n√£o estiver em modo admin
                const existingWarning = document.getElementById('admin-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
            }
        }

        function showGuestConfirmation() {
            hideAllScreens();
            document.getElementById('guest-confirmation').classList.remove('hidden');
        }

        function showErrorPage() {
            hideAllScreens();
            document.getElementById('error-page').classList.remove('hidden');
        }

        function showPendingApproval() {
            hideAllScreens();
            document.getElementById('pending-approval').classList.remove('hidden');
            
            // Carregar dados da solicita√ß√£o
            const pendingData = JSON.parse(localStorage.getItem('pendingRequest') || '{}');
            document.getElementById('pending-name').textContent = pendingData.name || '';
            document.getElementById('pending-username').textContent = pendingData.username || '';
            document.getElementById('pending-phone').textContent = pendingData.phone || '';
        }

        function hideAllScreens() {
            const screens = ['login-screen', 'register-screen', 'admin-panel', 'user-panel', 'guest-confirmation', 'error-page', 'pending-approval'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        // Carregar configura√ß√µes da conta
        function loadAccountSettings() {
            if (currentUser) {
                document.getElementById('settings-name').value = currentUser.name || '';
                document.getElementById('settings-username').value = currentUser.username || '';
                document.getElementById('settings-phone').value = currentUser.phone || '';
            }
        }

        // Atualizar configura√ß√µes
        async function updateSettings() {
            const name = document.getElementById('settings-name').value;
            const username = document.getElementById('settings-username').value;
            const phone = document.getElementById('settings-phone').value;
            const password = document.getElementById('settings-password').value;
            const confirmPassword = document.getElementById('settings-confirm-password').value;
            
            if (!name || !username) {
                showNotification('Por favor, preencha nome e username', 'error');
                return;
            }
            
            if (password && password !== confirmPassword) {
                showNotification('As senhas n√£o coincidem', 'error');
                return;
            }
            
            // Verificar se o username j√° existe (exceto o atual)
            if (username !== currentUser.username) {
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .neq('id', currentUser.id)
                    .maybeSingle();
                
                if (existingUser) {
                    showNotification('Nome de usu√°rio j√° existe', 'error');
                    return;
                }
            }
            
            // Preparar dados para atualiza√ß√£o
            const updateData = {
                name: name,
                username: username,
                phone: phone
            };
            
            if (password) {
                updateData.password = password;
            }
            
            // Atualizar no banco
            const { data, error } = await supabase
                .from('users')
                .update(updateData)
                .eq('id', currentUser.id)
                .select();
            
            if (error) {
                showNotification('Erro ao atualizar: ' + error.message, 'error');
            } else {
                currentUser = data[0];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Limpar campos de senha
                document.getElementById('settings-password').value = '';
                document.getElementById('settings-confirm-password').value = '';
                
                // Atualizar nome no header
                document.getElementById('admin-name').textContent = currentUser.name || currentUser.username;
                
                showNotification('Configura√ß√µes atualizadas com sucesso!', 'success');
            }
        }

        // Autentica√ß√£o
        async function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showNotification('Por favor, preencha todos os campos', 'error');
                return;
            }
            
            try {
                // Buscar usu√°rio no banco de dados
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .maybeSingle();
                
                if (error) {
                    console.error('Erro na consulta:', error);
                    showNotification('Erro ao fazer login: ' + error.message, 'error');
                    return;
                }
                
                if (!user) {
                    showNotification('Usu√°rio ou senha incorretos', 'error');
                    return;
                }
                
                // Verificar se usu√°rio est√° ativo
                if (user.active === false) {
                    showNotification('Sua conta foi desativada. Entre em contato com o administrador.', 'error');
                    return;
                }
                
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showNotification('Login realizado com sucesso!', 'success');
                
                if (user.role === 'admin') {
                    showAdminPanel();
                } else {
                    showUserPanel();
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showNotification('Erro inesperado no login', 'error');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const username = document.getElementById('register-username').value;
            const phone = document.getElementById('register-phone').value;
            const password = document.getElementById('register-password').value;
            
            if (!name || !username || !phone || !password) {
                showNotification('Por favor, preencha todos os campos', 'error');
                return;
            }
            
            try {
                // Verificar se o usu√°rio j√° existe
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .maybeSingle();
                
                if (existingUser) {
                    showNotification('Nome de usu√°rio j√° existe', 'error');
                    return;
                }
                
                // Verificar se j√° existe solicita√ß√£o pendente
                const { data: existingRequest } = await supabase
                    .from('user_requests')
                    .select('username')
                    .eq('username', username)
                    .eq('status', 'pending')
                    .maybeSingle();
                
                if (existingRequest) {
                    showNotification('J√° existe uma solicita√ß√£o pendente para este usu√°rio', 'error');
                    return;
                }
                
                // Criar solicita√ß√£o de usu√°rio (aguardando aprova√ß√£o)
                const { data, error } = await supabase
                    .from('user_requests')
                    .insert([{
                        name: name,
                        username: username,
                        phone: phone,
                        password: password,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) {
                    showNotification('Erro ao enviar solicita√ß√£o: ' + error.message, 'error');
                } else {
                    // Salvar dados da solicita√ß√£o no localStorage
                    localStorage.setItem('pendingRequest', JSON.stringify({
                        name: name,
                        username: username,
                        phone: phone
                    }));
                    
                    showNotification('Solicita√ß√£o enviada! Aguarde aprova√ß√£o do administrador.', 'success');
                    showPendingApproval();
                }
            } catch (error) {
                console.error('Erro no registro:', error);
                showNotification('Erro inesperado no registro', 'error');
            }
        }

        async function checkApprovalStatus() {
            const pendingData = JSON.parse(localStorage.getItem('pendingRequest') || '{}');
            
            if (!pendingData.username) {
                showNotification('Nenhuma solicita√ß√£o encontrada', 'error');
                return;
            }
            
            try {
                // Verificar se foi aprovado (existe na tabela users)
                const { data: approvedUser } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', pendingData.username)
                    .maybeSingle();
                
                if (approvedUser) {
                    localStorage.removeItem('pendingRequest');
                    showNotification('Sua conta foi aprovada! Voc√™ j√° pode fazer login.', 'success');
                    showLogin();
                    return;
                }
                
                // Verificar status na tabela de solicita√ß√µes
                const { data: request } = await supabase
                    .from('user_requests')
                    .select('*')
                    .eq('username', pendingData.username)
                    .maybeSingle();
                
                if (!request) {
                    showNotification('Solicita√ß√£o n√£o encontrada', 'error');
                    return;
                }
                
                if (request.status === 'rejected') {
                    localStorage.removeItem('pendingRequest');
                    showNotification('Sua solicita√ß√£o foi rejeitada. Entre em contato com o administrador.', 'error');
                    showLogin();
                } else if (request.status === 'pending') {
                    showNotification('Sua solicita√ß√£o ainda est√° pendente. Aguarde a aprova√ß√£o.', 'info');
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                showNotification('Erro ao verificar status da solicita√ß√£o', 'error');
            }
        }

        async function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('adminMode');
            localStorage.removeItem('originalAdmin');
            currentUser = null;
            originalAdmin = null;
            showLogin();
            showNotification('Logout realizado com sucesso!', 'success');
        }

        // Carregar solicita√ß√µes pendentes
        async function loadPendingRequests() {
            try {
                const { data, error } = await supabase
                    .from('user_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    showNotification('Erro ao carregar solicita√ß√µes: ' + error.message, 'error');
                    return;
                }
                
                const requestsList = document.getElementById('pending-requests');
                
                if (data.length === 0) {
                    requestsList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma solicita√ß√£o pendente.</p>';
                    return;
                }
                
                requestsList.innerHTML = data.map(request => `
                    <div class="border border-yellow-200 rounded-lg p-4 bg-yellow-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-800">${request.name}</h4>
                                <p class="text-gray-600">Usu√°rio: ${request.username}</p>
                                <p class="text-gray-600">Telefone: ${request.phone}</p>
                                <p class="text-gray-500 text-sm">Solicitado em: ${new Date(request.created_at).toLocaleString('pt-BR')}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approveRequest('${request.id}')" 
                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    ‚úì Aprovar
                                </button>
                                <button onclick="rejectRequest('${request.id}')" 
                                        class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                    ‚úó Rejeitar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar solicita√ß√µes:', error);
                showNotification('Erro inesperado ao carregar solicita√ß√µes', 'error');
            }
        }

        // Aprovar solicita√ß√£o
        async function approveRequest(requestId) {
            if (!confirm('Tem certeza que deseja aprovar esta solicita√ß√£o?')) {
                return;
            }
            
            try {
                // Buscar dados da solicita√ß√£o
                const { data: request, error: fetchError } = await supabase
                    .from('user_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (fetchError || !request) {
                    showNotification('Erro ao buscar solicita√ß√£o: ' + (fetchError?.message || 'N√£o encontrada'), 'error');
                    return;
                }
                
                // Criar usu√°rio na tabela users
                const { data: newUser, error: createError } = await supabase
                    .from('users')
                    .insert([{
                        name: request.name,
                        username: request.username,
                        phone: request.phone,
                        password: request.password,
                        role: 'user',
                        active: true,
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (createError) {
                    showNotification('Erro ao criar usu√°rio: ' + createError.message, 'error');
                    return;
                }
                
                // Atualizar status da solicita√ß√£o
                const { error: updateError } = await supabase
                    .from('user_requests')
                    .update({
                        status: 'approved',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: currentUser.id
                    })
                    .eq('id', requestId);
                
                if (updateError) {
                    showNotification('Erro ao atualizar solicita√ß√£o: ' + updateError.message, 'error');
                    return;
                }
                
                showNotification('Solicita√ß√£o aprovada com sucesso!', 'success');
                loadPendingRequests();
                loadUsers();
                loadDashboardStats();
            } catch (error) {
                console.error('Erro ao aprovar solicita√ß√£o:', error);
                showNotification('Erro inesperado ao aprovar solicita√ß√£o', 'error');
            }
        }

        // Rejeitar solicita√ß√£o
        async function rejectRequest(requestId) {
            if (!confirm('Tem certeza que deseja rejeitar esta solicita√ß√£o?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_requests')
                    .update({
                        status: 'rejected',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: currentUser.id
                    })
                    .eq('id', requestId);
                
                if (error) {
                    showNotification('Erro ao rejeitar solicita√ß√£o: ' + error.message, 'error');
                } else {
                    showNotification('Solicita√ß√£o rejeitada.', 'success');
                    loadPendingRequests();
                    loadDashboardStats();
                }
            } catch (error) {
                console.error('Erro ao rejeitar solicita√ß√£o:', error);
                showNotification('Erro inesperado ao rejeitar solicita√ß√£o', 'error');
            }
        }

        // Criar evento
        async function createNewEvent() {
            if (!supabase) {
                showNotification('Erro: Conex√£o com banco de dados n√£o estabelecida', 'error');
                return;
            }
            
            const name = document.getElementById('event-name').value;
            const date = document.getElementById('event-date').value;
            const location = document.getElementById('event-location').value;
            const address = document.getElementById('event-address').value;
            const description = document.getElementById('event-description').value;
            
            // Op√ß√µes do evento
            const allowCompanions = document.getElementById('allow-companions').checked;
            const showLocation = document.getElementById('show-location').checked;
            const showAddress = document.getElementById('show-address').checked;
            const enableMessages = document.getElementById('enable-messages').checked;
            const enableGifts = document.getElementById('enable-gifts').checked;
            const enableBankTransfer = document.getElementById('enable-bank-transfer').checked;
            
            // Dados de presentes
            const giftsList = document.getElementById('gifts-list').value;
            const giftsMaxSelection = document.getElementById('gifts-max-selection').value;
            
            // Dados banc√°rios
            const bankIban = document.getElementById('bank-iban').value;
            const bankHolder = document.getElementById('bank-holder').value;
            const bankMessage = document.getElementById('bank-message').value;
            const supportPhone = document.getElementById('support-phone').value;
            
            if (!name || !date) {
                showNotification('Por favor, preencha nome e data do evento', 'error');
                return;
            }
            
            if (!currentUser || !currentUser.id) {
                showNotification('Erro: Usu√°rio n√£o identificado', 'error');
                return;
            }
            
            try {
                const companionToken = generateToken();
                const noCompanionToken = generateToken();
                
                const { data, error } = await supabase
                    .from('events')
                    .insert([{
                        name: name,
                        date: date,
                        location: location,
                        address: address,
                        description: description,
                        admin_id: currentUser.id,
                        companion_token: companionToken,
                        no_companion_token: noCompanionToken,
                        allow_companions: allowCompanions,
                        show_location: showLocation,
                        show_address: showAddress,
                        enable_messages: enableMessages,
                        enable_gifts: enableGifts,
                        enable_bank_transfer: enableBankTransfer,
                        gifts_list: giftsList,
                        gifts_max_selection: parseInt(giftsMaxSelection) || 1,
                        bank_iban: bankIban,
                        bank_holder: bankHolder,
                        bank_message: bankMessage,
                        support_phone: supportPhone,
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) {
                    console.error('Erro detalhado:', error);
                    showNotification('Erro ao criar evento: ' + error.message, 'error');
                } else {
                    const event = data[0];
                    showNotification('Evento criado com sucesso!', 'success');
                    
                    // Limpar formul√°rio
                    clearEventForm();
                    
                    // Mostrar links gerados
                    showEventLinks(event);
                    
                    // Recarregar eventos
                    loadUserEvents();
                }
            } catch (error) {
                console.error('Erro ao criar evento:', error);
                showNotification('Erro inesperado ao criar evento', 'error');
            }
        }

        // Limpar formul√°rio
        function clearEventForm() {
            document.getElementById('event-name').value = '';
            document.getElementById('event-date').value = '';
            document.getElementById('event-location').value = '';
            document.getElementById('event-address').value = '';
            document.getElementById('event-description').value = '';
            
            // Resetar checkboxes para valores padr√£o
            document.getElementById('allow-companions').checked = true;
            document.getElementById('show-location').checked = true;
            document.getElementById('show-address').checked = true;
            document.getElementById('enable-messages').checked = true;
            document.getElementById('enable-gifts').checked = false;
            document.getElementById('enable-bank-transfer').checked = false;
            
            // Limpar campos de presentes e banco
            document.getElementById('gifts-list').value = '';
            document.getElementById('gifts-max-selection').value = '1';
            document.getElementById('bank-iban').value = '';
            document.getElementById('bank-holder').value = '';
            document.getElementById('bank-message').value = '';
            document.getElementById('support-phone').value = '';
            
            // Ocultar se√ß√µes de configura√ß√£o
            document.getElementById('gifts-config').classList.add('hidden');
            document.getElementById('bank-config').classList.add('hidden');
        }

        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function showEventLinks(event) {
            const baseUrl = window.location.origin + window.location.pathname;
            const companionLink = `${baseUrl}?event=${event.id}&token=${event.companion_token}&acompanhante=true`;
            const noCompanionLink = `${baseUrl}?event=${event.id}&token=${event.no_companion_token}&acompanhante=false`;
            
            const linksHtml = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-6">
                    <h3 class="text-lg font-bold text-blue-800 mb-4">Links do Evento: ${event.name}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">Link para convidados COM acompanhante:</label>
                            <div class="flex">
                                <input type="text" value="${companionLink}" readonly 
                                       class="flex-1 px-3 py-2 bg-white border border-blue-300 rounded-l-md text-sm">
                                <button onclick="copyToClipboard('${companionLink}')" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700">
                                    Copiar
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-2">Link para convidados SEM acompanhante:</label>
                            <div class="flex">
                                <input type="text" value="${noCompanionLink}" readonly 
                                       class="flex-1 px-3 py-2 bg-white border border-blue-300 rounded-l-md text-sm">
                                <button onclick="copyToClipboard('${noCompanionLink}')" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700">
                                    Copiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar os links ap√≥s o formul√°rio de cria√ß√£o
            const existingLinks = document.querySelector('.event-links');
            if (existingLinks) {
                existingLinks.remove();
            }
            
            const linksDiv = document.createElement('div');
            linksDiv.className = 'event-links';
            linksDiv.innerHTML = linksHtml;
            
            const createEventSection = document.querySelector('#user-panel .bg-white:nth-child(2)') || 
                                     document.querySelector('#admin-panel .bg-white:nth-child(2)');
            if (createEventSection) {
                createEventSection.appendChild(linksDiv);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Link copiado para a √°rea de transfer√™ncia!', 'success');
            });
        }

        // Carregar usu√°rios
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    showNotification('Erro ao carregar usu√°rios: ' + error.message, 'error');
                    return;
                }
                
                const usersList = document.getElementById('users-list');
                
                if (data.length === 0) {
                    usersList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum usu√°rio cadastrado ainda.</p>';
                    return;
                }
                
                // Separar admins e usu√°rios
                const admins = data.filter(user => user.role === 'admin');
                const regularUsers = data.filter(user => user.role === 'user');
                
                let html = '';
                
                if (admins.length > 0) {
                    html += '<h3 class="text-lg font-semibold text-blue-600 mb-4">Administradores</h3>';
                    html += admins.map(user => `
                        <div class="border border-blue-200 rounded-lg p-4 bg-blue-50 mb-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="text-lg font-semibold text-gray-800">${user.name}</h4>
                                    <p class="text-gray-600">Usu√°rio: ${user.username}</p>
                                    <p class="text-gray-600">Senha: 
                                        <span id="password-display-${user.id}">${'*'.repeat(user.password.length)}</span>
                                        <button onclick="togglePassword('${user.id}', '${user.password}')" id="toggle-${user.id}" 
                                                class="ml-2 text-blue-600 hover:text-blue-800 text-sm">
                                            üëÅÔ∏è Mostrar
                                        </button>
                                    </p>
                                    <p class="text-blue-600 text-sm font-medium">üëë Administrador</p>
                                    <p class="text-gray-500 text-sm">Criado em: ${new Date(user.created_at).toLocaleString('pt-BR')}</p>
                                </div>
                                <div class="flex space-x-2">
                                    ${user.id !== currentUser.id ? `
                                        <button onclick="deleteUser('${user.id}')" 
                                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                            Excluir
                                        </button>
                                    ` : '<span class="text-gray-500 text-sm">Voc√™</span>'}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                if (regularUsers.length > 0) {
                    html += '<h3 class="text-lg font-semibold text-green-600 mb-4 mt-6">Usu√°rios</h3>';
                    html += regularUsers.map(user => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="text-lg font-semibold text-gray-800">${user.name}</h4>
                                    <p class="text-gray-600">Usu√°rio: ${user.username}</p>
                                    <p class="text-gray-600">Senha: 
                                        <span id="password-display-${user.id}">${'*'.repeat(user.password.length)}</span>
                                        <button onclick="togglePassword('${user.id}', '${user.password}')" id="toggle-${user.id}" 
                                                class="ml-2 text-blue-600 hover:text-blue-800 text-sm">
                                            üëÅÔ∏è Mostrar
                                        </button>
                                    </p>
                                    <p class="text-green-600 text-sm font-medium">üë§ Usu√°rio</p>
                                    <p class="text-sm ${user.active !== false ? 'text-green-600' : 'text-red-600'}">
                                        Status: ${user.active !== false ? 'üü¢ Ativo' : 'üî¥ Desativado'}
                                    </p>
                                    <p class="text-gray-500 text-sm">Criado em: ${new Date(user.created_at).toLocaleString('pt-BR')}</p>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="loginAsUser('${user.id}')" 
                                            class="bg-purple-600 text-white px-2 py-1 rounded text-xs hover:bg-purple-700">
                                        üîë Entrar na Conta
                                    </button>
                                    <button onclick="promoteToAdmin('${user.id}')" 
                                            class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">
                                        Promover
                                    </button>
                                    <button onclick="toggleUserStatus('${user.id}', ${user.active !== false})" 
                                            class="${user.active !== false ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'} text-white px-2 py-1 rounded text-xs">
                                        ${user.active !== false ? 'Desativar' : 'Ativar'}
                                    </button>
                                    <button onclick="deleteUser('${user.id}')" 
                                            class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                if (data.length === 0) {
                    html = '<p class="text-gray-500 text-center py-8">Nenhum usu√°rio cadastrado ainda.</p>';
                }
                
                usersList.innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                showNotification('Erro inesperado ao carregar usu√°rios', 'error');
            }
        }

        // Excluir usu√°rio
        async function deleteUser(userId) {
            if (!confirm('Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                
                if (error) {
                    showNotification('Erro ao excluir usu√°rio: ' + error.message, 'error');
                } else {
                    showNotification('Usu√°rio exclu√≠do com sucesso!', 'success');
                    loadUsers();
                    loadDashboardStats();
                }
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                showNotification('Erro inesperado ao excluir usu√°rio', 'error');
            }
        }

        // Carregar estat√≠sticas do dashboard
        async function loadDashboardStats() {
            try {
                // Solicita√ß√µes pendentes
                const { data: pendingRequests } = await supabase
                    .from('user_requests')
                    .select('id')
                    .eq('status', 'pending');
                document.getElementById('pending-requests-count').textContent = pendingRequests?.length || 0;
                
                // Total de usu√°rios
                const { data: users } = await supabase.from('users').select('id');
                document.getElementById('total-users').textContent = users?.length || 0;
                
                // Total de eventos
                const { data: events } = await supabase.from('events').select('id');
                document.getElementById('total-events').textContent = events?.length || 0;
                
                // Total de confirma√ß√µes
                const { data: confirmations } = await supabase.from('confirmations').select('id');
                document.getElementById('total-confirmations').textContent = confirmations?.length || 0;
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Carregar relat√≥rios de eventos
        async function loadEventReports() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    showNotification('Erro ao carregar eventos: ' + error.message, 'error');
                    return;
                }
                
                const eventsList = document.getElementById('events-reports');
                
                if (events.length === 0) {
                    eventsList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum evento encontrado.</p>';
                    return;
                }
                
                // Para cada evento, buscar as confirma√ß√µes
                const eventsWithStats = await Promise.all(events.map(async (event) => {
                    const { data: confirmations } = await supabase
                        .from('confirmations')
                        .select('*')
                        .eq('event_id', event.id);
                    
                    const confirmed = confirmations?.filter(c => c.attendance === 'confirmed').length || 0;
                    const declined = confirmations?.filter(c => c.attendance === 'declined').length || 0;
                    
                    return { ...event, confirmed, declined, total: confirmations?.length || 0 };
                }));
                
                eventsList.innerHTML = eventsWithStats.map(event => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800">${event.name}</h3>
                                <p class="text-gray-600">${new Date(event.date).toLocaleString('pt-BR')}</p>
                                <p class="text-gray-600">${event.location}</p>
                                <p class="text-sm text-gray-500">Criado por: Admin</p>
                                <div class="flex space-x-4 mt-2">
                                    <span class="text-green-600 font-medium">‚úì ${event.confirmed} Confirmados</span>
                                    <span class="text-red-600 font-medium">‚úó ${event.declined} Recusaram</span>
                                    <span class="text-gray-600">Total: ${event.total}</span>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button onclick="downloadEventReport('${event.id}', '${event.name}')" 
                                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                    üìä Baixar Relat√≥rio
                                </button>
                                <button onclick="viewEventConfirmations('${event.id}')" 
                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    üë• Ver Confirma√ß√µes
                                </button>
                                <button onclick="deleteEventConfirmations('${event.id}')" 
                                        class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                                    üóëÔ∏è Limpar Confirma√ß√µes
                                </button>
                                <button onclick="editEvent('${event.id}')" 
                                        class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                                    ‚úèÔ∏è Editar Evento
                                </button>
                                <button onclick="deleteEvent('${event.id}')" 
                                        class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                    ‚ùå Excluir Evento
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar relat√≥rios:', error);
                showNotification('Erro inesperado ao carregar relat√≥rios', 'error');
            }
        }

        // Baixar relat√≥rio do evento
        async function downloadEventReport(eventId, eventName) {
            try {
                const { data: confirmations } = await supabase
                    .from('confirmations')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('guest_name', { ascending: true });
                
                const confirmed = confirmations?.filter(c => c.attendance === 'confirmed') || [];
                const declined = confirmations?.filter(c => c.attendance === 'declined') || [];
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Nome do Evento,Status,Nome do Convidado,Acompanhante,Observa√ß√µes,Data de Confirma√ß√£o\n";
                
                confirmed.forEach(c => {
                    csvContent += `"${eventName}","Confirmado","${c.guest_name}","${c.companion_name || 'Sem acompanhante'}","${c.notes || ''}","${new Date(c.created_at).toLocaleString('pt-BR')}"\n`;
                });
                
                declined.forEach(c => {
                    csvContent += `"${eventName}","Recusou","${c.guest_name}","","${c.notes || ''}","${new Date(c.created_at).toLocaleString('pt-BR')}"\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `relatorio_${eventName.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Relat√≥rio baixado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao baixar relat√≥rio:', error);
                showNotification('Erro ao baixar relat√≥rio', 'error');
            }
        }

        // Ativar/Desativar usu√°rio
        async function toggleUserStatus(userId, isActive) {
            const action = isActive ? 'desativar' : 'ativar';
            if (!confirm(`Tem certeza que deseja ${action} este usu√°rio?`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ active: !isActive })
                    .eq('id', userId);
                
                if (error) {
                    showNotification(`Erro ao ${action} usu√°rio: ` + error.message, 'error');
                } else {
                    showNotification(`Usu√°rio ${isActive ? 'desativado' : 'ativado'} com sucesso!`, 'success');
                    loadUsers();
                    loadDashboardStats();
                }
            } catch (error) {
                console.error(`Erro ao ${action} usu√°rio:`, error);
                showNotification(`Erro inesperado ao ${action} usu√°rio`, 'error');
            }
        }

        // Excluir confirma√ß√µes do evento
        async function deleteEventConfirmations(eventId) {
            if (!confirm('Tem certeza que deseja excluir TODAS as confirma√ß√µes deste evento? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('confirmations')
                    .delete()
                    .eq('event_id', eventId);
                
                if (error) {
                    showNotification('Erro ao excluir confirma√ß√µes: ' + error.message, 'error');
                } else {
                    showNotification('Todas as confirma√ß√µes foram exclu√≠das!', 'success');
                    loadEventReports();
                    loadDashboardStats();
                }
            } catch (error) {
                console.error('Erro ao excluir confirma√ß√µes:', error);
                showNotification('Erro inesperado ao excluir confirma√ß√µes', 'error');
            }
        }

        // Ver confirma√ß√µes do evento
        async function viewEventConfirmations(eventId) {
            try {
                const { data, error } = await supabase
                    .from('confirmations')
                    .select('*')
                    .eq('event_id', eventId);
                
                if (error) {
                    showNotification('Erro ao carregar confirma√ß√µes: ' + error.message, 'error');
                    return;
                }
                
                const confirmed = data.filter(c => c.attendance === 'confirmed');
                const declined = data.filter(c => c.attendance === 'declined');
                
                const confirmationsHtml = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">Confirma√ß√µes do Evento</h2>
                                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-green-600 mb-4">Confirmados (${confirmed.length})</h3>
                                    <div class="space-y-2">
                                        ${confirmed.map(c => `
                                            <div class="bg-green-50 p-3 rounded">
                                                <p class="font-medium">${c.guest_name}</p>
                                                ${c.companion_name ? `<p class="text-sm text-gray-600">Acompanhante: ${c.companion_name}</p>` : ''}
                                                ${c.notes ? `<p class="text-sm text-gray-500">${c.notes}</p>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-red-600 mb-4">N√£o Confirmados (${declined.length})</h3>
                                    <div class="space-y-2">
                                        ${declined.map(c => `
                                            <div class="bg-red-50 p-3 rounded">
                                                <p class="font-medium">${c.guest_name}</p>
                                                ${c.notes ? `<p class="text-sm text-gray-500">${c.notes}</p>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', confirmationsHtml);
            } catch (error) {
                console.error('Erro ao visualizar confirma√ß√µes:', error);
                showNotification('Erro inesperado ao visualizar confirma√ß√µes', 'error');
            }
        }

        function closeModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black');
            if (modal) {
                modal.remove();
            }
        }

        // Excluir evento (Admin)
        async function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);
                
                if (error) {
                    showNotification('Erro ao excluir evento: ' + error.message, 'error');
                } else {
                    showNotification('Evento exclu√≠do com sucesso!', 'success');
                    loadEventReports();
                    loadDashboardStats();
                }
            } catch (error) {
                console.error('Erro ao excluir evento:', error);
                showNotification('Erro inesperado ao excluir evento', 'error');
            }
        }

        // Carregar p√°gina do convidado
        async function loadGuestPage(eventId, hasCompanion) {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            try {
                // Verificar se o evento existe e se o token √© v√°lido
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (error || !event) {
                    showErrorPage();
                    return;
                }
                
                // Verificar se o token corresponde ao tipo de convite
                const validToken = hasCompanion ? event.companion_token : event.no_companion_token;
                if (token !== validToken) {
                    showErrorPage();
                    return;
                }
                
                currentEvent = event;
                showGuestConfirmation();
                
                // Carregar detalhes do evento
                let eventDetailsHtml = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${event.name}</h1>
                    <div class="text-gray-600 space-y-2">
                        <p><strong>Data:</strong> ${new Date(event.date).toLocaleString('pt-BR')}</p>
                `;
                
                if (event.show_location && event.location) {
                    eventDetailsHtml += `<p><strong>Local:</strong> ${event.location}</p>`;
                }
                
                if (event.show_address && event.address) {
                    eventDetailsHtml += `<p><strong>Endere√ßo:</strong> ${event.address}</p>`;
                }
                
                if (event.description) {
                    eventDetailsHtml += `<p class="mt-4">${event.description}</p>`;
                }
                
                eventDetailsHtml += `</div>`;
                
                // Verificar se acompanhantes s√£o permitidos
                if (!event.allow_companions) {
                    eventDetailsHtml += '<div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg mt-4"><strong>Este convite √© individual (sem acompanhante)</strong></div>';
                } else if (!hasCompanion) {
                    eventDetailsHtml += '<div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg mt-4"><strong>Este convite √© individual (sem acompanhante)</strong></div>';
                }
                
                document.getElementById('event-details').innerHTML = eventDetailsHtml;
                
                // Configurar se√ß√£o de acompanhante baseado nas configura√ß√µes do evento
                if (event.allow_companions && hasCompanion) {
                    document.getElementById('add-companion-section').classList.remove('hidden');
                } else {
                    document.getElementById('add-companion-section').classList.add('hidden');
                    document.getElementById('companion-section').classList.add('hidden');
                }
                
                // Iniciar contagem regressiva
                startCountdown(event.date);
                
                // Verificar se j√° existe confirma√ß√£o
                await checkExistingConfirmation(eventId, hasCompanion);
                
                // Configurar se√ß√µes baseado nas configura√ß√µes do evento
                if (event.enable_messages) {
                    loadMessages(eventId);
                    document.getElementById('messages-section').classList.remove('hidden');
                } else {
                    document.getElementById('messages-section').classList.add('hidden');
                }
                
                if (event.enable_gifts) {
                    loadGiftsList(eventId);
                    document.getElementById('gifts-section').classList.remove('hidden');
                } else {
                    document.getElementById('gifts-section').classList.add('hidden');
                }
                
                if (event.enable_bank_transfer) {
                    loadBankTransferInfo(event);
                    document.getElementById('bank-transfer-section').classList.remove('hidden');
                } else {
                    document.getElementById('bank-transfer-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Erro ao carregar p√°gina do convidado:', error);
                showErrorPage();
            }
        }

        // Verificar confirma√ß√£o existente
        async function checkExistingConfirmation(eventId, hasCompanion) {
            const guestId = localStorage.getItem(`guest_${eventId}_${hasCompanion}`);
            
            if (guestId) {
                try {
                    const { data, error } = await supabase
                        .from('confirmations')
                        .select('*')
                        .eq('id', guestId)
                        .single();
                    
                    if (data) {
                        currentGuest = data;
                        // Preencher formul√°rio com dados existentes
                        document.getElementById('guest-name').value = data.guest_name;
                        
                        // Configurar acompanhante se existir
                        if (data.companion_name && currentEvent.allow_companions && hasCompanion) {
                            addCompanion();
                            document.getElementById('companion-name').value = data.companion_name;
                        }
                        
                        document.querySelector(`input[name="attendance"][value="${data.attendance}"]`).checked = true;
                        if (data.notes) {
                            document.getElementById('guest-notes').value = data.notes;
                        }
                        
                        // Mostrar tela de sucesso
                        document.getElementById('confirmation-form').classList.add('hidden');
                        document.getElementById('confirmation-success').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Erro ao verificar confirma√ß√£o existente:', error);
                }
            }
        }

        // Submeter confirma√ß√£o
        async function submitConfirmation() {
            const guestName = document.getElementById('guest-name').value;
            const companionName = document.getElementById('companion-name').value;
            const attendance = document.querySelector('input[name="attendance"]:checked')?.value;
            const notes = document.getElementById('guest-notes').value;
            
            if (!guestName || !attendance) {
                showNotification('Por favor, preencha seu nome e confirme sua presen√ßa', 'error');
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const hasCompanion = urlParams.get('acompanhante') === 'true';
            
            // Verificar se acompanhante √© permitido
            const finalCompanionName = (currentEvent.allow_companions && hasCompanion) ? companionName : null;
            
            const confirmationData = {
                event_id: currentEvent.id,
                guest_name: guestName,
                companion_name: finalCompanionName,
                attendance: attendance,
                notes: notes,
                has_companion_permission: hasCompanion && currentEvent.allow_companions,
                created_at: new Date().toISOString()
            };
            
            try {
                let result;
                
                if (currentGuest) {
                    // Atualizar confirma√ß√£o existente
                    result = await supabase
                        .from('confirmations')
                        .update(confirmationData)
                        .eq('id', currentGuest.id)
                        .select();
                } else {
                    // Criar nova confirma√ß√£o
                    result = await supabase
                        .from('confirmations')
                        .insert([confirmationData])
                        .select();
                }
                
                if (result.error) {
                    showNotification('Erro ao salvar confirma√ß√£o: ' + result.error.message, 'error');
                } else {
                    const confirmation = result.data[0];
                    currentGuest = confirmation;
                    
                    // Salvar ID da confirma√ß√£o no localStorage para persist√™ncia
                    localStorage.setItem(`guest_${currentEvent.id}_${hasCompanion}`, confirmation.id);
                    
                    // Mostrar tela de sucesso
                    document.getElementById('confirmation-form').classList.add('hidden');
                    document.getElementById('confirmation-success').classList.remove('hidden');
                    
                    // Mostrar notifica√ß√£o de agradecimento
                    showNotification('Obrigado! Sua resposta foi enviada com sucesso.', 'success');
                }
            } catch (error) {
                console.error('Erro ao submeter confirma√ß√£o:', error);
                showNotification('Erro inesperado ao salvar confirma√ß√£o', 'error');
            }
        }

        // Editar confirma√ß√£o
        function editConfirmation() {
            document.getElementById('confirmation-form').classList.remove('hidden');
            document.getElementById('confirmation-success').classList.add('hidden');
        }

        // Voltar ao in√≠cio
        function goHome() {
            window.location.href = window.location.pathname;
        }

        // Mostrar/ocultar senha
        function togglePassword(userId, password) {
            const passwordDisplay = document.getElementById(`password-display-${userId}`);
            const toggleButton = document.getElementById(`toggle-${userId}`);
            
            if (toggleButton.textContent.includes('Mostrar')) {
                passwordDisplay.textContent = password;
                toggleButton.textContent = 'üôà Ocultar';
            } else {
                passwordDisplay.textContent = '*'.repeat(password.length);
                toggleButton.textContent = 'üëÅÔ∏è Mostrar';
            }
        }

        // Promover usu√°rio a admin
        async function promoteToAdmin(userId) {
            if (!confirm('Tem certeza que deseja promover este usu√°rio a administrador?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ role: 'admin' })
                    .eq('id', userId);
                
                if (error) {
                    showNotification('Erro ao promover usu√°rio: ' + error.message, 'error');
                } else {
                    showNotification('Usu√°rio promovido a administrador!', 'success');
                    loadUsers();
                }
            } catch (error) {
                console.error('Erro ao promover usu√°rio:', error);
                showNotification('Erro inesperado ao promover usu√°rio', 'error');
            }
        }

        // Fun√ß√µes do painel de usu√°rio
        function loadUserAccountSettings() {
            if (currentUser) {
                document.getElementById('user-settings-name').value = currentUser.name || '';
                document.getElementById('user-settings-username').value = currentUser.username || '';
                document.getElementById('user-settings-phone').value = currentUser.phone || '';
            }
        }

        async function updateUserSettings() {
            const name = document.getElementById('user-settings-name').value;
            const username = document.getElementById('user-settings-username').value;
            const phone = document.getElementById('user-settings-phone').value;
            const password = document.getElementById('user-settings-password').value;
            const confirmPassword = document.getElementById('user-settings-confirm-password').value;
            
            if (!name || !username) {
                showNotification('Por favor, preencha nome e username', 'error');
                return;
            }
            
            if (password && password !== confirmPassword) {
                showNotification('As senhas n√£o coincidem', 'error');
                return;
            }
            
            try {
                // Verificar se o username j√° existe (exceto o atual)
                if (username !== currentUser.username) {
                    const { data: existingUser } = await supabase
                        .from('users')
                        .select('username')
                        .eq('username', username)
                        .neq('id', currentUser.id)
                        .maybeSingle();
                    
                    if (existingUser) {
                        showNotification('Nome de usu√°rio j√° existe', 'error');
                        return;
                    }
                }
                
                // Preparar dados para atualiza√ß√£o
                const updateData = {
                    name: name,
                    username: username,
                    phone: phone
                };
                
                if (password) {
                    updateData.password = password;
                }
                
                // Atualizar no banco
                const { data, error } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', currentUser.id)
                    .select();
                
                if (error) {
                    showNotification('Erro ao atualizar: ' + error.message, 'error');
                } else {
                    currentUser = data[0];
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Limpar campos de senha
                    document.getElementById('user-settings-password').value = '';
                    document.getElementById('user-settings-confirm-password').value = '';
                    
                    // Atualizar nome no header
                    document.getElementById('user-name').textContent = currentUser.name || currentUser.username;
                    
                    showNotification('Configura√ß√µes atualizadas com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao atualizar configura√ß√µes:', error);
                showNotification('Erro inesperado ao atualizar configura√ß√µes', 'error');
            }
        }

        async function loadUserEvents() {
            try {
                const { data, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('admin_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    showNotification('Erro ao carregar eventos: ' + error.message, 'error');
                    return;
                }
                
                const eventsList = document.getElementById('user-events-list');
                
                if (data.length === 0) {
                    eventsList.innerHTML = '<p class="text-gray-500 text-center py-8">Voc√™ ainda n√£o criou nenhum evento. Crie seu primeiro evento acima!</p>';
                    return;
                }
                
                // Para cada evento, buscar as confirma√ß√µes
                const eventsWithStats = await Promise.all(data.map(async (event) => {
                    const { data: confirmations } = await supabase
                        .from('confirmations')
                        .select('*')
                        .eq('event_id', event.id);
                    
                    const confirmed = confirmations?.filter(c => c.attendance === 'confirmed').length || 0;
                    const declined = confirmations?.filter(c => c.attendance === 'declined').length || 0;
                    
                    return { ...event, confirmed, declined, total: confirmations?.length || 0 };
                }));
                
                eventsList.innerHTML = eventsWithStats.map(event => {
                    const baseUrl = window.location.origin + window.location.pathname;
                    const companionLink = `${baseUrl}?event=${event.id}&token=${event.companion_token}&acompanhante=true`;
                    const noCompanionLink = `${baseUrl}?event=${event.id}&token=${event.no_companion_token}&acompanhante=false`;
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold text-gray-800">${event.name}</h3>
                                    <p class="text-gray-600">${new Date(event.date).toLocaleString('pt-BR')}</p>
                                    <p class="text-gray-600">${event.location}</p>
                                    ${event.address ? `<p class="text-gray-500 text-sm">${event.address}</p>` : ''}
                                    ${event.description ? `<p class="text-gray-700 mt-2">${event.description}</p>` : ''}
                                    <div class="flex space-x-4 mt-3">
                                        <span class="text-green-600 font-medium">‚úì ${event.confirmed} Confirmados</span>
                                        <span class="text-red-600 font-medium">‚úó ${event.declined} Recusaram</span>
                                        <span class="text-gray-600">Total: ${event.total}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col space-y-2">
                                    <button onclick="downloadEventReport('${event.id}', '${event.name}')" 
                                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        üìä Relat√≥rio
                                    </button>
                                    <button onclick="viewEventConfirmations('${event.id}')" 
                                            class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                        üë• Ver Lista
                                    </button>
                                    <button onclick="editEvent('${event.id}')" 
                                            class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button onclick="deleteUserEvent('${event.id}')" 
                                            class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                        üóëÔ∏è Excluir
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-800 mb-3">Links para Convidados:</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-blue-700 mb-1">COM acompanhante:</label>
                                        <div class="flex">
                                            <input type="text" value="${companionLink}" readonly 
                                                   class="flex-1 px-2 py-1 bg-white border border-blue-300 rounded-l text-xs">
                                            <button onclick="copyToClipboard('${companionLink}')" 
                                                    class="bg-blue-600 text-white px-3 py-1 rounded-r text-xs hover:bg-blue-700">
                                                Copiar
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-blue-700 mb-1">SEM acompanhante:</label>
                                        <div class="flex">
                                            <input type="text" value="${noCompanionLink}" readonly 
                                                   class="flex-1 px-2 py-1 bg-white border border-blue-300 rounded-l text-xs">
                                            <button onclick="copyToClipboard('${noCompanionLink}')" 
                                                    class="bg-blue-600 text-white px-3 py-1 rounded-r text-xs hover:bg-blue-700">
                                                Copiar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar eventos do usu√°rio:', error);
                showNotification('Erro inesperado ao carregar eventos', 'error');
            }
        }

        // Editar evento
        async function editEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (error || !event) {
                    showNotification('Erro ao carregar evento', 'error');
                    return;
                }
                
                // Preencher formul√°rio com dados do evento
                document.getElementById('event-name').value = event.name;
                document.getElementById('event-date').value = event.date;
                document.getElementById('event-location').value = event.location || '';
                document.getElementById('event-address').value = event.address || '';
                document.getElementById('event-description').value = event.description || '';
                
                // Configurar checkboxes
                document.getElementById('allow-companions').checked = event.allow_companions;
                document.getElementById('show-location').checked = event.show_location;
                document.getElementById('show-address').checked = event.show_address;
                document.getElementById('enable-messages').checked = event.enable_messages;
                
                // Alterar bot√£o para modo edi√ß√£o
                const createButton = document.querySelector('button[onclick="createNewEvent()"]');
                createButton.textContent = 'Atualizar Evento';
                createButton.onclick = () => updateEvent(eventId);
                createButton.className = 'mt-6 bg-orange-600 text-white px-6 py-2 rounded-md hover:bg-orange-700 transition-colors';
                
                // Adicionar bot√£o cancelar
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancelar Edi√ß√£o';
                cancelButton.className = 'mt-6 ml-3 bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors';
                cancelButton.onclick = cancelEdit;
                createButton.parentNode.insertBefore(cancelButton, createButton.nextSibling);
                
                // Scroll para o formul√°rio
                document.getElementById('event-name').scrollIntoView({ behavior: 'smooth' });
                
                showNotification('Editando evento. Fa√ßa as altera√ß√µes e clique em "Atualizar Evento"', 'info');
            } catch (error) {
                console.error('Erro ao editar evento:', error);
                showNotification('Erro inesperado ao editar evento', 'error');
            }
        }
        
        // Atualizar evento
        async function updateEvent(eventId) {
            const name = document.getElementById('event-name').value;
            const date = document.getElementById('event-date').value;
            const location = document.getElementById('event-location').value;
            const address = document.getElementById('event-address').value;
            const description = document.getElementById('event-description').value;
            
            const allowCompanions = document.getElementById('allow-companions').checked;
            const showLocation = document.getElementById('show-location').checked;
            const showAddress = document.getElementById('show-address').checked;
            const enableMessages = document.getElementById('enable-messages').checked;
            
            if (!name || !date) {
                showNotification('Por favor, preencha nome e data do evento', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('events')
                    .update({
                        name: name,
                        date: date,
                        location: location,
                        address: address,
                        description: description,
                        allow_companions: allowCompanions,
                        show_location: showLocation,
                        show_address: showAddress,
                        enable_messages: enableMessages
                    })
                    .eq('id', eventId);
                
                if (error) {
                    showNotification('Erro ao atualizar evento: ' + error.message, 'error');
                } else {
                    showNotification('Evento atualizado com sucesso!', 'success');
                    cancelEdit();
                    
                    // Recarregar eventos
                    if (currentUser.role === 'admin') {
                        loadEventReports();
                    } else {
                        loadUserEvents();
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar evento:', error);
                showNotification('Erro inesperado ao atualizar evento', 'error');
            }
        }
        
        // Cancelar edi√ß√£o
        function cancelEdit() {
            // Restaurar bot√£o original
            const updateButton = document.querySelector('button[onclick*="updateEvent"]');
            if (updateButton) {
                updateButton.textContent = 'Criar Evento';
                updateButton.onclick = createNewEvent;
                updateButton.className = 'mt-6 bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors';
            }
            
            // Remover bot√£o cancelar
            const cancelButton = document.querySelector('button[onclick="cancelEdit()"]');
            if (cancelButton) {
                cancelButton.remove();
            }
            
            // Limpar formul√°rio
            clearEventForm();
            
            showNotification('Edi√ß√£o cancelada', 'info');
        }

        // Excluir evento do usu√°rio
        async function deleteUserEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId)
                    .eq('admin_id', currentUser.id); // Garantir que s√≥ pode excluir pr√≥prios eventos
                
                if (error) {
                    showNotification('Erro ao excluir evento: ' + error.message, 'error');
                } else {
                    showNotification('Evento exclu√≠do com sucesso!', 'success');
                    loadUserEvents();
                }
            } catch (error) {
                console.error('Erro ao excluir evento:', error);
                showNotification('Erro inesperado ao excluir evento', 'error');
            }
        }

        // Fun√ß√µes de acompanhante
        function addCompanion() {
            document.getElementById('add-companion-section').classList.add('hidden');
            document.getElementById('companion-section').classList.remove('hidden');
        }

        function removeCompanion() {
            document.getElementById('add-companion-section').classList.remove('hidden');
            document.getElementById('companion-section').classList.add('hidden');
            document.getElementById('companion-name').value = '';
        }

        // Contagem regressiva
        function startCountdown(eventDate) {
            const countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const eventTime = new Date(eventDate).getTime();
                const distance = eventTime - now;
                
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown-section').innerHTML = '<p class="text-red-600 font-bold text-xl">O evento j√° aconteceu!</p>';
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById('days').textContent = days;
                document.getElementById('hours').textContent = hours;
                document.getElementById('minutes').textContent = minutes;
                document.getElementById('seconds').textContent = seconds;
            }, 1000);
        }

        // Carregar mensagens do mural
        async function loadMessages(eventId) {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar mensagens:', error);
                    return;
                }
                
                const messagesBoard = document.getElementById('messages-board');
                
                if (data.length === 0) {
                    messagesBoard.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum recado ainda. Seja o primeiro a deixar uma mensagem!</p>';
                    return;
                }
                
                messagesBoard.innerHTML = data.map(message => `
                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-medium text-gray-800">${message.guest_name}</span>
                            <span class="text-xs text-gray-500">${new Date(message.created_at).toLocaleString('pt-BR')}</span>
                        </div>
                        <p class="text-gray-700">${message.message}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }

        // Postar mensagem no mural
        async function postMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                showNotification('Por favor, digite uma mensagem', 'error');
                return;
            }
            
            const guestName = document.getElementById('guest-name').value || 'Convidado';
            
            try {
                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        event_id: currentEvent.id,
                        guest_name: guestName,
                        message: message,
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    showNotification('Erro ao enviar mensagem: ' + error.message, 'error');
                } else {
                    messageInput.value = '';
                    loadMessages(currentEvent.id);
                    showNotification('Mensagem enviada!', 'success');
                }
            } catch (error) {
                console.error('Erro ao postar mensagem:', error);
                showNotification('Erro inesperado ao enviar mensagem', 'error');
            }
        }

        // Vari√°veis para modo admin
        let originalAdmin = null;

        // Entrar na conta de um usu√°rio (modo admin)
        async function loginAsUser(userId) {
            if (!confirm('Tem certeza que deseja entrar na conta deste usu√°rio? Voc√™ poder√° visualizar e editar os dados dele.')) {
                return;
            }
            
            try {
                // Buscar dados do usu√°rio
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error || !user) {
                    showNotification('Erro ao carregar dados do usu√°rio', 'error');
                    return;
                }
                
                // Salvar admin original
                originalAdmin = currentUser;
                localStorage.setItem('originalAdmin', JSON.stringify(originalAdmin));
                localStorage.setItem('adminMode', 'true');
                
                // Definir usu√°rio atual como o usu√°rio selecionado
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                showNotification(`Entrando na conta de: ${user.name}`, 'success');
                showUserPanel();
            } catch (error) {
                console.error('Erro ao entrar na conta do usu√°rio:', error);
                showNotification('Erro inesperado ao entrar na conta', 'error');
            }
        }

        // Voltar ao painel admin
        function backToAdmin() {
            if (originalAdmin) {
                currentUser = originalAdmin;
                localStorage.setItem('currentUser', JSON.stringify(originalAdmin));
                localStorage.removeItem('adminMode');
                localStorage.removeItem('originalAdmin');
                originalAdmin = null;
                
                showNotification('Voltando ao painel administrativo', 'success');
                showAdminPanel();
            }
        }

        // Mostrar indicadores de modo admin
        function showAdminModeIndicators() {
            document.getElementById('admin-mode-indicator').classList.remove('hidden');
            document.getElementById('back-to-admin').classList.remove('hidden');
        }

        // Ocultar indicadores de modo admin
        function hideAdminModeIndicators() {
            document.getElementById('admin-mode-indicator').classList.add('hidden');
            document.getElementById('back-to-admin').classList.add('hidden');
        }

        // Carregar lista de presentes
        async function loadGiftsList(eventId) {
            try {
                const { data: event } = await supabase
                    .from('events')
                    .select('gifts_list, gifts_max_selection')
                    .eq('id', eventId)
                    .single();
                
                if (!event || !event.gifts_list) return;
                
                const gifts = event.gifts_list.split('\n').filter(gift => gift.trim());
                const maxSelection = event.gifts_max_selection || 1;
                
                // Buscar presentes j√° escolhidos
                const { data: selectedGifts } = await supabase
                    .from('gift_selections')
                    .select('gift_name, guest_name')
                    .eq('event_id', eventId);
                
                const giftCounts = {};
                selectedGifts?.forEach(selection => {
                    giftCounts[selection.gift_name] = (giftCounts[selection.gift_name] || 0) + 1;
                });
                
                const giftsListDisplay = document.getElementById('gifts-list-display');
                giftsListDisplay.innerHTML = gifts.map(gift => {
                    const selectedCount = giftCounts[gift] || 0;
                    const isAvailable = selectedCount < maxSelection;
                    const selectedBy = selectedGifts?.filter(s => s.gift_name === gift).map(s => s.guest_name) || [];
                    
                    return `
                        <div class="bg-white p-4 rounded-lg border ${isAvailable ? 'border-gray-200' : 'border-red-200 bg-red-50'}">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-800">${gift}</h4>
                                <span class="text-sm ${isAvailable ? 'text-green-600' : 'text-red-600'}">
                                    ${selectedCount}/${maxSelection}
                                </span>
                            </div>
                            ${selectedBy.length > 0 ? `
                                <p class="text-xs text-gray-500 mb-2">Escolhido por: ${selectedBy.join(', ')}</p>
                            ` : ''}
                            <button onclick="selectGift('${gift}', ${isAvailable})" 
                                    class="${isAvailable ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-400 cursor-not-allowed'} text-white px-3 py-1 rounded text-sm transition-colors"
                                    ${!isAvailable ? 'disabled' : ''}>
                                ${isAvailable ? 'Escolher' : 'Indispon√≠vel'}
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar lista de presentes:', error);
            }
        }
        
        // Selecionar presente
        async function selectGift(giftName, isAvailable) {
            if (!isAvailable) return;
            
            const guestName = document.getElementById('guest-name').value;
            if (!guestName) {
                showNotification('Por favor, preencha seu nome primeiro', 'error');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja escolher: ${giftName}?`)) {
                return;
            }
            
            try {
                // Verificar se o convidado j√° escolheu um presente
                const { data: existingSelection } = await supabase
                    .from('gift_selections')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .eq('guest_name', guestName)
                    .maybeSingle();
                
                if (existingSelection) {
                    if (!confirm('Voc√™ j√° escolheu um presente. Deseja alterar sua escolha?')) {
                        return;
                    }
                    
                    // Atualizar sele√ß√£o existente
                    const { error } = await supabase
                        .from('gift_selections')
                        .update({
                            gift_name: giftName,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingSelection.id);
                    
                    if (error) {
                        showNotification('Erro ao atualizar presente: ' + error.message, 'error');
                    } else {
                        showNotification('Presente alterado com sucesso!', 'success');
                        loadGiftsList(currentEvent.id);
                    }
                } else {
                    // Criar nova sele√ß√£o
                    const { error } = await supabase
                        .from('gift_selections')
                        .insert([{
                            event_id: currentEvent.id,
                            guest_name: guestName,
                            gift_name: giftName,
                            created_at: new Date().toISOString()
                        }]);
                    
                    if (error) {
                        showNotification('Erro ao selecionar presente: ' + error.message, 'error');
                    } else {
                        showNotification('Presente selecionado com sucesso!', 'success');
                        loadGiftsList(currentEvent.id);
                    }
                }
            } catch (error) {
                console.error('Erro ao selecionar presente:', error);
                showNotification('Erro inesperado ao selecionar presente', 'error');
            }
        }
        
        // Carregar informa√ß√µes de transfer√™ncia banc√°ria
        function loadBankTransferInfo(event) {
            const messageDiv = document.getElementById('bank-transfer-message');
            const ibanInput = document.getElementById('display-iban');
            const holderInput = document.getElementById('display-holder');
            const supportPhoneDisplay = document.getElementById('support-phone-display');
            
            if (event.bank_message) {
                messageDiv.innerHTML = `<p class="text-gray-700">${event.bank_message}</p>`;
            } else {
                messageDiv.innerHTML = '<p class="text-gray-700">Gostar√≠amos que nos presenteasse com uma transfer√™ncia banc√°ria. Obrigado!</p>';
            }
            
            ibanInput.value = event.bank_iban || '';
            holderInput.value = event.bank_holder || '';
            supportPhoneDisplay.textContent = event.support_phone || '';
        }
        
        // Copiar IBAN
        function copyIban() {
            const ibanInput = document.getElementById('display-iban');
            ibanInput.select();
            navigator.clipboard.writeText(ibanInput.value).then(() => {
                showNotification('IBAN copiado para a √°rea de transfer√™ncia!', 'success');
                
                // Mostrar se√ß√£o de comprovante
                const receiptSection = document.getElementById('receipt-section');
                receiptSection.classList.remove('hidden');
            });
        }
        
        // Abrir WhatsApp para envio de comprovante
        function openWhatsApp() {
            const supportPhone = document.getElementById('support-phone-display').textContent;
            if (!supportPhone) {
                showNotification('N√∫mero de telefone n√£o configurado', 'error');
                return;
            }
            
            // Remover caracteres especiais do telefone
            const cleanPhone = supportPhone.replace(/\D/g, '');
            const eventName = currentEvent.name;
            const guestName = document.getElementById('guest-name').value || 'Convidado';
            
            const message = `Ol√°! Fiz uma transfer√™ncia banc√°ria como presente para o evento "${eventName}". Meu nome √© ${guestName}. Segue o comprovante em anexo.`;
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Controlar exibi√ß√£o das configura√ß√µes
        document.addEventListener('DOMContentLoaded', function() {
            const enableGifts = document.getElementById('enable-gifts');
            const enableBankTransfer = document.getElementById('enable-bank-transfer');
            const giftsConfig = document.getElementById('gifts-config');
            const bankConfig = document.getElementById('bank-config');
            
            enableGifts.addEventListener('change', function() {
                if (this.checked) {
                    giftsConfig.classList.remove('hidden');
                    enableBankTransfer.checked = false;
                    bankConfig.classList.add('hidden');
                } else {
                    giftsConfig.classList.add('hidden');
                }
            });
            
            enableBankTransfer.addEventListener('change', function() {
                if (this.checked) {
                    bankConfig.classList.remove('hidden');
                    enableGifts.checked = false;
                    giftsConfig.classList.add('hidden');
                } else {
                    bankConfig.classList.add('hidden');
                }
            });
        });

        // Inicializar aplica√ß√£o
        window.addEventListener('DOMContentLoaded', () => {
            initializeSupabase();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97420afe727377d9',t:'MTc1NjAzMDA0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
