<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesAO - Sistema de Confirma√ß√£o de Presen√ßa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><pattern id="hearts" patternUnits="userSpaceOnUse" width="60" height="60"><circle cx="15" cy="15" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="45" cy="45" r="1.5" fill="rgba(255,255,255,0.08)"/><path d="M30 25c-3-3-8-3-8 2s5 8 8 8 8-3 8-8-5-5-8-2z" fill="rgba(255,255,255,0.06)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23hearts)"/><circle cx="200" cy="150" r="80" fill="rgba(255,255,255,0.03)"/><circle cx="800" cy="300" r="120" fill="rgba(255,255,255,0.02)"/><circle cx="1000" cy="600" r="100" fill="rgba(255,255,255,0.03)"/><circle cx="400" cy="700" r="90" fill="rgba(255,255,255,0.02)"/></svg>') center/cover;
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        body.version-noiva {
            background: 
                linear-gradient(135deg, rgba(255, 154, 158, 0.8) 0%, rgba(254, 207, 239, 0.8) 50%, rgba(254, 207, 239, 0.8) 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><pattern id="flowers" patternUnits="userSpaceOnUse" width="80" height="80"><circle cx="20" cy="20" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="60" r="2" fill="rgba(255,255,255,0.08)"/><path d="M40 30c-2-4-6-4-6 0s2 6 6 6 6-2 6-6-4-4-6 0z" fill="rgba(255,255,255,0.06)"/><path d="M35 35l5-5m0 5l-5-5" stroke="rgba(255,255,255,0.04)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23flowers)"/><circle cx="150" cy="200" r="100" fill="rgba(255,255,255,0.03)"/><circle cx="900" cy="400" r="140" fill="rgba(255,255,255,0.02)"/><circle cx="1100" cy="650" r="110" fill="rgba(255,255,255,0.03)"/><circle cx="300" cy="600" r="95" fill="rgba(255,255,255,0.02)"/></svg>') center/cover;
        }

        body.version-noiva .btn-primary {
            background: linear-gradient(135deg, #ff9a9e 0%, #f093fb 100%);
        }

        body.version-noiva .stats-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #f093fb 100%);
        }

        body.version-noiva .logo h1 {
            color: #ff6b9d;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            color: #333;
            flex: 1;
        }

        .admin-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            color: #333;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 1.6em;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .password-field {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #666;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .event-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .countdown {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 300px;
            margin: 0 auto;
        }

        .countdown-item {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .countdown-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
            line-height: 1;
        }

        .countdown-label {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .response-section {
            text-align: center;
            margin: 30px 0;
        }

        .response-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .response-btn {
            padding: 15px 30px;
            border: 2px solid #667eea;
            border-radius: 12px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .response-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .response-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .guest-form {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #e1e5e9;
        }

        .response-status {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #4caf50;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            color: white;
        }

        .response-status.negative {
            background: rgba(244, 67, 54, 0.1);
            border-color: #f44336;
        }

        .top-nav {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .back-nav {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stats-number {
            font-size: 3em;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            display: block;
        }

        .stats-label {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 500;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            color: #333;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 15px 0;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #333;
        }

        .radio-group input[type="radio"] {
            width: auto;
        }

        .companions-section {
            margin-top: 15px;
        }

        .companion-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .companion-item input {
            flex: 1;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 14px;
            margin-top: auto;
        }

        .user-management-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-info {
            flex: 1;
            min-width: 200px;
        }

        .user-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .editable-field {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
        }

        .editable-field:hover {
            background: #f0f0f0;
            border-color: #ddd;
        }

        .editable-field.editing {
            background: white;
            border-color: #667eea;
        }

        .photo-preview {
            margin-top: 15px;
            text-align: center;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            background: #f9f9f9;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .event-photo {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                min-height: calc(100vh - 20px);
            }
            
            .content-wrapper, .admin-content {
                padding: 20px;
            }
            
            .response-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .response-btn {
                padding: 12px 20px;
            }
            
            .top-nav {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
                justify-content: center;
            }
            
            .back-nav {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
            }
            
            .admin-grid {
                grid-template-columns: 1fr;
            }

            .user-management-item {
                flex-direction: column;
                align-items: stretch;
            }

            .user-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Guest Event View -->
        <div id="guestView" class="container">
            <div class="top-nav" id="topNav">
                <button class="btn btn-primary btn-small" onclick="showLogin()" id="loginBtn">Login</button>
                <button class="btn btn-secondary btn-small hidden" onclick="goToProfile()" id="profileBtn">Perfil</button>
                <button class="btn btn-secondary btn-small hidden" onclick="logout()" id="logoutBtn">Sair</button>
            </div>
            <div class="content-wrapper">
                <div class="logo">
                    <h1>üéâ InvitesAO</h1>
                </div>
                <div id="guestContent">
                    <div style="text-align: center; padding: 40px;">
                        <h2>üéâ Bem-vindo ao InvitesAO</h2>
                        <p style="margin: 20px 0; color: #666;">Sistema de confirma√ß√£o de presen√ßa para seus eventos especiais.</p>
                        <button class="btn btn-primary" onclick="showLogin()">Fazer Login</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                Copyright ¬© invitesAO 2025
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginView" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="backToMain()">‚Üê Voltar</button>
            </div>
            <div class="content-wrapper">
                <div class="logo">
                    <h1>üéâ InvitesAO</h1>
                </div>
                <div id="loginNotification"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Nome de Usu√°rio</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <div class="password-field">
                            <input type="password" id="loginPassword" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 20px;">
                        <input type="checkbox" id="rememberLogin">
                        <label for="rememberLogin">Lembrar dados</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
                <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
            </div>
            <div class="footer">
                Copyright ¬© invitesAO 2025
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerView" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="backToMain()">‚Üê Voltar</button>
            </div>
            <div class="content-wrapper">
                <div class="logo">
                    <h1>üéâ InvitesAO</h1>
                </div>
                <div id="registerNotification"></div>
                <form id="registerForm">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>Nome de Usu√°rio</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="registerPhone" placeholder="922131116" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <div class="password-field">
                            <input type="password" id="registerPassword" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('registerPassword')">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Criar Conta</button>
                </form>
                <button class="btn btn-secondary" onclick="showLogin()">J√° tenho conta</button>
            </div>
            <div class="footer">
                Copyright ¬© invitesAO 2025
            </div>
        </div>

        <!-- User Dashboard -->
        <div id="userDashboard" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="logout()">‚Üê Sair</button>
            </div>
            <div class="content-wrapper">
                <div class="logo">
                    <h1>Meus Eventos</h1>
                </div>
                <div id="userNotification"></div>
                <button class="btn btn-primary" onclick="showCreateEvent()">Criar Novo Evento</button>
                <div id="userEvents"></div>
            </div>
            <div class="footer">
                Copyright ¬© invitesAO 2025
            </div>
        </div>

        <!-- Create/Edit Event -->
        <div id="createEventView" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="showUserDashboard()">‚Üê Voltar</button>
            </div>
            <div class="content-wrapper">
                <div class="logo">
                    <h1 id="eventFormTitle">Criar Evento</h1>
                </div>
                <div id="eventNotification"></div>
                <form id="eventForm">
                    <div class="form-group">
                        <label>Nome do Evento</label>
                        <input type="text" id="eventName" required>
                    </div>
                    <div class="form-group">
                        <label>Data do Evento</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label>Data Limite para Confirma√ß√£o</label>
                        <input type="date" id="eventDeadline" required>
                    </div>
                    <div class="form-group">
                        <label>Limite de Confirma√ß√µes (0 = sem limite)</label>
                        <input type="number" id="eventLimit" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label>M√°ximo de Acompanhantes por Convidado</label>
                        <input type="number" id="maxCompanions" min="0" max="20" value="5">
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Foto dos Noivos</label>
                        <input type="file" id="eventPhoto" accept="image/*" onchange="previewPhoto(this)">
                        <div id="photoPreview" class="photo-preview hidden">
                            <img id="previewImage" src="" alt="Preview da foto">
                            <button type="button" class="btn btn-small btn-danger" onclick="removePhoto()">Remover Foto</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Vers√£o do Site</label>
                        <select id="siteVersion">
                            <option value="noivos">ü§µ Vers√£o dos Noivos (Azul/Roxo)</option>
                            <option value="noiva">üíê Vers√£o da Noiva (Rosa)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Evento</button>
                </form>
            </div>
            <div class="footer">
                Copyright ¬© invitesAO 2025
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="admin-container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="logout()">‚Üê Sair</button>
            </div>
            <div class="admin-header">
                <h1>üîß Painel Administrativo</h1>
            </div>
            <div id="adminNotification"></div>
            
            <div class="admin-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalUsers">0</div>
                    <div class="stats-label">üë• Usu√°rios Totais</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="pendingUsers">0</div>
                    <div class="stats-label">‚è≥ Aguardando Aprova√ß√£o</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalEvents">0</div>
                    <div class="stats-label">üéâ Eventos Criados</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalResponses">0</div>
                    <div class="stats-label">üìù Confirma√ß√µes</div>
                </div>
            </div>

            <div class="admin-content">
                <h3>‚è≥ Solicita√ß√µes Pendentes</h3>
                <div id="pendingRequests"></div>
            </div>

            <div class="admin-content" id="fullAdminSection">
                <h3>üë• Gerenciar Usu√°rios</h3>
                <div id="userManagement"></div>
            </div>

            <div class="admin-content" id="eventsSection">
                <h3>üéâ Todos os Eventos</h3>
                <div id="allEvents"></div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div id="editUserModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>‚úèÔ∏è Editar Usu√°rio</h3>
                <form id="editUserForm">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="editUserName" required>
                    </div>
                    <div class="form-group">
                        <label>Nome de Usu√°rio</label>
                        <input type="text" id="editUserUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="editUserPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Nova Senha (deixe vazio para manter atual)</label>
                        <div class="password-field">
                            <input type="password" id="editUserPassword">
                            <button type="button" class="password-toggle" onclick="togglePassword('editUserPassword')">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-success">Salvar</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="passwordModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>üîê Confirma√ß√£o de Seguran√ßa</h3>
                <p id="modalMessage">Para continuar, digite sua senha:</p>
                <div class="form-group">
                    <label>Sua Senha</label>
                    <div class="password-field">
                        <input type="password" id="modalPassword">
                        <button type="button" class="password-toggle" onclick="togglePassword('modalPassword')">üëÅÔ∏è</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="confirmPasswordAction()">Confirmar</button>
                    <button class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://jqdrxvnnbkeepdnrzndv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxZHJ4dm5uYmtlZXBkbnJ6bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDk5NTAsImV4cCI6MjA3MTU4NTk1MH0.k0sGvCvzZra3up5RTlJqFDu8FleeYvBr8EGqf5q-G3Q';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global Variables
        let currentUser = null;
        let currentEvent = null;
        let editingEventId = null;
        let editingUserId = null;
        let currentAttending = null;
        let pendingAction = null;
        let eventPhotoBase64 = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSavedLogin();
            await loadEventFromUrl();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
            document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
        }

        // Check Saved Login with persistent session
        async function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            const savedCredentials = localStorage.getItem('savedCredentials');
            
            if (savedCredentials) {
                try {
                    const credentials = JSON.parse(savedCredentials);
                    document.getElementById('loginUsername').value = credentials.username || '';
                    document.getElementById('loginPassword').value = credentials.password || '';
                    document.getElementById('rememberLogin').checked = true;
                } catch (error) {
                    localStorage.removeItem('savedCredentials');
                }
            }
            
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (user.isAdmin) {
                        currentUser = user;
                        return;
                    }
                    
                    // Verify user still exists and is active
                    const { data: dbUser } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (dbUser && dbUser.approved && dbUser.active) {
                        currentUser = dbUser;
                        localStorage.setItem('currentUser', JSON.stringify(dbUser));
                        
                        // Auto-navigate to appropriate dashboard
                        if (!window.location.search.includes('event=')) {
                            if (dbUser.is_moderator) {
                                showAdminDashboard();
                            } else {
                                showUserDashboard();
                            }
                        }
                    } else {
                        localStorage.removeItem('currentUser');
                    }
                } catch (error) {
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // Password toggle function
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const toggle = field.nextElementSibling;
            
            if (field.type === 'password') {
                field.type = 'text';
                toggle.textContent = 'üôà';
            } else {
                field.type = 'password';
                toggle.textContent = 'üëÅÔ∏è';
            }
        }

        // Load Event from URL
        async function loadEventFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');
            const version = urlParams.get('version');
            
            if (version === 'noiva') {
                document.body.classList.add('version-noiva');
            }
            
            if (eventId) {
                await loadGuestEvent(eventId);
            } else {
                updateTopNav();
            }
        }

        // Load Guest Event
        async function loadGuestEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                if (event.active === false) {
                    document.getElementById('guestContent').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2>‚ö†Ô∏è Evento Inativo</h2>
                            <p style="color: #666;">Este evento foi temporariamente desativado.</p>
                        </div>
                    `;
                    return;
                }

                currentEvent = event;
                
                if (event.site_version === 'noiva') {
                    document.body.classList.add('version-noiva');
                }
                
                await renderGuestEvent(event);
                updateTopNav();
            } catch (error) {
                document.getElementById('guestContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>‚ùå Evento n√£o encontrado</h2>
                        <p style="color: #666;">O link pode estar incorreto ou o evento foi removido.</p>
                    </div>
                `;
            }
        }

        // Render Guest Event
        async function renderGuestEvent(event) {
            const now = new Date();
            const eventDate = new Date(event.event_date);
            const deadline = new Date(event.deadline);
            
            const guestResponse = await getGuestResponse(event.id);
            let responseSection = '';

            if (guestResponse) {
                const statusClass = guestResponse.attending ? '' : 'negative';
                const statusText = guestResponse.attending ? '‚úÖ Presen√ßa confirmada!' : '‚ùå Voc√™ informou que n√£o comparecer√°';
                
                let companionInfo = '';
                if (guestResponse.attending && guestResponse.companions > 0) {
                    companionInfo = `<p><strong>Acompanhantes:</strong> ${guestResponse.companions}</p>`;
                    if (guestResponse.companion_names && guestResponse.companion_names.length > 0) {
                        companionInfo += `<p><strong>Nomes:</strong> ${guestResponse.companion_names.join(', ')}</p>`;
                    }
                }
                
                responseSection = `
                    <div class="response-status ${statusClass}" id="responseStatus">
                        <h3>${statusText}</h3>
                        <p><strong>Nome:</strong> ${guestResponse.guest_name}</p>
                        ${companionInfo}
                        <p style="margin-top: 15px;">Obrigado pela confirma√ß√£o!</p>
                    </div>
                `;
                
                // Auto-hide after 5 minutes
                setTimeout(() => {
                    const statusElement = document.getElementById('responseStatus');
                    if (statusElement) {
                        statusElement.style.transition = 'opacity 1s ease-out';
                        statusElement.style.opacity = '0';
                        setTimeout(() => {
                            if (statusElement.parentNode) {
                                statusElement.remove();
                            }
                        }, 1000);
                    }
                }, 300000); // 5 minutes
                
            } else if (now <= deadline) {
                responseSection = `
                    <div class="guest-form">
                        <div class="response-section">
                            <h3 style="color: #333;">Confirma Presen√ßa?</h3>
                            <p style="margin-bottom: 20px; color: #555;">Favor confirmar at√© ${formatDate(deadline)}</p>
                            <div class="response-buttons">
                                <button class="response-btn" onclick="selectAttendance(true, this)">SIM</button>
                                <button class="response-btn" onclick="selectAttendance(false, this)">N√ÉO</button>
                            </div>
                        </div>
                        <div id="guestDetailsForm" class="hidden">
                            <div class="form-group">
                                <label style="color: #333;">Voc√™ √© convidado(a) do(a):</label>
                                <div class="radio-group">
                                    <label style="color: #333;">
                                        <input type="radio" name="guestType" value="noivo">
                                        <span>Noivo</span>
                                    </label>
                                    <label style="color: #333;">
                                        <input type="radio" name="guestType" value="noiva">
                                        <span>Noiva</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="color: #333;">Seu nome completo</label>
                                <input type="text" id="guestName" required>
                            </div>
                            <div id="companionsSection" class="companions-section hidden">
                                <div class="form-group">
                                    <label style="color: #333;">Acompanhantes</label>
                                    <div id="companionsList"></div>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="addCompanion()">+ Adicionar Acompanhante</button>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="submitResponse()">Confirmar</button>
                        </div>
                    </div>
                `;
            } else {
                responseSection = `
                    <div class="notification error">
                        <h3>Prazo Expirado</h3>
                        <p>O prazo para confirma√ß√£o de presen√ßa j√° expirou.</p>
                    </div>
                `;
            }

            document.getElementById('guestContent').innerHTML = `
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">${event.name}</h2>
                ${event.photo ? `<img src="${event.photo}" alt="Foto dos Noivos" class="event-photo">` : ''}
                <div style="text-align: center; margin-bottom: 20px; color: #333;">
                    <strong>Data: ${formatDate(eventDate)}</strong>
                </div>
                ${event.description ? `<p style="margin-bottom: 20px; text-align: center; color: #555;">${event.description}</p>` : ''}
                
                <div class="countdown" id="countdown"></div>
                
                ${responseSection}
            `;

            startCountdown(eventDate);
        }

        // Start Countdown
        function startCountdown(eventDate) {
            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) return;

            function updateCountdown() {
                const now = new Date().getTime();
                const eventTime = eventDate.getTime();
                const distance = eventTime - now;

                if (distance < 0) {
                    countdownElement.innerHTML = '<h3>üéâ O evento j√° come√ßou!</h3>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `
                    <div class="countdown-grid">
                        <div class="countdown-item">
                            <span class="countdown-number">${days}</span>
                            <span class="countdown-label">dias</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${hours}</span>
                            <span class="countdown-label">horas</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${minutes}</span>
                            <span class="countdown-label">min</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${seconds}</span>
                            <span class="countdown-label">seg</span>
                        </div>
                    </div>
                `;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // Select Attendance
        function selectAttendance(attending, buttonElement) {
            currentAttending = attending;
            
            // Update button styles
            document.querySelectorAll('.response-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            buttonElement.classList.add('selected');
            
            const detailsForm = document.getElementById('guestDetailsForm');
            const companionsSection = document.getElementById('companionsSection');
            
            detailsForm.classList.remove('hidden');
            
            if (attending && currentEvent.max_companions > 0) {
                companionsSection.classList.remove('hidden');
            } else {
                companionsSection.classList.add('hidden');
            }
        }

        // Add Companion
        function addCompanion() {
            const companionsList = document.getElementById('companionsList');
            const currentCompanions = companionsList.children.length;
            
            if (currentCompanions >= currentEvent.max_companions) {
                showNotification(`M√°ximo de ${currentEvent.max_companions} acompanhante(s) permitido.`, 'error');
                return;
            }
            
            const companionDiv = document.createElement('div');
            companionDiv.className = 'companion-item';
            companionDiv.innerHTML = `
                <input type="text" placeholder="Nome do acompanhante" class="companion-input">
                <button type="button" class="btn btn-small btn-danger" onclick="removeCompanion(this)">Remover</button>
            `;
            
            companionsList.appendChild(companionDiv);
        }

        // Remove Companion
        function removeCompanion(button) {
            button.parentElement.remove();
        }

        // Submit Response
        async function submitResponse() {
            const guestName = document.getElementById('guestName').value.trim();
            const guestTypeRadio = document.querySelector('input[name="guestType"]:checked');

            if (!guestName) {
                showNotification('Por favor, informe seu nome.', 'error');
                return;
            }

            if (!guestTypeRadio) {
                showNotification('Por favor, selecione se voc√™ √© convidado do noivo ou da noiva.', 'error');
                return;
            }

            const guestType = guestTypeRadio.value;
            let companions = 0;
            let companionNames = [];

            if (currentAttending && currentEvent.max_companions > 0) {
                const companionInputs = document.querySelectorAll('.companion-input');
                companionInputs.forEach(input => {
                    if (input.value && input.value.trim()) {
                        companionNames.push(input.value.trim());
                    }
                });
                companions = companionNames.length;
            }

            try {
                const responseData = {
                    event_id: currentEvent.id,
                    guest_name: guestName,
                    guest_type: guestType,
                    attending: currentAttending,
                    companions: companions,
                    companion_names: companionNames,
                    created_at: new Date().toISOString()
                };

                const { data: existingResponse } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .eq('guest_name', guestName)
                    .single();

                if (existingResponse) {
                    const { error } = await supabase
                        .from('responses')
                        .update(responseData)
                        .eq('event_id', currentEvent.id)
                        .eq('guest_name', guestName);
                    
                    if (error) throw error;
                    showNotification('Resposta atualizada com sucesso!', 'success');
                } else {
                    const { error } = await supabase
                        .from('responses')
                        .insert([responseData]);
                    
                    if (error) throw error;
                    
                    const message = currentAttending 
                        ? 'Presen√ßa confirmada, obrigado!'
                        : 'Resposta enviada, obrigado!';
                    showNotification(message, 'success');
                }

                const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
                responses[currentEvent.id] = responseData;
                localStorage.setItem('eventResponses', JSON.stringify(responses));

                setTimeout(async () => {
                    await renderGuestEvent(currentEvent);
                }, 2000);
            } catch (error) {
                showNotification('Erro ao salvar resposta: ' + error.message, 'error');
            }
        }

        // Get Guest Response
        async function getGuestResponse(eventId) {
            const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
            const localResponse = responses[eventId];
            
            if (localResponse) {
                try {
                    const { data: dbResponse } = await supabase
                        .from('responses')
                        .select('*')
                        .eq('event_id', eventId)
                        .eq('guest_name', localResponse.guest_name)
                        .single();
                    
                    if (dbResponse) {
                        return localResponse;
                    } else {
                        delete responses[eventId];
                        localStorage.setItem('eventResponses', JSON.stringify(responses));
                        return null;
                    }
                } catch (error) {
                    delete responses[eventId];
                    localStorage.setItem('eventResponses', JSON.stringify(responses));
                    return null;
                }
            }
            
            return null;
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const rememberLogin = document.getElementById('rememberLogin').checked;

            if (rememberLogin) {
                localStorage.setItem('savedCredentials', JSON.stringify({
                    username: username,
                    password: password
                }));
            } else {
                localStorage.removeItem('savedCredentials');
            }

            if (username === 'Invites' && password === '#Invites2025@!!1995') {
                currentUser = { id: 'admin', username: 'Invites', isAdmin: true };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showAdminDashboard();
                return;
            }

            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error || !user) {
                    showNotification('Nome de usu√°rio ou senha incorretos.', 'error', 'loginNotification');
                    return;
                }

                if (!user.approved) {
                    showNotification('Sua conta ainda n√£o foi aprovada pelo administrador.', 'error', 'loginNotification');
                    return;
                }

                if (!user.active) {
                    showNotification('Sua conta foi desativada.', 'error', 'loginNotification');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                if (user.is_moderator) {
                    showAdminDashboard();
                } else {
                    showUserDashboard();
                }
            } catch (error) {
                showNotification('Erro ao fazer login: ' + error.message, 'error', 'loginNotification');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value.trim();

            try {
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (existingUser) {
                    showNotification('Nome de usu√°rio j√° existe.', 'error', 'registerNotification');
                    return;
                }

                const { error } = await supabase
                    .from('users')
                    .insert([{
                        name,
                        username,
                        phone,
                        password,
                        approved: false,
                        active: true
                    }]);

                if (error) throw error;

                showNotification('Conta criada! Aguarde aprova√ß√£o do administrador.', 'success', 'registerNotification');
                setTimeout(() => {
                    document.getElementById('registerForm').reset();
                    showLogin();
                }, 3000);
            } catch (error) {
                showNotification('Erro ao criar conta: ' + error.message, 'error', 'registerNotification');
            }
        }

        // User Dashboard Functions
        async function showUserDashboard() {
            hideAllViews();
            document.getElementById('userDashboard').classList.remove('hidden');
            
            // Verificar se admin est√° logado como usu√°rio
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                const backToAdminBtn = document.createElement('button');
                backToAdminBtn.className = 'btn btn-secondary btn-small';
                backToAdminBtn.textContent = '‚Üê Voltar ao Admin';
                backToAdminBtn.onclick = returnToAdmin;
                backToAdminBtn.style.position = 'absolute';
                backToAdminBtn.style.top = '20px';
                backToAdminBtn.style.right = '20px';
                backToAdminBtn.style.zIndex = '1000';
                
                // Remover bot√£o existente se houver
                const existingBtn = document.querySelector('.return-to-admin-btn');
                if (existingBtn) existingBtn.remove();
                
                backToAdminBtn.classList.add('return-to-admin-btn');
                document.body.appendChild(backToAdminBtn);
            }
            
            await loadUserEvents();
        }

        function returnToAdmin() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                currentUser = JSON.parse(adminUser);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.removeItem('adminUser');
                
                // Remover bot√£o
                const btn = document.querySelector('.return-to-admin-btn');
                if (btn) btn.remove();
                
                showAdminDashboard();
            }
        }

        async function loadUserEvents() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select(`
                        *,
                        responses(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const eventsHtml = events.map(event => {
                    const responseCount = event.responses?.length || 0;
                    const confirmedCount = event.responses?.filter(r => r.attending).length || 0;
                    const eventUrl = `${window.location.origin}${window.location.pathname}?event=${event.id}`;
                    const statusText = event.active !== false ? 'Ativo' : 'Inativo';
                    const statusClass = event.active !== false ? 'success' : 'danger';
                    
                    return `
                        <div class="event-card">
                            <h3>${event.name} <span class="btn btn-small btn-${statusClass}" style="font-size: 10px; padding: 2px 8px;">${statusText}</span></h3>
                            <p><strong>Data:</strong> ${formatDate(new Date(event.event_date))}</p>
                            <p><strong>Confirma√ß√µes:</strong> ${confirmedCount}/${event.event_limit === 0 ? '‚àû' : event.event_limit}</p>
                            <p><strong>Total de respostas:</strong> ${responseCount}</p>
                            <div style="margin: 10px 0;">
                                <p><strong>Link:</strong></p>
                                <small><a href="${eventUrl}" target="_blank" style="word-break: break-all;">${eventUrl}</a></small>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-small btn-secondary" onclick="editEvent('${event.id}')">Editar</button>
                                <button class="btn btn-small btn-primary" onclick="viewResponses('${event.id}')">Respostas</button>
                                <button class="btn btn-small btn-success" onclick="downloadReport('${event.id}')">PDF</button>
                                <button class="btn btn-small ${event.active !== false ? 'btn-danger' : 'btn-success'}" onclick="toggleEventStatus('${event.id}', ${event.active === false})">${event.active !== false ? 'Desativar' : 'Ativar'}</button>
                                <button class="btn btn-small btn-danger" onclick="deleteEventWithPassword('${event.id}')">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('userEvents').innerHTML = eventsHtml || '<p>Nenhum evento criado ainda.</p>';
            } catch (error) {
                showNotification('Erro ao carregar eventos: ' + error.message, 'error', 'userNotification');
            }
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const eventDate = document.getElementById('eventDate').value;
            const deadlineDate = document.getElementById('eventDeadline').value;

            if (!eventDate || !deadlineDate) {
                showNotification('Datas s√£o obrigat√≥rias!', 'error', 'eventNotification');
                return;
            }

            const eventData = {
                name: document.getElementById('eventName').value,
                event_date: eventDate,
                deadline: deadlineDate,
                event_limit: parseInt(document.getElementById('eventLimit').value),
                max_companions: parseInt(document.getElementById('maxCompanions').value),
                description: document.getElementById('eventDescription').value,
                site_version: document.getElementById('siteVersion').value,
                photo: eventPhotoBase64,
                user_id: currentUser.id
            };

            try {
                if (editingEventId) {
                    const { error } = await supabase
                        .from('events')
                        .update(eventData)
                        .eq('id', editingEventId);
                    
                    if (error) throw error;
                    showNotification('Evento atualizado!', 'success', 'eventNotification');
                } else {
                    const { error } = await supabase
                        .from('events')
                        .insert([eventData]);
                    
                    if (error) throw error;
                    showNotification('Evento criado!', 'success', 'eventNotification');
                }

                setTimeout(() => {
                    showUserDashboard();
                    editingEventId = null;
                }, 2000);
            } catch (error) {
                showNotification('Erro ao salvar evento: ' + error.message, 'error', 'eventNotification');
            }
        }

        async function editEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                editingEventId = eventId;
                document.getElementById('eventFormTitle').textContent = 'Editar Evento';
                document.getElementById('eventName').value = event.name;
                
                const eventDate = new Date(event.event_date);
                document.getElementById('eventDate').value = eventDate.toISOString().split('T')[0];

                const deadlineDate = new Date(event.deadline);
                document.getElementById('eventDeadline').value = deadlineDate.toISOString().split('T')[0];

                document.getElementById('eventLimit').value = event.event_limit;
                document.getElementById('maxCompanions').value = event.max_companions || 5;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('siteVersion').value = event.site_version || 'noivos';
                
                // Carregar foto se existir
                if (event.photo) {
                    eventPhotoBase64 = event.photo;
                    document.getElementById('previewImage').src = event.photo;
                    document.getElementById('photoPreview').classList.remove('hidden');
                } else {
                    removePhoto();
                }
                
                showCreateEvent();
            } catch (error) {
                showNotification('Erro ao carregar evento: ' + error.message, 'error', 'userNotification');
            }
        }

        async function toggleEventStatus(eventId, activate) {
            try {
                const { error } = await supabase
                    .from('events')
                    .update({ active: activate })
                    .eq('id', eventId);

                if (error) throw error;

                showNotification(`Evento ${activate ? 'ativado' : 'desativado'}!`, 'success', 'userNotification');
                await loadUserEvents();
            } catch (error) {
                showNotification('Erro ao alterar status: ' + error.message, 'error', 'userNotification');
            }
        }

        function deleteEventWithPassword(eventId) {
            showPasswordModal(
                'Para excluir este evento, digite sua senha:',
                async () => await deleteEvent(eventId)
            );
        }

        async function deleteEvent(eventId) {
            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                showNotification('Evento exclu√≠do!', 'success', 'userNotification');
                await loadUserEvents();
            } catch (error) {
                showNotification('Erro ao excluir: ' + error.message, 'error', 'userNotification');
            }
        }

        async function viewResponses(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);

                let html = `
                    <div class="event-card">
                        <h3>üìä ${event.name} - Respostas</h3>
                        <p><strong>Confirmados:</strong> ${attending.length} + ${totalCompanions} acompanhantes = ${attending.length + totalCompanions} total</p>
                        <p><strong>N√£o comparecer√£o:</strong> ${notAttending.length}</p>
                        
                        <h4 style="margin-top: 20px; color: #28a745;">‚úÖ Confirmados</h4>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            ${attending.map(r => `
                                <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${r.guest_name}</strong>
                                        <span style="margin-left: 10px; padding: 2px 6px; border-radius: 10px; font-size: 10px; background: ${r.guest_type === 'noivo' ? '#667eea' : '#ff9a9e'}; color: white;">
                                            ${r.guest_type === 'noivo' ? 'ü§µ' : 'üë∞'}
                                        </span>
                                        ${r.companions > 0 ? `<br><small>+ ${r.companions} acompanhante(s)</small>` : ''}
                                        ${r.companion_names && r.companion_names.length > 0 ? `<br><small>Nomes: ${r.companion_names.join(', ')}</small>` : ''}
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="deleteResponseWithPassword('${eventId}', '${r.guest_name}')">üóëÔ∏è</button>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center;">Nenhuma confirma√ß√£o.</p>'}
                        </div>
                        
                        <h4 style="margin-top: 20px; color: #dc3545;">‚ùå N√£o Comparecer√£o</h4>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            ${notAttending.map(r => `
                                <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${r.guest_name}</strong>
                                        <span style="margin-left: 10px; padding: 2px 6px; border-radius: 10px; font-size: 10px; background: ${r.guest_type === 'noivo' ? '#667eea' : '#ff9a9e'}; color: white;">
                                            ${r.guest_type === 'noivo' ? 'ü§µ' : 'üë∞'}
                                        </span>
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="deleteResponseWithPassword('${eventId}', '${r.guest_name}')">üóëÔ∏è</button>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center;">Nenhuma resposta negativa.</p>'}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success btn-small" onclick="downloadReport('${eventId}')">Baixar PDF</button>
                            <button class="btn btn-secondary btn-small" onclick="showUserDashboard()">Voltar</button>
                        </div>
                    </div>
                `;

                document.getElementById('userEvents').innerHTML = html;
            } catch (error) {
                showNotification('Erro ao carregar respostas: ' + error.message, 'error', 'userNotification');
            }
        }

        function deleteResponseWithPassword(eventId, guestName) {
            showPasswordModal(
                `Para eliminar a resposta de ${guestName}, digite sua senha:`,
                async () => await deleteResponse(eventId, guestName)
            );
        }

        async function deleteResponse(eventId, guestName) {
            try {
                const { error } = await supabase
                    .from('responses')
                    .delete()
                    .eq('event_id', eventId)
                    .eq('guest_name', guestName);

                if (error) throw error;

                const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
                if (responses[eventId] && responses[eventId].guest_name === guestName) {
                    delete responses[eventId];
                    localStorage.setItem('eventResponses', JSON.stringify(responses));
                }

                showNotification(`Resposta eliminada!`, 'success', 'userNotification');
                await viewResponses(eventId);
            } catch (error) {
                showNotification('Erro ao eliminar: ' + error.message, 'error', 'userNotification');
            }
        }

        async function downloadReport(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error: responsesError } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('guest_name', { ascending: true });

                if (responsesError) throw responsesError;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                
                // Separar por tipo de convidado
                const attendingNoivo = attending.filter(r => r.guest_type === 'noivo');
                const attendingNoiva = attending.filter(r => r.guest_type === 'noiva');
                const notAttendingNoivo = notAttending.filter(r => r.guest_type === 'noivo');
                const notAttendingNoiva = notAttending.filter(r => r.guest_type === 'noiva');
                
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);
                const totalCompanionsNoivo = attendingNoivo.reduce((sum, r) => sum + (r.companions || 0), 0);
                const totalCompanionsNoiva = attendingNoiva.reduce((sum, r) => sum + (r.companions || 0), 0);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('RELATORIO DO EVENTO', 105, 25, { align: 'center' });

                // Event details
                doc.setFontSize(14);
                doc.text(event.name, 105, 40, { align: 'center' });

                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Data do Evento: ${formatDate(new Date(event.event_date))}`, 105, 55, { align: 'center' });

                // Summary
                doc.setFontSize(10);
                doc.text(`Total Confirmados: ${attending.length} pessoas + ${totalCompanions} acompanhantes = ${attending.length + totalCompanions} total`, 20, 70);
                doc.text(`Total que nao comparecerao: ${notAttending.length} pessoas`, 20, 80);

                let yPos = 100;

                // Function to add guest list
                const addGuestList = (guests, title, isNoivo = true) => {
                    if (guests.length === 0) return yPos;
                    
                    // Check if we need a new page
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, 20, yPos);
                    yPos += 10;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');

                    guests.forEach((response, index) => {
                        // Check if we need a new page (leaving space for companion names)
                        const spaceNeeded = response.companion_names && response.companion_names.length > 0 ? 15 : 10;
                        if (yPos + spaceNeeded > 280) {
                            doc.addPage();
                            yPos = 30;
                        }

                        const guestLine = `${index + 1}. ${response.guest_name}`;
                        doc.text(guestLine, 25, yPos);
                        
                        if (response.companions > 0) {
                            doc.text(`+ ${response.companions} acompanhante(s)`, 130, yPos);
                            
                            if (response.companion_names && response.companion_names.length > 0) {
                                yPos += 8;
                                const companionText = `Nomes: ${response.companion_names.join(', ')}`;
                                // Split long companion names if needed
                                const maxWidth = 160;
                                const lines = doc.splitTextToSize(companionText, maxWidth);
                                lines.forEach((line, lineIndex) => {
                                    doc.text(line, 30, yPos + (lineIndex * 6));
                                });
                                yPos += (lines.length - 1) * 6;
                            }
                        }
                        yPos += 10;
                    });

                    return yPos + 10;
                };

                // Confirmed attendees - Noivo
                if (attendingNoivo.length > 0) {
                    yPos = addGuestList(attendingNoivo, `ü§µ CONVIDADOS DO NOIVO CONFIRMADOS (${attendingNoivo.length} + ${totalCompanionsNoivo} acompanhantes):`);
                }

                // Confirmed attendees - Noiva
                if (attendingNoiva.length > 0) {
                    yPos = addGuestList(attendingNoiva, `üë∞ CONVIDADOS DA NOIVA CONFIRMADOS (${attendingNoiva.length} + ${totalCompanionsNoiva} acompanhantes):`);
                }

                // Not attending - Noivo
                if (notAttendingNoivo.length > 0) {
                    yPos = addGuestList(notAttendingNoivo, `ü§µ CONVIDADOS DO NOIVO QUE NAO COMPARECERAO (${notAttendingNoivo.length}):`);
                }

                // Not attending - Noiva
                if (notAttendingNoiva.length > 0) {
                    yPos = addGuestList(notAttendingNoiva, `üë∞ CONVIDADOS DA NOIVA QUE NAO COMPARECERAO (${notAttendingNoiva.length}):`);
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Pagina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')} as ${new Date().toLocaleTimeString('pt-BR')}`, 105, 295, { align: 'center' });
                }

                doc.save(`${event.name}_relatorio.pdf`);
            } catch (error) {
                showNotification('Erro ao gerar PDF: ' + error.message, 'error', 'userNotification');
            }
        }

        // Admin Dashboard Functions
        async function showAdminDashboard() {
            hideAllViews();
            document.getElementById('adminDashboard').classList.remove('hidden');
            
            // Show/hide sections based on user type
            if (currentUser.isAdmin) {
                document.getElementById('fullAdminSection').style.display = 'block';
                document.getElementById('eventsSection').style.display = 'block';
            } else {
                document.getElementById('fullAdminSection').style.display = 'none';
                document.getElementById('eventsSection').style.display = 'none';
            }
            
            await loadAdminData();
        }

        async function loadAdminData() {
            try {
                const { data: users } = await supabase.from('users').select('*');
                const { data: events } = await supabase.from('events').select('*');
                const { data: responses } = await supabase.from('responses').select('*');

                const pendingUsers = users?.filter(u => !u.approved) || [];
                const approvedUsers = users?.filter(u => u.approved) || [];

                document.getElementById('totalUsers').textContent = users?.length || 0;
                document.getElementById('pendingUsers').textContent = pendingUsers.length;
                document.getElementById('totalEvents').textContent = events?.length || 0;
                document.getElementById('totalResponses').textContent = responses?.length || 0;

                // Pending requests
                const pendingHtml = pendingUsers.map(user => `
                    <div class="user-management-item">
                        <div class="user-info">
                            <strong>${user.name}</strong><br>
                            <small>@${user.username} ‚Ä¢ ${user.phone}</small>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-small btn-success" onclick="approveUser('${user.id}')">Aprovar</button>
                            <button class="btn btn-small btn-danger" onclick="rejectUser('${user.id}')">Rejeitar</button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('pendingRequests').innerHTML = pendingHtml || '<p>Nenhuma solicita√ß√£o pendente.</p>';

                // User management (only for full admin)
                if (currentUser.isAdmin) {
                    const usersHtml = approvedUsers.map(user => `
                        <div class="user-management-item">
                            <div class="user-info">
                                <strong class="editable-field" onclick="editUserField('${user.id}', 'name', this)">${user.name}</strong><br>
                                <small>
                                    @<span class="editable-field" onclick="editUserField('${user.id}', 'username', this)">${user.username}</span> ‚Ä¢ 
                                    <span class="editable-field" onclick="editUserField('${user.id}', 'phone', this)">${user.phone}</span>
                                </small><br>
                                <small>Senha: <span class="editable-field" onclick="editUserField('${user.id}', 'password', this)" style="font-family: monospace;">${user.password}</span></small>
                                ${user.is_moderator ? '<br><span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">MODERADOR</span>' : ''}
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-small ${user.active ? 'btn-danger' : 'btn-success'}" onclick="toggleUserStatus('${user.id}', ${!user.active})">${user.active ? 'Desativar' : 'Ativar'}</button>
                                ${currentUser.isAdmin ? (!user.is_moderator ? `<button class="btn btn-small btn-primary" onclick="toggleModerator('${user.id}', true)">Tornar Moderador</button>` : `<button class="btn btn-small btn-secondary" onclick="toggleModerator('${user.id}', false)">Remover Moderador</button>`) : ''}
                                <button class="btn btn-small btn-secondary" onclick="showEditUserModal('${user.id}')">Editar</button>
                                ${currentUser.isAdmin ? `<button class="btn btn-small" style="background: #28a745; color: white;" onclick="loginAsUser('${user.id}')">Entrar Como</button>` : ''}
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('userManagement').innerHTML = usersHtml || '<p>Nenhum usu√°rio aprovado.</p>';

                    // All events
                    const eventsHtml = events?.map(event => `
                        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>${event.name}</strong><br>
                            <small>Data: ${formatDate(new Date(event.event_date))} ‚Ä¢ Criado por: ${users?.find(u => u.id === event.user_id)?.name || 'Usu√°rio removido'}</small><br>
                            <small>Status: ${event.active !== false ? 'Ativo' : 'Inativo'}</small>
                        </div>
                    `).join('') || '<p>Nenhum evento criado.</p>';

                    document.getElementById('allEvents').innerHTML = eventsHtml;
                }
            } catch (error) {
                showNotification('Erro ao carregar dados: ' + error.message, 'error', 'adminNotification');
            }
        }

        // Edit User Functions
        function editUserField(userId, field, element) {
            if (!currentUser.isAdmin) return;
            
            const currentValue = element.textContent;
            const input = document.createElement('input');
            input.type = field === 'password' ? 'password' : 'text';
            input.value = currentValue;
            input.className = 'editable-field editing';
            input.style.width = '100%';
            
            element.replaceWith(input);
            input.focus();
            input.select();
            
            const saveEdit = async () => {
                const newValue = input.value.trim();
                if (newValue && newValue !== currentValue) {
                    try {
                        const { error } = await supabase
                            .from('users')
                            .update({ [field]: newValue })
                            .eq('id', userId);
                        
                        if (error) throw error;
                        
                        element.textContent = newValue;
                        showNotification('Campo atualizado!', 'success', 'adminNotification');
                    } catch (error) {
                        showNotification('Erro ao atualizar: ' + error.message, 'error', 'adminNotification');
                        element.textContent = currentValue;
                    }
                } else {
                    element.textContent = currentValue;
                }
                input.replaceWith(element);
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                }
                if (e.key === 'Escape') {
                    element.textContent = currentValue;
                    input.replaceWith(element);
                }
            });
        }

        function showEditUserModal(userId) {
            supabase.from('users').select('*').eq('id', userId).single()
                .then(({ data: user }) => {
                    if (user) {
                        editingUserId = userId;
                        document.getElementById('editUserName').value = user.name;
                        document.getElementById('editUserUsername').value = user.username;
                        document.getElementById('editUserPhone').value = user.phone;
                        document.getElementById('editUserPassword').value = '';
                        document.getElementById('editUserModal').classList.remove('hidden');
                    }
                });
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            editingUserId = null;
        }

        async function handleEditUser(e) {
            e.preventDefault();
            
            const updateData = {
                name: document.getElementById('editUserName').value.trim(),
                username: document.getElementById('editUserUsername').value.trim(),
                phone: document.getElementById('editUserPhone').value.trim()
            };

            const newPassword = document.getElementById('editUserPassword').value.trim();
            if (newPassword) {
                updateData.password = newPassword;
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', editingUserId);

                if (error) throw error;

                showNotification('Usu√°rio atualizado!', 'success', 'adminNotification');
                closeEditUserModal();
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao atualizar usu√°rio: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ approved: true })
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usu√°rio aprovado!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao aprovar: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function rejectUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usu√°rio rejeitado!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao rejeitar: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function toggleUserStatus(userId, activate) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ active: activate })
                    .eq('id', userId);

                if (error) throw error;

                showNotification(`Usu√°rio ${activate ? 'ativado' : 'desativado'}!`, 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao alterar status: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function toggleModerator(userId, makeModerator) {
            if (!currentUser.isAdmin) {
                showNotification('Apenas o administrador principal pode gerenciar moderadores.', 'error', 'adminNotification');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ is_moderator: makeModerator })
                    .eq('id', userId);

                if (error) throw error;

                showNotification(`${makeModerator ? 'Moderador adicionado' : 'Moderador removido'}!`, 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao alterar moderador: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function loginAsUser(userId) {
            if (!currentUser.isAdmin) {
                showNotification('Acesso negado.', 'error', 'adminNotification');
                return;
            }
            
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                if (!user.approved || !user.active) {
                    showNotification('Usu√°rio inativo ou n√£o aprovado.', 'error', 'adminNotification');
                    return;
                }

                // Salvar admin atual para poder voltar
                localStorage.setItem('adminUser', JSON.stringify(currentUser));
                
                // Fazer login como o usu√°rio
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showNotification(`Entrando como ${user.name}...`, 'success', 'adminNotification');
                
                setTimeout(() => {
                    if (user.is_moderator) {
                        showAdminDashboard();
                    } else {
                        showUserDashboard();
                    }
                }, 1500);
            } catch (error) {
                showNotification('Erro ao entrar como usu√°rio: ' + error.message, 'error', 'adminNotification');
            }
        }

        // Password Modal Functions
        function showPasswordModal(message, action) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalPassword').value = '';
            document.getElementById('passwordModal').classList.remove('hidden');
            pendingAction = action;
            document.getElementById('modalPassword').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            pendingAction = null;
        }

        async function confirmPasswordAction() {
            const password = document.getElementById('modalPassword').value;
            
            if (!password) {
                showNotification('Digite sua senha.', 'error', 'adminNotification');
                return;
            }

            let isValidPassword = false;
            
            if (currentUser.isAdmin && password === '#Invites2025@!!1995') {
                isValidPassword = true;
            } else if (!currentUser.isAdmin) {
                try {
                    const { data: user } = await supabase
                        .from('users')
                        .select('password')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (user && user.password === password) {
                        isValidPassword = true;
                    }
                } catch (error) {
                    console.error('Error verifying password:', error);
                }
            }

            if (!isValidPassword) {
                showNotification('Senha incorreta.', 'error', 'adminNotification');
                return;
            }

            closePasswordModal();
            
            if (pendingAction) {
                await pendingAction();
                pendingAction = null;
            }
        }

        // Navigation Functions
        function hideAllViews() {
            document.querySelectorAll('#app > div').forEach(view => {
                view.classList.add('hidden');
            });
        }

        function showGuestView() {
            hideAllViews();
            document.getElementById('guestView').classList.remove('hidden');
        }

        function showLogin() {
            hideAllViews();
            document.getElementById('loginView').classList.remove('hidden');
        }

        function showRegister() {
            hideAllViews();
            document.getElementById('registerView').classList.remove('hidden');
        }

        function showCreateEvent() {
            hideAllViews();
            document.getElementById('createEventView').classList.remove('hidden');
            document.getElementById('eventFormTitle').textContent = editingEventId ? 'Editar Evento' : 'Criar Evento';
            
            // Limpar formul√°rio se for novo evento
            if (!editingEventId) {
                document.getElementById('eventForm').reset();
                removePhoto();
            }
        }

        function backToMain() {
            if (currentEvent) {
                showGuestView();
            } else {
                showGuestView();
            }
        }

        function goToProfile() {
            if (currentUser && (currentUser.isAdmin || currentUser.is_moderator)) {
                showAdminDashboard();
            } else if (currentUser && currentUser.approved) {
                showUserDashboard();
            }
        }

        function updateTopNav() {
            const loginBtn = document.getElementById('loginBtn');
            const profileBtn = document.getElementById('profileBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                loginBtn.classList.add('hidden');
                profileBtn.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                profileBtn.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Utility Functions
        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function showNotification(message, type, containerId = 'guestContent') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;

            const existingNotification = container.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            container.insertBefore(notification, container.firstChild);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Photo Upload Functions
        function previewPhoto(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Verificar tamanho do arquivo (m√°ximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('A foto deve ter no m√°ximo 5MB.', 'error', 'eventNotification');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    eventPhotoBase64 = e.target.result;
                    document.getElementById('previewImage').src = eventPhotoBase64;
                    document.getElementById('photoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            eventPhotoBase64 = null;
            document.getElementById('eventPhoto').value = '';
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('previewImage').src = '';
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975d92a7005a77d7',t:'MTc1NjMxODcyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
