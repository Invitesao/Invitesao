<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesAO - Sistema de Confirmação de Presença</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e1e5e9;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-small {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .event-card {
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .event-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .event-date {
            color: #666;
            font-size: 14px;
        }
        
        .countdown {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .countdown-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .countdown-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .countdown-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .countdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .response-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .response-buttons .btn {
            flex: 1;
            margin-bottom: 0;
        }
        
        .cover-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: auto;
            padding: 20px 0;
            font-size: 14px;
        }
        
        .login-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .user-phone {
            color: #666;
            font-size: 14px;
        }
        
        .user-actions {
            display: flex;
            gap: 5px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .radio-group {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
        }
        
        .radio-option input[type="radio"] {
            display: none;
        }
        
        .radio-circle {
            width: 24px;
            height: 24px;
            border: 3px solid #ccc;
            border-radius: 50%;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .radio-option input[type="radio"]:checked + .radio-circle {
            border-color: #667eea;
            background: #667eea;
        }
        
        .radio-option input[type="radio"]:checked + .radio-circle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .radio-text {
            color: #333;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .password-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
            margin: 10px 0;
            border: 2px solid #e1e5e9;
        }

        .companion-input {
            margin-bottom: 10px;
        }

        .companion-input input {
            margin-bottom: 5px;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">InvitesAO</div>
            <p style="margin-top: 15px;">Sistema de Confirmação de Presença</p>
        </div>

        <!-- Tela inicial - Login/Registro -->
        <div id="welcomeView">
            <div class="card">
                <h2 class="text-center">Bem-vindo ao InvitesAO</h2>
                <p class="text-center text-small" style="margin-bottom: 30px;">Sistema de Confirmação de Presença</p>
                <button class="btn btn-primary" onclick="showLogin()">Entrar</button>
                <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
            </div>
        </div>

        <!-- Tela do convidado (apenas para links diretos) -->
        <div id="guestView" class="hidden">
            <a href="#" onclick="showLogin()" class="login-link">Entrar</a>
            <div class="card">
                <img id="eventCover" class="cover-image hidden" alt="Capa do evento">
                <h1 id="eventTitle" class="text-center"></h1>
                <div id="eventDateContainer" class="text-center">
                    <p id="eventDate"></p>
                </div>
                
                <div id="countdownContainer" class="countdown">
                    <div class="countdown-grid">
                        <div class="countdown-item">
                            <div class="countdown-number" id="countdownDays">0</div>
                            <div class="countdown-label">Dias</div>
                        </div>
                        <div class="countdown-item">
                            <div class="countdown-number" id="countdownHours">0</div>
                            <div class="countdown-label">Horas</div>
                        </div>
                        <div class="countdown-item">
                            <div class="countdown-number" id="countdownMinutes">0</div>
                            <div class="countdown-label">Minutos</div>
                        </div>
                    </div>
                </div>
                
                <div id="confirmUntilContainer" class="text-center">
                    <p id="confirmUntil"></p>
                </div>
                
                <div class="text-center">
                    <h3>Confirma presença?</h3>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="attendance" value="yes" onchange="handleAttendanceChange()">
                            <span class="radio-circle"></span>
                            <span class="radio-text">Sim</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="attendance" value="no" onchange="handleAttendanceChange()">
                            <span class="radio-circle"></span>
                            <span class="radio-text">Não</span>
                        </label>
                    </div>
                </div>
                
                <div id="guestFormSection" class="hidden">
                    <div class="form-group">
                        <label>Seu nome completo</label>
                        <input type="text" id="guestName" placeholder="Digite seu nome completo">
                    </div>
                    
                    <div id="companionsSection" class="hidden">
                        <div class="form-group">
                            <label>Número de acompanhantes</label>
                            <select id="companions" onchange="updateCompanionNames()">
                                <option value="0">Apenas eu</option>
                            </select>
                        </div>
                        <div id="companionNamesSection" class="hidden">
                            <label>Nomes dos acompanhantes</label>
                            <div id="companionInputs"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="submitGuestResponse()">Confirmar Resposta</button>
                </div>
                
                <div id="responseConfirmed" class="hidden text-center">
                    <div class="alert alert-success">
                        <h3 id="confirmationTitle">Presença confirmada</h3>
                        <p id="confirmationMessage">Obrigado!</p>
                        <button class="btn btn-secondary btn-small" onclick="editResponse()" id="editBtn">Editar Resposta</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login -->
        <div id="loginView" class="hidden">
            <div class="card">
                <h2 class="text-center">Entrar</h2>
                <div class="form-group">
                    <label>Nome de usuário</label>
                    <input type="text" id="loginUsername" placeholder="Digite seu nome de usuário">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha">
                </div>
                <button class="btn btn-primary" onclick="login()">Entrar</button>
                <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
                <button class="btn btn-secondary" onclick="backToGuest()" id="backToGuestBtn" style="display: none;">Voltar ao Convite</button>
                <button class="btn btn-secondary" onclick="showWelcome()" id="backToWelcomeBtn">Voltar</button>
            </div>
        </div>

        <!-- Registro -->
        <div id="registerView" class="hidden">
            <div class="card">
                <h2 class="text-center">Criar Conta</h2>
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="registerName" placeholder="Digite seu nome completo">
                </div>
                <div class="form-group">
                    <label>Nome de usuário</label>
                    <input type="text" id="registerUsername" placeholder="Digite seu nome de usuário">
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="tel" id="registerPhone" placeholder="Ex: 922131116">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="registerPassword" placeholder="Digite sua senha">
                </div>
                <button class="btn btn-primary" onclick="register()">Criar Conta</button>
                <button class="btn btn-secondary" onclick="showLogin()">Já tenho conta</button>
                <button class="btn btn-secondary" onclick="showWelcome()">Voltar</button>
            </div>
        </div>

        <!-- Aguardando aprovação -->
        <div id="pendingView" class="hidden">
            <div class="card">
                <h2 class="text-center">Conta Criada!</h2>
                <div class="alert alert-success">
                    <p class="text-center">Sua conta foi criada com sucesso e está aguardando aprovação do administrador.</p>
                    <p class="text-center">Você será redirecionado automaticamente quando sua conta for aprovada.</p>
                </div>
                <div class="text-center">
                    <div class="loading-spinner"></div>
                    <p class="text-small">Verificando status da conta...</p>
                </div>
                <button class="btn btn-secondary" onclick="showWelcome()">Voltar ao Início</button>
            </div>
        </div>

        <!-- Dashboard do usuário -->
        <div id="userDashboard" class="hidden">
            <div class="card">
                <div class="event-header">
                    <h2>Meus Eventos</h2>
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="backToAdmin()" id="backToAdminBtn" style="display: none;">Voltar ao Admin</button>
                        <button class="btn btn-primary btn-small" onclick="logout()">Sair</button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showCreateEvent()">Criar Novo Evento</button>
                <div id="userEvents"></div>
            </div>
        </div>

        <!-- Criar/Editar evento -->
        <div id="createEventView" class="hidden">
            <div class="card">
                <h2 class="text-center" id="eventFormTitle">Criar Evento</h2>
                <div class="form-group">
                    <label>Nome do Evento</label>
                    <input type="text" id="eventName" placeholder="Digite o nome do evento">
                </div>
                <div class="form-group">
                    <label>Data do Evento *</label>
                    <input type="date" id="eventDate" required>
                    <div style="display: flex; align-items: center; margin-top: 10px;">
                        <input type="checkbox" id="includeTime" onchange="toggleTimeInput()" checked>
                        <label for="includeTime" style="margin-left: 8px; margin-bottom: 0;">Incluir horário</label>
                    </div>
                    <input type="time" id="eventTime" style="margin-top: 10px;">
                </div>
                <div class="form-group">
                    <label>Data limite para confirmação (opcional)</label>
                    <input type="date" id="confirmationDate">
                    <div style="display: flex; align-items: center; margin-top: 10px;">
                        <input type="checkbox" id="includeConfirmTime" onchange="toggleConfirmTimeInput()">
                        <label for="includeConfirmTime" style="margin-left: 8px; margin-bottom: 0;">Incluir horário</label>
                    </div>
                    <input type="time" id="confirmationTime" class="hidden" style="margin-top: 10px;">
                </div>
                <div class="form-group">
                    <label>Limite de confirmações (opcional)</label>
                    <input type="number" id="maxConfirmations" placeholder="0 = sem limite" min="0">
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="allowCompanions" onchange="toggleCompanionsInput()">
                        <label for="allowCompanions" style="margin-left: 8px; margin-bottom: 0;">Permitir acompanhantes</label>
                    </div>
                    <div id="companionsInputSection" class="hidden">
                        <label>Máximo de acompanhantes por convidado</label>
                        <input type="number" id="maxCompanions" placeholder="Ex: 2" min="1" max="10" value="1">
                    </div>
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="enableCover" onchange="toggleCoverUpload()">
                        <label for="enableCover" style="margin-left: 8px; margin-bottom: 0;">Ativar foto de capa</label>
                    </div>
                    <div id="coverUploadSection" class="hidden">
                        <input type="file" id="coverImage" class="file-input" accept="image/*" onchange="previewImage()">
                        <label for="coverImage" class="file-label">Escolher imagem</label>
                        <img id="imagePreview" class="cover-image hidden" alt="Preview">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveEvent()">Salvar Evento</button>
                <button class="btn btn-secondary" onclick="showUserDashboard()">Cancelar</button>
            </div>
        </div>

        <!-- Detalhes do evento -->
        <div id="eventDetailsView" class="hidden">
            <div class="card">
                <div class="event-header">
                    <h2 id="detailEventTitle"></h2>
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="editEvent()" id="editEventBtn">Editar</button>
                        <button class="btn btn-secondary btn-small" onclick="generateReport()" id="reportBtn">Relatório PDF</button>
                        <button class="btn btn-danger btn-small" onclick="deleteEvent()" id="deleteEventBtn">Excluir</button>
                        <button class="btn btn-secondary btn-small" onclick="showUserDashboard()">Voltar</button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalConfirmed">0</div>
                        <div class="stat-label">Confirmados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDeclined">0</div>
                        <div class="stat-label">Recusaram</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCompanions">0</div>
                        <div class="stat-label">Acompanhantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPeople">0</div>
                        <div class="stat-label">Total de Pessoas</div>
                    </div>
                </div>
                
                <p><strong>Código do evento:</strong> <span id="eventCodeDisplay"></span></p>
                <p><strong>Data:</strong> <span id="eventDateDisplay"></span></p>
                <p><strong>Link do convite:</strong> <br><span id="eventLink" style="word-break: break-all; color: #667eea;"></span></p>
                
                <h3>Confirmações de Presença</h3>
                <div id="responsesList"></div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden">
            <div class="card">
                <div class="event-header">
                    <h2>Painel Administrativo</h2>
                    <button class="btn btn-secondary btn-small" onclick="logout()">Sair</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Usuários</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEvents">0</div>
                        <div class="stat-label">Eventos</div>
                    </div>
                </div>
                
                <div class="tab-container">
                    <button class="tab-button active" onclick="showTab('pending')">Solicitações</button>
                    <button class="tab-button" onclick="showTab('users')">Usuários</button>
                    <button class="tab-button" onclick="showTab('events')">Eventos</button>
                </div>
                
                <div id="pendingTab" class="tab-content active">
                    <h3>Solicitações Pendentes</h3>
                    <div id="pendingRequests"></div>
                </div>
                
                <div id="usersTab" class="tab-content">
                    <h3>Gerenciar Usuários</h3>
                    <div id="usersList" class="user-list"></div>
                </div>
                
                <div id="eventsTab" class="tab-content">
                    <h3>Todos os Eventos</h3>
                    <div id="allEvents"></div>
                </div>
            </div>
        </div>

        <!-- Modal para detalhes do usuário -->
        <div id="userModal" class="modal hidden">
            <div class="modal-content">
                <h3>Detalhes do Usuário</h3>
                <div id="userDetails"></div>
                <div class="form-group">
                    <label>Nova Senha</label>
                    <input type="password" id="newPassword" placeholder="Digite a nova senha">
                </div>
                <button class="btn btn-warning" onclick="changeUserPassword()">Alterar Senha</button>
                <button class="btn btn-secondary" onclick="closeUserModal()">Fechar</button>
            </div>
        </div>

        <div class="footer">
            Copyright © invitesAo 2025
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const supabaseUrl = 'https://jqdrxvnnbkeepdnrzndv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxZHJ4dm5uYmtlZXBkbnJ6bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDk5NTAsImV4cCI6MjA3MTU4NTk1MH0.k0sGvCvzZra3up5RTlJqFDu8FleeYvBr8EGqf5q-G3Q';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentEvent = null;
        let editingEventId = null;
        let selectedUserId = null;
        let isGuestMode = false;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se é um link direto para evento
            const urlParams = new URLSearchParams(window.location.search);
            const eventCode = urlParams.get('event');
            
            if (eventCode) {
                isGuestMode = true;
                loadEventByCode(eventCode);
            } else {
                showWelcome();
            }
        });

        async function loadEventByCode(code) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('code', code)
                    .single();

                if (error || !event) {
                    showEventNotFound();
                    return;
                }

                currentEvent = event;
                displayGuestEvent();
            } catch (error) {
                showEventNotFound();
            }
        }

        function showEventNotFound() {
            hideAllViews();
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="header">
                    <div class="logo">InvitesAO</div>
                    <p style="margin-top: 15px;">Sistema de Confirmação de Presença</p>
                </div>
                <div class="card">
                    <h2 class="text-center">Evento não encontrado</h2>
                    <p class="text-center">O evento que você está procurando não existe ou foi removido.</p>
                    <p class="text-center">Gostaria de criar uma conta para organizar seus próprios eventos?</p>
                    <button class="btn btn-primary" onclick="location.reload(); showRegister();">Criar Conta</button>
                    <button class="btn btn-secondary" onclick="location.reload();">Voltar ao Início</button>
                </div>
                <div class="footer">
                    Copyright © invitesAo 2025
                </div>
            `;
        }

        function handleAttendanceChange() {
            const selectedValue = document.querySelector('input[name="attendance"]:checked').value;
            const formSection = document.getElementById('guestFormSection');
            const companionsSection = document.getElementById('companionsSection');
            
            formSection.classList.remove('hidden');
            
            if (selectedValue === 'yes' && currentEvent.max_companions > 0) {
                companionsSection.classList.remove('hidden');
                populateCompanionsSelect();
            } else {
                companionsSection.classList.add('hidden');
            }
        }

        function populateCompanionsSelect() {
            const select = document.getElementById('companions');
            select.innerHTML = '<option value="0">Apenas eu</option>';
            
            for (let i = 1; i <= currentEvent.max_companions; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i} acompanhante${i > 1 ? 's' : ''}`;
                select.appendChild(option);
            }
        }

        function updateCompanionNames() {
            const companionsCount = parseInt(document.getElementById('companions').value);
            const companionNamesSection = document.getElementById('companionNamesSection');
            const companionInputs = document.getElementById('companionInputs');
            
            if (companionsCount > 0) {
                companionNamesSection.classList.remove('hidden');
                companionInputs.innerHTML = '';
                
                for (let i = 1; i <= companionsCount; i++) {
                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'companion-input';
                    inputDiv.innerHTML = `
                        <input type="text" placeholder="Nome do ${i}º acompanhante" id="companion${i}">
                    `;
                    companionInputs.appendChild(inputDiv);
                }
            } else {
                companionNamesSection.classList.add('hidden');
            }
        }

        async function submitGuestResponse() {
            const selectedAttendance = document.querySelector('input[name="attendance"]:checked');
            const name = document.getElementById('guestName').value.trim();
            
            if (!selectedAttendance) {
                showAlert('Selecione uma opção de presença', 'error');
                return;
            }
            
            if (!name) {
                showAlert('Digite seu nome', 'error');
                return;
            }

            const attending = selectedAttendance.value === 'yes';
            const companions = attending ? (parseInt(document.getElementById('companions').value) || 0) : 0;

            // Coletar nomes dos acompanhantes
            let companionNames = [];
            if (companions > 0) {
                for (let i = 1; i <= companions; i++) {
                    const companionName = document.getElementById(`companion${i}`).value.trim();
                    if (companionName) {
                        companionNames.push(companionName);
                    }
                }
            }

            // Verificar deadline se existir
            if (currentEvent.confirmation_deadline && new Date() > new Date(currentEvent.confirmation_deadline)) {
                showAlert('Prazo para confirmação expirado', 'error');
                return;
            }

            try {
                // Verificar se já existe resposta para este nome
                const { data: existingResponse } = await supabase
                    .from('responses')
                    .select('id')
                    .eq('event_id', currentEvent.id)
                    .eq('guest_name', name)
                    .single();

                let result;
                if (existingResponse) {
                    // Atualizar resposta existente
                    result = await supabase
                        .from('responses')
                        .update({
                            attending: attending,
                            companions: companions,
                            companion_names: companionNames
                        })
                        .eq('id', existingResponse.id)
                        .select()
                        .single();
                } else {
                    // Criar nova resposta
                    result = await supabase
                        .from('responses')
                        .insert({
                            event_id: currentEvent.id,
                            guest_name: name,
                            attending: attending,
                            companions: companions,
                            companion_names: companionNames
                        })
                        .select()
                        .single();
                }

                if (result.error) throw result.error;

                localStorage.setItem(`guest_${currentEvent.code}`, result.data.id);
                displayGuestConfirmation(result.data);
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao registrar resposta', 'error');
            }
        }

        function displayGuestConfirmation(response) {
            // Ocultar formulário
            document.querySelector('.radio-group').style.display = 'none';
            document.getElementById('guestFormSection').classList.add('hidden');
            
            // Mostrar confirmação
            document.getElementById('responseConfirmed').classList.remove('hidden');
            
            if (response.attending) {
                document.getElementById('confirmationTitle').textContent = 'Presença confirmada!';
                let message = 'Obrigado pela confirmação!';
                if (response.companions > 0) {
                    message += ` Você confirmou ${response.companions} acompanhante${response.companions > 1 ? 's' : ''}.`;
                }
                document.getElementById('confirmationMessage').textContent = message;
            } else {
                document.getElementById('confirmationTitle').textContent = 'Resposta registrada';
                document.getElementById('confirmationMessage').textContent = 'Obrigado por responder.';
            }
        }

        function showTab(tabName) {
            // Remover classe active de todos os botões e conteúdos
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar o botão e conteúdo selecionado
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Navegação entre telas
        function hideAllViews() {
            document.querySelectorAll('[id$="View"], [id$="Dashboard"]').forEach(el => {
                el.classList.add('hidden');
            });
        }

        function showWelcome() {
            hideAllViews();
            document.getElementById('welcomeView').classList.remove('hidden');
        }

        function showLogin() {
            hideAllViews();
            document.getElementById('loginView').classList.remove('hidden');
            
            // Mostrar botão "Voltar ao Convite" se estiver em modo convidado
            if (isGuestMode) {
                document.getElementById('backToGuestBtn').style.display = 'block';
                document.getElementById('backToWelcomeBtn').style.display = 'none';
            } else {
                document.getElementById('backToGuestBtn').style.display = 'none';
                document.getElementById('backToWelcomeBtn').style.display = 'block';
            }
        }

        function backToGuest() {
            if (currentEvent) {
                displayGuestEvent();
            } else {
                showWelcome();
            }
        }

        function showRegister() {
            hideAllViews();
            document.getElementById('registerView').classList.remove('hidden');
        }

        function showPending(userId) {
            hideAllViews();
            document.getElementById('pendingView').classList.remove('hidden');
            startPendingCheck(userId);
        }

        function showUserDashboard() {
            hideAllViews();
            document.getElementById('userDashboard').classList.remove('hidden');
            
            // Verificar se deve mostrar botão "Voltar ao Admin"
            if (currentUser && currentUser.isAdminLogin) {
                document.getElementById('backToAdminBtn').style.display = 'inline-block';
            } else {
                document.getElementById('backToAdminBtn').style.display = 'none';
            }
            
            loadUserEvents();
        }

        function showAdminDashboard() {
            hideAllViews();
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadAdminData();
        }

        function showCreateEvent() {
            hideAllViews();
            document.getElementById('createEventView').classList.remove('hidden');
            document.getElementById('eventFormTitle').textContent = 'Criar Evento';
            editingEventId = null;
            clearEventForm();
        }

        function showEventDetails(eventId) {
            hideAllViews();
            document.getElementById('eventDetailsView').classList.remove('hidden');
            loadEventDetails(eventId);
        }

        function displayGuestEvent() {
            hideAllViews();
            document.getElementById('guestView').classList.remove('hidden');
            
            document.getElementById('eventTitle').textContent = currentEvent.name;
            
            // Formatação da data (obrigatória agora)
            const eventDate = new Date(currentEvent.date);
            const includeTime = currentEvent.include_time !== false;
            const dateOptions = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit'
            };
            
            let dateText = eventDate.toLocaleDateString('pt-BR', dateOptions);
            if (includeTime) {
                dateText += ', ' + eventDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }
            document.getElementById('eventDate').textContent = `Data: ${dateText}`;
            document.getElementById('eventDateContainer').classList.remove('hidden');
            
            // Mostrar countdown
            document.getElementById('countdownContainer').classList.remove('hidden');
            startCountdown();
            
            // Formatação da data limite (se existir)
            if (currentEvent.confirmation_deadline) {
                const deadlineDate = new Date(currentEvent.confirmation_deadline);
                const includeConfirmTime = currentEvent.include_confirm_time !== false;
                const dateOptions = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit'
                };
                let deadlineText = deadlineDate.toLocaleDateString('pt-BR', dateOptions);
                if (includeConfirmTime) {
                    deadlineText += ', ' + deadlineDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
                document.getElementById('confirmUntil').innerHTML = `<strong>Favor confirmar presença até ${deadlineText}</strong>`;
                document.getElementById('confirmUntilContainer').classList.remove('hidden');
            } else {
                document.getElementById('confirmUntilContainer').classList.add('hidden');
            }

            // Foto de capa
            if (currentEvent.cover_image) {
                document.getElementById('eventCover').src = currentEvent.cover_image;
                document.getElementById('eventCover').classList.remove('hidden');
            } else {
                document.getElementById('eventCover').classList.add('hidden');
            }

            checkExistingResponse();
        }

        // Autenticação
        async function register() {
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUsername').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;

            if (!name || !username || !phone || !password) {
                showAlert('Preencha todos os campos', 'error');
                return;
            }

            try {
                // Verificar se username já existe
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (existingUser) {
                    showAlert('Nome de usuário já existe', 'error');
                    return;
                }

                const { data, error } = await supabase.from('users').insert({
                    name: name,
                    username: username,
                    phone: phone,
                    password: password, // Em produção, usar hash
                    status: 'pending'
                }).select().single();

                if (error) throw error;

                showPending(data.id);
            } catch (error) {
                showAlert('Erro ao criar conta: ' + error.message, 'error');
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showAlert('Preencha todos os campos', 'error');
                return;
            }

            try {
                // Admin login
                if (username === 'Invites' && password === '#Invites2025@!!1995') {
                    currentUser = { is_admin: true, name: 'Administrador', username: 'Invites' };
                    showAdminDashboard();
                    return;
                }

                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .eq('is_active', true)
                    .single();

                if (error || !user) {
                    showAlert('Nome de usuário ou senha incorretos, ou conta desativada', 'error');
                    return;
                }

                if (user.status === 'pending') {
                    showPending(user.id);
                    return;
                } else if (user.status !== 'approved') {
                    showAlert('Sua conta foi desativada', 'error');
                    return;
                }

                currentUser = user;
                showUserDashboard();
            } catch (error) {
                showAlert('Erro ao fazer login: ' + error.message, 'error');
            }
        }

        async function logout() {
            currentUser = null;
            showWelcome();
        }

        // Sistema de verificação de aprovação
        async function startPendingCheck(userId) {
            const checkApproval = async () => {
                try {
                    const { data: user } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', userId)
                        .single();

                    if (user && user.status === 'approved') {
                        currentUser = user;
                        showAlert('Sua conta foi aprovada! Bem-vindo!', 'success');
                        showUserDashboard();
                        return;
                    } else if (user && user.status === 'rejected') {
                        showAlert('Sua conta foi rejeitada pelo administrador', 'error');
                        showWelcome();
                        return;
                    }
                } catch (error) {
                    console.error('Erro ao verificar aprovação:', error);
                }
            };

            // Verificar a cada 3 segundos
            const interval = setInterval(checkApproval, 3000);
            
            // Parar verificação após 5 minutos
            setTimeout(() => {
                clearInterval(interval);
            }, 300000);
        }

        function startCountdown() {
            if (!currentEvent.date) return;
            
            const eventDate = new Date(currentEvent.date);
            const daysElement = document.getElementById('countdownDays');
            const hoursElement = document.getElementById('countdownHours');
            const minutesElement = document.getElementById('countdownMinutes');

            function updateCountdown() {
                const now = new Date();
                const diff = eventDate - now;
                
                if (diff <= 0) {
                    daysElement.textContent = '0';
                    hoursElement.textContent = '0';
                    minutesElement.textContent = '0';
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                daysElement.textContent = days;
                hoursElement.textContent = hours;
                minutesElement.textContent = minutes;
            }

            updateCountdown();
            setInterval(updateCountdown, 60000);
        }

        // Funções para formulário de evento
        function toggleTimeInput() {
            const checkbox = document.getElementById('includeTime');
            const timeInput = document.getElementById('eventTime');
            
            if (checkbox.checked) {
                timeInput.classList.remove('hidden');
            } else {
                timeInput.classList.add('hidden');
            }
        }

        function toggleConfirmTimeInput() {
            const checkbox = document.getElementById('includeConfirmTime');
            const timeInput = document.getElementById('confirmationTime');
            
            if (checkbox.checked) {
                timeInput.classList.remove('hidden');
            } else {
                timeInput.classList.add('hidden');
            }
        }

        function toggleCoverUpload() {
            const checkbox = document.getElementById('enableCover');
            const uploadSection = document.getElementById('coverUploadSection');
            
            if (checkbox.checked) {
                uploadSection.classList.remove('hidden');
            } else {
                uploadSection.classList.add('hidden');
            }
        }

        function toggleCompanionsInput() {
            const checkbox = document.getElementById('allowCompanions');
            const inputSection = document.getElementById('companionsInputSection');
            
            if (checkbox.checked) {
                inputSection.classList.remove('hidden');
            } else {
                inputSection.classList.add('hidden');
            }
        }

        async function checkExistingResponse() {
            const guestId = localStorage.getItem(`guest_${currentEvent.code}`);
            if (guestId) {
                const { data: response } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('id', guestId)
                    .single();

                if (response) {
                    displayExistingResponse(response);
                }
            }
        }

        function displayExistingResponse(response) {
            // Ocultar formulário de resposta
            document.querySelector('.text-center h3').style.display = 'none';
            document.querySelector('.radio-group').style.display = 'none';
            document.getElementById('guestFormSection').classList.add('hidden');
            
            // Mostrar confirmação
            document.getElementById('responseConfirmed').classList.remove('hidden');

            const title = response.attending ? 'Presença Confirmada!' : 'Resposta Registrada';
            let message = `Olá ${response.guest_name}! `;
            
            if (response.attending) {
                message += `Sua presença foi confirmada${response.companions > 0 ? ` com ${response.companions} acompanhante(s)` : ''}.`;
            } else {
                message += 'Obrigado por responder ao convite.';
            }

            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;

            // Verificar se ainda pode editar (24h)
            const responseDate = new Date(response.created_at);
            const now = new Date();
            const hoursDiff = (now - responseDate) / (1000 * 60 * 60);
            const editBtn = document.getElementById('editBtn');

            if (hoursDiff > 24) {
                editBtn.style.display = 'none';
            } else {
                editBtn.style.display = 'inline-block';
                const hoursLeft = Math.ceil(24 - hoursDiff);
                editBtn.textContent = `Editar Resposta (${hoursLeft}h restantes)`;
            }
        }

        function editResponse() {
            // Reativar formulário
            document.querySelector('.text-center h3').style.display = 'block';
            document.querySelector('.radio-group').style.display = 'flex';
            document.getElementById('responseConfirmed').classList.add('hidden');
            document.getElementById('guestName').disabled = false;
            
            // Remover resposta anterior
            const guestId = localStorage.getItem(`guest_${currentEvent.code}`);
            if (guestId) {
                supabase.from('responses').delete().eq('id', guestId);
                localStorage.removeItem(`guest_${currentEvent.code}`);
            }
        }

        // Gerenciamento de eventos do usuário
        async function loadUserEvents() {
            try {
                console.log('Carregando eventos para usuário:', currentUser.id); // Debug
                
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                console.log('Eventos carregados:', events, 'Erro:', error); // Debug

                const container = document.getElementById('userEvents');
                container.innerHTML = '';

                if (error) {
                    console.error('Erro ao carregar eventos:', error);
                    container.innerHTML = '<p class="text-center text-small">Erro ao carregar eventos</p>';
                    return;
                }

                if (!events || events.length === 0) {
                    container.innerHTML = '<p class="text-center text-small">Você ainda não criou nenhum evento</p>';
                    return;
                }

                events.forEach(event => {
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card';
                    
                    // Data é obrigatória agora
                    const eventDate = new Date(event.date);
                    const includeTime = event.include_time !== false;
                    const dateOptions = { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit'
                    };
                    
                    let dateDisplay = eventDate.toLocaleDateString('pt-BR', dateOptions);
                    if (includeTime) {
                        dateDisplay += ', ' + eventDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    }
                    
                    eventCard.innerHTML = `
                        <div class="event-header">
                            <div>
                                <div class="event-title">${event.name || 'Evento sem nome'}</div>
                                <div class="event-date">${dateDisplay}</div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="showEventDetails('${event.id}')">Ver Detalhes</button>
                        </div>
                        <p><strong>Código:</strong> ${event.code || 'Sem código'}</p>
                    `;
                    container.appendChild(eventCard);
                });
            } catch (error) {
                console.error('Erro geral ao carregar eventos:', error);
                const container = document.getElementById('userEvents');
                container.innerHTML = '<p class="text-center text-small">Erro ao carregar eventos</p>';
            }
        }

        async function loadEventDetails(eventId) {
            const { data: event } = await supabase
                .from('events')
                .select('*')
                .eq('id', eventId)
                .single();

            const { data: responses } = await supabase
                .from('responses')
                .select('*')
                .eq('event_id', eventId)
                .order('created_at', { ascending: false });

            document.getElementById('detailEventTitle').textContent = event.name;
            document.getElementById('eventCodeDisplay').textContent = event.code;
            
            // Formatação da data (obrigatória)
            const eventDate = new Date(event.date);
            const includeTime = event.include_time !== false;
            const dateOptions = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit'
            };
            
            let dateDisplay = eventDate.toLocaleDateString('pt-BR', dateOptions);
            if (includeTime) {
                dateDisplay += ', ' + eventDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }
            document.getElementById('eventDateDisplay').textContent = dateDisplay;
            
            // Link corrigido para GitHub Pages
            document.getElementById('eventLink').textContent = `https://invitesao.github.io/Invitesao/?event=${event.code}`;

            // Calcular estatísticas
            const confirmed = responses.filter(r => r.attending);
            const declined = responses.filter(r => !r.attending);
            const totalCompanions = confirmed.reduce((sum, r) => sum + (r.companions || 0), 0);
            const totalPeople = confirmed.length + totalCompanions;

            document.getElementById('totalConfirmed').textContent = confirmed.length;
            document.getElementById('totalDeclined').textContent = declined.length;
            document.getElementById('totalCompanions').textContent = totalCompanions;
            document.getElementById('totalPeople').textContent = totalPeople;

            const responsesList = document.getElementById('responsesList');
            responsesList.innerHTML = '';

            if (responses.length === 0) {
                responsesList.innerHTML = '<p class="text-center text-small">Nenhuma resposta ainda</p>';
            } else {
                responses.forEach(response => {
                    const responseItem = document.createElement('div');
                    responseItem.className = 'user-item';
                    
                    let companionInfo = '';
                    if (response.companions > 0) {
                        companionInfo = ` • ${response.companions} acompanhante${response.companions > 1 ? 's' : ''}`;
                        if (response.companion_names && response.companion_names.length > 0) {
                            companionInfo += ` (${response.companion_names.join(', ')})`;
                        }
                    }
                    
                    responseItem.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${response.guest_name}</div>
                            <div class="user-phone">${response.attending ? 'Confirmou presença' : 'Não comparecerá'}${companionInfo}</div>
                            <div class="text-small" style="color: #999;">${new Date(response.created_at).toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="user-actions">
                            <span style="color: ${response.attending ? '#28a745' : '#dc3545'}; font-size: 1.2rem;">
                                ${response.attending ? '✓' : '✗'}
                            </span>
                        </div>
                    `;
                    responsesList.appendChild(responseItem);
                });
            }

            currentEvent = event;
        }

        function clearEventForm() {
            document.getElementById('eventName').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('confirmationDate').value = '';
            document.getElementById('confirmationTime').value = '';
            document.getElementById('maxConfirmations').value = '';
            document.getElementById('maxCompanions').value = '1';
            document.getElementById('includeTime').checked = true;
            document.getElementById('includeConfirmTime').checked = false;
            document.getElementById('enableCover').checked = false;
            document.getElementById('allowCompanions').checked = false;
            document.getElementById('coverImage').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('eventTime').classList.remove('hidden');
            document.getElementById('confirmationTime').classList.add('hidden');
            document.getElementById('coverUploadSection').classList.add('hidden');
            document.getElementById('companionsInputSection').classList.add('hidden');
        }

        function previewImage() {
            const file = document.getElementById('coverImage').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveEvent() {
            const name = document.getElementById('eventName').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            
            if (!name) {
                showAlert('Digite o nome do evento', 'error');
                return;
            }

            if (!eventDate) {
                showAlert('A data do evento é obrigatória', 'error');
                return;
            }

            const eventTime = document.getElementById('eventTime').value;
            const includeTime = document.getElementById('includeTime').checked;
            
            const confirmationDate = document.getElementById('confirmationDate').value;
            const confirmationTime = document.getElementById('confirmationTime').value;
            const includeConfirmTime = document.getElementById('includeConfirmTime').checked;
            
            const maxConfirmations = parseInt(document.getElementById('maxConfirmations').value) || null;
            const enableCover = document.getElementById('enableCover').checked;
            const allowCompanions = document.getElementById('allowCompanions').checked;
            const maxCompanions = allowCompanions ? (parseInt(document.getElementById('maxCompanions').value) || 1) : 0;

            // Construir data do evento (obrigatória)
            let fullEventDate;
            if (includeTime && eventTime) {
                fullEventDate = eventDate + 'T' + eventTime + ':00';
            } else {
                fullEventDate = eventDate + 'T12:00:00';
            }

            // Construir data limite (opcional)
            let fullConfirmationDate = null;
            if (confirmationDate) {
                if (includeConfirmTime && confirmationTime) {
                    fullConfirmationDate = confirmationDate + 'T' + confirmationTime + ':00';
                } else {
                    fullConfirmationDate = confirmationDate + 'T23:59:00';
                }
            }

            // Upload da imagem (se selecionada)
            let coverImageUrl = null;
            if (enableCover) {
                const coverFile = document.getElementById('coverImage').files[0];
                if (coverFile) {
                    try {
                        const fileName = `${Date.now()}_${coverFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                        const { data: uploadData, error: uploadError } = await supabase.storage
                            .from('event-covers')
                            .upload(fileName, coverFile);

                        if (!uploadError) {
                            const { data: urlData } = supabase.storage
                                .from('event-covers')
                                .getPublicUrl(fileName);
                            coverImageUrl = urlData.publicUrl;
                        }
                    } catch (uploadErr) {
                        console.log('Erro no upload da imagem:', uploadErr);
                        // Continuar sem a imagem se houver erro
                    }
                }
            }
            
            // Preparar dados do evento
            const eventData = {
                name: name,
                date: fullEventDate,
                confirmation_deadline: fullConfirmationDate,
                max_confirmations: maxConfirmations,
                max_companions: maxCompanions,
                cover_image: coverImageUrl,
                include_time: includeTime,
                include_confirm_time: includeConfirmTime,
                user_id: currentUser.id
            };

            // Gerar código apenas para novos eventos
            if (!editingEventId) {
                eventData.code = generateEventCode();
            }

            console.log('Dados do evento:', eventData); // Debug

            try {
                let result;
                if (editingEventId) {
                    result = await supabase
                        .from('events')
                        .update(eventData)
                        .eq('id', editingEventId)
                        .select();
                } else {
                    result = await supabase
                        .from('events')
                        .insert([eventData])
                        .select();
                }

                console.log('Resultado:', result); // Debug

                if (result.error) {
                    console.error('Erro do Supabase:', result.error);
                    showAlert('Erro ao salvar evento: ' + result.error.message, 'error');
                    return;
                }

                showAlert('Evento salvo com sucesso!', 'success');
                setTimeout(() => {
                    showUserDashboard();
                }, 1000);
                
            } catch (error) {
                console.error('Erro geral:', error);
                showAlert('Erro ao salvar evento: ' + error.message, 'error');
            }
        }

        function generateEventCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function editEvent() {
            hideAllViews();
            document.getElementById('createEventView').classList.remove('hidden');
            document.getElementById('eventFormTitle').textContent = 'Editar Evento';
            editingEventId = currentEvent.id;

            document.getElementById('eventName').value = currentEvent.name;
            
            // Preencher data do evento (obrigatória)
            const eventDate = new Date(currentEvent.date);
            document.getElementById('eventDate').value = eventDate.toISOString().split('T')[0];
            
            if (currentEvent.include_time) {
                document.getElementById('includeTime').checked = true;
                document.getElementById('eventTime').classList.remove('hidden');
                document.getElementById('eventTime').value = eventDate.toTimeString().slice(0, 5);
            }
            
            // Preencher data limite (se existir)
            if (currentEvent.confirmation_deadline) {
                const confirmDate = new Date(currentEvent.confirmation_deadline);
                document.getElementById('confirmationDate').value = confirmDate.toISOString().split('T')[0];
                
                if (currentEvent.include_confirm_time) {
                    document.getElementById('includeConfirmTime').checked = true;
                    document.getElementById('confirmationTime').classList.remove('hidden');
                    document.getElementById('confirmationTime').value = confirmDate.toTimeString().slice(0, 5);
                }
            }
            
            document.getElementById('maxConfirmations').value = currentEvent.max_confirmations || '';
            
            if (currentEvent.max_companions > 0) {
                document.getElementById('allowCompanions').checked = true;
                document.getElementById('companionsInputSection').classList.remove('hidden');
                document.getElementById('maxCompanions').value = currentEvent.max_companions;
            }

            if (currentEvent.cover_image) {
                document.getElementById('enableCover').checked = true;
                document.getElementById('coverUploadSection').classList.remove('hidden');
                document.getElementById('imagePreview').src = currentEvent.cover_image;
                document.getElementById('imagePreview').classList.remove('hidden');
            }
        }

        async function deleteEvent() {
            if (!confirm('Tem certeza que deseja excluir este evento? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                // Excluir respostas primeiro
                await supabase
                    .from('responses')
                    .delete()
                    .eq('event_id', currentEvent.id);

                // Excluir evento
                await supabase
                    .from('events')
                    .delete()
                    .eq('id', currentEvent.id);

                showAlert('Evento excluído com sucesso!', 'success');
                showUserDashboard();
            } catch (error) {
                showAlert('Erro ao excluir evento', 'error');
            }
        }

        // Admin functions
        async function loadAdminData() {
            // Carregar estatísticas
            const { data: users } = await supabase.from('users').select('*').eq('is_active', true);
            const { data: events } = await supabase.from('events').select('*');

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalEvents').textContent = events.length;

            // Carregar solicitações pendentes
            const pendingUsers = users.filter(u => u.status === 'pending');
            const pendingContainer = document.getElementById('pendingRequests');
            pendingContainer.innerHTML = '';

            if (pendingUsers.length === 0) {
                pendingContainer.innerHTML = '<p class="text-center text-small">Nenhuma solicitação pendente</p>';
            } else {
                pendingUsers.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-item';
                    userCard.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-phone">${user.phone}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-success btn-small" onclick="approveUser('${user.id}')">Aprovar</button>
                            <button class="btn btn-danger btn-small" onclick="rejectUser('${user.id}')">Rejeitar</button>
                        </div>
                    `;
                    pendingContainer.appendChild(userCard);
                });
            }

            // Carregar todos os usuários
            const approvedUsers = users.filter(u => u.status === 'approved');
            const usersContainer = document.getElementById('usersList');
            usersContainer.innerHTML = '';

            approvedUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-item';
                userCard.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${user.name} ${!user.is_active ? '(Desativado)' : ''}</div>
                        <div class="user-phone">${user.phone}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-secondary btn-small" onclick="viewUserDetails('${user.id}')">Ver</button>
                        <button class="btn btn-secondary btn-small" onclick="loginAsUser('${user.id}')">Entrar</button>
                        <button class="btn btn-warning btn-small" onclick="toggleUserStatus('${user.id}', ${user.is_active})">${user.is_active ? 'Desativar' : 'Ativar'}</button>
                        <button class="btn btn-danger btn-small" onclick="deleteUser('${user.id}')">Excluir</button>
                    </div>
                `;
                usersContainer.appendChild(userCard);
            });

            // Carregar todos os eventos
            const allEventsContainer = document.getElementById('allEvents');
            allEventsContainer.innerHTML = '';

            events.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                
                const eventDate = new Date(event.date);
                const includeTime = event.include_time !== false;
                const dateOptions = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit'
                };
                
                let dateDisplay = eventDate.toLocaleDateString('pt-BR', dateOptions);
                if (includeTime) {
                    dateDisplay += ', ' + eventDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
                
                eventCard.innerHTML = `
                    <div class="event-header">
                        <div>
                            <div class="event-title">${event.name}</div>
                            <div class="event-date">${dateDisplay}</div>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="adminViewEvent('${event.id}')">Ver</button>
                            <button class="btn btn-danger btn-small" onclick="adminDeleteEvent('${event.id}')">Excluir</button>
                        </div>
                    </div>
                `;
                allEventsContainer.appendChild(eventCard);
            });
        }

        async function approveUser(userId) {
            await supabase
                .from('users')
                .update({ status: 'approved' })
                .eq('id', userId);
            
            showAlert('Usuário aprovado!', 'success');
            loadAdminData();
        }

        async function rejectUser(userId) {
            await supabase
                .from('users')
                .delete()
                .eq('id', userId);
            
            showAlert('Usuário rejeitado!', 'success');
            loadAdminData();
        }

        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'ativado' : 'desativado';
            
            await supabase
                .from('users')
                .update({ is_active: newStatus })
                .eq('id', userId);
            
            showAlert(`Usuário ${action}!`, 'success');
            loadAdminData();
        }

        async function viewUserDetails(userId) {
            const { data: user } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();
            
            selectedUserId = userId;
            
            document.getElementById('userDetails').innerHTML = `
                <p><strong>Nome:</strong> ${user.name}</p>
                <p><strong>Usuário:</strong> ${user.username}</p>
                <p><strong>Telefone:</strong> ${user.phone}</p>
                <div class="password-display">
                    <strong>Senha atual:</strong> ${user.password}
                </div>
                <p><strong>Status:</strong> ${user.status}</p>
                <p><strong>Ativo:</strong> ${user.is_active ? 'Sim' : 'Não'}</p>
                <p><strong>Criado em:</strong> ${new Date(user.created_at).toLocaleString('pt-BR')}</p>
            `;
            
            document.getElementById('userModal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
            document.getElementById('newPassword').value = '';
            selectedUserId = null;
        }

        async function changeUserPassword() {
            const newPassword = document.getElementById('newPassword').value;
            
            if (!newPassword.trim()) {
                showAlert('Digite a nova senha', 'error');
                return;
            }

            try {
                await supabase
                    .from('users')
                    .update({ password: newPassword })
                    .eq('id', selectedUserId);
                
                showAlert('Senha alterada com sucesso!', 'success');
                closeUserModal();
                loadAdminData();
            } catch (error) {
                showAlert('Erro ao alterar senha', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Tem certeza que deseja excluir este usuário? Todos os eventos dele também serão excluídos.')) {
                return;
            }

            try {
                // Buscar eventos do usuário
                const { data: userEvents } = await supabase
                    .from('events')
                    .select('id')
                    .eq('user_id', userId);

                // Excluir respostas dos eventos do usuário
                for (const event of userEvents) {
                    await supabase
                        .from('responses')
                        .delete()
                        .eq('event_id', event.id);
                }

                // Excluir eventos do usuário
                await supabase
                    .from('events')
                    .delete()
                    .eq('user_id', userId);

                // Excluir usuário
                await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                showAlert('Usuário excluído com sucesso!', 'success');
                loadAdminData();
            } catch (error) {
                showAlert('Erro ao excluir usuário', 'error');
            }
        }

        async function loginAsUser(userId) {
            const { data: user } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();
            
            currentUser = user;
            currentUser.isAdminLogin = true; // Marcar como login de admin
            document.getElementById('backToAdminBtn').style.display = 'inline-block';
            showUserDashboard();
        }

        function backToAdmin() {
            currentUser = { is_admin: true, name: 'Administrador', username: 'Invites' };
            showAdminDashboard();
        }

        async function adminViewEvent(eventId) {
            const { data: event } = await supabase
                .from('events')
                .select('*')
                .eq('id', eventId)
                .single();
            
            currentEvent = event;
            showEventDetails(eventId);
        }

        async function adminDeleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) {
                return;
            }

            try {
                // Excluir respostas primeiro
                await supabase
                    .from('responses')
                    .delete()
                    .eq('event_id', eventId);

                // Excluir evento
                await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                showAlert('Evento excluído com sucesso!', 'success');
                loadAdminData();
            } catch (error) {
                showAlert('Erro ao excluir evento', 'error');
            }
        }

        // Relatório PDF melhorado
        async function generateReport() {
            const { data: responses } = await supabase
                .from('responses')
                .select('*')
                .eq('event_id', currentEvent.id)
                .order('created_at', { ascending: false });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Configurar fonte para suportar caracteres especiais
            doc.setFont('helvetica');

            // Cabeçalho com cor
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('InvitesAO', 20, 20);
            doc.setFontSize(14);
            doc.text('Relatório do Evento', 20, 32);

            // Resetar cor do texto
            doc.setTextColor(0, 0, 0);

            // Informações do evento em caixa
            doc.setFillColor(248, 249, 250);
            doc.rect(15, 50, 180, 40, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(15, 50, 180, 40, 'S');

            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Informações do Evento', 20, 65);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            const eventName = currentEvent.name || 'Sem nome';
            const eventDate = new Date(currentEvent.date).toLocaleString('pt-BR');
            const eventCode = currentEvent.code || 'Sem código';
            
            doc.text(`Nome: ${eventName}`, 20, 75);
            doc.text(`Data: ${eventDate}`, 20, 82);
            doc.text(`Código: ${eventCode}`, 20, 89);

            // Estatísticas em cards
            const confirmed = responses.filter(r => r.attending);
            const declined = responses.filter(r => !r.attending);
            const totalCompanions = confirmed.reduce((sum, r) => sum + (r.companions || 0), 0);
            const totalPeople = confirmed.length + totalCompanions;

            // Cards de estatísticas
            const cardWidth = 40;
            const cardHeight = 25;
            const startX = 20;
            const startY = 105;

            // Card Confirmados
            doc.setFillColor(40, 167, 69);
            doc.rect(startX, startY, cardWidth, cardHeight, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(confirmed.length.toString(), startX + 20, startY + 12, { align: 'center' });
            doc.setFontSize(10);
            doc.text('Confirmados', startX + 20, startY + 20, { align: 'center' });

            // Card Recusaram
            doc.setFillColor(220, 53, 69);
            doc.rect(startX + 45, startY, cardWidth, cardHeight, 'F');
            doc.text(declined.length.toString(), startX + 65, startY + 12, { align: 'center' });
            doc.text('Recusaram', startX + 65, startY + 20, { align: 'center' });

            // Card Acompanhantes
            doc.setFillColor(255, 193, 7);
            doc.rect(startX + 90, startY, cardWidth, cardHeight, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text(totalCompanions.toString(), startX + 110, startY + 12, { align: 'center' });
            doc.text('Acompanhantes', startX + 110, startY + 20, { align: 'center' });

            // Card Total
            doc.setFillColor(102, 126, 234);
            doc.rect(startX + 135, startY, cardWidth, cardHeight, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text(totalPeople.toString(), startX + 155, startY + 12, { align: 'center' });
            doc.text('Total Pessoas', startX + 155, startY + 20, { align: 'center' });

            // Lista de confirmações
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Lista de Confirmações', 20, 150);

            if (responses.length === 0) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.text('Nenhuma resposta registrada ainda.', 20, 165);
            } else {
                let yPosition = 165;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);

                responses.forEach((response, index) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                        
                        // Repetir cabeçalho na nova página
                        doc.setFillColor(102, 126, 234);
                        doc.rect(0, 0, 210, 25, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(14);
                        doc.text('Lista de Confirmações (continuação)', 20, 15);
                        doc.setTextColor(0, 0, 0);
                        yPosition = 35;
                    }
                    
                    const guestName = response.guest_name || 'Nome não informado';
                    const status = response.attending ? '✓ Confirmou' : '✗ Recusou';
                    const companions = (response.companions && response.companions > 0) ? 
                        ` • ${response.companions} acompanhante${response.companions > 1 ? 's' : ''}` : '';
                    const date = new Date(response.created_at).toLocaleString('pt-BR');
                    
                    // Número da linha
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${index + 1}.`, 20, yPosition);
                    
                    // Nome do convidado
                    doc.setFont('helvetica', 'normal');
                    doc.text(guestName, 30, yPosition);
                    
                    // Status com cor
                    if (response.attending) {
                        doc.setTextColor(40, 167, 69);
                    } else {
                        doc.setTextColor(220, 53, 69);
                    }
                    doc.text(status, 120, yPosition);
                    
                    // Acompanhantes
                    doc.setTextColor(0, 0, 0);
                    if (companions) {
                        doc.text(companions, 155, yPosition);
                    }
                    
                    // Nomes dos acompanhantes (se houver)
                    if (response.companion_names && response.companion_names.length > 0) {
                        doc.setFontSize(9);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Nomes: ${response.companion_names.join(', ')}`, 30, yPosition + 6);
                        doc.setFontSize(11);
                        yPosition += 6;
                    }
                    
                    // Data (linha seguinte, menor)
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Respondeu em: ${date}`, 30, yPosition + 8);
                    
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    yPosition += 18;
                });
            }

            // Rodapé
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Página ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Gerado pelo InvitesAO', 105, 295, { align: 'center' });
            }

            // Salvar PDF com nome seguro
            const safeName = eventName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
            doc.save(`Relatorio_${safeName}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Utilitários
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
            alertDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Verificar parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const eventParam = urlParams.get('event');
        if (eventParam) {
            document.getElementById('eventCode').value = eventParam;
            loadEvent();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974d23c3754177e3',t:'MTc1NjE0NjQwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
