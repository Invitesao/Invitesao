<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesAO - Sistema de Confirmação de Presença</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 2.5em;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .event-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .event-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .countdown {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        .countdown-item {
            display: inline-block;
            margin: 0 10px;
            text-align: center;
        }

        .countdown-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .countdown-label {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .response-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .response-buttons .btn {
            flex: 1;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 14px;
            margin-top: auto;
        }

        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .login-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .companions-input {
            margin-top: 15px;
        }

        .edit-timer {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .admin-container {
                padding: 40px;
            }
            
            .container {
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Link for Guests -->
        <a href="#" class="login-link hidden" id="guestLoginLink" onclick="showLogin()">Login</a>

        <!-- Guest Event View -->
        <div id="guestView" class="container">
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="guestContent">
                    <p style="text-align: center; color: #666;">Carregando evento...</p>
                </div>
            </div>
            <div class="footer">
                Copyright © invitesAO
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginView" class="container hidden">
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="loginNotification"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
                <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
                <button class="btn btn-secondary" onclick="showGuestView()">Voltar</button>
            </div>
            <div class="footer">
                Copyright © invitesAO
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerView" class="container hidden">
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="registerNotification"></div>
                <form id="registerForm">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="registerPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Criar Conta</button>
                </form>
                <button class="btn btn-secondary" onclick="showLogin()">Já tenho conta</button>
            </div>
            <div class="footer">
                Copyright © invitesAO
            </div>
        </div>

        <!-- User Dashboard -->
        <div id="userDashboard" class="container hidden">
            <div class="card">
                <div class="logo">
                    <h1>🎉 Meus Eventos</h1>
                </div>
                <div id="userNotification"></div>
                <button class="btn btn-primary" onclick="showCreateEvent()">Criar Novo Evento</button>
                <button class="btn btn-secondary" onclick="logout()">Sair</button>
                <div id="userEvents"></div>
            </div>
            <div class="footer">
                Copyright © invitesAO
            </div>
        </div>

        <!-- Create/Edit Event -->
        <div id="createEventView" class="container hidden">
            <div class="card">
                <div class="logo">
                    <h1 id="eventFormTitle">🎉 Criar Evento</h1>
                </div>
                <div id="eventNotification"></div>
                <form id="eventForm">
                    <div class="form-group">
                        <label>Nome do Evento</label>
                        <input type="text" id="eventName" required>
                    </div>
                    <div class="form-group">
                        <label>Data do Evento</label>
                        <input type="datetime-local" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label>Data Limite para Confirmação</label>
                        <input type="datetime-local" id="eventDeadline" required>
                    </div>
                    <div class="form-group">
                        <label>Limite de Confirmações</label>
                        <input type="number" id="eventLimit" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Descrição</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="eventCoverEnabled"> Permitir foto de capa
                        </label>
                    </div>
                    <div class="form-group hidden" id="coverUploadGroup">
                        <label>Foto de Capa</label>
                        <input type="file" id="eventCover" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Evento</button>
                    <button type="button" class="btn btn-secondary" onclick="showUserDashboard()">Cancelar</button>
                </form>
            </div>
            <div class="footer">
                Copyright © invitesAO
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="admin-container hidden">
            <div class="admin-header">
                <h1>🔧 Painel Administrativo</h1>
                <button class="btn btn-danger btn-small" onclick="logout()">Sair</button>
            </div>
            <div id="adminNotification"></div>
            
            <div class="admin-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalUsers">0</div>
                    <div>Usuários Totais</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="pendingUsers">0</div>
                    <div>Solicitações Pendentes</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalEvents">0</div>
                    <div>Eventos Totais</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalResponses">0</div>
                    <div>Respostas Totais</div>
                </div>
            </div>

            <div class="card">
                <h3>Solicitações Pendentes</h3>
                <div id="pendingRequests"></div>
            </div>

            <div class="card">
                <h3>Gerenciar Usuários</h3>
                <div id="userManagement"></div>
            </div>

            <div class="card">
                <h3>Todos os Eventos</h3>
                <div id="allEvents"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://jqdrxvnnbkeepdnrzndv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxZHJ4dm5uYmtlZXBkbnJ6bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDk5NTAsImV4cCI6MjA3MTU4NTk1MH0.k0sGvCvzZra3up5RTlJqFDu8FleeYvBr8EGqf5q-G3Q';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global Variables
        let currentUser = null;
        let currentEvent = null;
        let editingEventId = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadEventFromUrl();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
            document.getElementById('eventCoverEnabled').addEventListener('change', toggleCoverUpload);
        }

        // Authentication Functions
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                if (currentUser.email === 'admin@invitesao.com') {
                    showAdminDashboard();
                } else {
                    const { data: user } = await supabase
                        .from('users')
                        .select('*')
                        .eq('email', currentUser.email)
                        .single();
                    
                    if (user && user.approved) {
                        showUserDashboard();
                    } else {
                        showNotification('Sua conta ainda não foi aprovada pelo administrador.', 'info');
                        logout();
                    }
                }
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                if (email === 'admin@invitesao.com') {
                    showAdminDashboard();
                } else {
                    const { data: user } = await supabase
                        .from('users')
                        .select('*')
                        .eq('email', email)
                        .single();
                    
                    if (user && user.approved) {
                        showUserDashboard();
                    } else {
                        showNotification('Sua conta ainda não foi aprovada pelo administrador.', 'info', 'loginNotification');
                        await supabase.auth.signOut();
                    }
                }
            } catch (error) {
                showNotification('Erro ao fazer login: ' + error.message, 'error', 'loginNotification');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;

            try {
                // Create user in Supabase Auth
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });

                if (error) throw error;

                // Create user record
                const { error: dbError } = await supabase
                    .from('users')
                    .insert([{
                        id: data.user.id,
                        name,
                        email,
                        phone,
                        approved: false
                    }]);

                if (dbError) throw dbError;

                showNotification('Conta criada! Aguarde aprovação do administrador.', 'success', 'registerNotification');
                setTimeout(() => showLogin(), 2000);
            } catch (error) {
                showNotification('Erro ao criar conta: ' + error.message, 'error', 'registerNotification');
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            showGuestView();
        }

        // Event Functions
        async function loadEventFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');
            
            if (eventId) {
                await loadGuestEvent(eventId);
                document.getElementById('guestLoginLink').classList.remove('hidden');
            } else {
                document.getElementById('guestContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>🎉 Bem-vindo ao InvitesAO</h2>
                        <p style="margin: 20px 0; color: #666;">Sistema de confirmação de presença para seus eventos especiais.</p>
                        <button class="btn btn-primary" onclick="showLogin()">Fazer Login</button>
                    </div>
                `;
            }
        }

        async function loadGuestEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                currentEvent = event;
                renderGuestEvent(event);
            } catch (error) {
                document.getElementById('guestContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>❌ Evento não encontrado</h2>
                        <p style="color: #666;">O link do evento pode estar incorreto ou o evento foi removido.</p>
                    </div>
                `;
            }
        }

        function renderGuestEvent(event) {
            const now = new Date();
            const eventDate = new Date(event.event_date);
            const deadline = new Date(event.deadline);
            
            let coverHtml = '';
            if (event.cover_enabled && event.cover_url) {
                coverHtml = `<img src="${event.cover_url}" alt="Capa do evento" class="event-cover">`;
            }

            let deadlineStatus = '';
            if (now > deadline) {
                deadlineStatus = '<div class="notification error">Prazo para confirmação expirado</div>';
            }

            const guestResponse = getGuestResponse(event.id);
            let responseSection = '';

            if (guestResponse) {
                const canEdit = canEditResponse(guestResponse.created_at);
                responseSection = `
                    <div class="notification success">
                        <strong>Sua resposta:</strong> ${guestResponse.attending ? 'Confirmado' : 'Não comparecerá'}<br>
                        <strong>Nome:</strong> ${guestResponse.guest_name}<br>
                        ${guestResponse.companions > 0 ? `<strong>Acompanhantes:</strong> ${guestResponse.companions}<br>` : ''}
                        ${canEdit ? `
                            <button class="btn btn-small btn-secondary" onclick="editResponse()" style="margin-top: 10px;">Editar Resposta</button>
                            <div class="edit-timer">Você pode editar sua resposta por mais ${getRemainingEditTime(guestResponse.created_at)}</div>
                        ` : ''}
                    </div>
                `;
            } else if (now <= deadline) {
                responseSection = `
                    <div class="response-buttons">
                        <button class="btn btn-success" onclick="respondEvent(true)">Sim, vou comparecer</button>
                        <button class="btn btn-danger" onclick="respondEvent(false)">Não posso comparecer</button>
                    </div>
                `;
            }

            document.getElementById('guestContent').innerHTML = `
                ${coverHtml}
                <h2 style="text-align: center; margin-bottom: 20px;">${event.name}</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <strong>📅 ${formatDate(eventDate)}</strong>
                </div>
                ${event.description ? `<p style="margin-bottom: 20px; text-align: center; color: #666;">${event.description}</p>` : ''}
                
                <div class="countdown" id="countdown"></div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <strong>Favor confirmar presença até: ${formatDate(deadline)}</strong>
                </div>
                
                ${deadlineStatus}
                ${responseSection}
                
                <div id="responseForm" class="hidden">
                    <div class="form-group">
                        <label>Seu nome completo</label>
                        <input type="text" id="guestName" required>
                    </div>
                    <div class="form-group companions-input hidden" id="companionsGroup">
                        <label>Número de acompanhantes</label>
                        <input type="number" id="companions" min="0" max="10" value="0">
                    </div>
                    <button class="btn btn-primary" onclick="submitResponse()">Confirmar</button>
                    <button class="btn btn-secondary" onclick="cancelResponse()">Cancelar</button>
                </div>
            `;

            startCountdown(eventDate);
        }

        function startCountdown(eventDate) {
            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) return;

            function updateCountdown() {
                const now = new Date().getTime();
                const eventTime = eventDate.getTime();
                const distance = eventTime - now;

                if (distance < 0) {
                    countdownElement.innerHTML = '<h3>🎉 O evento já começou!</h3>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `
                    <h3>⏰ Contagem Regressiva</h3>
                    <div style="margin-top: 15px;">
                        <div class="countdown-item">
                            <span class="countdown-number">${days}</span>
                            <span class="countdown-label">dias</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${hours}</span>
                            <span class="countdown-label">horas</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${minutes}</span>
                            <span class="countdown-label">min</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${seconds}</span>
                            <span class="countdown-label">seg</span>
                        </div>
                    </div>
                `;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        let currentAttending = null;

        function respondEvent(attending) {
            currentAttending = attending;
            document.getElementById('responseForm').classList.remove('hidden');
            if (attending) {
                document.getElementById('companionsGroup').classList.remove('hidden');
            } else {
                document.getElementById('companionsGroup').classList.add('hidden');
            }
        }

        async function submitResponse() {
            const guestName = document.getElementById('guestName').value;
            const companions = currentAttending ? parseInt(document.getElementById('companions').value) || 0 : 0;

            if (!guestName.trim()) {
                showNotification('Por favor, informe seu nome.', 'error');
                return;
            }

            try {
                const response = {
                    event_id: currentEvent.id,
                    guest_name: guestName,
                    attending: currentAttending,
                    companions: companions,
                    created_at: new Date().toISOString()
                };

                // Save to localStorage
                const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
                responses[currentEvent.id] = response;
                localStorage.setItem('eventResponses', JSON.stringify(responses));

                // Save to database
                const { error } = await supabase
                    .from('responses')
                    .insert([response]);

                if (error) throw error;

                const message = currentAttending 
                    ? `🎉 Obrigado, ${guestName}! Sua presença foi confirmada${companions > 0 ? ` com ${companions} acompanhante(s)` : ''}.`
                    : `😔 Obrigado por avisar, ${guestName}. Sentiremos sua falta!`;

                showNotification(message, 'success');
                setTimeout(() => {
                    renderGuestEvent(currentEvent);
                }, 2000);
            } catch (error) {
                showNotification('Erro ao salvar resposta: ' + error.message, 'error');
            }
        }

        function cancelResponse() {
            document.getElementById('responseForm').classList.add('hidden');
            document.getElementById('guestName').value = '';
            document.getElementById('companions').value = '0';
        }

        function getGuestResponse(eventId) {
            const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
            return responses[eventId] || null;
        }

        function canEditResponse(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const hoursPassed = (now - created) / (1000 * 60 * 60);
            return hoursPassed < 24;
        }

        function getRemainingEditTime(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const hoursPassed = (now - created) / (1000 * 60 * 60);
            const hoursRemaining = 24 - hoursPassed;
            
            if (hoursRemaining > 1) {
                return `${Math.floor(hoursRemaining)} horas`;
            } else {
                const minutesRemaining = Math.floor(hoursRemaining * 60);
                return `${minutesRemaining} minutos`;
            }
        }

        function editResponse() {
            const response = getGuestResponse(currentEvent.id);
            if (response && canEditResponse(response.created_at)) {
                currentAttending = response.attending;
                document.getElementById('guestName').value = response.guest_name;
                document.getElementById('companions').value = response.companions;
                document.getElementById('responseForm').classList.remove('hidden');
                if (response.attending) {
                    document.getElementById('companionsGroup').classList.remove('hidden');
                }
            }
        }

        // User Dashboard Functions
        async function showUserDashboard() {
            hideAllViews();
            document.getElementById('userDashboard').classList.remove('hidden');
            await loadUserEvents();
        }

        async function loadUserEvents() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const eventsHtml = events.map(event => {
                    const responseCount = event.response_count || 0;
                    const eventUrl = `${window.location.origin}${window.location.pathname}?event=${event.id}`;
                    
                    return `
                        <div class="event-card">
                            <h3>${event.name}</h3>
                            <p><strong>Data:</strong> ${formatDate(new Date(event.event_date))}</p>
                            <p><strong>Confirmações:</strong> ${responseCount}/${event.limit}</p>
                            <p><strong>Link:</strong> <a href="${eventUrl}" target="_blank">${eventUrl}</a></p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-small btn-secondary" onclick="editEvent('${event.id}')">Editar</button>
                                <button class="btn btn-small btn-primary" onclick="viewResponses('${event.id}')">Ver Respostas</button>
                                <button class="btn btn-small btn-success" onclick="downloadReport('${event.id}')">Baixar PDF</button>
                                <button class="btn btn-small btn-danger" onclick="deleteEvent('${event.id}')">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('userEvents').innerHTML = eventsHtml || '<p>Nenhum evento criado ainda.</p>';
            } catch (error) {
                showNotification('Erro ao carregar eventos: ' + error.message, 'error', 'userNotification');
            }
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const eventData = {
                name: document.getElementById('eventName').value,
                event_date: document.getElementById('eventDate').value,
                deadline: document.getElementById('eventDeadline').value,
                limit: parseInt(document.getElementById('eventLimit').value),
                description: document.getElementById('eventDescription').value,
                cover_enabled: document.getElementById('eventCoverEnabled').checked,
                user_id: currentUser.id
            };

            try {
                let coverUrl = null;
                const coverFile = document.getElementById('eventCover').files[0];
                
                if (eventData.cover_enabled && coverFile) {
                    const fileExt = coverFile.name.split('.').pop();
                    const fileName = `${Date.now()}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('event-covers')
                        .upload(fileName, coverFile);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('event-covers')
                        .getPublicUrl(fileName);
                    
                    coverUrl = urlData.publicUrl;
                }

                if (coverUrl) {
                    eventData.cover_url = coverUrl;
                }

                if (editingEventId) {
                    const { error } = await supabase
                        .from('events')
                        .update(eventData)
                        .eq('id', editingEventId);
                    
                    if (error) throw error;
                    showNotification('Evento atualizado com sucesso!', 'success', 'eventNotification');
                } else {
                    const { error } = await supabase
                        .from('events')
                        .insert([eventData]);
                    
                    if (error) throw error;
                    showNotification('Evento criado com sucesso!', 'success', 'eventNotification');
                }

                setTimeout(() => {
                    showUserDashboard();
                    editingEventId = null;
                }, 2000);
            } catch (error) {
                showNotification('Erro ao salvar evento: ' + error.message, 'error', 'eventNotification');
            }
        }

        async function editEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                editingEventId = eventId;
                document.getElementById('eventFormTitle').textContent = '✏️ Editar Evento';
                document.getElementById('eventName').value = event.name;
                document.getElementById('eventDate').value = event.event_date;
                document.getElementById('eventDeadline').value = event.deadline;
                document.getElementById('eventLimit').value = event.limit;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventCoverEnabled').checked = event.cover_enabled;
                
                toggleCoverUpload();
                showCreateEvent();
            } catch (error) {
                showNotification('Erro ao carregar evento: ' + error.message, 'error', 'userNotification');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;

            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                showNotification('Evento excluído com sucesso!', 'success', 'userNotification');
                await loadUserEvents();
            } catch (error) {
                showNotification('Erro ao excluir evento: ' + error.message, 'error', 'userNotification');
            }
        }

        async function viewResponses(eventId) {
            try {
                const { data: responses, error } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);

                let html = `
                    <div class="card">
                        <h3>📊 Resumo das Respostas</h3>
                        <p><strong>Confirmados:</strong> ${attending.length} pessoas + ${totalCompanions} acompanhantes = ${attending.length + totalCompanions} total</p>
                        <p><strong>Não comparecerão:</strong> ${notAttending.length}</p>
                        <p><strong>Total de respostas:</strong> ${responses.length}</p>
                        
                        <h4 style="margin-top: 20px;">✅ Confirmados</h4>
                        ${attending.map(r => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${r.guest_name}</strong>
                                ${r.companions > 0 ? ` + ${r.companions} acompanhante(s)` : ''}
                                <small style="color: #666; display: block;">Confirmado em: ${formatDate(new Date(r.created_at))}</small>
                            </div>
                        `).join('') || '<p>Nenhuma confirmação ainda.</p>'}
                        
                        <h4 style="margin-top: 20px;">❌ Não comparecerão</h4>
                        ${notAttending.map(r => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${r.guest_name}</strong>
                                <small style="color: #666; display: block;">Respondido em: ${formatDate(new Date(r.created_at))}</small>
                            </div>
                        `).join('') || '<p>Nenhuma resposta negativa.</p>'}
                        
                        <button class="btn btn-secondary" onclick="showUserDashboard()" style="margin-top: 20px;">Voltar</button>
                    </div>
                `;

                document.getElementById('userEvents').innerHTML = html;
            } catch (error) {
                showNotification('Erro ao carregar respostas: ' + error.message, 'error', 'userNotification');
            }
        }

        async function downloadReport(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error: responsesError } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (responsesError) throw responsesError;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(20);
                doc.text('Relatório do Evento', 20, 30);
                
                doc.setFontSize(16);
                doc.text(event.name, 20, 50);
                
                doc.setFontSize(12);
                doc.text(`Data do Evento: ${formatDate(new Date(event.event_date))}`, 20, 70);
                doc.text(`Gerado em: ${formatDate(new Date())}`, 20, 80);

                // Summary
                doc.setFontSize(14);
                doc.text('Resumo:', 20, 100);
                doc.setFontSize(12);
                doc.text(`Confirmados: ${attending.length} pessoas + ${totalCompanions} acompanhantes = ${attending.length + totalCompanions} total`, 20, 115);
                doc.text(`Não comparecerão: ${notAttending.length}`, 20, 125);
                doc.text(`Total de respostas: ${responses.length}`, 20, 135);

                // Confirmed list
                let yPos = 155;
                doc.setFontSize(14);
                doc.text('Lista de Confirmados:', 20, yPos);
                yPos += 15;

                doc.setFontSize(10);
                attending.forEach(response => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }
                    const text = `${response.guest_name}${response.companions > 0 ? ` + ${response.companions} acompanhante(s)` : ''}`;
                    doc.text(text, 20, yPos);
                    yPos += 10;
                });

                // Not attending list
                if (notAttending.length > 0) {
                    yPos += 10;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }
                    doc.setFontSize(14);
                    doc.text('Não comparecerão:', 20, yPos);
                    yPos += 15;

                    doc.setFontSize(10);
                    notAttending.forEach(response => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(response.guest_name, 20, yPos);
                        yPos += 10;
                    });
                }

                doc.save(`relatorio-${event.name.replace(/[^a-zA-Z0-9]/g, '-')}.pdf`);
            } catch (error) {
                showNotification('Erro ao gerar relatório: ' + error.message, 'error', 'userNotification');
            }
        }

        // Admin Functions
        async function showAdminDashboard() {
            hideAllViews();
            document.getElementById('adminDashboard').classList.remove('hidden');
            await loadAdminData();
        }

        async function loadAdminData() {
            try {
                // Load stats
                const { data: users } = await supabase.from('users').select('*');
                const { data: events } = await supabase.from('events').select('*');
                const { data: responses } = await supabase.from('responses').select('*');

                document.getElementById('totalUsers').textContent = users?.length || 0;
                document.getElementById('pendingUsers').textContent = users?.filter(u => !u.approved).length || 0;
                document.getElementById('totalEvents').textContent = events?.length || 0;
                document.getElementById('totalResponses').textContent = responses?.length || 0;

                // Load pending requests
                const pendingUsers = users?.filter(u => !u.approved) || [];
                const pendingHtml = pendingUsers.map(user => `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${user.name}</strong><br>
                        <small>Email: ${user.email} | Telefone: ${user.phone}</small><br>
                        <button class="btn btn-small btn-success" onclick="approveUser('${user.id}')">Aprovar</button>
                        <button class="btn btn-small btn-danger" onclick="rejectUser('${user.id}')">Rejeitar</button>
                    </div>
                `).join('');
                document.getElementById('pendingRequests').innerHTML = pendingHtml || '<p>Nenhuma solicitação pendente.</p>';

                // Load user management
                const approvedUsers = users?.filter(u => u.approved) || [];
                const usersHtml = approvedUsers.map(user => `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${user.name}</strong><br>
                        <small>Email: ${user.email} | Telefone: ${user.phone}</small><br>
                        <small>Status: ${user.active ? 'Ativo' : 'Inativo'}</small><br>
                        <button class="btn btn-small btn-secondary" onclick="loginAsUser('${user.id}')">Entrar como usuário</button>
                        <button class="btn btn-small ${user.active ? 'btn-danger' : 'btn-success'}" onclick="toggleUserStatus('${user.id}', ${!user.active})">
                            ${user.active ? 'Desativar' : 'Ativar'}
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="resetUserPassword('${user.id}')">Resetar Senha</button>
                    </div>
                `).join('');
                document.getElementById('userManagement').innerHTML = usersHtml || '<p>Nenhum usuário aprovado.</p>';

                // Load all events
                const eventsHtml = events?.map(event => `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${event.name}</strong><br>
                        <small>Data: ${formatDate(new Date(event.event_date))}</small><br>
                        <small>Criado por: ${users?.find(u => u.id === event.user_id)?.name || 'Usuário não encontrado'}</small><br>
                        <button class="btn btn-small btn-primary" onclick="viewEventResponses('${event.id}')">Ver Respostas</button>
                        <button class="btn btn-small btn-success" onclick="downloadEventReport('${event.id}')">Baixar PDF</button>
                        <button class="btn btn-small btn-danger" onclick="deleteEventAdmin('${event.id}')">Excluir</button>
                    </div>
                `).join('') || '<p>Nenhum evento criado.</p>';
                document.getElementById('allEvents').innerHTML = eventsHtml;

            } catch (error) {
                showNotification('Erro ao carregar dados: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ approved: true, active: true })
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usuário aprovado com sucesso!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao aprovar usuário: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function rejectUser(userId) {
            if (!confirm('Tem certeza que deseja rejeitar este usuário?')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usuário rejeitado e removido.', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao rejeitar usuário: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function toggleUserStatus(userId, active) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ active })
                    .eq('id', userId);

                if (error) throw error;

                showNotification(`Usuário ${active ? 'ativado' : 'desativado'} com sucesso!`, 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao alterar status: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function loginAsUser(userId) {
            try {
                const { data: user } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (user) {
                    // Simulate login as user
                    currentUser = { id: userId, email: user.email };
                    showUserDashboard();
                }
            } catch (error) {
                showNotification('Erro ao entrar como usuário: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function resetUserPassword(userId) {
            const newPassword = prompt('Digite a nova senha para o usuário:');
            if (!newPassword) return;

            try {
                // In a real implementation, you would use Supabase Admin API
                showNotification('Funcionalidade de reset de senha implementada via Admin API.', 'info', 'adminNotification');
            } catch (error) {
                showNotification('Erro ao resetar senha: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function viewEventResponses(eventId) {
            // Similar to viewResponses but for admin
            await viewResponses(eventId);
        }

        async function downloadEventReport(eventId) {
            // Similar to downloadReport but for admin
            await downloadReport(eventId);
        }

        async function deleteEventAdmin(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;
            await deleteEvent(eventId);
            await loadAdminData();
        }

        // View Management Functions
        function hideAllViews() {
            const views = ['guestView', 'loginView', 'registerView', 'userDashboard', 'createEventView', 'adminDashboard'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            document.getElementById('guestLoginLink').classList.add('hidden');
        }

        function showGuestView() {
            hideAllViews();
            document.getElementById('guestView').classList.remove('hidden');
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('event')) {
                document.getElementById('guestLoginLink').classList.remove('hidden');
            }
        }

        function showLogin() {
            hideAllViews();
            document.getElementById('loginView').classList.remove('hidden');
        }

        function showRegister() {
            hideAllViews();
            document.getElementById('registerView').classList.remove('hidden');
        }

        function showCreateEvent() {
            hideAllViews();
            document.getElementById('createEventView').classList.remove('hidden');
            if (!editingEventId) {
                document.getElementById('eventFormTitle').textContent = '🎉 Criar Evento';
                document.getElementById('eventForm').reset();
            }
        }

        function toggleCoverUpload() {
            const enabled = document.getElementById('eventCoverEnabled').checked;
            const uploadGroup = document.getElementById('coverUploadGroup');
            if (enabled) {
                uploadGroup.classList.remove('hidden');
            } else {
                uploadGroup.classList.add('hidden');
            }
        }

        // Utility Functions
        function showNotification(message, type, containerId = 'guestContent') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            if (containerId === 'guestContent') {
                container.insertBefore(notification, container.firstChild);
            } else {
                container.innerHTML = `<div class="notification ${type}">${message}</div>`;
            }

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function formatDate(date) {
            return date.toLocaleString('pt-BR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974e1494035677e0',t:'MTc1NjE1NjI3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
