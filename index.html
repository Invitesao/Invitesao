<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmação de Presença</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: #5aa189; }
        .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .btn-primary { background: #5aa189; }
        .btn-primary:hover { background: #4a8f77; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .message-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .tab-button.active { color: #5aa189; border-color: #5aa189; }
        .tab-button:not(.active) { color: #6b7280; border-color: transparent; }
        .tab-content.hidden { display: none; }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Header com botão de login -->
    <header class="w-full p-4 flex justify-between items-center">
        <div class="text-white font-semibold text-xl">
            <span id="event-title">Confirmação de Presença</span>
        </div>
        <button id="login-btn" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-300 backdrop-filter backdrop-blur-sm">
            Login Administrador
        </button>
    </header>

    <!-- Container principal -->
    <div class="container mx-auto px-4 py-8">
        <!-- Loading -->
        <div id="loading" class="flex justify-center items-center min-h-96">
            <div class="loading w-12 h-12 border-4 border-white border-t-transparent rounded-full"></div>
        </div>

        <!-- Página de confirmação para convidados -->
        <div id="guest-page" class="hidden fade-in">
            <div class="max-w-2xl mx-auto">
                <!-- Informações do evento -->
                <div class="bg-white rounded-2xl card-shadow p-8 mb-8 text-center">
                    <div class="mb-6">
                        <h1 id="couple-names" class="text-4xl font-bold text-gray-800 mb-2"></h1>
                        <p id="event-type" class="text-xl text-gray-600 mb-4"></p>
                        <p id="event-date" class="text-lg text-gray-500"></p>
                    </div>
                    
                    <!-- Cronômetro regressivo -->
                    <div class="mb-6">
                        <div class="text-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">⏰ Faltam apenas:</h3>
                        </div>
                        <div id="countdown" class="grid grid-cols-4 gap-4 max-w-lg mx-auto">
                            <div class="bg-white text-gray-800 rounded-xl p-4 text-center shadow-lg transform hover:scale-105 transition-all duration-300 border-2 border-gray-100">
                                <div id="days" class="text-3xl font-bold mb-1 text-gray-800">0</div>
                                <div class="text-sm uppercase tracking-wide text-gray-600">Dias</div>
                            </div>
                            <div class="bg-white text-gray-800 rounded-xl p-4 text-center shadow-lg transform hover:scale-105 transition-all duration-300 border-2 border-gray-100">
                                <div id="hours" class="text-3xl font-bold mb-1 text-gray-800">0</div>
                                <div class="text-sm uppercase tracking-wide text-gray-600">Horas</div>
                            </div>
                            <div class="bg-white text-gray-800 rounded-xl p-4 text-center shadow-lg transform hover:scale-105 transition-all duration-300 border-2 border-gray-100">
                                <div id="minutes" class="text-3xl font-bold mb-1 text-gray-800">0</div>
                                <div class="text-sm uppercase tracking-wide text-gray-600">Min</div>
                            </div>
                            <div class="bg-white text-gray-800 rounded-xl p-4 text-center shadow-lg transform hover:scale-105 transition-all duration-300 animate-pulse border-2 border-gray-100">
                                <div id="seconds" class="text-3xl font-bold mb-1 text-gray-800">0</div>
                                <div class="text-sm uppercase tracking-wide text-gray-600">Seg</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário de confirmação -->
                <div class="bg-white rounded-2xl card-shadow p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Confirme sua Presença</h2>
                    
                    <form id="rsvp-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seu Nome</label>
                            <input type="text" id="guest-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300" placeholder="Digite seu nome completo" style="--tw-ring-color: #5aa189;">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-4">Você irá ao evento?</label>
                            <div class="grid grid-cols-2 gap-4">
                                <button type="button" id="confirm-yes" class="p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition-all duration-300 text-center">
                                    <div class="text-2xl mb-2">✅</div>
                                    <div class="font-medium">Sim, estarei lá!</div>
                                </button>
                                <button type="button" id="confirm-no" class="p-4 border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all duration-300 text-center">
                                    <div class="text-2xl mb-2">❌</div>
                                    <div class="font-medium">Não poderei ir</div>
                                </button>
                            </div>
                        </div>

                        <div id="companion-section" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-4">Você levará acompanhante?</label>
                            <div class="grid grid-cols-2 gap-4">
                                <button type="button" id="companion-yes" class="p-3 border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all duration-300 text-center">
                                    <div class="font-medium">Sim, com acompanhante</div>
                                </button>
                                <button type="button" id="companion-no" class="p-3 border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all duration-300 text-center">
                                    <div class="font-medium">Sem acompanhante</div>
                                </button>
                            </div>
                        </div>

                        <div id="companion-name-section" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Acompanhante</label>
                            <input type="text" id="companion-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300" placeholder="Nome do seu acompanhante" style="--tw-ring-color: #5aa189;">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem para os Noivos (Opcional)</label>
                            <textarea id="guest-message" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300" placeholder="Deixe uma mensagem carinhosa..." style="--tw-ring-color: #5aa189;"></textarea>
                        </div>

                        <button type="submit" id="submit-btn" class="w-full btn-primary text-white py-4 rounded-lg font-semibold text-lg hover:shadow-lg transition-all duration-300">
                            Confirmar Presença
                        </button>
                    </form>
                </div>

                <!-- Mensagens dos convidados -->
                <div class="bg-white rounded-2xl card-shadow p-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Mensagens dos Convidados</h3>
                    <div id="messages-container" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Mensagens serão carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de administração -->
        <div id="admin-page" class="hidden fade-in">
            <div class="max-w-6xl mx-auto">
                <div class="bg-white rounded-2xl card-shadow p-8 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Painel do Evento</h1>
                        <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all duration-300">
                            Sair
                        </button>
                    </div>

                    <!-- Abas de navegação -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button id="guests-tab" class="tab-button active py-2 px-1 border-b-2 font-medium text-sm" style="border-color: #5aa189; color: #5aa189;">
                                👥 Lista de Convidados
                            </button>
                            <button id="messages-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                💬 Mensagens
                            </button>
                        </nav>
                    </div>

                    <!-- Conteúdo da aba de convidados -->
                    <div id="guests-content" class="tab-content">
                        <!-- Estatísticas -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-lg text-center border-2 border-gray-100 shadow-sm">
                                <div id="confirmed-count" class="text-3xl font-bold" style="color: #5aa189;">0</div>
                                <div class="text-gray-700">Confirmados</div>
                            </div>
                            <div class="bg-white p-6 rounded-lg text-center border-2 border-gray-100 shadow-sm">
                                <div id="declined-count" class="text-3xl font-bold text-gray-600">0</div>
                                <div class="text-gray-700">Não Confirmados</div>
                            </div>
                            <div class="bg-white p-6 rounded-lg text-center border-2 border-gray-100 shadow-sm">
                                <div id="total-count" class="text-3xl font-bold text-gray-800">0</div>
                                <div class="text-gray-700">Total de Respostas</div>
                            </div>
                        </div>

                        <!-- Botão de download PDF -->
                        <div class="flex justify-end mb-4">
                            <button id="download-pdf" class="text-white px-6 py-3 rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg" style="background-color: #5aa189;" onmouseover="this.style.backgroundColor='#4a8f77'" onmouseout="this.style.backgroundColor='#5aa189'">
                                📄 Baixar Lista em PDF
                            </button>
                        </div>

                        <!-- Lista de convidados -->
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Convidados</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full bg-white rounded-lg overflow-hidden shadow-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acompanhante</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="guests-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Convidados serão carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Conteúdo da aba de mensagens -->
                    <div id="messages-content" class="tab-content hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">💬 Mensagens dos Convidados</h2>
                            <p class="text-gray-600">Todas as mensagens carinhosas deixadas pelos seus convidados</p>
                        </div>
                        <div id="admin-messages-container" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Mensagens serão carregadas aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Login -->
        <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login Administrador</h2>
                <form id="login-form">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Token de Acesso</label>
                        <input type="password" id="admin-token" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300" placeholder="Digite o token do evento" style="--tw-ring-color: #5aa189;">
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-login" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-all duration-300">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 btn-primary text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all duration-300">
                            Entrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Sucesso -->
        <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
                <div class="text-6xl mb-4">🎉</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Presença Confirmada!</h2>
                <p class="text-gray-600 mb-6">Obrigado por confirmar sua presença. Estamos ansiosos para te ver no evento!</p>
                <button id="close-success" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all duration-300">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://bjyvawcwgzghtpzwkwag.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqeXZhd2N3Z3pnaHRwendrd2FnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MjQ4ODcsImV4cCI6MjA3MTIwMDg4N30.dMnWptSZqPcw2tC6sTmFxLH4_1X1LZkPCSVQBFOCA6Q';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variáveis globais
        let currentEvent = null;
        let isAdmin = false;
        let countdownInterval = null;

        // Elementos DOM
        const elements = {
            loading: document.getElementById('loading'),
            guestPage: document.getElementById('guest-page'),
            adminPage: document.getElementById('admin-page'),
            loginModal: document.getElementById('login-modal'),
            successModal: document.getElementById('success-modal'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            rsvpForm: document.getElementById('rsvp-form'),
            loginForm: document.getElementById('login-form'),
            confirmYes: document.getElementById('confirm-yes'),
            confirmNo: document.getElementById('confirm-no'),
            companionYes: document.getElementById('companion-yes'),
            companionNo: document.getElementById('companion-no'),
            companionSection: document.getElementById('companion-section'),
            companionNameSection: document.getElementById('companion-name-section')
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            const slug = getSlugFromURL();
            if (slug) {
                await loadEvent(slug);
            } else {
                showError('Evento não encontrado');
            }
            setupEventListeners();
        });

        // Extrair slug da URL
        function getSlugFromURL() {
            const path = window.location.pathname;
            return path.substring(1) || null;
        }

        // Carregar dados do evento
        async function loadEvent(slug) {
            try {
                let event = null;
                
                if (slug && slug !== '') {
                    // Tentar buscar por slug específico
                    const { data, error } = await supabase
                        .from('events')
                        .select('*')
                        .eq('slug', slug)
                        .single();
                    
                    if (error || !data) {
                        console.error('Evento não encontrado para slug:', slug, error);
                        showError('Evento não encontrado');
                        return;
                    }
                    
                    event = data;
                } else {
                    // Se não há slug, mostrar erro
                    showError('URL do evento não especificada');
                    return;
                }

                currentEvent = event;
                
                // Aplicar configurações padrão se não existirem
                if (!event.allow_companions) event.allow_companions = true;
                if (!event.max_companions) event.max_companions = 1;
                if (!event.companion_mode) event.companion_mode = 'yes_no'; // 'yes_no', 'quantity', 'disabled'
                if (!event.require_companion_names) event.require_companion_names = true;
                
                displayEventInfo(event);
                setupCompanionForm(event);
                startCountdown(event.event_date);
                await loadMessages();
                
                elements.loading.classList.add('hidden');
                elements.guestPage.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar evento:', error);
                showError('Erro ao carregar o evento');
            }
        }

        // Exibir informações do evento
        function displayEventInfo(event) {
            document.getElementById('couple-names').textContent = event.couple_names;
            document.getElementById('event-type').textContent = event.event_type;
            document.getElementById('event-date').textContent = formatDate(event.event_date);
            document.getElementById('event-title').textContent = `${event.couple_names} - ${event.event_type}`;
        }

        // Formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Contador regressivo
        function startCountdown(eventDate) {
            const targetDate = new Date(eventDate).getTime();
            
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').innerHTML = '<div class="col-span-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl p-6 text-center shadow-lg"><div class="text-3xl mb-2">🎉</div><div class="text-2xl font-bold">O evento já começou!</div></div>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('days').textContent = days;
                document.getElementById('hours').textContent = hours;
                document.getElementById('minutes').textContent = minutes;
                document.getElementById('seconds').textContent = seconds;
            }, 1000);
        }

        // Configurar formulário de acompanhantes baseado nas configurações do evento
        function setupCompanionForm(event) {
            const companionSection = elements.companionSection;
            const companionNameSection = elements.companionNameSection;
            
            // Se acompanhantes não são permitidos, esconder seção
            if (!event.allow_companions || event.companion_mode === 'disabled') {
                companionSection.style.display = 'none';
                return;
            }
            
            // Configurar baseado no modo
            if (event.companion_mode === 'quantity') {
                // Modo quantidade - mostrar seletor numérico
                setupQuantityMode(event.max_companions);
            } else {
                // Modo sim/não padrão
                setupYesNoMode();
            }
            
            // Configurar se nomes são obrigatórios
            if (!event.require_companion_names) {
                const companionNameInput = document.getElementById('companion-name');
                if (companionNameInput) {
                    companionNameInput.removeAttribute('required');
                    companionNameInput.placeholder = 'Nome do acompanhante (opcional)';
                }
            }
        }
        
        // Configurar modo sim/não para acompanhantes
        function setupYesNoMode() {
            const companionSection = elements.companionSection;
            companionSection.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-4">Você levará acompanhante?</label>
                <div class="grid grid-cols-2 gap-4">
                    <button type="button" id="companion-yes" class="p-3 border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all duration-300 text-center">
                        <div class="font-medium">Sim, com acompanhante</div>
                    </button>
                    <button type="button" id="companion-no" class="p-3 border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all duration-300 text-center">
                        <div class="font-medium">Sem acompanhante</div>
                    </button>
                </div>
            `;
            
            // Reconfigurar elementos
            elements.companionYes = document.getElementById('companion-yes');
            elements.companionNo = document.getElementById('companion-no');
            
            // Reconfigurar listeners
            elements.companionYes.addEventListener('click', () => selectCompanion(true));
            elements.companionNo.addEventListener('click', () => selectCompanion(false));
        }
        
        // Configurar modo quantidade para acompanhantes
        function setupQuantityMode(maxCompanions) {
            const companionSection = elements.companionSection;
            let optionsHTML = '';
            
            for (let i = 0; i <= maxCompanions; i++) {
                const label = i === 0 ? 'Sem acompanhante' : 
                             i === 1 ? '1 acompanhante' : 
                             `${i} acompanhantes`;
                optionsHTML += `
                    <button type="button" data-quantity="${i}" class="companion-quantity-btn p-3 border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all duration-300 text-center">
                        <div class="font-medium">${label}</div>
                    </button>
                `;
            }
            
            companionSection.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-4">Quantos acompanhantes você levará?</label>
                <div class="grid grid-cols-${Math.min(maxCompanions + 1, 4)} gap-2">
                    ${optionsHTML}
                </div>
            `;
            
            // Configurar listeners para botões de quantidade
            document.querySelectorAll('.companion-quantity-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const quantity = parseInt(btn.dataset.quantity);
                    selectCompanionQuantity(quantity);
                });
            });
        }
        
        // Selecionar quantidade de acompanhantes
        function selectCompanionQuantity(quantity) {
            // Resetar todos os botões
            document.querySelectorAll('.companion-quantity-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'bg-green-50');
                btn.style.borderColor = '#d1d5db';
                btn.style.backgroundColor = 'transparent';
            });
            
            // Ativar botão selecionado
            const selectedBtn = document.querySelector(`[data-quantity="${quantity}"]`);
            if (selectedBtn) {
                selectedBtn.style.borderColor = '#5aa189';
                selectedBtn.style.backgroundColor = '#f0f9ff';
            }
            
            // Configurar campos de nomes baseado na quantidade
            setupCompanionNameFields(quantity);
            
            // Salvar seleção
            elements.companionSection.dataset.selectedQuantity = quantity;
        }
        
        // Configurar campos de nomes dos acompanhantes
        function setupCompanionNameFields(quantity) {
            const companionNameSection = elements.companionNameSection;
            
            if (quantity === 0) {
                companionNameSection.classList.add('hidden');
                return;
            }
            
            companionNameSection.classList.remove('hidden');
            
            if (quantity === 1) {
                // Um acompanhante - campo simples
                companionNameSection.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Acompanhante</label>
                    <input type="text" id="companion-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300" placeholder="Nome do seu acompanhante" style="--tw-ring-color: #5aa189;">
                `;
            } else {
                // Múltiplos acompanhantes - campos múltiplos
                let fieldsHTML = `<label class="block text-sm font-medium text-gray-700 mb-2">Nomes dos Acompanhantes</label>`;
                
                for (let i = 1; i <= quantity; i++) {
                    fieldsHTML += `
                        <input type="text" id="companion-name-${i}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 mb-3" placeholder="Nome do ${i}º acompanhante" style="--tw-ring-color: #5aa189;">
                    `;
                }
                
                companionNameSection.innerHTML = fieldsHTML;
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Botões de confirmação
            elements.confirmYes.addEventListener('click', () => selectConfirmation(true));
            elements.confirmNo.addEventListener('click', () => selectConfirmation(false));

            // Botões de acompanhante
            elements.companionYes.addEventListener('click', () => selectCompanion(true));
            elements.companionNo.addEventListener('click', () => selectCompanion(false));

            // Formulários
            elements.rsvpForm.addEventListener('submit', handleRSVPSubmit);
            elements.loginForm.addEventListener('submit', handleLogin);

            // Botões de modal
            elements.loginBtn.addEventListener('click', () => elements.loginModal.classList.remove('hidden'));
            elements.logoutBtn.addEventListener('click', logout);
            document.getElementById('cancel-login').addEventListener('click', () => elements.loginModal.classList.add('hidden'));
            document.getElementById('close-success').addEventListener('click', () => elements.successModal.classList.add('hidden'));

            // Abas do painel admin
            document.getElementById('guests-tab').addEventListener('click', () => switchTab('guests'));
            document.getElementById('messages-tab').addEventListener('click', () => switchTab('messages'));

            // Download PDF
            document.getElementById('download-pdf').addEventListener('click', generatePDF);
        }

        // Selecionar confirmação
        function selectConfirmation(confirmed) {
            elements.confirmYes.classList.remove('border-green-500', 'bg-green-50');
            elements.confirmNo.classList.remove('border-red-500', 'bg-red-50');

            if (confirmed) {
                elements.confirmYes.style.borderColor = '#5aa189';
                elements.confirmYes.style.backgroundColor = '#f0f9ff';
                elements.companionSection.classList.remove('hidden');
            } else {
                elements.confirmNo.style.borderColor = '#6b7280';
                elements.confirmNo.style.backgroundColor = '#f9fafb';
                elements.companionSection.classList.add('hidden');
                elements.companionNameSection.classList.add('hidden');
            }

            elements.confirmYes.dataset.selected = confirmed;
            elements.confirmNo.dataset.selected = !confirmed;
        }

        // Selecionar acompanhante
        function selectCompanion(hasCompanion) {
            elements.companionYes.classList.remove('border-purple-500', 'bg-purple-50');
            elements.companionNo.classList.remove('border-purple-500', 'bg-purple-50');

            if (hasCompanion) {
                elements.companionYes.classList.add('border-purple-500', 'bg-purple-50');
                elements.companionNameSection.classList.remove('hidden');
            } else {
                elements.companionNo.classList.add('border-purple-500', 'bg-purple-50');
                elements.companionNameSection.classList.add('hidden');
            }

            elements.companionYes.dataset.selected = hasCompanion;
            elements.companionNo.dataset.selected = !hasCompanion;
        }

        // Submeter confirmação de presença
        async function handleRSVPSubmit(e) {
            e.preventDefault();

            const guestName = document.getElementById('guest-name').value;
            const confirmed = elements.confirmYes.dataset.selected === 'true';
            const message = document.getElementById('guest-message').value;

            if (!guestName) {
                alert('Por favor, digite seu nome');
                return;
            }

            if (elements.confirmYes.dataset.selected === undefined && elements.confirmNo.dataset.selected === undefined) {
                alert('Por favor, confirme se você irá ao evento');
                return;
            }

            // Coletar dados de acompanhantes baseado no modo configurado
            let companionData = getCompanionData();

            try {
                // Salvar RSVP no Supabase
                const { data: rsvpData, error: rsvpError } = await supabase
                    .from('rsvps')
                    .upsert({
                        event_id: currentEvent.id,
                        guest_name: guestName,
                        confirmed: confirmed,
                        has_companion: companionData.hasCompanion,
                        companion_count: companionData.count,
                        companion_name: companionData.names.length === 1 ? companionData.names[0] : null,
                        companion_names: companionData.names.length > 1 ? JSON.stringify(companionData.names) : null
                    }, {
                        onConflict: 'event_id,guest_name'
                    });

                if (rsvpError) {
                    console.error('Erro ao salvar RSVP:', rsvpError);
                    alert('Erro ao salvar confirmação. Tente novamente.');
                    return;
                }

                // Salvar mensagem se fornecida
                if (message && message.trim()) {
                    const { error: messageError } = await supabase
                        .from('messages')
                        .insert({
                            event_id: currentEvent.id,
                            guest_name: guestName,
                            message: message.trim()
                        });

                    if (messageError) {
                        console.error('Erro ao salvar mensagem:', messageError);
                    }
                }

                await loadMessages(); // Recarregar mensagens
                elements.successModal.classList.remove('hidden');
                elements.rsvpForm.reset();
                resetFormSelections();

            } catch (error) {
                console.error('Erro ao salvar confirmação:', error);
                alert('Erro ao salvar confirmação. Tente novamente.');
            }
        }
        
        // Coletar dados de acompanhantes baseado na configuração
        function getCompanionData() {
            const companionData = {
                hasCompanion: false,
                count: 0,
                names: []
            };
            
            // Se acompanhantes não são permitidos
            if (!currentEvent.allow_companions || currentEvent.companion_mode === 'disabled') {
                return companionData;
            }
            
            if (currentEvent.companion_mode === 'quantity') {
                // Modo quantidade
                const selectedQuantity = elements.companionSection.dataset.selectedQuantity;
                if (selectedQuantity && parseInt(selectedQuantity) > 0) {
                    companionData.hasCompanion = true;
                    companionData.count = parseInt(selectedQuantity);
                    
                    // Coletar nomes
                    if (companionData.count === 1) {
                        const nameInput = document.getElementById('companion-name');
                        if (nameInput && nameInput.value.trim()) {
                            companionData.names.push(nameInput.value.trim());
                        }
                    } else {
                        for (let i = 1; i <= companionData.count; i++) {
                            const nameInput = document.getElementById(`companion-name-${i}`);
                            if (nameInput && nameInput.value.trim()) {
                                companionData.names.push(nameInput.value.trim());
                            }
                        }
                    }
                }
            } else {
                // Modo sim/não tradicional
                const hasCompanion = elements.companionYes && elements.companionYes.dataset.selected === 'true';
                if (hasCompanion) {
                    companionData.hasCompanion = true;
                    companionData.count = 1;
                    
                    const nameInput = document.getElementById('companion-name');
                    if (nameInput && nameInput.value.trim()) {
                        companionData.names.push(nameInput.value.trim());
                    }
                }
            }
            
            return companionData;
        }

        // Resetar seleções do formulário
        function resetFormSelections() {
            elements.confirmYes.classList.remove('border-green-500', 'bg-green-50');
            elements.confirmNo.classList.remove('border-red-500', 'bg-red-50');
            elements.companionYes.classList.remove('border-purple-500', 'bg-purple-50');
            elements.companionNo.classList.remove('border-purple-500', 'bg-purple-50');
            elements.companionSection.classList.add('hidden');
            elements.companionNameSection.classList.add('hidden');
            delete elements.confirmYes.dataset.selected;
            delete elements.confirmNo.dataset.selected;
            delete elements.companionYes.dataset.selected;
            delete elements.companionNo.dataset.selected;
        }

        // Carregar mensagens
        async function loadMessages() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Erro ao carregar mensagens:', error);
                    return;
                }

                displayMessages(messages || []);
            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }

        // Exibir mensagens
        function displayMessages(messages) {
            const container = document.getElementById('messages-container');
            const adminContainer = document.getElementById('admin-messages-container');
            
            const messagesHTML = messages.map(msg => `
                <div class="message-card p-4 rounded-lg border-l-4" style="border-left-color: #5aa189;">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-800">${msg.guest_name}</h4>
                        <span class="text-sm text-gray-500">${formatMessageDate(msg.created_at)}</span>
                    </div>
                    <p class="text-gray-700">${msg.message}</p>
                </div>
            `).join('');

            container.innerHTML = messagesHTML || '<p class="text-gray-500 text-center">Ainda não há mensagens.</p>';
            if (adminContainer) {
                adminContainer.innerHTML = messagesHTML || '<p class="text-gray-500 text-center">Ainda não há mensagens.</p>';
            }
        }

        // Formatar data da mensagem
        function formatMessageDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Login do administrador
        async function handleLogin(e) {
            e.preventDefault();
            const token = document.getElementById('admin-token').value;

            if (token === currentEvent.admin_token) {
                isAdmin = true;
                elements.loginModal.classList.add('hidden');
                await showAdminPage();
            } else {
                alert('Token inválido');
            }
        }

        // Mostrar página de administração
        async function showAdminPage() {
            elements.guestPage.classList.add('hidden');
            elements.adminPage.classList.remove('hidden');
            await loadAdminData();
        }

        // Carregar dados de administração
        async function loadAdminData() {
            try {
                const { data: guests, error } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Erro ao carregar convidados:', error);
                    return;
                }

                displayGuestStats(guests || []);
                displayGuestsList(guests || []);
                await loadMessages();
            } catch (error) {
                console.error('Erro ao carregar dados de administração:', error);
            }
        }

        // Exibir estatísticas
        function displayGuestStats(guests) {
            const confirmed = guests.filter(g => g.confirmed).length;
            const declined = guests.filter(g => !g.confirmed).length;
            const total = guests.length;

            document.getElementById('confirmed-count').textContent = confirmed;
            document.getElementById('declined-count').textContent = declined;
            document.getElementById('total-count').textContent = total;
        }

        // Exibir lista de convidados
        function displayGuestsList(guests) {
            const tbody = document.getElementById('guests-table');
            
            const guestsHTML = guests.map(guest => {
                // Processar nomes de acompanhantes
                let companionDisplay = '';
                if (guest.has_companion) {
                    if (guest.companion_count > 1 && guest.companion_names) {
                        // Múltiplos acompanhantes
                        try {
                            const names = JSON.parse(guest.companion_names);
                            companionDisplay = names.map(name => `+ ${name}`).join('<br>');
                        } catch (e) {
                            companionDisplay = `+ ${guest.companion_count} acompanhante(s)`;
                        }
                    } else if (guest.companion_name) {
                        // Um acompanhante com nome
                        companionDisplay = `+ ${guest.companion_name}`;
                    } else {
                        // Acompanhante sem nome especificado
                        const count = guest.companion_count || 1;
                        companionDisplay = `+ ${count} acompanhante${count > 1 ? 's' : ''}`;
                    }
                }
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${guest.guest_name}</div>
                            ${companionDisplay ? `<div class="text-sm text-gray-500">${companionDisplay}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${guest.confirmed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${guest.confirmed ? 'Confirmado' : 'Não Confirmado'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${guest.has_companion ? `${guest.companion_count || 1}` : 'Não'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatMessageDate(guest.created_at)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="deleteGuest(${guest.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = guestsHTML || '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum convidado ainda</td></tr>';
        }

        // Excluir convidado
        async function deleteGuest(guestId) {
            if (confirm('Tem certeza que deseja excluir este convidado?')) {
                try {
                    const { error } = await supabase
                        .from('rsvps')
                        .delete()
                        .eq('id', guestId);

                    if (error) {
                        console.error('Erro ao excluir convidado:', error);
                        alert('Erro ao excluir convidado');
                        return;
                    }

                    await loadAdminData(); // Recarregar dados
                } catch (error) {
                    console.error('Erro ao excluir convidado:', error);
                    alert('Erro ao excluir convidado');
                }
            }
        }

        // Logout
        function logout() {
            isAdmin = false;
            elements.adminPage.classList.add('hidden');
            elements.guestPage.classList.remove('hidden');
        }

        // Alternar entre abas
        function switchTab(tabName) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('active');
                tab.classList.add('text-gray-500', 'border-transparent');
                tab.style.color = '#6b7280';
                tab.style.borderColor = 'transparent';
            });

            // Esconder todo o conteúdo
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Ativar aba selecionada
            if (tabName === 'guests') {
                const guestsTab = document.getElementById('guests-tab');
                guestsTab.classList.add('active');
                guestsTab.classList.remove('text-gray-500', 'border-transparent');
                guestsTab.style.color = '#5aa189';
                guestsTab.style.borderColor = '#5aa189';
                document.getElementById('guests-content').classList.remove('hidden');
            } else if (tabName === 'messages') {
                const messagesTab = document.getElementById('messages-tab');
                messagesTab.classList.add('active');
                messagesTab.classList.remove('text-gray-500', 'border-transparent');
                messagesTab.style.color = '#5aa189';
                messagesTab.style.borderColor = '#5aa189';
                document.getElementById('messages-content').classList.remove('hidden');
            }
        }

        // Gerar PDF da lista de convidados
        async function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configurações do PDF
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                let yPosition = 30;

                // Título do documento
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(`Lista de Convidados - ${currentEvent.couple_names}`, margin, yPosition);
                
                yPosition += 10;
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(`${currentEvent.event_type} - ${formatDate(currentEvent.event_date)}`, margin, yPosition);
                
                yPosition += 20;

                // Buscar dados atualizados
                const { data: guests, error } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .order('confirmed', { ascending: false })
                    .order('guest_name', { ascending: true });

                if (error) {
                    alert('Erro ao gerar PDF');
                    return;
                }

                const confirmedGuests = guests.filter(g => g.confirmed);
                const declinedGuests = guests.filter(g => !g.confirmed);

                // Estatísticas
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('📊 RESUMO:', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.text(`✅ Confirmados: ${confirmedGuests.length}`, margin, yPosition);
                yPosition += 6;
                doc.text(`❌ Não Confirmados: ${declinedGuests.length}`, margin, yPosition);
                yPosition += 6;
                doc.text(`📋 Total de Respostas: ${guests.length}`, margin, yPosition);
                yPosition += 20;

                // Função para adicionar seção
                function addSection(title, guestList, emoji) {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 30;
                    }

                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${emoji} ${title} (${guestList.length})`, margin, yPosition);
                    yPosition += 15;

                    if (guestList.length === 0) {
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'italic');
                        doc.text('Nenhum convidado nesta categoria', margin + 5, yPosition);
                        yPosition += 15;
                        return;
                    }

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');

                    guestList.forEach((guest, index) => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 30;
                        }

                        const guestText = `${index + 1}. ${guest.guest_name}`;
                        let companionText = '';
                        
                        // Processar acompanhantes para o PDF
                        if (guest.has_companion) {
                            if (guest.companion_count > 1 && guest.companion_names) {
                                try {
                                    const names = JSON.parse(guest.companion_names);
                                    companionText = ` + ${names.join(', ')}`;
                                } catch (e) {
                                    companionText = ` + ${guest.companion_count} acompanhante(s)`;
                                }
                            } else if (guest.companion_name) {
                                companionText = ` + ${guest.companion_name}`;
                            } else {
                                const count = guest.companion_count || 1;
                                companionText = ` + ${count} acompanhante${count > 1 ? 's' : ''}`;
                            }
                        }
                        
                        const dateText = ` (${formatMessageDate(guest.created_at)})`;
                        
                        doc.text(guestText, margin + 5, yPosition);
                        
                        if (companionText) {
                            doc.setFont(undefined, 'italic');
                            doc.text(companionText, margin + 5 + doc.getTextWidth(guestText), yPosition);
                            doc.setFont(undefined, 'normal');
                        }
                        
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(dateText, pageWidth - margin - doc.getTextWidth(dateText), yPosition);
                        doc.setTextColor(0);
                        doc.setFontSize(10);
                        
                        yPosition += 8;
                    });

                    yPosition += 10;
                }

                // Adicionar seções
                addSection('CONVIDADOS CONFIRMADOS', confirmedGuests, '✅');
                addSection('CONVIDADOS NÃO CONFIRMADOS', declinedGuests, '❌');

                // Rodapé
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`Página ${i} de ${totalPages}`, pageWidth - margin - 20, doc.internal.pageSize.height - 10);
                    doc.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, margin, doc.internal.pageSize.height - 10);
                }

                // Salvar PDF
                const fileName = `Lista_Convidados_${currentEvent.couple_names.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Tente novamente.');
            }
        }

        // Mostrar erro
        function showError(message) {
            elements.loading.classList.add('hidden');
            document.body.innerHTML = `
                <div class="min-h-screen flex items-center justify-center gradient-bg">
                    <div class="bg-white rounded-2xl p-8 text-center card-shadow">
                        <div class="text-6xl mb-4">😔</div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-4">Oops!</h1>
                        <p class="text-gray-600">${message}</p>
                    </div>
                </div>
            `;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'971b91d232bc77e3',t:'MTc1NTYyNjYyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
