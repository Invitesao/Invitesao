<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>InvitesQR - Painel de Clientes</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: white;
    }
    .container {
      max-width: 700px;
      margin: 2rem auto;
      padding: 2rem;
      background: #1e1e1e;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    h2, h3 {
      text-align: center;
      color: #00ffd5;
    }
    input, button, select, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 6px;
    }
    input, textarea {
      background: #2a2a2a;
      color: white;
    }
    button {
      background: #00ffd5;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 8px;
      border: 1px solid #444;
    }
    th {
      background: #2e2e2e;
      color: #00ffd5;
    }
    .hidden { display: none; }
    .forgot-password { color: #ccc; text-align: center; cursor: pointer; font-size: 0.9em; margin-top: -10px; }
    .forgot-password:hover { text-decoration: underline; color: #00ffd5; }
  </style>
</head>
<body>
<div class="container" id="login-box">
  <h2>Login Admin</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="senha" placeholder="Senha">
  <button onclick="logar()">Entrar</button>
  <div class="forgot-password" onclick="recuperarSenha()">Esqueci minha senha</div>
</div>

<div class="container hidden" id="painel">
  <h2>Controle de Clientes</h2>

  <h3>Cadastrar Cliente</h3>
  <input type="text" id="nome_cliente" placeholder="Nome do cliente">
  <input type="number" id="limite_scan" placeholder="Limite de scans (ex: 50)">
  <input type="date" id="validade_token" placeholder="Validade do token">
  <input type="text" id="device_id" placeholder="ID do dispositivo (opcional)">
  <button onclick="cadastrarCliente()">Salvar Cliente</button>

  <h3>Importar Convidados (.txt)</h3>
  <select id="cliente_select"></select>
  <input type="file" id="convidados_file" accept=".txt">
  <button onclick="importarConvidadosArquivo()">Importar Lista</button>

  <h3>Clientes Ativos</h3>
  <table>
    <thead>
      <tr><th>Nome</th><th>Token</th><th>Dispositivo</th><th>Scans</th><th>Limite</th><th>Validade</th><th>AÃ§Ãµes</th></tr>
    </thead>
    <tbody id="lista-clientes"></tbody>
  </table>

  <h3>Logs de Acesso</h3>
  <table>
    <thead>
      <tr><th>Token</th><th>Data</th><th>Dispositivo</th><th>Status</th></tr>
    </thead>
    <tbody id="logs-uso"></tbody>
  </table>

  <button onclick="exportarCSV()">ðŸ“„ Exportar CSV</button>
  <button onclick="logout()">Sair</button>
</div>

<script>
  const supabase = supabase.createClient(
    'https://rnvunprjvppbjavkaoek.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8'
  );

  async function logar() {
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: senha });
    if (error || !data.session) {
      alert('Credenciais invÃ¡lidas');
      return;
    }
    document.getElementById('login-box').classList.add('hidden');
    document.getElementById('painel').classList.remove('hidden');
    listarClientes();
    listarLogs();
  }

  async function recuperarSenha() {
    const email = document.getElementById('email').value;
    if (!email) return alert('Digite seu email para recuperar a senha.');
    const { error } = await supabase.auth.resetPasswordForEmail(email);
    if (error) return alert('Erro ao enviar e-mail: ' + error.message);
    alert('Um e-mail de redefiniÃ§Ã£o foi enviado.');
  }

  function logout() {
    supabase.auth.signOut();
    document.getElementById('painel').classList.add('hidden');
    document.getElementById('login-box').classList.remove('hidden');
  }

  function gerarTokenUnico() {
    return 'TKN-' + Math.random().toString(36).substring(2, 10).toUpperCase();
  }

  async function cadastrarCliente() {
    const nome = document.getElementById('nome_cliente').value;
    const limite = parseInt(document.getElementById('limite_scan').value);
    const validade = document.getElementById('validade_token').value;
    const device_id = document.getElementById('device_id').value || null;
    if (!nome || !limite || !validade) return alert('Preencha todos os campos obrigatÃ³rios');
    const token = gerarTokenUnico();
    const { error } = await supabase.from('clientes').insert([{ nome, token, limite_scan: limite, scans_feitos: 0, validade_token: validade, device_id }]);
    if (error) return alert('Erro: ' + error.message);
    listarClientes();
    document.getElementById('nome_cliente').value = '';
    document.getElementById('limite_scan').value = '';
    document.getElementById('validade_token').value = '';
    document.getElementById('device_id').value = '';
  }

  async function listarClientes() {
    const { data } = await supabase.from('clientes').select('*').order('nome');
    const tabela = document.getElementById('lista-clientes');
    const select = document.getElementById('cliente_select');
    tabela.innerHTML = '';
    select.innerHTML = '<option value="">Selecione o cliente</option>';
    data.forEach(c => {
      tabela.innerHTML += `<tr>
        <td>${c.nome}</td>
        <td>${c.token}</td>
        <td>${c.device_id || '-'}</td>
        <td>${c.scans_feitos}</td>
        <td>${c.limite_scan}</td>
        <td>${c.validade_token || '-'}</td>
        <td><button onclick="removerCliente('${c.id}')">Remover</button></td>
      </tr>`;
      select.innerHTML += `<option value="${c.token}">${c.nome}</option>`;
    });
  }

  async function removerCliente(id) {
    if (!confirm('Remover este cliente?')) return;
    await supabase.from('clientes').delete().eq('id', id);
    listarClientes();
  }

  async function listarLogs() {
    const { data } = await supabase.from('log_uso').select('*').order('data', { ascending: false });
    const tabela = document.getElementById('logs-uso');
    tabela.innerHTML = '';
    data.forEach(log => {
      tabela.innerHTML += `<tr>
        <td>${log.token}</td>
        <td>${log.data}</td>
        <td>${log.device_id || '-'}</td>
        <td>${log.status}</td>
      </tr>`;
    });
  }

  async function importarConvidadosArquivo() {
    const token = document.getElementById('cliente_select').value;
    const arquivo = document.getElementById('convidados_file').files[0];
    if (!token || !arquivo) return alert('Selecione um cliente e um arquivo .txt');
    const leitor = new FileReader();
    leitor.onload = async function(e) {
      const linhas = e.target.result.split('\n');
      const convidados = linhas.map(l => {
        const partes = l.trim().split('|');
        return { nome: partes[0], codigo: partes[1], foi_usado: false, token };
      }).filter(c => c.nome && c.codigo);
      const { error } = await supabase.from('convidados').insert(convidados);
      if (error) return alert('Erro ao importar: ' + error.message);
      alert('Convidados importados com sucesso');
    };
    leitor.readAsText(arquivo);
  }

  function exportarCSV() {
    supabase.from('clientes').select('*').then(({ data }) => {
      let csv = 'Nome,Token,Device ID,Scans Feitos,Limite,Validade\n';
      data.forEach(c => {
        csv += `${c.nome},${c.token},${c.device_id || '-'},${c.scans_feitos},${c.limite_scan},${c.validade_token}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'clientes.csv';
      a.click();
    });
  }
</script>
</body>
</html>
