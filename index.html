<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invites - Confirma√ß√£o de Presen√ßa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        .font-dancing { font-family: 'Dancing Script', cursive; }
        .font-inter { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .wedding-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(238, 90, 36, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }
        
        .admin-panel {
            background: linear-gradient(135deg, #2c3e50, #3498db);
        }
        
        .loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="font-inter min-h-screen gradient-bg relative">

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="font-dancing text-6xl text-white mb-4">üíç Invites</h1>
            <p class="text-xl text-white/90 max-w-2xl mx-auto">
                Crie sites √∫nicos para confirma√ß√£o de presen√ßa. Seus clientes recebem um link personalizado para gerenciar tudo!
            </p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center mb-8">
            <div class="wedding-card rounded-full p-2 flex flex-col sm:flex-row gap-2">
                <button onclick="showSection('home')" id="nav-home" class="px-4 py-2 sm:px-6 sm:py-3 rounded-full bg-pink-500 text-white font-medium text-sm sm:text-base">
                    üè† In√≠cio
                </button>
                <button onclick="showSection('create')" id="nav-create" class="px-4 py-2 sm:px-6 sm:py-3 rounded-full text-gray-600 hover:bg-gray-100 font-medium text-sm sm:text-base">
                    ‚ûï Criar Convite
                </button>
                <button onclick="showSection('login')" id="nav-login" class="px-4 py-2 sm:px-6 sm:py-3 rounded-full text-gray-600 hover:bg-gray-100 font-medium text-sm sm:text-base">
                    üîê Login Cliente
                </button>
            </div>
        </nav>

        <!-- Home Section -->
        <section id="home-section" class="max-w-4xl mx-auto">
            <div class="wedding-card rounded-3xl p-8 mb-8">
                <div class="text-center">
                    <h2 class="font-dancing text-4xl text-gray-800 mb-6">Como Funciona</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üé®</div>
                            <h3 class="text-xl font-semibold mb-2">1. Crie o Convite</h3>
                            <p class="text-gray-600">Preencha os dados do evento e crie um convite personalizado</p>
                        </div>
                        <div class="text-center">
                            <div class="text-6xl mb-4">üîó</div>
                            <h3 class="text-xl font-semibold mb-2">2. Envie o Link</h3>
                            <p class="text-gray-600">Receba um link √∫nico para enviar aos seus clientes</p>
                        </div>
                        <div class="text-center">
                            <div class="text-6xl mb-4">üë•</div>
                            <h3 class="text-xl font-semibold mb-2">3. Controle Total</h3>
                            <p class="text-gray-600">Seus clientes fazem login e gerenciam confirma√ß√µes de presen√ßa</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demo Wedding Site -->
            <div class="wedding-card rounded-3xl p-8">
                <h3 class="font-dancing text-3xl text-center text-gray-800 mb-6">Exemplo de Convite Criado</h3>
                <div class="bg-gradient-to-r from-pink-100 to-purple-100 rounded-2xl p-6">
                    <div class="text-center">
                        <h4 class="font-dancing text-4xl text-gray-800 mb-2">Maria & Jo√£o</h4>
                        <p class="text-gray-600 mb-4">üìÖ 15 de Junho, 2024 ‚Ä¢ üïï 18:00</p>

                        <div class="bg-white rounded-xl p-4 mb-4">
                            <h5 class="font-semibold mb-2">Confirme sua Presen√ßa</h5>
                            <div class="flex gap-2 justify-center">
                                <button class="bg-green-500 text-white px-4 py-2 rounded-lg">‚úÖ Confirmo</button>
                                <button class="bg-red-500 text-white px-4 py-2 rounded-lg">‚ùå N√£o Posso</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500">Este √© um exemplo de como fica o site do cliente</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Create Wedding Site Section -->
        <section id="create-section" class="max-w-2xl mx-auto hidden">
            <div class="wedding-card rounded-3xl p-8">
                <h2 class="font-dancing text-4xl text-center text-gray-800 mb-8">Criar Novo Convite</h2>
                
                <form id="weddingForm" class="space-y-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Noivo *</label>
                            <input type="text" id="groomName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Noiva *</label>
                            <input type="text" id="brideName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data do Casamento *</label>
                        <input type="date" id="weddingDate" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hor√°rio *</label>
                        <input type="time" id="weddingTime" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Local do Evento *</label>
                        <input type="text" id="eventVenue" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio para Login *</label>
                            <input type="text" id="username" required placeholder="Ex: maria_joao" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Senha *</label>
                            <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                        </div>
                    </div>

                    <button type="submit" id="createButton" class="w-full btn-primary text-white py-4 rounded-xl font-semibold text-lg">
                        üéâ Criar Convite
                    </button>
                </form>

                <!-- Success Message -->
                <div id="success-message" class="hidden mt-6 p-6 bg-green-100 border border-green-300 rounded-xl">
                    <h3 class="font-semibold text-green-800 mb-2">‚úÖ Convite Criado com Sucesso!</h3>
                    <p class="text-green-700 mb-4">Envie este link para seus clientes:</p>
                    <div class="bg-white p-3 rounded-lg border">
                        <code id="generated-url" class="text-sm text-blue-600"></code>
                    </div>
                    <button onclick="copyUrl()" class="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        üìã Copiar Link
                    </button>
                </div>
            </div>
        </section>

        <!-- Client Login Section -->
        <section id="login-section" class="max-w-md mx-auto hidden">
            <div class="wedding-card rounded-3xl p-8">
                <h2 class="font-dancing text-4xl text-center text-gray-800 mb-8">Login do Cliente</h2>
                
                <form id="adminLoginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usu√°rio</label>
                        <input type="text" id="loginUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                    </div>

                    <div id="loginError" class="text-red-500 text-sm hidden"></div>

                    <button type="submit" id="loginButton" class="w-full btn-primary text-white py-4 rounded-xl font-semibold text-lg">
                        üîê Entrar no Painel
                    </button>
                </form>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="dashboard-section" class="hidden">
            <div class="admin-panel rounded-3xl p-8 text-white mb-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="font-dancing text-4xl mb-2">Painel do Convite</h2>
                        <p id="wedding-info" class="text-blue-100"></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyWeddingUrl()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg text-white">
                            üìã Copiar Link
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg">
                            üö™ Sair
                        </button>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white/10 rounded-xl p-6 text-center">
                        <div class="text-3xl mb-2">üë•</div>
                        <div class="text-2xl font-bold" id="total-guests">0</div>
                        <div class="text-sm text-blue-100">Total de Convidados</div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-6 text-center">
                        <div class="text-3xl mb-2">‚úÖ</div>
                        <div class="text-2xl font-bold" id="confirmed-guests">0</div>
                        <div class="text-sm text-blue-100">Confirmados</div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-6 text-center">
                        <div class="text-3xl mb-2">üíå</div>
                        <div class="text-2xl font-bold" id="total-messages">0</div>
                        <div class="text-sm text-blue-100">Mensagens</div>
                    </div>
                </div>
            </div>

            <!-- Edit Wedding Info -->
            <div class="wedding-card rounded-3xl p-8 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800">Editar Informa√ß√µes do Convite</h3>
                    <button onclick="toggleEditMode()" id="edit-toggle-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                        ‚úèÔ∏è Editar
                    </button>
                </div>
                
                <div id="edit-form" class="hidden space-y-4 mb-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Noivo</label>
                            <input type="text" id="edit-groom-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Noiva</label>
                            <input type="text" id="edit-bride-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data do Casamento</label>
                        <input type="date" id="edit-wedding-date" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hor√°rio</label>
                        <input type="time" id="edit-wedding-time" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Local do Evento</label>
                        <input type="text" id="edit-event-venue" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem Personalizada (opcional)</label>
                        <textarea id="edit-custom-message" placeholder="Ex: Venha celebrar conosco este momento especial..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 h-24"></textarea>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="saveWeddingInfo()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold">
                            üíæ Salvar Altera√ß√µes
                        </button>
                        <button onclick="cancelEdit()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
                
                <div id="wedding-preview" class="bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl p-6">
                    <!-- Wedding site preview will be loaded here -->
                </div>
                
                <div class="flex gap-2 mt-4 justify-center">
                    <button onclick="copyWeddingUrl()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        üìã Copiar Link
                    </button>
                    <button onclick="openWeddingSite()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        üåê Abrir Site
                    </button>
                </div>
            </div>

            <!-- Guest List -->
            <div class="wedding-card rounded-3xl p-8 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800">Lista de Convidados</h3>
                    <button onclick="downloadGuestReport()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        üìä Baixar Relat√≥rio
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Nome</th>
                                <th class="text-left py-3 px-4">Acompanhante</th>
                                <th class="text-left py-3 px-4">Status</th>
                                <th class="text-left py-3 px-4">Data</th>
                            </tr>
                        </thead>
                        <tbody id="guest-list">
                            <!-- Guest list will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Messages -->
            <div class="wedding-card rounded-3xl p-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Mensagens dos Convidados</h3>
                <div id="messages-list" class="space-y-4">
                    <!-- Messages will be populated here -->
                </div>
            </div>
        </section>

        <!-- Wedding Site View -->
        <section id="wedding-site-section" class="hidden">
            <div id="wedding-site-content">
                <!-- Wedding site content will be loaded here -->
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="text-center py-6 mt-12">
        <p class="text-sm text-white/70">Created by Invites</p>
    </footer>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://ybbhynfttwogkdsnqmvu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliYmh5bmZ0dHdvZ2tkc25xbXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY3MDIsImV4cCI6MjA3MTI1MjcwMn0.LPMGW_OPKiwTEKhyzl_v2Snb9nVeZg0wP4Ot6zKrCn0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentWedding = null;
        let currentUser = null;

        // Session Management
        function saveSession(wedding) {
            localStorage.setItem('weddingSession', JSON.stringify(wedding));
        }

        function loadSession() {
            const session = localStorage.getItem('weddingSession');
            return session ? JSON.parse(session) : null;
        }

        function clearSession() {
            localStorage.removeItem('weddingSession');
        }

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(section + '-section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('[id^="nav-"]').forEach(btn => {
                btn.className = btn.className.replace('bg-pink-500 text-white', 'text-gray-600 hover:bg-gray-100');
            });
            document.getElementById('nav-' + section).className = 'px-4 py-2 sm:px-6 sm:py-3 rounded-full bg-pink-500 text-white font-medium text-sm sm:text-base';
        }

        // Fun√ß√£o para gerar URL personalizada
        function generateCustomUrl(groomName, brideName) {
            return `${groomName.toLowerCase().replace(/\s+/g, '-')}-${brideName.toLowerCase().replace(/\s+/g, '-')}`;
        }

        // Fun√ß√£o para criar o casamento no Supabase
        async function createWedding(weddingData) {
            const { data, error } = await supabase
                .from('weddings')
                .insert({
                    username: weddingData.username,
                    password: weddingData.password,
                    groom_name: weddingData.groomName,
                    bride_name: weddingData.brideName,
                    wedding_date: weddingData.weddingDate,
                    wedding_time: weddingData.weddingTime,
                    event_venue: weddingData.eventVenue,
                    custom_url: weddingData.customUrl
                })
                .select()
                .single();

            if (error) {
                console.error('Supabase error:', error);
                throw error;
            }
            return data;
        }

        // Create Wedding Site
        document.getElementById('weddingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const createButton = document.getElementById('createButton');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const groomName = document.getElementById('groomName').value.trim();
            const brideName = document.getElementById('brideName').value.trim();
            const weddingDate = document.getElementById('weddingDate').value;
            const weddingTime = document.getElementById('weddingTime').value;
            const eventVenue = document.getElementById('eventVenue').value.trim();

            // Verificar se todos os campos est√£o preenchidos
            if (!username || !password || !groomName || !brideName || !weddingDate || !weddingTime || !eventVenue) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            createButton.textContent = 'Criando...';
            createButton.disabled = true;

            // Dados do casamento para serem enviados ao Supabase
            const weddingData = {
                username: username,
                password: password,
                groomName: groomName,
                brideName: brideName,
                weddingDate: weddingDate,
                weddingTime: weddingTime,
                eventVenue: eventVenue,
                customUrl: generateCustomUrl(groomName, brideName)
            };

            // Enviar para o Supabase
            try {
                console.log('Enviando dados:', weddingData);
                const createdWedding = await createWedding(weddingData);
                console.log('Casamento criado:', createdWedding);
                
                // Show success message with custom domain
                const generatedUrl = `https://${weddingData.customUrl}.invites.co`;
                document.getElementById('generated-url').textContent = generatedUrl;
                document.getElementById('success-message').classList.remove('hidden');
                
                // Reset form
                document.getElementById('weddingForm').reset();
                
                alert('üéâ Parab√©ns! Seu site foi criado com sucesso!');
            } catch (error) {
                console.error('Erro completo:', error);
                let errorMessage = 'Erro ao criar o site. ';
                
                if (error.message) {
                    errorMessage += error.message;
                } else if (error.details) {
                    errorMessage += error.details;
                } else {
                    errorMessage += 'Tente novamente.';
                }
                
                alert(errorMessage);
            } finally {
                createButton.textContent = 'üéâ Criar Convite';
                createButton.disabled = false;
            }
        });

        // Copy URL function
        function copyUrl() {
            const url = document.getElementById('generated-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copiado para a √°rea de transfer√™ncia!');
            });
        }

        // Fun√ß√£o para login do administrador
        async function loginAdmin(username, password) {
            const { data, error } = await supabase
                .from('weddings')
                .select('*')
                .eq('username', username)
                .eq('password', password)
                .single();

            if (error) throw error;
            return data;
        }

        // Fun√ß√£o para mostrar o painel de administra√ß√£o
        function showAdminDashboard() {
            showSection('dashboard');
        }

        // Login
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            loginError.classList.add('hidden');
            loginButton.textContent = 'Entrando...';
            loginButton.disabled = true;

            try {
                // Realiza o login no Supabase
                const adminData = await loginAdmin(username, password);
                
                currentUser = adminData;
                currentWedding = adminData;
                saveSession(adminData);
                
                // Dados do painel
                document.getElementById('wedding-info').textContent = `${adminData.groom_name} & ${adminData.bride_name} - ${formatDate(adminData.wedding_date)}`;

                loadDashboard();
                showAdminDashboard();
            } catch (error) {
                loginError.textContent = 'Usu√°rio ou senha incorretos.';
                loginError.classList.remove('hidden');
            } finally {
                loginButton.textContent = 'üîê Entrar';
                loginButton.disabled = false;
            }
        });

        // Load Dashboard
        async function loadDashboard() {
            if (!currentWedding) return;

            // Update wedding info
            document.getElementById('wedding-info').textContent = 
                `${currentWedding.groom_name} & ${currentWedding.bride_name} - ${formatDate(currentWedding.wedding_date)}`;

            // Load statistics
            await loadStatistics();
            
            // Load guest list
            await loadGuestList();
            
            // Load messages
            await loadMessages();
            
            // Load wedding preview
            loadWeddingPreview();
        }

        // Load Statistics
        async function loadStatistics() {
            try {
                // Get RSVPs
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentWedding.id);

                // Get Messages
                const { data: messages } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('wedding_id', currentWedding.id);

                const totalGuests = rsvps ? rsvps.length : 0;
                const confirmedGuests = rsvps ? rsvps.filter(r => r.attendance).length : 0;
                const totalMessages = messages ? messages.length : 0;

                document.getElementById('total-guests').textContent = totalGuests;
                document.getElementById('confirmed-guests').textContent = confirmedGuests;
                document.getElementById('total-messages').textContent = totalMessages;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load Guest List
        async function loadGuestList() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentWedding.id)
                    .order('created_at', { ascending: false });

                const guestList = document.getElementById('guest-list');
                guestList.innerHTML = '';

                if (rsvps && rsvps.length > 0) {
                    rsvps.forEach(rsvp => {
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="py-3 px-4">${rsvp.guest_name}</td>
                            <td class="py-3 px-4">${rsvp.companion_name || '-'}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs ${rsvp.attendance ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${rsvp.attendance ? '‚úÖ Confirmado' : '‚ùå N√£o Confirmado'}
                                </span>
                            </td>
                            <td class="py-3 px-4">${formatDate(rsvp.created_at)}</td>
                        `;
                        guestList.appendChild(row);
                    });
                } else {
                    guestList.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">Nenhum convidado ainda</td></tr>';
                }

            } catch (error) {
                console.error('Error loading guest list:', error);
            }
        }

        // Load Messages
        async function loadMessages() {
            try {
                const { data: messages } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('wedding_id', currentWedding.id)
                    .order('created_at', { ascending: false });

                const messagesList = document.getElementById('messages-list');
                messagesList.innerHTML = '';

                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'bg-gray-50 rounded-xl p-4';
                        messageDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800">${message.guest_name}</h4>
                                <span class="text-sm text-gray-500">${formatDate(message.created_at)}</span>
                            </div>
                            <p class="text-gray-600">${message.message}</p>
                        `;
                        messagesList.appendChild(messageDiv);
                    });
                } else {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma mensagem ainda</p>';
                }

            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Load Wedding Preview
        function loadWeddingPreview() {
            const preview = document.getElementById('wedding-preview');
            const customMessage = currentWedding.custom_message || '';
            const showTime = currentWedding.wedding_time;
            const eventVenue = currentWedding.event_venue || '';
            
            preview.innerHTML = `
                <div class="text-center">
                    <h4 class="font-dancing text-4xl text-gray-800 mb-2">${currentWedding.groom_name} & ${currentWedding.bride_name}</h4>
                    <p class="text-gray-600 mb-2">üìÖ ${formatDate(currentWedding.wedding_date)}${showTime ? ` ‚Ä¢ üïï ${currentWedding.wedding_time}` : ''}</p>
                    ${eventVenue ? `<p class="text-gray-600 mb-4">üìç ${eventVenue}</p>` : ''}
                    ${customMessage ? `<p class="text-gray-700 mb-6 italic">"${customMessage}"</p>` : ''}
                    <div class="bg-white rounded-xl p-4 mb-4">
                        <h5 class="font-semibold mb-2">Confirme sua Presen√ßa</h5>
                        <div class="flex gap-2 justify-center">
                            <button class="bg-green-500 text-white px-4 py-2 rounded-lg">‚úÖ Confirmo</button>
                            <button class="bg-red-500 text-white px-4 py-2 rounded-lg">‚ùå N√£o Posso</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">Preview do seu convite</p>
                </div>
            `;
        }

        // Toggle Edit Mode
        function toggleEditMode() {
            const editForm = document.getElementById('edit-form');
            const toggleBtn = document.getElementById('edit-toggle-btn');
            
            if (editForm.classList.contains('hidden')) {
                // Show edit form
                editForm.classList.remove('hidden');
                toggleBtn.textContent = '‚ùå Cancelar';
                toggleBtn.className = 'bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600';
                
                // Populate form with current data
                document.getElementById('edit-groom-name').value = currentWedding.groom_name;
                document.getElementById('edit-bride-name').value = currentWedding.bride_name;
                document.getElementById('edit-wedding-date').value = currentWedding.wedding_date;
                document.getElementById('edit-wedding-time').value = currentWedding.wedding_time || '';
                document.getElementById('edit-event-venue').value = currentWedding.event_venue || '';
                document.getElementById('edit-custom-message').value = currentWedding.custom_message || '';
            } else {
                // Hide edit form
                cancelEdit();
            }
        }

        // Cancel Edit
        function cancelEdit() {
            const editForm = document.getElementById('edit-form');
            const toggleBtn = document.getElementById('edit-toggle-btn');
            
            editForm.classList.add('hidden');
            toggleBtn.textContent = '‚úèÔ∏è Editar';
            toggleBtn.className = 'bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600';
        }

        // Save Wedding Info
        async function saveWeddingInfo() {
            const updatedData = {
                groom_name: document.getElementById('edit-groom-name').value,
                bride_name: document.getElementById('edit-bride-name').value,
                wedding_date: document.getElementById('edit-wedding-date').value,
                wedding_time: document.getElementById('edit-wedding-time').value,
                event_venue: document.getElementById('edit-event-venue').value,
                custom_message: document.getElementById('edit-custom-message').value
            };

            try {
                const { error } = await supabase
                    .from('weddings')
                    .update(updatedData)
                    .eq('id', currentWedding.id);

                if (error) throw error;

                // Update current wedding object
                Object.assign(currentWedding, updatedData);
                
                // Update session
                saveSession(currentWedding);
                
                // Refresh preview and info
                loadWeddingPreview();
                document.getElementById('wedding-info').textContent = 
                    `${currentWedding.groom_name} & ${currentWedding.bride_name} - ${formatDate(currentWedding.wedding_date)}`;
                
                // Hide edit form
                cancelEdit();
                
                alert('Informa√ß√µes atualizadas com sucesso!');

            } catch (error) {
                console.error('Error updating wedding info:', error);
                alert('Erro ao salvar altera√ß√µes. Tente novamente.');
            }
        }

        // Copy Wedding URL
        function copyWeddingUrl() {
            const url = `https://${currentWedding.custom_url}.invites.co`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link do site copiado!');
            });
        }

        // Open Wedding Site
        function openWeddingSite() {
            const url = `https://${currentWedding.custom_url}.invites.co`;
            window.open(url, '_blank');
        }

        // Download Guest Report
        async function downloadGuestReport() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentWedding.id)
                    .order('created_at', { ascending: false });

                if (!rsvps || rsvps.length === 0) {
                    alert('Nenhum convidado para exportar');
                    return;
                }

                // Create CSV content
                let csvContent = "Nome,Acompanhante,Status,Data de Confirma√ß√£o\n";
                
                rsvps.forEach(rsvp => {
                    const status = rsvp.attendance ? 'Confirmado' : 'N√£o Confirmado';
                    const companion = rsvp.companion_name || 'Sem acompanhante';
                    const date = formatDate(rsvp.created_at);
                    
                    csvContent += `"${rsvp.guest_name}","${companion}","${status}","${date}"\n`;
                });

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `relatorio-convidados-${currentWedding.groom_name}-${currentWedding.bride_name}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Erro ao baixar relat√≥rio. Tente novamente.');
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            currentWedding = null;
            clearSession();
            showSection('home');
        }

        // Utility Functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        // Check for wedding site parameter on load
        window.addEventListener('load', () => {
            // Check if this is a custom domain (wedding site)
            const hostname = window.location.hostname;
            if (hostname.endsWith('.invites.co') && hostname !== 'invites.co') {
                // Extract wedding site identifier from subdomain
                const siteParam = hostname.replace('.invites.co', '');
                loadWeddingSite(siteParam);
            } else {
                // This is the main admin panel
                const urlParams = new URLSearchParams(window.location.search);
                const siteParam = urlParams.get('site');
                
                if (siteParam) {
                    loadWeddingSite(siteParam);
                } else {
                    // Check for existing session
                    const session = loadSession();
                    if (session) {
                        currentUser = session;
                        currentWedding = session;
                        loadDashboard();
                        showSection('dashboard');
                    } else {
                        showSection('home');
                    }
                }
            }
        });

        // Load Wedding Site for Guests
        async function loadWeddingSite(customUrl) {
            try {
                const { data: wedding, error } = await supabase
                    .from('weddings')
                    .select('*')
                    .eq('custom_url', customUrl)
                    .single();

                if (error || !wedding) {
                    alert('Site de casamento n√£o encontrado');
                    return;
                }

                currentWedding = wedding;
                renderWeddingSite();
                
                // Hide navigation and show only wedding site
                document.querySelector('header').style.display = 'none';
                document.querySelector('nav').style.display = 'none';
                showSection('wedding-site');

            } catch (error) {
                console.error('Error loading wedding site:', error);
                alert('Erro ao carregar site de casamento');
            }
        }

        // Render Wedding Site for Guests
        function renderWeddingSite() {
            const content = document.getElementById('wedding-site-content');
            const customMessage = currentWedding.custom_message || '';
            const showTime = currentWedding.wedding_time;
            const eventVenue = currentWedding.event_venue || '';
            
            content.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="wedding-card rounded-3xl p-8 text-center">
                        <h1 class="font-dancing text-6xl text-gray-800 mb-4">${currentWedding.groom_name} & ${currentWedding.bride_name}</h1>
                        <p class="text-xl text-gray-600 mb-4">üìÖ ${formatDate(currentWedding.wedding_date)}${showTime ? ` ‚Ä¢ üïï ${currentWedding.wedding_time}` : ''}</p>
                        ${eventVenue ? `<p class="text-lg text-gray-600 mb-8">üìç ${eventVenue}</p>` : ''}
                        
                        ${customMessage ? `<div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-6 mb-6">
                            <p class="text-lg text-gray-700 italic">"${customMessage}"</p>
                        </div>` : ''}
                        
                        <div class="bg-gradient-to-r from-pink-50 to-purple-50 rounded-2xl p-6 mb-6">
                            <h3 class="text-2xl font-semibold mb-4">Confirme sua Presen√ßa</h3>
                            <form id="rsvp-form" class="space-y-4">
                                <input type="text" id="guest-name" placeholder="Seu nome completo" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500">
                                
                                <div class="flex items-center gap-3 mb-4">
                                    <input type="checkbox" id="has-companion" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-500">
                                    <label for="has-companion" class="text-gray-700">Vou com acompanhante</label>
                                </div>
                                
                                <div id="companion-field" class="hidden">
                                    <input type="text" id="companion-name" placeholder="Nome do acompanhante" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500">
                                </div>
                                
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button type="button" onclick="submitRSVP(true)" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold">
                                        ‚úÖ Confirmo Presen√ßa
                                    </button>
                                    <button type="button" onclick="submitRSVP(false)" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold">
                                        ‚ùå N√£o Posso Ir
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 mb-6">
                            <h3 class="text-2xl font-semibold mb-4">Deixe uma Mensagem</h3>
                            <form id="message-form" class="space-y-4">
                                <input type="text" id="message-guest-name" placeholder="Seu nome" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                                <textarea id="message-text" placeholder="Sua mensagem para os noivos..." required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 h-24"></textarea>
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold">
                                    üíå Enviar Mensagem
                                </button>
                            </form>
                        </div>

                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6">
                            <h3 class="text-2xl font-semibold mb-4">üí¨ Mural de Mensagens</h3>
                            <div id="public-messages-list" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- Public messages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for forms
            document.getElementById('message-form').addEventListener('submit', submitMessage);
            
            // Load public messages
            loadPublicMessages();
            
            // Toggle companion field
            document.getElementById('has-companion').addEventListener('change', function() {
                const companionField = document.getElementById('companion-field');
                if (this.checked) {
                    companionField.classList.remove('hidden');
                    document.getElementById('companion-name').required = true;
                } else {
                    companionField.classList.add('hidden');
                    document.getElementById('companion-name').required = false;
                    document.getElementById('companion-name').value = '';
                }
            });
        }

        // Submit RSVP
        async function submitRSVP(attendance) {
            const guestName = document.getElementById('guest-name').value;
            const companionName = document.getElementById('companion-name').value;

            if (!guestName) {
                alert('Por favor, digite seu nome');
                return;
            }

            try {
                const { error } = await supabase
                    .from('rsvps')
                    .insert({
                        wedding_id: currentWedding.id,
                        guest_name: guestName,
                        companion_name: companionName || null,
                        attendance: attendance,
                        guest_count: companionName ? 2 : 1
                    });

                if (error) {
                    console.error('RSVP error:', error);
                    throw error;
                }

                alert(attendance ? 'Presen√ßa confirmada! Obrigado!' : 'Obrigado por nos avisar!');
                document.getElementById('rsvp-form').reset();

            } catch (error) {
                console.error('Error submitting RSVP:', error);
                alert('Erro ao confirmar presen√ßa. Tente novamente.');
            }
        }

        // Load Public Messages for Wedding Site
        async function loadPublicMessages() {
            try {
                const { data: messages } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('wedding_id', currentWedding.id)
                    .order('created_at', { ascending: false })
                    .limit(10);

                const messagesList = document.getElementById('public-messages-list');
                messagesList.innerHTML = '';

                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'bg-white rounded-xl p-4 shadow-sm';
                        messageDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800">${message.guest_name}</h4>
                                <span class="text-sm text-gray-500">${formatDate(message.created_at)}</span>
                            </div>
                            <p class="text-gray-600">${message.message}</p>
                        `;
                        messagesList.appendChild(messageDiv);
                    });
                } else {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-8">Seja o primeiro a deixar uma mensagem! üíï</p>';
                }

            } catch (error) {
                console.error('Error loading public messages:', error);
            }
        }

        // Submit Message
        async function submitMessage(e) {
            e.preventDefault();
            
            const guestName = document.getElementById('message-guest-name').value;
            const messageText = document.getElementById('message-text').value;

            try {
                const { error } = await supabase
                    .from('messages')
                    .insert({
                        wedding_id: currentWedding.id,
                        guest_name: guestName,
                        message: messageText
                    });

                if (error) {
                    console.error('Message error:', error);
                    throw error;
                }

                alert('Mensagem enviada com sucesso!');
                document.getElementById('message-form').reset();
                
                // Reload public messages to show the new one
                loadPublicMessages();

            } catch (error) {
                console.error('Error submitting message:', error);
                alert('Erro ao enviar mensagem. Tente novamente.');
            }
        }

        // Initialize
        showSection('home');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9727aaa0845b77e3',t:'MTc1NTc1MzQ3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
