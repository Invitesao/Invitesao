<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Convites PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 20px 15px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #56ab2f;
            background: #f0fff0;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .upload-text {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #888;
        }

        .editor-section {
            display: none;
        }

        .pdf-preview {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            background: white;
        }

        .pdf-canvas {
            width: 100%;
            height: auto;
            display: block;
            cursor: crosshair;
        }

        .text-overlay {
            position: absolute;
            background: rgba(255, 255, 0, 0.3);
            border: 2px dashed #ff6b6b;
            padding: 8px;
            cursor: move;
            font-family: Arial, sans-serif;
            font-weight: bold;
            color: #333;
            min-width: 120px;
            min-height: 44px;
            text-align: center;
            border-radius: 6px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .text-overlay:hover {
            background: rgba(255, 255, 0, 0.5);
        }

        .text-overlay.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 18px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 18px;
            transition: border-color 0.3s;
            min-height: 50px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
            min-height: 50px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(86, 171, 47, 0.3);
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            border: 1px solid #c3e6cb;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .controls button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        .font-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .font-controls input, .font-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .content {
                padding: 15px 12px;
            }
            
            .header {
                padding: 25px 15px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .btn {
                font-size: 16px;
                padding: 16px;
                min-height: 48px;
            }
            
            input[type="text"] {
                font-size: 16px;
                padding: 16px;
                min-height: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Editor de Convites</h1>
            <p>Personalize seus convites em 3 passos simples</p>
        </div>
        
        <div class="content">
            <div id="successMessage" class="success" style="display: none;"></div>
            
            <!-- Tela de Login -->
            <div id="loginSection" class="login-section">
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 30px; border-radius: 20px; margin-bottom: 25px; border: 2px solid #667eea; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîê</div>
                    <h2 style="color: #667eea; margin: 0 0 15px 0; font-size: 24px;">Acesso Restrito</h2>
                    <p style="color: #666; margin-bottom: 25px; font-size: 16px;">Digite seu token de acesso para usar o editor de convites</p>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <input type="text" id="tokenInput" placeholder="Digite seu token de acesso..." style="width: 100%; padding: 18px; border: 2px solid #667eea; border-radius: 12px; font-size: 18px; text-align: center; font-weight: bold; letter-spacing: 2px;">
                    </div>
                    
                    <button class="btn btn-primary" onclick="validateToken()" style="width: 100%; margin-bottom: 15px;">
                        üöÄ Entrar no Editor
                    </button>
                    
                    <div id="loginError" style="display: none; background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid #f5c6cb;">
                        ‚ùå Token inv√°lido ou expirado
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <p style="color: #888; font-size: 14px; margin: 0;">
                            üí° <strong>N√£o tem um token?</strong><br>
                            Entre em contato conosco para obter acesso
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Contador de Limites -->
            <div id="limitsDisplay" style="background: linear-gradient(135deg, #fff3e0 0%, #e8f5e8 100%); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ff9800; display: none; text-align: center;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="color: #ff9800; font-weight: bold; font-size: 16px;">
                        üìä Seus Limites de Convites
                    </div>
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div style="background: white; padding: 8px 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <span style="color: #28a745; font-weight: bold; font-size: 18px;" id="remainingCount">0</span>
                            <span style="color: #666; font-size: 14px;"> restantes</span>
                        </div>
                        <div style="background: white; padding: 8px 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <span style="color: #666; font-size: 14px;">Usados: </span>
                            <span style="color: #dc3545; font-weight: bold;" id="usedCount">0</span>
                            <span style="color: #666; font-size: 14px;"> de </span>
                            <span style="color: #667eea; font-weight: bold;" id="maxCount">0</span>
                        </div>
                    </div>
                </div>
                <div id="limitWarning" style="margin-top: 10px; padding: 8px; background: #f8d7da; color: #721c24; border-radius: 8px; display: none; font-size: 14px;">
                    ‚ö†Ô∏è <strong>Limite quase esgotado!</strong> Entre em contato para renovar seu plano.
                </div>
            </div>

            <!-- Guia de Passos -->
            <div id="stepsGuide" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 2px solid #667eea; display: none;">
                <h3 style="color: #667eea; margin: 0 0 15px 0; text-align: center; font-size: 18px;">üéØ Como usar (muito f√°cil!):</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">1</div>
                        <span style="color: #333; font-weight: 500;">üìÅ Clique abaixo para escolher seu arquivo PDF</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                        <div style="background: #ccc; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">2</div>
                        <span style="color: #666;">‚úèÔ∏è Digite os nomes dos convidados</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                        <div style="background: #ccc; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">3</div>
                        <span style="color: #666;">üì• Baixe seus convites personalizados</span>
                    </div>
                </div>
            </div>

            <!-- √Årea de Upload -->
            <div class="upload-section" id="uploadSection" style="display: none;">
                <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">PASSO 1: Clique aqui para escolher seu PDF</div>
                    <div class="upload-hint">Ou arraste o arquivo aqui</div>
                </div>
                <input type="file" id="pdfFile" accept=".pdf" />
            </div>

            <!-- Editor -->
            <div class="editor-section" id="editorSection">
                <!-- Passo 2 Ativo -->
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #28a745;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <div style="background: #28a745; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">2</div>
                        <h3 style="color: #28a745; margin: 0; font-size: 18px;">‚úèÔ∏è PASSO 2: Adicione os nomes</h3>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <input type="text" id="guestName" placeholder="Digite o nome do convidado e pressione Enter..." onkeypress="handleEnterKey(event)" style="width: 100%; padding: 15px; border: 2px solid #28a745; border-radius: 10px; font-size: 16px; font-weight: 500;">
                    </div>

                    <div class="controls">
                        <button class="btn btn-success" onclick="addTextToPDF()" style="background: #28a745; flex: 2;">‚ûï Adicionar Nome</button>
                        <button class="btn btn-secondary" onclick="clearAllText()" style="flex: 1;">üóëÔ∏è Limpar</button>
                    </div>
                </div>

                <!-- Dicas Simples -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffc107;">
                    <div style="color: #856404; font-size: 14px; line-height: 1.5;">
                        <strong>üí° Muito simples:</strong><br>
                        ‚Ä¢ Digite um nome e pressione <strong>Enter</strong><br>
                        ‚Ä¢ Arraste os nomes para cima/baixo no convite<br>
                        ‚Ä¢ Clique em um nome para <strong>editar, mudar cor/tamanho</strong><br>
                        ‚Ä¢ Use <strong>Enter</strong> para salvar altera√ß√µes
                    </div>
                </div>

                <!-- Controles de Formata√ß√£o (mais vis√≠veis) -->
                <div id="formatControls" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px dashed #dee2e6; display: none;">
                    <div style="color: #495057; font-weight: bold; margin-bottom: 10px; text-align: center;">üé® Personalizar texto selecionado:</div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">üî§ Fonte:</label>
                            <select id="fontFamily" onchange="updateSelectedElement()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px;">
                                <option value="Arial" selected>Arial (Cl√°ssica)</option>
                                <option value="Times New Roman">Times New Roman (Elegante)</option>
                                <option value="Georgia">Georgia (Sofisticada)</option>
                                <option value="Verdana">Verdana (Moderna)</option>
                                <option value="Helvetica">Helvetica (Limpa)</option>
                                <option value="Trebuchet MS">Trebuchet MS (Amig√°vel)</option>
                                <option value="Impact">Impact (Forte)</option>
                                <option value="Comic Sans MS">Comic Sans MS (Divertida)</option>
                                <option value="Courier New">Courier New (M√°quina)</option>
                                <option value="Brush Script MT">Brush Script MT (Manuscrita)</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">üìè Tamanho:</label>
                                <select id="fontSize" onchange="updateSelectedElement()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                    <option value="12">Pequeno</option>
                                    <option value="16" selected>Normal</option>
                                    <option value="20">Grande</option>
                                    <option value="24">Muito Grande</option>
                                    <option value="28">Gigante</option>
                                    <option value="32">Extra Grande</option>
                                    <option value="36">Gigante</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">üé® Cor:</label>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <input type="color" id="textColor" value="#000000" onchange="updateSelectedElement()" style="width: 40px; height: 35px; border: none; border-radius: 5px; cursor: pointer;">
                                    <span id="colorLabel" style="font-size: 12px; color: #666;">Preto</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="page-controls" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <button onclick="previousPage()" id="prevBtn" class="btn-page" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">‚Üê Anterior</button>
                    <span id="pageInfo" style="font-weight: bold; color: #333;">P√°gina 1 de 1</span>
                    <button onclick="nextPage()" id="nextBtn" class="btn-page" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Pr√≥xima ‚Üí</button>
                </div>

                <div id="selectedInfo" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 14px; display: none; border: 2px solid #667eea;">
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #667eea;">‚úèÔ∏è Editando:</strong> <span id="selectedText" style="font-weight: bold;"></span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="editNameInput" placeholder="Digite o novo nome..." onkeypress="handleEditEnterKey(event)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 8px;">
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="updateSelectedName()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">‚úÖ Salvar Nome</button>
                        <button onclick="deleteSelected()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">üóëÔ∏è Excluir</button>
                        <button onclick="deselectElement()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">‚ùå Cancelar</button>
                    </div>
                </div>

                <div class="pdf-preview" id="pdfPreview">
                    <div id="loadingIndicator" style="display: none; text-align: center; padding: 50px; color: #667eea;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                        <div>Carregando PDF...</div>
                    </div>
                    <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
                </div>



                <!-- Passo 3 -->
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #e8f5e8 100%); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid #ff9800;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <div style="background: #ff9800; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">3</div>
                        <h3 style="color: #ff9800; margin: 0; font-size: 18px;">üì• PASSO 3: Baixar convites</h3>
                    </div>
                    
                    <button class="btn btn-success" onclick="showPDFPreview()" style="background: #28a745; margin-bottom: 10px;">üëÅÔ∏è Ver Pr√©via e Baixar PDF</button>
                    <button class="btn btn-whatsapp" onclick="shareWhatsApp()" style="margin-bottom: 10px;">üì± Compartilhar no WhatsApp</button>
                    <button class="btn btn-secondary" onclick="resetEditor()">üîÑ Fazer Outro Convite</button>
                    <button class="btn" onclick="logout()" style="background: #dc3545; color: white; margin-top: 10px;">üö™ Sair do Sistema</button>
                </div>
                
                <!-- Modal de Pr√©via do PDF -->
                <div id="pdfPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
                    <div style="background: white; margin: 20px auto; max-width: 90%; max-height: 90%; border-radius: 15px; position: relative; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="color: #667eea; margin: 0;">üìÑ Pr√©via do PDF Final</h2>
                            <button onclick="closePDFPreview()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 16px;">‚úï Fechar</button>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <p style="color: #666; margin-bottom: 15px;">Esta √© a pr√©via de como seu PDF ficar√°. Voc√™ ainda pode ajustar as posi√ß√µes dos nomes!</p>
                            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="previousPreviewPage()" id="prevPreviewBtn" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">‚Üê Anterior</button>
                                <span id="previewPageInfo" style="padding: 8px 15px; background: #f8f9fa; border-radius: 5px; font-weight: bold;">P√°gina 1 de 1</span>
                                <button onclick="nextPreviewPage()" id="nextPreviewBtn" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Pr√≥xima ‚Üí</button>
                            </div>
                        </div>
                        
                        <div id="previewContainer" style="border: 2px solid #ddd; border-radius: 10px; margin: 20px 0; background: white; text-align: center; min-height: 400px; position: relative;">
                            <canvas id="previewCanvas" style="max-width: 100%; height: auto; cursor: crosshair;"></canvas>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="generateFinalPDF()" style="background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">üì• Baixar PDF</button>
                            <button onclick="closePDFPreview()" style="background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer;">‚Ü©Ô∏è Voltar ao Editor</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://hmbyjclwuozkcclhhlak.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtYnlqY2x3dW96a2NjbGhobGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4OTgzMjgsImV4cCI6MjA3MDQ3NDMyOH0.nWa9dazt2cPAwbTHROIiyXWookV2L7Hi7p3GS5pq_Ko';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Vari√°veis globais
        let currentUser = null;
        let userLimits = {
            maxInvites: 0,
            usedInvites: 0,
            remainingInvites: 0
        };
        let originalPDF = null;
        let pdfDoc = null;
        let canvas = null;
        let ctx = null;
        let textElements = [];
        let selectedElement = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let scale = 1;
        let currentPage = 1;
        let totalPages = 1;
        let previewCanvas = null;
        let previewCtx = null;
        let previewCurrentPage = 1;
        let isPreviewMode = false;

        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('pdfCanvas');
            ctx = canvas.getContext('2d', { willReadFrequently: true });
            previewCanvas = document.getElementById('previewCanvas');
            previewCtx = previewCanvas.getContext('2d', { willReadFrequently: true });
            setupEventListeners();
            
            // Verificar se j√° est√° logado
            checkExistingLogin();
        });

        // Verificar login existente
        async function checkExistingLogin() {
            const savedToken = localStorage.getItem('inviteEditorToken');
            const savedExpiry = localStorage.getItem('inviteEditorTokenExpiry');
            
            if (savedToken && savedExpiry) {
                const now = new Date().getTime();
                if (now < parseInt(savedExpiry)) {
                    // Token ainda v√°lido - buscar dados completos
                    try {
                        const { data, error } = await supabaseClient
                            .from('access_tokens')
                            .select('*')
                            .eq('token', savedToken)
                            .eq('is_active', true)
                            .single();
                        
                        if (data && !error) {
                            currentUser = data;
                            await loadUserLimits();
                            showMainApp();
                            return;
                        }
                    } catch (error) {
                        console.error('Erro ao verificar token salvo:', error);
                    }
                }
            }
            
            // Mostrar tela de login
            showLoginScreen();
        }

        // Validar token
        async function validateToken() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                showLoginError('Digite um token v√°lido');
                return;
            }
            
            try {
                showSuccess('Validando token...');
                
                // Consultar token no Supabase
                const { data, error } = await supabaseClient
                    .from('access_tokens')
                    .select('*')
                    .eq('token', token)
                    .eq('is_active', true)
                    .single();
                
                if (error || !data) {
                    showLoginError('Token inv√°lido ou n√£o encontrado');
                    return;
                }
                
                // Verificar se o token n√£o expirou
                const now = new Date();
                const expiryDate = new Date(data.expires_at);
                
                if (now > expiryDate) {
                    showLoginError('Token expirado');
                    return;
                }
                
                // Registrar uso do token
                await supabaseClient
                    .from('token_usage')
                    .insert({
                        token_id: data.id,
                        used_at: new Date().toISOString(),
                        ip_address: 'unknown', // Pode ser obtido via API externa
                        user_agent: navigator.userAgent
                    });
                
                // Salvar token localmente
                currentUser = data;
                localStorage.setItem('inviteEditorToken', token);
                localStorage.setItem('inviteEditorTokenExpiry', expiryDate.getTime().toString());
                
                // Carregar limites do usu√°rio
                await loadUserLimits();
                
                showSuccess('Login realizado com sucesso!');
                setTimeout(() => {
                    showMainApp();
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao validar token:', error);
                showLoginError('Erro de conex√£o. Tente novamente.');
            }
        }

        // Mostrar erro de login
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Mostrar tela de login
        function showLoginScreen() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('stepsGuide').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('editorSection').style.display = 'none';
        }

        // Carregar limites do usu√°rio
        async function loadUserLimits() {
            try {
                if (!currentUser) return;
                
                // Buscar dados do token com limites
                const { data: tokenData, error: tokenError } = await supabaseClient
                    .from('access_tokens')
                    .select('max_invites, current_invites')
                    .eq('id', currentUser.id)
                    .single();
                
                if (tokenError) {
                    console.error('Erro ao carregar limites:', tokenError);
                    return;
                }
                
                userLimits.maxInvites = tokenData.max_invites || 0;
                userLimits.usedInvites = tokenData.current_invites || 0;
                userLimits.remainingInvites = userLimits.maxInvites - userLimits.usedInvites;
                
                updateLimitsDisplay();
                
            } catch (error) {
                console.error('Erro ao carregar limites:', error);
            }
        }
        
        // Atualizar display dos limites
        function updateLimitsDisplay() {
            document.getElementById('remainingCount').textContent = userLimits.remainingInvites;
            document.getElementById('usedCount').textContent = userLimits.usedInvites;
            document.getElementById('maxCount').textContent = userLimits.maxInvites;
            
            // Mostrar aviso se restam poucos convites
            const limitWarning = document.getElementById('limitWarning');
            if (userLimits.remainingInvites <= 3 && userLimits.remainingInvites > 0) {
                limitWarning.style.display = 'block';
            } else {
                limitWarning.style.display = 'none';
            }
            
            // Mudar cor do contador baseado na quantidade restante
            const remainingElement = document.getElementById('remainingCount');
            if (userLimits.remainingInvites <= 0) {
                remainingElement.style.color = '#dc3545'; // Vermelho
            } else if (userLimits.remainingInvites <= 3) {
                remainingElement.style.color = '#ffc107'; // Amarelo
            } else {
                remainingElement.style.color = '#28a745'; // Verde
            }
        }
        
        // Verificar se pode gerar convite
        function canGenerateInvite() {
            if (userLimits.maxInvites === 0) return true; // Ilimitado
            return userLimits.remainingInvites > 0;
        }
        
        // Incrementar contador de convites usados
        async function incrementInviteUsage() {
            try {
                if (!currentUser || userLimits.maxInvites === 0) return; // N√£o contar se ilimitado
                
                // Atualizar no banco
                const { error } = await supabaseClient
                    .from('access_tokens')
                    .update({ 
                        current_invites: userLimits.usedInvites + 1 
                    })
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('Erro ao atualizar contador:', error);
                    return;
                }
                
                // Atualizar localmente
                userLimits.usedInvites++;
                userLimits.remainingInvites = userLimits.maxInvites - userLimits.usedInvites;
                updateLimitsDisplay();
                
                // Registrar na tabela de PDFs gerados
                await supabaseClient
                    .from('pdf_generations')
                    .insert({
                        token_id: currentUser.id,
                        generated_at: new Date().toISOString(),
                        pdf_name: generateAutoFileName(),
                        names_count: textElements.length,
                        pages_count: totalPages
                    });
                
            } catch (error) {
                console.error('Erro ao incrementar uso:', error);
            }
        }

        // Mostrar app principal
        function showMainApp() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('limitsDisplay').style.display = 'block';
            document.getElementById('stepsGuide').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'block';
        }

        // Logout
        function logout() {
            localStorage.removeItem('inviteEditorToken');
            localStorage.removeItem('inviteEditorTokenExpiry');
            currentUser = null;
            resetEditor();
            showLoginScreen();
            showSuccess('Logout realizado com sucesso!');
        }

        // Adicionar Enter key no campo de token
        document.addEventListener('DOMContentLoaded', function() {
            const tokenInput = document.getElementById('tokenInput');
            if (tokenInput) {
                tokenInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        validateToken();
                    }
                });
            }
        });

        function setupEventListeners() {
            const uploadArea = document.querySelector('.upload-area');
            const fileInput = document.getElementById('pdfFile');

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handlePDFUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePDFUpload(e.target.files[0]);
                }
            });

            // Canvas events
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            
            // Preview canvas events
            previewCanvas.addEventListener('click', handlePreviewCanvasClick);
            previewCanvas.addEventListener('mousedown', handlePreviewMouseDown);
            previewCanvas.addEventListener('mousemove', handlePreviewMouseMove);
            previewCanvas.addEventListener('mouseup', handlePreviewMouseUp);
        }

        async function handlePDFUpload(file) {
            try {
                console.log('Carregando PDF:', file.name, file.size);
                showSuccess('Carregando PDF...');
                
                const arrayBuffer = await file.arrayBuffer();
                // Criar uma c√≥pia do ArrayBuffer para evitar problemas de detach
                originalPDF = arrayBuffer.slice();
                
                console.log('ArrayBuffer criado, tamanho:', originalPDF.byteLength);
                
                // Carregar PDF com PDF.js para preview
                const loadingTask = pdfjsLib.getDocument({
                    data: arrayBuffer,
                    cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                    cMapPacked: true
                });
                
                pdfDoc = await loadingTask.promise;
                totalPages = pdfDoc.numPages;
                currentPage = 1;
                console.log('PDF carregado, p√°ginas:', totalPages);
                
                // Aguardar um pouco para garantir que o DOM est√° pronto
                setTimeout(async () => {
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('editorSection').style.display = 'block';
                    document.getElementById('loadingIndicator').style.display = 'block';
                    
                    // Aguardar o canvas estar vis√≠vel
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    await renderPDFPreview();
                    updatePageControls();
                    document.getElementById('loadingIndicator').style.display = 'none';
                    showSuccess(`PDF carregado com sucesso! ${totalPages} p√°gina(s) encontrada(s). Clique no PDF para posicionar os nomes.`);
                }, 100);
                
            } catch (error) {
                console.error('Erro detalhado:', error);
                alert('Erro ao carregar PDF: ' + error.message);
            }
        }

        async function renderPDFPreview() {
            try {
                const page = await pdfDoc.getPage(currentPage);
                
                // Aguardar o container estar totalmente renderizado
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // CORRE√á√ÉO: Usar dimens√µes EXATAS do PDF para manter propor√ß√£o perfeita
                const viewport = page.getViewport({ scale: 1.0 });
                const pdfWidth = viewport.width;
                const pdfHeight = viewport.height;
                const pdfRatio = pdfWidth / pdfHeight;
                
                // Calcular largura dispon√≠vel do container
                const previewContainer = document.getElementById('pdfPreview');
                const containerStyle = window.getComputedStyle(previewContainer);
                const borderWidth = parseInt(containerStyle.borderLeftWidth) + parseInt(containerStyle.borderRightWidth);
                const paddingWidth = parseInt(containerStyle.paddingLeft) + parseInt(containerStyle.paddingRight);
                const availableWidth = previewContainer.clientWidth - borderWidth - paddingWidth - 20; // Margem extra
                
                // Limitar altura m√°xima
                const maxHeight = window.innerHeight * 0.5;
                
                // Calcular dimens√µes mantendo propor√ß√£o EXATA do PDF
                let displayWidth, displayHeight;
                
                if (availableWidth / pdfRatio <= maxHeight) {
                    // Limitado pela largura
                    displayWidth = availableWidth;
                    displayHeight = availableWidth / pdfRatio;
                } else {
                    // Limitado pela altura
                    displayHeight = maxHeight;
                    displayWidth = maxHeight * pdfRatio;
                }
                
                // Garantir que as dimens√µes sejam inteiras
                displayWidth = Math.floor(displayWidth);
                displayHeight = Math.floor(displayHeight);
                
                // Calcular escala baseada nas dimens√µes finais
                scale = displayWidth / pdfWidth;
                
                // Configurar canvas com dimens√µes EXATAS calculadas
                canvas.width = displayWidth;
                canvas.height = displayHeight;
                canvas.style.width = displayWidth + 'px';
                canvas.style.height = displayHeight + 'px';
                canvas.style.maxWidth = 'none'; // N√£o permitir redimensionamento autom√°tico
                canvas.style.display = 'block';
                canvas.style.margin = '0 auto';
                
                // Limpar canvas antes de renderizar
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Usar viewport com escala calculada
                const scaledViewport = page.getViewport({ scale });
                
                // Renderizar PDF
                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };
                
                console.log(`üìê DIMENS√ïES CORRIGIDAS:`);
                console.log(`PDF original: ${pdfWidth}x${pdfHeight} (ratio: ${pdfRatio.toFixed(3)})`);
                console.log(`Canvas: ${displayWidth}x${displayHeight} (ratio: ${(displayWidth/displayHeight).toFixed(3)})`);
                console.log(`Escala √∫nica: ${scale.toFixed(4)}`);
                console.log(`Container dispon√≠vel: ${availableWidth}px`);
                
                await page.render(renderContext).promise;
                console.log('‚úÖ PDF renderizado com propor√ß√µes exatas!');
                
                // Carregar textos salvos da p√°gina atual
                loadSavedTexts();
                
            } catch (error) {
                console.error('Erro ao renderizar PDF:', error);
                alert('Erro ao exibir o PDF. Tente outro arquivo.');
            }
        }

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            console.log('Clique no canvas:', x, y);
            
            // Verificar se clicou em um elemento existente da p√°gina atual
            const currentPageTexts = getCurrentPageTexts();
            const clickedElement = currentPageTexts.find(el => 
                x >= el.x && x <= el.x + el.width &&
                y >= el.y && y <= el.y + el.height
            );
            
            if (clickedElement) {
                console.log('Elemento clicado:', clickedElement.text);
                selectElement(clickedElement);
            } else {
                // Adicionar novo texto na posi√ß√£o clicada
                const guestName = document.getElementById('guestName').value.trim();
                console.log('Nome digitado:', guestName);
                if (guestName) {
                    addTextAtPosition(x, y, guestName);
                } else {
                    // Se n√£o h√° nome digitado, focar no campo
                    document.getElementById('guestName').focus();
                    showSuccess('Digite um nome no campo acima primeiro!');
                }
            }
        }

        function addTextToPDF() {
            const guestName = document.getElementById('guestName').value.trim();
            console.log('Tentando adicionar nome:', guestName);
            
            if (!guestName) {
                showSuccess('Digite o nome do convidado primeiro!');
                document.getElementById('guestName').focus();
                return;
            }
            
            // Adicionar no centro do canvas
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            addTextAtPosition(x, y, guestName);
        }

        async function addTextAtPosition(x, y, text) {
            console.log('Adicionando texto:', text, 'na posi√ß√£o:', x, y, 'p√°gina:', currentPage);
            
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const color = document.getElementById('textColor').value;
            const fontFamily = document.getElementById('fontFamily').value;
            
            // Calcular largura exata do texto
            ctx.font = `bold ${fontSize}px ${fontFamily}`;
            const textWidth = ctx.measureText(text).width;
            
            // SEMPRE centralizar horizontalmente no meio do canvas
            const centerX = canvas.width / 2;
            
            const textElement = {
                id: Date.now(),
                text: text,
                x: centerX - textWidth/2, // SEMPRE perfeitamente centralizado
                y: y,
                fontSize: fontSize,
                fontFamily: fontFamily,
                color: color,
                width: textWidth,
                height: fontSize + 10,
                page: currentPage, // Associar √† p√°gina atual
                originalText: text // Guardar texto original para nome do arquivo
            };
            
            textElements.push(textElement);
            console.log('Elementos de texto atuais:', textElements.length);
            
            await redrawTextElements();
            selectElement(textElement);
            autoSave();
            
            // Limpar campo de nome ap√≥s adicionar
            document.getElementById('guestName').value = '';
            document.getElementById('guestName').focus();
            
            showSuccess(`"${text}" adicionado centralizado! Arraste para ajustar altura.`);
        }

        let isRendering = false;
        let pdfImageData = null;
        
        async function redrawTextElements() {
            // N√£o redesenhar o PDF, apenas os elementos de texto
            if (!canvas || !ctx || isRendering) return;
            
            isRendering = true;
            
            try {
                // Limpar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Redesenhar o PDF uma vez e salvar imagem
                if (pdfDoc) {
                    await renderPDFBase();
                    // Salvar imagem do PDF para uso durante arraste
                    pdfImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }
                
                // Desenhar linhas guia do centro
                drawCenterGuides();
                
                // Desenhar apenas elementos de texto da p√°gina atual
                const currentPageTexts = getCurrentPageTexts();
                currentPageTexts.forEach(element => {
                    ctx.font = `bold ${element.fontSize}px ${element.fontFamily || 'Arial'}`;
                    ctx.fillStyle = element.color;
                    ctx.textAlign = 'left'; // Usar alinhamento √† esquerda para posicionamento preciso
                    // CORRE√á√ÉO: Renderizar texto exatamente na posi√ß√£o calculada (j√° centralizada)
                    ctx.fillText(element.text, element.x, element.y + element.fontSize);
                    
                    // Desenhar borda se selecionado
                    if (selectedElement && selectedElement.id === element.id) {
                        ctx.strokeStyle = '#667eea';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.strokeRect(element.x, element.y, element.width, element.height);
                        ctx.setLineDash([]);
                    }
                });
            } finally {
                isRendering = false;
            }
        }
        
        function drawCenterGuides() {
            if (!canvas || !ctx) return;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Salvar estado atual do contexto
            ctx.save();
            
            // Configurar estilo das linhas guia
            ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)'; // Vermelho transparente
            ctx.lineWidth = 1;
            ctx.setLineDash([10, 5]); // Linha tracejada
            
            // Desenhar linha vertical (centro horizontal)
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, canvas.height);
            ctx.stroke();
            
            // Desenhar linha horizontal (centro vertical)
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(canvas.width, centerY);
            ctx.stroke();
            
            // Restaurar estado do contexto
            ctx.restore();
        }
        
        function redrawTextElementsQuick() {
            // Vers√£o r√°pida para arraste - usa imagem salva do PDF
            if (!canvas || !ctx || !pdfImageData) return;
            
            // Restaurar imagem do PDF
            ctx.putImageData(pdfImageData, 0, 0);
            
            // Desenhar linhas guia do centro
            drawCenterGuides();
            
            // Desenhar apenas os elementos de texto da p√°gina atual
            const currentPageTexts = getCurrentPageTexts();
            currentPageTexts.forEach(element => {
                ctx.font = `bold ${element.fontSize}px ${element.fontFamily || 'Arial'}`;
                ctx.fillStyle = element.color;
                ctx.textAlign = 'left'; // Usar alinhamento √† esquerda para posicionamento preciso
                ctx.fillText(element.text, element.x, element.y + element.fontSize);
                
                // Desenhar borda se selecionado
                if (selectedElement && selectedElement.id === element.id) {
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(element.x, element.y, element.width, element.height);
                    ctx.setLineDash([]);
                }
            });
        }

        let renderTask = null;
        
        async function renderPDFBase() {
            if (!pdfDoc || !ctx) return;
            
            try {
                // Cancelar renderiza√ß√£o anterior se existir
                if (renderTask) {
                    renderTask.cancel();
                }
                
                const page = await pdfDoc.getPage(currentPage);
                const scaledViewport = page.getViewport({ scale });
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };
                
                renderTask = page.render(renderContext);
                await renderTask.promise;
                renderTask = null;
            } catch (error) {
                if (error.name !== 'RenderingCancelledException') {
                    console.error('Erro ao renderizar base do PDF:', error);
                }
            }
        }

        function getCurrentPageTexts() {
            return textElements.filter(el => el.page === currentPage);
        }

        function updatePageControls() {
            document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            
            // Atualizar estilos dos bot√µes
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
            nextBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
            prevBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
            nextBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPDFPreview();
                updatePageControls();
                selectedElement = null;
                document.getElementById('selectedInfo').style.display = 'none';
                showSuccess(`P√°gina ${currentPage} carregada`);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderPDFPreview();
                updatePageControls();
                selectedElement = null;
                document.getElementById('selectedInfo').style.display = 'none';
                showSuccess(`P√°gina ${currentPage} carregada`);
            }
        }

        function selectElement(element) {
            selectedElement = element;
            
            // Atualizar controles com valores do elemento selecionado
            document.getElementById('fontSize').value = element.fontSize;
            document.getElementById('fontFamily').value = element.fontFamily || 'Arial';
            document.getElementById('textColor').value = element.color;
            
            // Mostrar controles de formata√ß√£o
            document.getElementById('formatControls').style.display = 'block';
            
            // Atualizar label da cor
            updateColorLabel(element.color);
            
            // Mostrar informa√ß√µes do elemento selecionado
            document.getElementById('selectedText').textContent = element.text;
            document.getElementById('editNameInput').value = element.text;
            document.getElementById('selectedInfo').style.display = 'block';
            
            redrawTextElements();
        }

        function updateColorLabel(color) {
            const colorLabel = document.getElementById('colorLabel');
            const colorNames = {
                '#000000': 'Preto',
                '#ffffff': 'Branco',
                '#ff0000': 'Vermelho',
                '#00ff00': 'Verde',
                '#0000ff': 'Azul',
                '#ffff00': 'Amarelo',
                '#ff00ff': 'Rosa',
                '#00ffff': 'Ciano',
                '#800080': 'Roxo',
                '#ffa500': 'Laranja'
            };
            
            colorLabel.textContent = colorNames[color.toLowerCase()] || 'Personalizada';
        }

        function updateSelectedElement() {
            if (!selectedElement) return;
            
            const newFontSize = parseInt(document.getElementById('fontSize').value);
            const newFontFamily = document.getElementById('fontFamily').value;
            const newColor = document.getElementById('textColor').value;
            
            selectedElement.fontSize = newFontSize;
            selectedElement.fontFamily = newFontFamily;
            selectedElement.color = newColor;
            selectedElement.height = newFontSize + 10;
            
            // Atualizar label da cor
            updateColorLabel(newColor);
            
            // Recalcular largura e recentrar horizontalmente
            ctx.font = `bold ${newFontSize}px ${newFontFamily}`;
            const textWidth = ctx.measureText(selectedElement.text).width;
            selectedElement.width = textWidth;
            
            // SEMPRE manter perfeitamente centralizado
            const centerX = canvas.width / 2;
            selectedElement.x = centerX - textWidth/2;
            
            redrawTextElements();
            autoSave();
        }

        function updateSelectedName() {
            if (!selectedElement) return;
            
            const newName = document.getElementById('editNameInput').value.trim();
            if (!newName) {
                showSuccess('Digite um nome v√°lido!');
                return;
            }
            
            // Atualizar o texto do elemento
            selectedElement.text = newName;
            
            // Recalcular largura e recentrar horizontalmente
            ctx.font = `bold ${selectedElement.fontSize}px ${selectedElement.fontFamily || 'Arial'}`;
            const textWidth = ctx.measureText(newName).width;
            selectedElement.width = textWidth;
            
            // SEMPRE manter perfeitamente centralizado
            const centerX = canvas.width / 2;
            selectedElement.x = centerX - textWidth/2;
            
            // Atualizar display
            document.getElementById('selectedText').textContent = newName;
            
            redrawTextElements();
            autoSave();
            showSuccess(`Nome alterado para "${newName}"!`);
        }
        
        function deselectElement() {
            selectedElement = null;
            document.getElementById('selectedInfo').style.display = 'none';
            document.getElementById('formatControls').style.display = 'none';
            redrawTextElements();
        }

        function deleteSelected() {
            if (!selectedElement) return;
            
            const deletedName = selectedElement.text;
            textElements = textElements.filter(el => el.id !== selectedElement.id);
            selectedElement = null;
            document.getElementById('selectedInfo').style.display = 'none';
            document.getElementById('formatControls').style.display = 'none';
            
            redrawTextElements();
            autoSave();
            showSuccess(`"${deletedName}" foi exclu√≠do!`);
        }

        function generateAutoFileName() {
            // Obter nomes √∫nicos dos elementos de texto (usar texto atual, n√£o original)
            const uniqueNames = [...new Set(textElements.map(el => el.text))];
            
            if (uniqueNames.length > 0) {
                if (uniqueNames.length === 1) {
                    // Um nome apenas - usar o nome atual
                    const sanitizedName = sanitizeFileName(uniqueNames[0]);
                    return `convite-${sanitizedName}.pdf`;
                } else {
                    // M√∫ltiplos nomes - usar o primeiro nome atual
                    const firstName = uniqueNames[0];
                    const sanitizedName = sanitizeFileName(firstName);
                    return `convite-${sanitizedName}-e-outros.pdf`;
                }
            } else {
                // Nome padr√£o se n√£o h√° nomes
                return 'convite-personalizado.pdf';
            }
        }

        function sanitizeFileName(name) {
            // Remover caracteres especiais e espa√ßos, converter para min√∫sculas
            return name.toLowerCase()
                      .replace(/[^a-z0-9\s-]/g, '') // Remover caracteres especiais
                      .replace(/\s+/g, '-') // Substituir espa√ßos por h√≠fens
                      .replace(/-+/g, '-') // Remover h√≠fens duplicados
                      .trim();
        }



        function handleMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const currentPageTexts = getCurrentPageTexts();
            const clickedElement = currentPageTexts.find(el => 
                x >= el.x && x <= el.x + el.width &&
                y >= el.y && y <= el.y + el.height
            );
            
            if (clickedElement) {
                isDragging = true;
                selectedElement = clickedElement;
                dragOffset.x = x - clickedElement.x;
                dragOffset.y = y - clickedElement.y;
                canvas.style.cursor = 'grabbing';
            }
        }

        let animationId = null;
        let isDragRendering = false;
        let previewDragRendering = false;
        
        function handleMouseMove(e) {
            if (isDragging && selectedElement) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                selectedElement.x = x - dragOffset.x;
                selectedElement.y = y - dragOffset.y;
                
                // S√≥ renderizar se n√£o estiver j√° renderizando
                if (!isDragRendering) {
                    isDragRendering = true;
                    requestAnimationFrame(() => {
                        redrawTextElementsQuick();
                        isDragRendering = false;
                    });
                }
            }
        }

        function handleMouseUp() {
            if (isDragging) {
                isDragging = false;
                canvas.style.cursor = 'crosshair';
                // Fazer uma renderiza√ß√£o completa quando terminar o arraste
                redrawTextElements();
                autoSave();
            }
        }

        function clearAllText() {
            textElements = [];
            selectedElement = null;
            redrawTextElements();
        }

        async function generateFinalPDF() {
            if (textElements.length === 0) {
                showSuccess('Adicione pelo menos um nome antes de gerar o PDF.');
                return;
            }

            if (!originalPDF) {
                showSuccess('Erro: PDF original n√£o encontrado. Fa√ßa upload novamente.');
                return;
            }
            
            // Verificar limite de convites
            if (!canGenerateInvite()) {
                showSuccess('‚ùå Limite de convites esgotado! Entre em contato para renovar seu plano.');
                return;
            }

            try {
                showSuccess('Gerando PDF personalizado...');
                
                // Criar uma nova c√≥pia do ArrayBuffer para evitar problemas
                const pdfData = originalPDF.slice();
                const pdfLibDoc = await PDFLib.PDFDocument.load(pdfData);
                const pages = pdfLibDoc.getPages();
                
                // Obter dimens√µes reais do PDF
                const firstPage = await pdfDoc.getPage(1);
                const viewport = firstPage.getViewport({ scale: 1.0 });
                const PDF_WIDTH = viewport.width;
                const PDF_HEIGHT = viewport.height;
                
                console.log(`üéØ CONVERS√ÉO DE COORDENADAS:`);
                console.log(`PDF original: ${PDF_WIDTH}x${PDF_HEIGHT}`);
                console.log(`Canvas: ${canvas.width}x${canvas.height}`);
                console.log(`Escala usada no canvas: ${scale.toFixed(4)}`);
                
                // CORRE√á√ÉO: Usar escala √∫nica para convers√£o perfeita
                const conversionScale = PDF_WIDTH / canvas.width;
                
                console.log(`Escala de convers√£o: ${conversionScale.toFixed(4)}`);
                
                // Processar cada p√°gina
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    const page = pages[pageNum - 1];
                    const pageTexts = textElements.filter(el => el.page === pageNum);
                    
                    pageTexts.forEach(element => {
                        // CORRE√á√ÉO: Usar coordenadas EXATAS do canvas (texto j√° est√° centralizado)
                        const canvasTextX = element.x; // Posi√ß√£o X j√° calculada (lado esquerdo do texto centralizado)
                        const canvasTextY = element.y + element.fontSize; // Baseline do texto no canvas
                        
                        // Converter para coordenadas do PDF usando escala √∫nica
                        const pdfX = canvasTextX * conversionScale;
                        const pdfY = PDF_HEIGHT - (canvasTextY * conversionScale);
                        
                        // Tamanho da fonte no PDF
                        const pdfFontSize = element.fontSize * conversionScale;
                        
                        console.log(`üìç "${element.text}" (P√°gina ${pageNum}):`);
                        console.log(`  Canvas: (${canvasTextX.toFixed(1)}, ${canvasTextY.toFixed(1)})`);
                        console.log(`  PDF: (${pdfX.toFixed(1)}, ${pdfY.toFixed(1)})`);
                        console.log(`  Fonte: ${element.fontSize}px ‚Üí ${pdfFontSize.toFixed(1)}px`);
                        
                        // Usar fonte padr√£o do PDF-lib (Helvetica √© similar ao Arial)
                        let pdfFont;
                        try {
                            // Mapear fontes para as dispon√≠veis no PDF-lib
                            const fontMap = {
                                'Arial': 'Helvetica',
                                'Times New Roman': 'Times-Roman',
                                'Georgia': 'Times-Roman',
                                'Verdana': 'Helvetica',
                                'Helvetica': 'Helvetica',
                                'Trebuchet MS': 'Helvetica',
                                'Impact': 'Helvetica-Bold',
                                'Comic Sans MS': 'Helvetica',
                                'Courier New': 'Courier',
                                'Brush Script MT': 'Times-Italic'
                            };
                            
                            const fontName = fontMap[element.fontFamily] || 'Helvetica';
                            
                            // Usar fontes padr√£o do PDF-lib
                            if (fontName === 'Times-Roman') {
                                pdfFont = PDFLib.StandardFonts.TimesRoman;
                            } else if (fontName === 'Times-Italic') {
                                pdfFont = PDFLib.StandardFonts.TimesRomanItalic;
                            } else if (fontName === 'Courier') {
                                pdfFont = PDFLib.StandardFonts.Courier;
                            } else if (fontName === 'Helvetica-Bold') {
                                pdfFont = PDFLib.StandardFonts.HelveticaBold;
                            } else {
                                pdfFont = PDFLib.StandardFonts.Helvetica;
                            }
                        } catch (error) {
                            pdfFont = PDFLib.StandardFonts.Helvetica; // Fallback
                        }
                        
                        page.drawText(element.text, {
                            x: pdfX,
                            y: pdfY,
                            size: pdfFontSize,
                            font: pdfFont,
                            color: PDFLib.rgb(
                                parseInt(element.color.substr(1, 2), 16) / 255,
                                parseInt(element.color.substr(3, 2), 16) / 255,
                                parseInt(element.color.substr(5, 2), 16) / 255
                            )
                        });
                    });
                }
                
                const pdfBytes = await pdfLibDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Gerar nome do arquivo automaticamente
                const finalFileName = generateAutoFileName();
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Incrementar contador de uso
                await incrementInviteUsage();
                
                showSuccess('PDF gerado e baixado com sucesso!');
                
                // Limpar campo de nome ap√≥s gerar PDF
                document.getElementById('guestName').value = '';
                
            } catch (error) {
                console.error('Erro:', error);
                showSuccess('Erro ao gerar PDF. Tente fazer upload do arquivo novamente.');
                
                // Se der erro, resetar para permitir novo upload
                setTimeout(() => {
                    resetEditor();
                }, 2000);
            }
        }

        function shareWhatsApp() {
            if (textElements.length === 0) {
                alert('Adicione pelo menos um nome antes de compartilhar.');
                return;
            }

            const whatsappUrl = `https://wa.me/`;
            window.open(whatsappUrl, '_blank');
            
            showSuccess('WhatsApp aberto!');
        }

        function resetEditor() {
            textElements = [];
            selectedElement = null;
            originalPDF = null;
            pdfDoc = null;
            currentPage = 1;
            totalPages = 1;
            
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('editorSection').style.display = 'none';
            document.getElementById('pdfFile').value = '';
            document.getElementById('guestName').value = '';
            document.getElementById('selectedInfo').style.display = 'none';
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                addTextToPDF();
            }
        }
        
        function handleEditEnterKey(event) {
            if (event.key === 'Enter') {
                updateSelectedName();
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 4000);
        }

        // Auto-salvar posi√ß√µes dos textos
        function autoSave() {
            if (textElements.length > 0) {
                localStorage.setItem('inviteTexts', JSON.stringify(textElements));
            }
        }

        // Carregar textos salvos - DESABILITADO para sempre come√ßar limpo
        function loadSavedTexts() {
            // N√£o carregar textos salvos - sempre come√ßar com tela limpa
            textElements = [];
        }

        // Fun√ß√µes da Pr√©via do PDF
        async function showPDFPreview() {
            if (textElements.length === 0) {
                showSuccess('Adicione pelo menos um nome antes de visualizar a pr√©via.');
                return;
            }

            if (!originalPDF) {
                showSuccess('Erro: PDF original n√£o encontrado. Fa√ßa upload novamente.');
                return;
            }

            try {
                isPreviewMode = true;
                previewCurrentPage = 1;
                document.getElementById('pdfPreviewModal').style.display = 'block';
                document.body.style.overflow = 'hidden'; // Impedir scroll da p√°gina
                
                // Aguardar o modal estar vis√≠vel
                await new Promise(resolve => setTimeout(resolve, 100));
                
                await renderPreviewPage();
                updatePreviewPageControls();
                showSuccess('Pr√©via carregada! Voc√™ pode ajustar as posi√ß√µes dos nomes clicando e arrastando.');
                
            } catch (error) {
                console.error('Erro ao mostrar pr√©via:', error);
                showSuccess('Erro ao carregar pr√©via. Tente novamente.');
                closePDFPreview();
            }
        }

        function closePDFPreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaurar scroll da p√°gina
            isPreviewMode = false;
        }

        let previewPdfImageData = null;
        let previewScale = 1;
        
        async function renderPreviewPage() {
            if (!pdfDoc || !previewCtx) return;
            
            try {
                const page = await pdfDoc.getPage(previewCurrentPage);
                
                // CORRE√á√ÉO: Usar mesma l√≥gica de propor√ß√£o do editor principal
                const viewport = page.getViewport({ scale: 1.0 });
                const pdfWidth = viewport.width;
                const pdfHeight = viewport.height;
                const pdfRatio = pdfWidth / pdfHeight;
                
                // Dimens√µes m√°ximas para a pr√©via
                const maxWidth = 700;
                const maxHeight = 500;
                
                // Calcular dimens√µes mantendo propor√ß√£o EXATA do PDF
                let displayWidth, displayHeight;
                
                if (maxWidth / pdfRatio <= maxHeight) {
                    // Limitado pela largura
                    displayWidth = maxWidth;
                    displayHeight = maxWidth / pdfRatio;
                } else {
                    // Limitado pela altura
                    displayHeight = maxHeight;
                    displayWidth = maxHeight * pdfRatio;
                }
                
                // Garantir que as dimens√µes sejam inteiras
                displayWidth = Math.floor(displayWidth);
                displayHeight = Math.floor(displayHeight);
                
                // Calcular escala baseada nas dimens√µes finais
                previewScale = displayWidth / pdfWidth;
                
                // Configurar canvas da pr√©via com dimens√µes exatas
                previewCanvas.width = displayWidth;
                previewCanvas.height = displayHeight;
                previewCanvas.style.width = displayWidth + 'px';
                previewCanvas.style.height = displayHeight + 'px';
                previewCanvas.style.maxWidth = 'none';
                
                console.log(`üìê PR√âVIA - Dimens√µes corrigidas:`);
                console.log(`PDF: ${pdfWidth}x${pdfHeight} (ratio: ${pdfRatio.toFixed(3)})`);
                console.log(`Pr√©via: ${displayWidth}x${displayHeight} (ratio: ${(displayWidth/displayHeight).toFixed(3)})`);
                console.log(`Escala pr√©via: ${previewScale.toFixed(4)}`);
                
                // Renderizar PDF base e salvar
                await renderPreviewPDFBase();
                previewPdfImageData = previewCtx.getImageData(0, 0, previewCanvas.width, previewCanvas.height);
                
                // Desenhar elementos de texto
                redrawPreviewTextElements();
                
            } catch (error) {
                console.error('Erro ao renderizar pr√©via:', error);
            }
        }
        
        async function renderPreviewPDFBase() {
            if (!pdfDoc || !previewCtx) return;
            
            try {
                const page = await pdfDoc.getPage(previewCurrentPage);
                const scaledViewport = page.getViewport({ scale: previewScale });
                
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                
                const renderContext = {
                    canvasContext: previewCtx,
                    viewport: scaledViewport
                };
                
                await page.render(renderContext).promise;
            } catch (error) {
                console.error('Erro ao renderizar base da pr√©via:', error);
            }
        }
        
        function redrawPreviewTextElements() {
            if (!previewPdfImageData) return;
            
            // Restaurar imagem do PDF
            previewCtx.putImageData(previewPdfImageData, 0, 0);
            
            // Desenhar elementos de texto da p√°gina atual
            const currentPageTexts = textElements.filter(el => el.page === previewCurrentPage);
            currentPageTexts.forEach(element => {
                // Usar a mesma escala relativa
                const scaleRatio = previewScale / scale;
                const previewX = element.x * scaleRatio;
                const previewY = element.y * scaleRatio;
                const previewFontSize = element.fontSize * scaleRatio;
                const previewWidth = element.width * scaleRatio;
                
                previewCtx.font = `bold ${previewFontSize}px ${element.fontFamily || 'Arial'}`;
                previewCtx.fillStyle = element.color;
                previewCtx.textAlign = 'left'; // Usar alinhamento √† esquerda para posicionamento preciso
                previewCtx.fillText(element.text, previewX, previewY + previewFontSize);
                
                // Desenhar borda se selecionado
                if (selectedElement && selectedElement.id === element.id) {
                    previewCtx.strokeStyle = '#667eea';
                    previewCtx.lineWidth = 2;
                    previewCtx.setLineDash([5, 5]);
                    previewCtx.strokeRect(previewX, previewY, previewWidth, previewFontSize + 10);
                    previewCtx.setLineDash([]);
                }
            });
        }

        function updatePreviewPageControls() {
            document.getElementById('previewPageInfo').textContent = `P√°gina ${previewCurrentPage} de ${totalPages}`;
            document.getElementById('prevPreviewBtn').disabled = previewCurrentPage <= 1;
            document.getElementById('nextPreviewBtn').disabled = previewCurrentPage >= totalPages;
            
            const prevBtn = document.getElementById('prevPreviewBtn');
            const nextBtn = document.getElementById('nextPreviewBtn');
            
            prevBtn.style.opacity = previewCurrentPage <= 1 ? '0.5' : '1';
            nextBtn.style.opacity = previewCurrentPage >= totalPages ? '0.5' : '1';
        }

        function previousPreviewPage() {
            if (previewCurrentPage > 1) {
                previewCurrentPage--;
                renderPreviewPage();
                updatePreviewPageControls();
            }
        }

        function nextPreviewPage() {
            if (previewCurrentPage < totalPages) {
                previewCurrentPage++;
                renderPreviewPage();
                updatePreviewPageControls();
            }
        }

        // Eventos do canvas da pr√©via (similares ao editor principal)
        function handlePreviewCanvasClick(e) {
            const rect = previewCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Verificar se clicou em um elemento existente
            const scaleRatio = previewScale / scale;
            const currentPageTexts = textElements.filter(el => el.page === previewCurrentPage);
            const clickedElement = currentPageTexts.find(el => {
                const previewElementX = el.x * scaleRatio;
                const previewElementY = el.y * scaleRatio;
                const previewElementWidth = el.width * scaleRatio;
                const previewElementHeight = el.height * scaleRatio;
                
                return x >= previewElementX && x <= previewElementX + previewElementWidth &&
                       y >= previewElementY && y <= previewElementY + previewElementHeight;
            });
            
            if (clickedElement) {
                selectElement(clickedElement);
                redrawPreviewTextElements(); // Redesenhar apenas os textos
            }
        }

        function handlePreviewMouseDown(e) {
            const rect = previewCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const scaleRatio = previewScale / scale;
            const currentPageTexts = textElements.filter(el => el.page === previewCurrentPage);
            
            const clickedElement = currentPageTexts.find(el => {
                const previewElementX = el.x * scaleRatio;
                const previewElementY = el.y * scaleRatio;
                const previewElementWidth = el.width * scaleRatio;
                const previewElementHeight = el.height * scaleRatio;
                
                return x >= previewElementX && x <= previewElementX + previewElementWidth &&
                       y >= previewElementY && y <= previewElementY + previewElementHeight;
            });
            
            if (clickedElement) {
                isDragging = true;
                selectedElement = clickedElement;
                dragOffset.x = x - (clickedElement.x * scaleRatio);
                dragOffset.y = y - (clickedElement.y * scaleRatio);
                previewCanvas.style.cursor = 'grabbing';
            }
        }

        function handlePreviewMouseMove(e) {
            if (isDragging && selectedElement && isPreviewMode) {
                const rect = previewCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const scaleRatio = previewScale / scale;
                
                // Atualizar posi√ß√£o no elemento original (coordenadas do editor)
                selectedElement.x = (x - dragOffset.x) / scaleRatio;
                selectedElement.y = (y - dragOffset.y) / scaleRatio;
                
                // Redesenhar apenas os elementos de texto (sem piscar)
                if (!previewDragRendering) {
                    previewDragRendering = true;
                    requestAnimationFrame(() => {
                        redrawPreviewTextElements();
                        previewDragRendering = false;
                    });
                }
            }
        }

        function handlePreviewMouseUp() {
            if (isDragging && isPreviewMode) {
                isDragging = false;
                previewCanvas.style.cursor = 'crosshair';
                autoSave();
                
                // Tamb√©m atualizar o editor principal se estiver na mesma p√°gina
                if (currentPage === previewCurrentPage) {
                    redrawTextElements();
                }
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d78a3cd79977d9',t:'MTc1NDkxMzI4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
