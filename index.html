<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invites - Sistema de Confirma√ß√£o de Presen√ßa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        .input {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .nav-tab {
            padding: 12px 24px;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
        }
        
        .nav-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .nav-tab:hover {
            color: #374151;
        }

        .guest-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
        }

        .guest-content {
            padding-top: 100px;
        }

        .promo-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .promo-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .countdown-pulse {
            animation: pulse 2s infinite;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="font-inter min-h-screen bg-gray-50">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4" id="main-header">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-semibold text-gray-900">Invites</h1>
            <button onclick="showLogin()" id="login-btn" class="btn btn-secondary">
                üë§ Login
            </button>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 px-6" id="main-nav">
        <div class="max-w-6xl mx-auto flex">
            <button onclick="showHome()" id="nav-home" class="nav-tab active">In√≠cio</button>
            <button onclick="showCreate()" id="nav-create" class="nav-tab">Criar Evento</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto px-6 py-8" id="main-container">

        <!-- Home Section -->
        <section id="home-section">
            <div class="card p-8">
                <h2 class="text-3xl font-semibold text-gray-900 mb-8 text-center">Como Funciona</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">1</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-900">Crie o Evento</h3>
                        <p class="text-gray-600">Configure os detalhes do seu evento e personalize as op√ß√µes</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">2</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-900">Compartilhe</h3>
                        <p class="text-gray-600">Envie o link personalizado para os convidados</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">3</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-900">Gerencie</h3>
                        <p class="text-gray-600">Acompanhe as confirma√ß√µes e baixe relat√≥rios</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Create Event Section -->
        <section id="create-section" class="hidden">
            <div class="card p-8">
                <h2 class="text-3xl font-semibold text-gray-900 mb-8">Criar Novo Evento</h2>
                
                <form id="event-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo do Evento *</label>
                        <input type="text" id="event-title" required placeholder="Ex: Casamento Jo√£o & Maria" class="input">
                    </div>

                    <!-- Configura√ß√µes -->
                    <div class="bg-gray-50 rounded-lg p-6 border">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Configura√ß√µes do Evento</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-description" checked class="mr-3">
                                <span class="text-sm text-gray-700">Mostrar descri√ß√£o do evento</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-deadline" checked class="mr-3">
                                <span class="text-sm text-gray-700">Definir prazo para confirma√ß√£o</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-max-limit" checked class="mr-3">
                                <span class="text-sm text-gray-700">Definir limite m√°ximo</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-public-wall" checked class="mr-3">
                                <span class="text-sm text-gray-700">Mural p√∫blico de mensagens</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-gifts" class="mr-3">
                                <span class="text-sm text-gray-700">Ativar sugest√µes de presentes</span>
                            </label>
                        </div>
                    </div>

                    <div id="description-field">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o do Evento *</label>
                        <textarea id="event-description" required placeholder="Descreva seu evento..." class="input h-24 resize-none"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data do Evento *</label>
                            <input type="date" id="event-date" required class="input">
                        </div>
                        <div id="deadline-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prazo para Confirma√ß√£o *</label>
                            <input type="date" id="confirmation-deadline" required class="input">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="max-limit-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Limite M√°ximo de Confirmados *</label>
                            <input type="number" id="max-confirmations" required placeholder="Ex: 100" min="1" class="input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Limite de Acompanhantes *</label>
                            <input type="number" id="companion-limit" required placeholder="Ex: 1" min="0" max="10" class="input">
                            <p class="text-sm text-gray-500 mt-1">0 = Sem acompanhantes | 1+ = M√°ximo por convidado</p>
                        </div>
                    </div>

                    <!-- Gift Configuration -->
                    <div id="gifts-field" class="bg-yellow-50 rounded-lg p-6 border border-yellow-200" style="display: none;">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Configura√ß√£o de Presentes</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Presente</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="gift-type" value="bank" id="gift-bank" class="mr-3">
                                    <span class="text-sm text-gray-700">Transfer√™ncia Banc√°ria</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="gift-type" value="list" id="gift-list" class="mr-3">
                                    <span class="text-sm text-gray-700">Lista de Sugest√µes</span>
                                </label>
                            </div>
                        </div>

                        <!-- Bank Transfer Configuration -->
                        <div id="bank-config" class="space-y-4" style="display: none;">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem Personalizada</label>
                                <textarea id="bank-message" class="input h-32 resize-none" placeholder="Digite sua mensagem personalizada...">Querido(a) convidado(a)!
Caso queira nos presentear, agradecemos
desde j√° o seu lindo gesto e gostar√≠amos
que o fizesse por transfer√™ncia banc√°ria.
para o IBAN indicado abaixo:

AO. 7210158 
Titular Diogo dos santos Ingl√™s

Muito obrigado(a)!
Deus lhe aben√ßoe sempre!</textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IBAN</label>
                                    <input type="text" id="bank-iban" placeholder="Ex: AO. 7210158" class="input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Titular da Conta</label>
                                    <input type="text" id="bank-holder" placeholder="Ex: Diogo dos santos Ingl√™s" class="input">
                                </div>
                            </div>
                        </div>

                        <!-- Gift List Configuration -->
                        <div id="list-config" class="space-y-4" style="display: none;">
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Lista de Presentes</label>
                                <button type="button" onclick="addGiftItem()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                    ‚ûï Adicionar Item
                                </button>
                            </div>
                            <div id="gift-items" class="space-y-3">
                                <!-- Gift items will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Credenciais -->
                    <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Credenciais de Acesso</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio *</label>
                                <input type="text" id="username" required placeholder="Ex: joao2025" class="input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha *</label>
                                <input type="password" id="password" required placeholder="Senha segura" class="input">
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="create-btn" class="w-full btn btn-primary py-4 text-lg">
                        Criar Evento
                    </button>
                </form>

                <!-- Success Message -->
                <div id="success-message" class="hidden mt-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="text-xl font-semibold text-green-800 mb-4">üéâ Evento Criado com Sucesso!</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded border">
                            <h4 class="font-semibold text-gray-800 mb-2">Link Completo (permite acompanhantes)</h4>
                            <div id="full-url" class="text-sm text-blue-600 font-mono mb-3 break-all"></div>
                            <button onclick="copyFullUrl()" class="btn btn-primary">üìã Copiar Link Completo</button>
                        </div>
                        
                        <div class="bg-white p-4 rounded border">
                            <h4 class="font-semibold text-gray-800 mb-2">Link Sem Acompanhante</h4>
                            <div id="no-companion-url" class="text-sm text-orange-600 font-mono mb-3 break-all"></div>
                            <button onclick="copyNoCompanionUrl()" class="btn btn-secondary">üìã Copiar Link Sem Acompanhante</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Login Section -->
        <section id="login-section" class="hidden">
            <div class="max-w-md mx-auto">
                <div class="card p-8">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-6 text-center">Login</h2>
                    
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                            <input type="text" id="login-username" required class="input" placeholder="Digite seu usu√°rio">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                            <input type="password" id="login-password" required class="input" placeholder="Digite sua senha">
                        </div>

                        <div id="login-error" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded border border-red-200"></div>

                        <div class="flex gap-3">
                            <button type="submit" id="login-btn-submit" class="flex-1 btn btn-primary py-3">Entrar</button>
                            <button type="button" onclick="goBack()" class="flex-1 btn btn-secondary py-3">Voltar</button>
                        </div>
                    </form>


                </div>
            </div>
        </section>

        <!-- Master Login Section -->
        <section id="master-login-section" class="hidden">
            <div class="max-w-md mx-auto">
                <div class="card p-8">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-6 text-center">Master Admin</h2>
                    
                    <form id="master-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo Master</label>
                            <input type="password" id="master-code" required class="input" placeholder="Digite o c√≥digo master">
                        </div>

                        <div id="master-error" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded border border-red-200"></div>

                        <div class="flex gap-3">
                            <button type="submit" id="master-btn-submit" class="flex-1 btn btn-danger py-3">Acessar</button>
                            <button type="button" onclick="showLogin()" class="flex-1 btn btn-secondary py-3">Voltar</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="hidden">
            <div class="card p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-900">Painel do Evento</h2>
                        <p id="event-info" class="text-gray-600"></p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="copyEventFullUrl()" class="btn btn-primary text-sm">üìã Link Completo</button>
                        <button onclick="copyEventNoCompanionUrl()" class="btn btn-secondary text-sm">üìã Sem Acompanhante</button>
                        <button onclick="showPasswordManager()" class="btn btn-secondary text-sm">üîë Senha</button>
                        <button onclick="showEventEditor()" class="btn btn-secondary text-sm">‚úèÔ∏è Editar Evento</button>
                        <button onclick="downloadReport()" class="btn btn-success text-sm">üìÑ Relat√≥rio</button>
                        <button onclick="showDeleteOptions()" class="btn btn-danger text-sm">üóëÔ∏è Gerenciar</button>
                        <button onclick="logout()" class="btn btn-danger text-sm">üö™ Sair</button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4 text-center border border-blue-100">
                        <div class="text-2xl font-bold text-blue-600" id="total-guests">0</div>
                        <div class="text-sm text-blue-700">Total</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border border-green-100">
                        <div class="text-2xl font-bold text-green-600" id="confirmed-guests">0</div>
                        <div class="text-sm text-green-700">Confirmados</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border border-purple-100" id="max-stat">
                        <div class="text-2xl font-bold text-purple-600" id="max-limit-display">0</div>
                        <div class="text-sm text-purple-700">Limite</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 text-center border border-orange-100" id="deadline-stat">
                        <div class="text-sm font-bold text-orange-600" id="deadline-display">-</div>
                        <div class="text-sm text-orange-700">Prazo</div>
                    </div>
                </div>
            </div>

            <!-- Password Manager -->
            <div id="password-manager" class="card p-6 mb-6 hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Gerenciar Senha</h3>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio Atual:</label>
                            <div class="bg-white p-2 rounded border font-mono text-sm" id="current-username"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Senha Atual:</label>
                            <div class="bg-white p-2 rounded border font-mono text-sm" id="current-password"></div>
                        </div>
                    </div>
                </div>

                <form id="password-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nova Senha *</label>
                        <input type="password" id="new-password" required class="input" placeholder="Digite a nova senha">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Nova Senha *</label>
                        <input type="password" id="confirm-password" required class="input" placeholder="Confirme a nova senha">
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn btn-success">‚úÖ Alterar Senha</button>
                        <button type="button" onclick="hidePasswordManager()" class="btn btn-secondary">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Event Editor -->
            <div id="event-editor" class="card p-6 mb-6 hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Editar Evento</h3>
                
                <form id="edit-event-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo do Evento *</label>
                        <input type="text" id="edit-event-title" required class="input">
                    </div>

                    <!-- Configura√ß√µes -->
                    <div class="bg-gray-50 rounded-lg p-6 border">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Configura√ß√µes do Evento</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-enable-description" class="mr-3">
                                <span class="text-sm text-gray-700">Mostrar descri√ß√£o do evento</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-enable-deadline" class="mr-3">
                                <span class="text-sm text-gray-700">Definir prazo para confirma√ß√£o</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-enable-max-limit" class="mr-3">
                                <span class="text-sm text-gray-700">Definir limite m√°ximo</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-enable-public-wall" class="mr-3">
                                <span class="text-sm text-gray-700">Mural p√∫blico de mensagens</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-enable-gifts" class="mr-3">
                                <span class="text-sm text-gray-700">Ativar sugest√µes de presentes</span>
                            </label>
                        </div>
                    </div>

                    <div id="edit-description-field">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o do Evento</label>
                        <textarea id="edit-event-description" class="input h-24 resize-none"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data do Evento *</label>
                            <input type="date" id="edit-event-date" required class="input">
                        </div>
                        <div id="edit-deadline-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prazo para Confirma√ß√£o</label>
                            <input type="date" id="edit-confirmation-deadline" class="input">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="edit-max-limit-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Limite M√°ximo de Confirmados</label>
                            <input type="number" id="edit-max-confirmations" min="1" class="input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Limite de Acompanhantes *</label>
                            <input type="number" id="edit-companion-limit" required min="0" max="10" class="input">
                            <p class="text-sm text-gray-500 mt-1">0 = Sem acompanhantes | 1+ = M√°ximo por convidado</p>
                        </div>
                    </div>

                    <!-- Edit Gift Configuration -->
                    <div id="edit-gifts-field" class="bg-yellow-50 rounded-lg p-6 border border-yellow-200" style="display: none;">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Configura√ß√£o de Presentes</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Presente</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="edit-gift-type" value="bank" id="edit-gift-bank" class="mr-3">
                                    <span class="text-sm text-gray-700">Transfer√™ncia Banc√°ria</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="edit-gift-type" value="list" id="edit-gift-list" class="mr-3">
                                    <span class="text-sm text-gray-700">Lista de Sugest√µes</span>
                                </label>
                            </div>
                        </div>

                        <!-- Edit Bank Transfer Configuration -->
                        <div id="edit-bank-config" class="space-y-4" style="display: none;">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem Personalizada</label>
                                <textarea id="edit-bank-message" class="input h-32 resize-none" placeholder="Digite sua mensagem personalizada..."></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IBAN</label>
                                    <input type="text" id="edit-bank-iban" placeholder="Ex: AO. 7210158" class="input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Titular da Conta</label>
                                    <input type="text" id="edit-bank-holder" placeholder="Ex: Diogo dos santos Ingl√™s" class="input">
                                </div>
                            </div>
                        </div>

                        <!-- Edit Gift List Configuration -->
                        <div id="edit-list-config" class="space-y-4" style="display: none;">
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Lista de Presentes</label>
                                <button type="button" onclick="addEditGiftItem()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                    ‚ûï Adicionar Item
                                </button>
                            </div>
                            <div id="edit-gift-items" class="space-y-3">
                                <!-- Gift items will be added here -->
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="btn btn-success">‚úÖ Salvar Altera√ß√µes</button>
                        <button type="button" onclick="hideEventEditor()" class="btn btn-secondary">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Delete Options -->
            <div id="delete-options" class="card p-6 mb-6 hidden">
                <h3 class="text-xl font-semibold text-red-800 mb-4">üóëÔ∏è Op√ß√µes de Exclus√£o</h3>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-red-700 font-medium">‚ö†Ô∏è Aten√ß√£o: Estas a√ß√µes s√£o irrevers√≠veis!</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Excluir Convidados Espec√≠ficos</h4>
                        <p class="text-sm text-gray-600 mb-3">Remove convidados individuais da lista</p>
                        <button onclick="showGuestDeletion()" class="btn btn-danger text-sm">üóëÔ∏è Gerenciar Convidados</button>
                    </div>

                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Limpar Todas as Mensagens</h4>
                        <p class="text-sm text-gray-600 mb-3">Remove todas as mensagens do mural p√∫blico</p>
                        <button onclick="clearAllMessages()" class="btn btn-danger text-sm">üóëÔ∏è Limpar Mensagens</button>
                    </div>

                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Limpar Todos os Convidados</h4>
                        <p class="text-sm text-gray-600 mb-3">Remove todos os convidados e suas confirma√ß√µes</p>
                        <button onclick="clearAllGuests()" class="btn btn-danger text-sm">üóëÔ∏è Limpar Todos</button>
                    </div>

                    <div class="bg-red-100 border border-red-300 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 mb-2">Excluir Evento Completo</h4>
                        <p class="text-sm text-red-700 mb-3">Remove permanentemente o evento e todos os dados</p>
                        <button onclick="deleteEntireEvent()" class="btn btn-danger text-sm">üóëÔ∏è Excluir Evento</button>
                    </div>
                </div>

                <div class="mt-6">
                    <button onclick="hideDeleteOptions()" class="btn btn-secondary">‚ùå Cancelar</button>
                </div>
            </div>

            <!-- Guest Deletion Manager -->
            <div id="guest-deletion" class="card p-6 mb-6 hidden">
                <h3 class="text-xl font-semibold text-red-800 mb-4">üóëÔ∏è Gerenciar Convidados</h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-3">Selecionar</th>
                                <th class="text-left py-2 px-3">Nome</th>
                                <th class="text-left py-2 px-3">Acompanhante</th>
                                <th class="text-left py-2 px-3">Status</th>
                                <th class="text-left py-2 px-3">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="guest-deletion-list">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 flex gap-3">
                    <button onclick="deleteSelectedGuests()" class="btn btn-danger">üóëÔ∏è Excluir Selecionados</button>
                    <button onclick="hideGuestDeletion()" class="btn btn-secondary">‚ùå Cancelar</button>
                </div>
            </div>

            <!-- Guest List -->
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Lista de Convidados</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-3">Nome</th>
                                <th class="text-left py-2 px-3">Acompanhante</th>
                                <th class="text-left py-2 px-3">Status</th>
                                <th class="text-left py-2 px-3">Data</th>
                            </tr>
                        </thead>
                        <tbody id="guest-list">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Messages -->
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Mensagens dos Convidados</h3>
                <div id="messages-list" class="space-y-4">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Master Dashboard Section -->
        <section id="master-dashboard-section" class="hidden">
            <div class="card p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-900">Painel Master Admin</h2>
                        <p class="text-gray-600">Gerenciamento de todos os eventos</p>
                    </div>
                    <button onclick="logout()" class="btn btn-danger">üö™ Sair</button>
                </div>

                <!-- Master Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4 text-center border border-blue-100">
                        <div class="text-2xl font-bold text-blue-600" id="total-events">0</div>
                        <div class="text-sm text-blue-700">Total de Eventos</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border border-green-100">
                        <div class="text-2xl font-bold text-green-600" id="total-all-guests">0</div>
                        <div class="text-sm text-green-700">Total de Convidados</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border border-purple-100">
                        <div class="text-2xl font-bold text-purple-600" id="total-messages">0</div>
                        <div class="text-sm text-purple-700">Total de Mensagens</div>
                    </div>
                </div>
            </div>

            <!-- All Events List -->
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Todos os Eventos</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-3">Evento</th>
                                <th class="text-left py-2 px-3">Usu√°rio</th>
                                <th class="text-left py-2 px-3">Senha</th>
                                <th class="text-left py-2 px-3">Convidados</th>
                                <th class="text-left py-2 px-3">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="all-events-list">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Event Site Section -->
        <section id="event-site-section" class="hidden">
            <div id="event-site-content">
                <!-- Populated by JavaScript -->
            </div>
        </section>

    </div>

    <!-- Footer -->
    <footer class="text-center py-6 mt-8 border-t border-gray-200 bg-white" id="main-footer">
        <p class="text-sm text-gray-500">¬© 2025 Invites - Sistema de Confirma√ß√£o de Presen√ßa</p>
    </footer>

    <!-- Promotional Link (only visible on guest pages) -->
    <a href="https://wa.me/244959823409?text=Ol√°! Vi o site de eventos e gostaria de saber mais sobre como criar o meu pr√≥prio evento." 
       class="promo-link hidden" id="promo-link" target="_blank">
        <span>üíö</span>
        <span>Gostou? Crie o seu!</span>
    </a>

    <script>
        // Global Variables
        const supabaseUrl = 'https://ybbhynfttwogkdsnqmvu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliYmh5bmZ0dHdvZ2tkc25xbXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY3MDIsImV4cCI6MjA3MTI1MjcwMn0.LPMGW_OPKiwTEKhyzl_v2Snb9nVeZg0wP4Ot6zKrCn0';
        const MASTER_CODE = 'invites2025master';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentEvent = null;
        let currentUser = null;
        let isMasterAdmin = false;
        let countdownInterval = null;
        let userResponse = null;
        let companionCount = 0;
        let giftItemCount = 0;
        let editGiftItemCount = 0;

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const clienteParam = urlParams.get('cliente');

        // Navigation Functions
        function showHome() {
            hideAllSections();
            document.getElementById('home-section').classList.remove('hidden');
            updateNavigation('home');
        }

        function showCreate() {
            hideAllSections();
            document.getElementById('create-section').classList.remove('hidden');
            updateNavigation('create');
        }

        function showLogin() {
            hideAllSections();
            document.getElementById('login-section').classList.remove('hidden');
        }

        function showMasterLogin() {
            hideAllSections();
            document.getElementById('master-login-section').classList.remove('hidden');
        }

        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboard-section').classList.remove('hidden');
        }

        function showMasterDashboard() {
            hideAllSections();
            document.getElementById('master-dashboard-section').classList.remove('hidden');
        }

        function showEventSite() {
            hideAllSections();
            document.getElementById('event-site-section').classList.remove('hidden');
            document.getElementById('main-nav').classList.add('hidden');
            document.getElementById('main-footer').classList.add('hidden');
            document.getElementById('promo-link').classList.remove('hidden');
        }

        function hideAllSections() {
            const sections = document.querySelectorAll('section');
            sections.forEach(section => section.classList.add('hidden'));
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('main-footer').classList.remove('hidden');
            document.getElementById('promo-link').classList.add('hidden');
        }

        function updateNavigation(active) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`nav-${active}`).classList.add('active');
        }

        function goBack() {
            if (clienteParam) {
                showEventSite();
            } else {
                showHome();
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function generateCustomUrl(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 50);
        }

        // Session Management
        function saveSession(data) {
            localStorage.setItem('eventSession', JSON.stringify(data));
        }

        function loadSession() {
            const session = localStorage.getItem('eventSession');
            return session ? JSON.parse(session) : null;
        }

        function clearSession() {
            localStorage.removeItem('eventSession');
        }

        // Field Toggle Functions
        function setupFieldToggles() {
            const toggles = [
                { checkbox: 'enable-description', field: 'description-field', input: 'event-description' },
                { checkbox: 'enable-deadline', field: 'deadline-field', input: 'confirmation-deadline' },
                { checkbox: 'enable-max-limit', field: 'max-limit-field', input: 'max-confirmations' },
                { checkbox: 'enable-gifts', field: 'gifts-field', input: null }
            ];

            toggles.forEach(({ checkbox, field, input }) => {
                const checkboxEl = document.getElementById(checkbox);
                const fieldEl = document.getElementById(field);
                const inputEl = input ? document.getElementById(input) : null;

                checkboxEl.addEventListener('change', () => {
                    if (checkboxEl.checked) {
                        fieldEl.style.display = 'block';
                        if (inputEl) inputEl.required = true;
                    } else {
                        fieldEl.style.display = 'none';
                        if (inputEl) {
                            inputEl.required = false;
                            inputEl.value = '';
                        }
                    }
                });
            });

            // Setup gift type toggles
            setupGiftTypeToggles();
        }

        function setupGiftTypeToggles() {
            const bankRadio = document.getElementById('gift-bank');
            const listRadio = document.getElementById('gift-list');
            const bankConfig = document.getElementById('bank-config');
            const listConfig = document.getElementById('list-config');

            if (bankRadio && listRadio) {
                bankRadio.addEventListener('change', () => {
                    if (bankRadio.checked) {
                        bankConfig.style.display = 'block';
                        listConfig.style.display = 'none';
                    }
                });

                listRadio.addEventListener('change', () => {
                    if (listRadio.checked) {
                        bankConfig.style.display = 'none';
                        listConfig.style.display = 'block';
                    }
                });
            }
        }

        // Gift Management Functions
        function addGiftItem() {
            giftItemCount++;
            const giftItems = document.getElementById('gift-items');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2 items-center';
            itemDiv.id = `gift-item-${giftItemCount}`;
            
            itemDiv.innerHTML = `
                <input type="text" 
                       id="gift-name-${giftItemCount}" 
                       placeholder="Nome do presente" 
                       class="input flex-1">
                <input type="number" 
                       id="gift-quantity-${giftItemCount}" 
                       placeholder="Qtd" 
                       min="1" 
                       value="1"
                       class="input w-20">
                <button type="button" 
                        onclick="removeGiftItem(${giftItemCount})" 
                        class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 text-sm">
                    üóëÔ∏è
                </button>
            `;
            
            giftItems.appendChild(itemDiv);
        }

        function removeGiftItem(itemId) {
            const item = document.getElementById(`gift-item-${itemId}`);
            if (item) {
                item.remove();
            }
        }

        function addEditGiftItem(existingName = '', existingQuantity = 1) {
            editGiftItemCount++;
            const giftItems = document.getElementById('edit-gift-items');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2 items-center';
            itemDiv.id = `edit-gift-item-${editGiftItemCount}`;
            
            itemDiv.innerHTML = `
                <input type="text" 
                       id="edit-gift-name-${editGiftItemCount}" 
                       placeholder="Nome do presente" 
                       value="${existingName}"
                       class="input flex-1">
                <input type="number" 
                       id="edit-gift-quantity-${editGiftItemCount}" 
                       placeholder="Qtd" 
                       min="1" 
                       value="${existingQuantity}"
                       class="input w-20">
                <button type="button" 
                        onclick="removeEditGiftItem(${editGiftItemCount})" 
                        class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 text-sm">
                    üóëÔ∏è
                </button>
            `;
            
            giftItems.appendChild(itemDiv);
        }

        function removeEditGiftItem(itemId) {
            const item = document.getElementById(`edit-gift-item-${itemId}`);
            if (item) {
                item.remove();
            }
        }

        function getGiftItems() {
            const items = [];
            for (let i = 1; i <= giftItemCount; i++) {
                const nameField = document.getElementById(`gift-name-${i}`);
                const quantityField = document.getElementById(`gift-quantity-${i}`);
                if (nameField && nameField.value.trim() && quantityField) {
                    items.push({
                        name: nameField.value.trim(),
                        quantity: parseInt(quantityField.value) || 1
                    });
                }
            }
            return items;
        }

        function getEditGiftItems() {
            const items = [];
            for (let i = 1; i <= editGiftItemCount; i++) {
                const nameField = document.getElementById(`edit-gift-name-${i}`);
                const quantityField = document.getElementById(`edit-gift-quantity-${i}`);
                if (nameField && nameField.value.trim() && quantityField) {
                    items.push({
                        name: nameField.value.trim(),
                        quantity: parseInt(quantityField.value) || 1
                    });
                }
            }
            return items;
        }

        // Create Event
        document.getElementById('event-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const createBtn = document.getElementById('create-btn');
            createBtn.textContent = 'Criando...';
            createBtn.disabled = true;

            try {
                const giftType = document.querySelector('input[name="gift-type"]:checked')?.value || null;
                let giftConfig = null;

                if (document.getElementById('enable-gifts').checked && giftType) {
                    if (giftType === 'bank') {
                        giftConfig = {
                            type: 'bank',
                            message: document.getElementById('bank-message').value.trim(),
                            iban: document.getElementById('bank-iban').value.trim(),
                            holder: document.getElementById('bank-holder').value.trim()
                        };
                    } else if (giftType === 'list') {
                        giftConfig = {
                            type: 'list',
                            items: getGiftItems()
                        };
                    }
                }

                const formData = {
                    title: document.getElementById('event-title').value.trim(),
                    description: document.getElementById('enable-description').checked ? 
                        document.getElementById('event-description').value.trim() : '',
                    event_date: document.getElementById('event-date').value,
                    confirmation_deadline: document.getElementById('enable-deadline').checked ? 
                        document.getElementById('confirmation-deadline').value : null,
                    max_confirmations: document.getElementById('enable-max-limit').checked ? 
                        parseInt(document.getElementById('max-confirmations').value) : null,
                    companion_limit: parseInt(document.getElementById('companion-limit').value),
                    username: document.getElementById('username').value.trim(),
                    password: document.getElementById('password').value.trim(),
                    custom_url: generateCustomUrl(document.getElementById('event-title').value.trim()),
                    enable_description: document.getElementById('enable-description').checked,
                    enable_deadline: document.getElementById('enable-deadline').checked,
                    enable_max_limit: document.getElementById('enable-max-limit').checked,
                    enable_public_wall: document.getElementById('enable-public-wall').checked,
                    enable_gifts: document.getElementById('enable-gifts').checked,
                    gift_config: giftConfig
                };

                const { data, error } = await supabase
                    .from('events')
                    .insert(formData)
                    .select()
                    .single();

                if (error) throw error;

                // Show success message
                const baseUrl = 'https://araujo418.github.io/painel-invitesqr/index.html';
                const fullUrl = `${baseUrl}?cliente=${formData.custom_url}`;
                const noCompanionUrl = `${fullUrl}&companion=no`;

                document.getElementById('full-url').textContent = fullUrl;
                document.getElementById('no-companion-url').textContent = noCompanionUrl;
                document.getElementById('success-message').classList.remove('hidden');

                // Reset form
                document.getElementById('event-form').reset();
                alert('üéâ Evento criado com sucesso!');

            } catch (error) {
                console.error('Error creating event:', error);
                alert('Erro ao criar evento: ' + error.message);
            } finally {
                createBtn.textContent = 'Criar Evento';
                createBtn.disabled = false;
            }
        });

        // Copy URL Functions
        function copyFullUrl() {
            const url = document.getElementById('full-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link completo copiado!');
            });
        }

        function copyNoCompanionUrl() {
            const url = document.getElementById('no-companion-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link sem acompanhante copiado!');
            });
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const loginBtn = document.getElementById('login-btn-submit');
            const errorDiv = document.getElementById('login-error');
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            loginBtn.textContent = 'Entrando...';
            loginBtn.disabled = true;
            errorDiv.classList.add('hidden');

            try {
                const { data, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error) throw error;

                currentEvent = data;
                currentUser = data;
                saveSession(data);

                await loadDashboard();
                showDashboard();

            } catch (error) {
                errorDiv.textContent = 'Usu√°rio ou senha incorretos.';
                errorDiv.classList.remove('hidden');
            } finally {
                loginBtn.textContent = 'Entrar';
                loginBtn.disabled = false;
            }
        });

        // Master Login
        document.getElementById('master-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const masterBtn = document.getElementById('master-btn-submit');
            const errorDiv = document.getElementById('master-error');
            const code = document.getElementById('master-code').value.trim();

            masterBtn.textContent = 'Verificando...';
            masterBtn.disabled = true;
            errorDiv.classList.add('hidden');

            try {
                if (code !== MASTER_CODE) {
                    throw new Error('C√≥digo master incorreto');
                }

                isMasterAdmin = true;
                await loadMasterDashboard();
                showMasterDashboard();

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                masterBtn.textContent = 'Acessar';
                masterBtn.disabled = false;
            }
        });

        // Dashboard Functions
        async function loadDashboard() {
            if (!currentEvent) return;

            // Update event info
            document.getElementById('event-info').textContent = 
                `${currentEvent.title} - ${formatDate(currentEvent.event_date)}`;

            // Show/hide stats based on configuration
            document.getElementById('max-stat').style.display = 
                currentEvent.enable_max_limit ? 'block' : 'none';
            document.getElementById('deadline-stat').style.display = 
                currentEvent.enable_deadline ? 'block' : 'none';

            await loadStats();
            await loadGuestList();
            await loadMessages();
        }

        async function loadStats() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id);

                const totalGuests = rsvps ? rsvps.length : 0;
                const confirmedGuests = rsvps ? rsvps.filter(r => r.attendance).length : 0;

                document.getElementById('total-guests').textContent = totalGuests;
                document.getElementById('confirmed-guests').textContent = confirmedGuests;

                if (currentEvent.enable_max_limit) {
                    document.getElementById('max-limit-display').textContent = 
                        currentEvent.max_confirmations || 'Ilimitado';
                }

                if (currentEvent.enable_deadline) {
                    document.getElementById('deadline-display').textContent = 
                        formatDate(currentEvent.confirmation_deadline);
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadGuestList() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .order('created_at', { ascending: false });

                const guestList = document.getElementById('guest-list');
                guestList.innerHTML = '';

                if (rsvps && rsvps.length > 0) {
                    rsvps.forEach(rsvp => {
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="py-3 px-4">${rsvp.guest_name}</td>
                            <td class="py-3 px-4">${rsvp.companion_name || '-'}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs ${rsvp.attendance ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${rsvp.attendance ? '‚úÖ Confirmado' : '‚ùå N√£o Confirmado'}
                                </span>
                            </td>
                            <td class="py-3 px-4">${formatDate(rsvp.created_at)}</td>
                        `;
                        guestList.appendChild(row);
                    });
                } else {
                    guestList.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">Nenhum convidado ainda</td></tr>';
                }

            } catch (error) {
                console.error('Error loading guest list:', error);
            }
        }

        async function loadMessages() {
            try {
                const { data: messages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .not('message', 'is', null)
                    .neq('message', '')
                    .order('created_at', { ascending: false });

                const messagesList = document.getElementById('messages-list');
                messagesList.innerHTML = '';

                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'bg-gray-50 rounded-lg p-4';
                        messageDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800">${message.guest_name}</h4>
                                <span class="text-sm text-gray-500">${formatDate(message.created_at)}</span>
                            </div>
                            <p class="text-gray-600">${message.message}</p>
                        `;
                        messagesList.appendChild(messageDiv);
                    });
                } else {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma mensagem ainda</p>';
                }

            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Master Dashboard Functions
        async function loadMasterDashboard() {
            try {
                // Get all events
                const { data: events } = await supabase
                    .from('events')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Get all RSVPs
                const { data: allRsvps } = await supabase
                    .from('rsvps')
                    .select('*');

                // Get all messages
                const { data: allMessages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .not('message', 'is', null)
                    .neq('message', '');

                // Update stats
                document.getElementById('total-events').textContent = events ? events.length : 0;
                document.getElementById('total-all-guests').textContent = allRsvps ? allRsvps.length : 0;
                document.getElementById('total-messages').textContent = allMessages ? allMessages.length : 0;

                // Load events list
                await loadAllEventsList(events, allRsvps);

            } catch (error) {
                console.error('Error loading master dashboard:', error);
            }
        }

        async function loadAllEventsList(events, allRsvps) {
            const eventsList = document.getElementById('all-events-list');
            eventsList.innerHTML = '';

            if (events && events.length > 0) {
                events.forEach(event => {
                    const eventRsvps = allRsvps ? allRsvps.filter(r => r.wedding_id === event.id) : [];
                    const confirmedCount = eventRsvps.filter(r => r.attendance).length;

                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4">
                            <div class="font-semibold">${event.title}</div>
                            <div class="text-sm text-gray-500">${formatDate(event.event_date)}</div>
                        </td>
                        <td class="py-3 px-4 font-mono text-sm">${event.username}</td>
                        <td class="py-3 px-4 font-mono text-sm">${event.password}</td>
                        <td class="py-3 px-4">
                            <span class="text-green-600 font-semibold">${confirmedCount}</span>
                            <span class="text-gray-400">/${eventRsvps.length}</span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="copyMasterEventUrl('${event.custom_url}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">
                                    üìã Link
                                </button>
                                <button onclick="downloadMasterReport(${event.id}, '${event.title}')" class="bg-purple-500 text-white px-2 py-1 rounded text-xs hover:bg-purple-600">
                                    üìÑ PDF
                                </button>
                                <button onclick="deleteMasterEvent(${event.id}, '${event.title}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                    üóëÔ∏è Del
                                </button>
                            </div>
                        </td>
                    `;
                    eventsList.appendChild(row);
                });
            } else {
                eventsList.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum evento criado ainda</td></tr>';
            }
        }

        // Password Manager
        function showPasswordManager() {
            document.getElementById('password-manager').classList.remove('hidden');
            document.getElementById('current-username').textContent = currentEvent.username;
            document.getElementById('current-password').textContent = currentEvent.password;
        }

        function hidePasswordManager() {
            document.getElementById('password-manager').classList.add('hidden');
            document.getElementById('password-form').reset();
        }

        // Event Editor
        function showEventEditor() {
            document.getElementById('event-editor').classList.remove('hidden');
            
            // Populate form with current event data
            document.getElementById('edit-event-title').value = currentEvent.title;
            document.getElementById('edit-event-description').value = currentEvent.description || '';
            document.getElementById('edit-event-date').value = currentEvent.event_date;
            document.getElementById('edit-confirmation-deadline').value = currentEvent.confirmation_deadline || '';
            document.getElementById('edit-max-confirmations').value = currentEvent.max_confirmations || '';
            document.getElementById('edit-companion-limit').value = currentEvent.companion_limit;
            
            // Set checkboxes
            document.getElementById('edit-enable-description').checked = currentEvent.enable_description;
            document.getElementById('edit-enable-deadline').checked = currentEvent.enable_deadline;
            document.getElementById('edit-enable-max-limit').checked = currentEvent.enable_max_limit;
            document.getElementById('edit-enable-public-wall').checked = currentEvent.enable_public_wall;
            document.getElementById('edit-enable-gifts').checked = currentEvent.enable_gifts || false;
            
            // Setup gift configuration
            if (currentEvent.enable_gifts && currentEvent.gift_config) {
                const giftConfig = currentEvent.gift_config;
                if (giftConfig.type === 'bank') {
                    document.getElementById('edit-gift-bank').checked = true;
                    document.getElementById('edit-bank-message').value = giftConfig.message || '';
                    document.getElementById('edit-bank-iban').value = giftConfig.iban || '';
                    document.getElementById('edit-bank-holder').value = giftConfig.holder || '';
                } else if (giftConfig.type === 'list') {
                    document.getElementById('edit-gift-list').checked = true;
                    // Load existing gift items
                    if (giftConfig.items && giftConfig.items.length > 0) {
                        giftConfig.items.forEach(item => {
                            addEditGiftItem(item.name, item.quantity);
                        });
                    }
                }
            }
            
            // Setup field toggles for edit form
            setupEditFieldToggles();
        }

        function hideEventEditor() {
            document.getElementById('event-editor').classList.add('hidden');
        }

        function setupEditFieldToggles() {
            const toggles = [
                { checkbox: 'edit-enable-description', field: 'edit-description-field', input: 'edit-event-description' },
                { checkbox: 'edit-enable-deadline', field: 'edit-deadline-field', input: 'edit-confirmation-deadline' },
                { checkbox: 'edit-enable-max-limit', field: 'edit-max-limit-field', input: 'edit-max-confirmations' },
                { checkbox: 'edit-enable-gifts', field: 'edit-gifts-field', input: null }
            ];

            toggles.forEach(({ checkbox, field, input }) => {
                const checkboxEl = document.getElementById(checkbox);
                const fieldEl = document.getElementById(field);
                const inputEl = input ? document.getElementById(input) : null;

                // Initial state
                if (checkboxEl.checked) {
                    fieldEl.style.display = 'block';
                } else {
                    fieldEl.style.display = 'none';
                }

                checkboxEl.addEventListener('change', () => {
                    if (checkboxEl.checked) {
                        fieldEl.style.display = 'block';
                    } else {
                        fieldEl.style.display = 'none';
                        if (inputEl) inputEl.value = '';
                    }
                });
            });

            // Setup edit gift type toggles
            setupEditGiftTypeToggles();
        }

        function setupEditGiftTypeToggles() {
            const bankRadio = document.getElementById('edit-gift-bank');
            const listRadio = document.getElementById('edit-gift-list');
            const bankConfig = document.getElementById('edit-bank-config');
            const listConfig = document.getElementById('edit-list-config');

            if (bankRadio && listRadio) {
                // Initial state
                if (bankRadio.checked) {
                    bankConfig.style.display = 'block';
                    listConfig.style.display = 'none';
                } else if (listRadio.checked) {
                    bankConfig.style.display = 'none';
                    listConfig.style.display = 'block';
                }

                bankRadio.addEventListener('change', () => {
                    if (bankRadio.checked) {
                        bankConfig.style.display = 'block';
                        listConfig.style.display = 'none';
                    }
                });

                listRadio.addEventListener('change', () => {
                    if (listRadio.checked) {
                        bankConfig.style.display = 'none';
                        listConfig.style.display = 'block';
                    }
                });
            }
        }

        // Delete Options
        function showDeleteOptions() {
            document.getElementById('delete-options').classList.remove('hidden');
        }

        function hideDeleteOptions() {
            document.getElementById('delete-options').classList.add('hidden');
        }

        // Guest Deletion
        function showGuestDeletion() {
            document.getElementById('guest-deletion').classList.remove('hidden');
            loadGuestDeletionList();
        }

        function hideGuestDeletion() {
            document.getElementById('guest-deletion').classList.add('hidden');
        }

        async function loadGuestDeletionList() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .order('created_at', { ascending: false });

                const guestList = document.getElementById('guest-deletion-list');
                guestList.innerHTML = '';

                if (rsvps && rsvps.length > 0) {
                    rsvps.forEach(rsvp => {
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="py-3 px-4">
                                <input type="checkbox" class="guest-checkbox" data-id="${rsvp.id}">
                            </td>
                            <td class="py-3 px-4">${rsvp.guest_name}</td>
                            <td class="py-3 px-4">${rsvp.companion_name || '-'}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs ${rsvp.attendance ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${rsvp.attendance ? '‚úÖ Confirmado' : '‚ùå N√£o Confirmado'}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <button onclick="deleteIndividualGuest(${rsvp.id}, '${rsvp.guest_name}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                    üóëÔ∏è Excluir
                                </button>
                            </td>
                        `;
                        guestList.appendChild(row);
                    });
                } else {
                    guestList.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum convidado ainda</td></tr>';
                }

            } catch (error) {
                console.error('Error loading guest deletion list:', error);
            }
        }

        document.getElementById('password-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                alert('As senhas n√£o coincidem!');
                return;
            }

            if (newPassword.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres!');
                return;
            }

            try {
                const { error } = await supabase
                    .from('events')
                    .update({ password: newPassword })
                    .eq('id', currentEvent.id);

                if (error) throw error;

                currentEvent.password = newPassword;
                saveSession(currentEvent);
                
                alert('‚úÖ Senha alterada com sucesso!');
                hidePasswordManager();

            } catch (error) {
                console.error('Error changing password:', error);
                alert('Erro ao alterar senha. Tente novamente.');
            }
        });

        // Edit Event Form
        document.getElementById('edit-event-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const editGiftType = document.querySelector('input[name="edit-gift-type"]:checked')?.value || null;
                let editGiftConfig = null;

                if (document.getElementById('edit-enable-gifts').checked && editGiftType) {
                    if (editGiftType === 'bank') {
                        editGiftConfig = {
                            type: 'bank',
                            message: document.getElementById('edit-bank-message').value.trim(),
                            iban: document.getElementById('edit-bank-iban').value.trim(),
                            holder: document.getElementById('edit-bank-holder').value.trim()
                        };
                    } else if (editGiftType === 'list') {
                        editGiftConfig = {
                            type: 'list',
                            items: getEditGiftItems()
                        };
                    }
                }

                const formData = {
                    title: document.getElementById('edit-event-title').value.trim(),
                    description: document.getElementById('edit-enable-description').checked ? 
                        document.getElementById('edit-event-description').value.trim() : '',
                    event_date: document.getElementById('edit-event-date').value,
                    confirmation_deadline: document.getElementById('edit-enable-deadline').checked ? 
                        document.getElementById('edit-confirmation-deadline').value : null,
                    max_confirmations: document.getElementById('edit-enable-max-limit').checked ? 
                        parseInt(document.getElementById('edit-max-confirmations').value) : null,
                    companion_limit: parseInt(document.getElementById('edit-companion-limit').value),
                    enable_description: document.getElementById('edit-enable-description').checked,
                    enable_deadline: document.getElementById('edit-enable-deadline').checked,
                    enable_max_limit: document.getElementById('edit-enable-max-limit').checked,
                    enable_public_wall: document.getElementById('edit-enable-public-wall').checked,
                    enable_gifts: document.getElementById('edit-enable-gifts').checked,
                    gift_config: editGiftConfig
                };

                const { error } = await supabase
                    .from('events')
                    .update(formData)
                    .eq('id', currentEvent.id);

                if (error) throw error;

                // Update current event object
                Object.assign(currentEvent, formData);
                saveSession(currentEvent);

                alert('‚úÖ Evento atualizado com sucesso!');
                hideEventEditor();
                await loadDashboard();

            } catch (error) {
                console.error('Error updating event:', error);
                alert('Erro ao atualizar evento: ' + error.message);
            }
        });

        // Delete Functions
        async function deleteIndividualGuest(guestId, guestName) {
            if (!confirm(`Tem certeza que deseja excluir o convidado "${guestName}"?`)) return;

            try {
                const { error } = await supabase
                    .from('rsvps')
                    .delete()
                    .eq('id', guestId);

                if (error) throw error;

                alert(`Convidado "${guestName}" exclu√≠do com sucesso!`);
                loadGuestDeletionList();
                await loadDashboard();

            } catch (error) {
                console.error('Error deleting guest:', error);
                alert('Erro ao excluir convidado.');
            }
        }

        async function deleteSelectedGuests() {
            const checkboxes = document.querySelectorAll('.guest-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos um convidado para excluir.');
                return;
            }

            if (!confirm(`Tem certeza que deseja excluir ${checkboxes.length} convidado(s) selecionado(s)?`)) return;

            try {
                const guestIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
                
                const { error } = await supabase
                    .from('rsvps')
                    .delete()
                    .in('id', guestIds);

                if (error) throw error;

                alert(`${checkboxes.length} convidado(s) exclu√≠do(s) com sucesso!`);
                loadGuestDeletionList();
                await loadDashboard();

            } catch (error) {
                console.error('Error deleting selected guests:', error);
                alert('Erro ao excluir convidados selecionados.');
            }
        }

        async function clearAllMessages() {
            if (!confirm('Tem certeza que deseja limpar TODAS as mensagens? Esta a√ß√£o √© irrevers√≠vel!')) return;

            try {
                const { error } = await supabase
                    .from('rsvps')
                    .update({ message: null })
                    .eq('wedding_id', currentEvent.id);

                if (error) throw error;

                alert('‚úÖ Todas as mensagens foram removidas!');
                await loadDashboard();

            } catch (error) {
                console.error('Error clearing messages:', error);
                alert('Erro ao limpar mensagens.');
            }
        }

        async function clearAllGuests() {
            if (!confirm('Tem certeza que deseja excluir TODOS os convidados? Esta a√ß√£o √© irrevers√≠vel!')) return;
            if (!confirm('CONFIRMA√á√ÉO FINAL: Todos os convidados e suas confirma√ß√µes ser√£o perdidos permanentemente!')) return;

            try {
                const { error } = await supabase
                    .from('rsvps')
                    .delete()
                    .eq('wedding_id', currentEvent.id);

                if (error) throw error;

                alert('‚úÖ Todos os convidados foram removidos!');
                hideDeleteOptions();
                await loadDashboard();

            } catch (error) {
                console.error('Error clearing all guests:', error);
                alert('Erro ao limpar todos os convidados.');
            }
        }

        async function deleteEntireEvent() {
            if (!confirm(`Tem certeza que deseja excluir COMPLETAMENTE o evento "${currentEvent.title}"?`)) return;
            if (!confirm('ATEN√á√ÉO: Esta a√ß√£o ir√° excluir o evento e TODOS os dados associados permanentemente!')) return;
            if (!confirm('CONFIRMA√á√ÉO FINAL: Digite "EXCLUIR" para confirmar') && prompt('Digite "EXCLUIR" para confirmar:') !== 'EXCLUIR') return;

            try {
                // Delete all RSVPs first
                await supabase.from('rsvps').delete().eq('wedding_id', currentEvent.id);
                
                // Delete event
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', currentEvent.id);

                if (error) throw error;

                alert('‚úÖ Evento exclu√≠do completamente!');
                logout();

            } catch (error) {
                console.error('Error deleting entire event:', error);
                alert('Erro ao excluir evento.');
            }
        }

        // Copy Event URLs
        function copyEventFullUrl() {
            const url = `https://araujo418.github.io/painel-invitesqr/index.html?cliente=${currentEvent.custom_url}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link completo copiado!');
            });
        }

        function copyEventNoCompanionUrl() {
            const url = `https://araujo418.github.io/painel-invitesqr/index.html?cliente=${currentEvent.custom_url}&companion=no`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link sem acompanhante copiado!');
            });
        }

        function copyMasterEventUrl(customUrl) {
            const url = `https://araujo418.github.io/painel-invitesqr/index.html?cliente=${customUrl}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link do evento copiado!');
            });
        }

        // Download Report
        async function downloadReport() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .order('created_at', { ascending: false });

                if (!rsvps || rsvps.length === 0) {
                    alert('Nenhum convidado para exportar');
                    return;
                }

                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(18);
                doc.text('RELAT√ìRIO DE CONVIDADOS', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text(currentEvent.title, 105, 35, { align: 'center' });
                doc.text(`Data: ${formatDate(currentEvent.event_date)}`, 105, 45, { align: 'center' });

                // Stats
                const confirmed = rsvps.filter(r => r.attendance);
                const totalGuests = rsvps.length;
                const confirmedGuests = confirmed.length;

                doc.setFontSize(12);
                doc.text(`Total de Convidados: ${totalGuests}`, 20, 65);
                doc.text(`Confirmados: ${confirmedGuests}`, 20, 75);

                let yPosition = 95;

                // Confirmed guests
                if (confirmed.length > 0) {
                    doc.setFontSize(14);
                    doc.text('CONFIRMADOS', 20, yPosition);
                    yPosition += 10;

                    doc.setFontSize(10);
                    confirmed.forEach(rsvp => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(`‚Ä¢ ${rsvp.guest_name}${rsvp.companion_name ? ` + ${rsvp.companion_name}` : ''}`, 25, yPosition);
                        yPosition += 7;
                    });
                    yPosition += 10;
                }

                // Not confirmed guests
                const notConfirmed = rsvps.filter(r => !r.attendance);
                if (notConfirmed.length > 0) {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(14);
                    doc.text('N√ÉO CONFIRMADOS', 20, yPosition);
                    yPosition += 10;

                    doc.setFontSize(10);
                    notConfirmed.forEach(rsvp => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(`‚Ä¢ ${rsvp.guest_name}${rsvp.companion_name ? ` + ${rsvp.companion_name}` : ''}`, 25, yPosition);
                        yPosition += 7;
                    });
                }

                // Save PDF
                const fileName = `relatorio-${currentEvent.title.replace(/[^a-z0-9]/gi, '-')}.pdf`;
                doc.save(fileName);

                alert('üìÑ Relat√≥rio PDF gerado com sucesso!');

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Erro ao gerar relat√≥rio PDF.');
            }
        }

        // Master functions
        async function downloadMasterReport(eventId, eventTitle) {
            // Similar to downloadReport but for master admin
            alert('Funcionalidade em desenvolvimento');
        }

        async function deleteMasterEvent(eventId, eventTitle) {
            if (!confirm(`Tem certeza que deseja excluir o evento "${eventTitle}"?`)) return;

            try {
                // Delete RSVPs first
                await supabase.from('rsvps').delete().eq('wedding_id', eventId);
                
                // Delete event
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                alert(`Evento "${eventTitle}" exclu√≠do com sucesso!`);
                loadMasterDashboard();

            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Erro ao excluir evento.');
            }
        }

        // Logout
        function logout() {
            currentEvent = null;
            currentUser = null;
            isMasterAdmin = false;
            clearSession();
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            hidePasswordManager();
            
            if (clienteParam) {
                showEventSite();
            } else {
                showHome();
            }
        }

        // Event Site Functions
        async function loadEventSite(customUrl) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('custom_url', customUrl)
                    .single();

                if (error || !event) {
                    alert('Evento n√£o encontrado');
                    return;
                }

                currentEvent = event;
                await checkExistingResponse();
                renderEventSite();
                showEventSite();

            } catch (error) {
                console.error('Error loading event site:', error);
                alert('Erro ao carregar evento');
            }
        }

        async function checkExistingResponse() {
            const guestName = localStorage.getItem(`guest_${currentEvent.id}`);
            if (!guestName) return;

            try {
                const { data: response } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .eq('guest_name', guestName)
                    .single();

                if (response) {
                    userResponse = response;
                }
            } catch (error) {
                console.log('No existing response found');
            }
        }

        function renderEventSite() {
            const content = document.getElementById('event-site-content');
            const today = new Date();
            const hasDeadline = currentEvent.enable_deadline && currentEvent.confirmation_deadline;
            const deadline = hasDeadline ? new Date(currentEvent.confirmation_deadline) : null;
            const isDeadlinePassed = hasDeadline && today > deadline;
            const allowCompanion = urlParams.get('companion') !== 'no';

            content.innerHTML = `
                <div class="max-w-4xl mx-auto px-4 guest-content">
                    <div class="card rounded-3xl p-8 lg:p-12 text-center">
                        <h1 class="font-playfair text-4xl lg:text-6xl text-gray-800 mb-6 font-bold">${currentEvent.title}</h1>
                        <div class="w-24 h-1 bg-gradient-to-r from-purple-400 to-blue-400 mx-auto mb-8 rounded-full"></div>
                        
                        ${currentEvent.enable_description && currentEvent.description ? 
                            `<p class="text-xl text-gray-600 mb-8 leading-relaxed">${currentEvent.description}</p>` : ''}
                        
                        <!-- Countdown Timer -->
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-3xl p-8 mb-8 border border-indigo-100">
                            <h3 class="text-2xl font-playfair font-semibold mb-6 text-gray-800">‚è∞ Contagem Regressiva</h3>
                            <div id="countdown-timer" class="grid grid-cols-4 gap-4 max-w-lg mx-auto">
                                <div class="text-center">
                                    <div class="bg-white rounded-xl p-4 shadow-sm border">
                                        <div id="days" class="text-3xl font-bold text-indigo-600">00</div>
                                        <div class="text-sm text-gray-600 font-medium">Dias</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="bg-white rounded-xl p-4 shadow-sm border">
                                        <div id="hours" class="text-3xl font-bold text-purple-600">00</div>
                                        <div class="text-sm text-gray-600 font-medium">Horas</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="bg-white rounded-xl p-4 shadow-sm border">
                                        <div id="minutes" class="text-3xl font-bold text-pink-600">00</div>
                                        <div class="text-sm text-gray-600 font-medium">Minutos</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="bg-white rounded-xl p-4 shadow-sm border">
                                        <div id="seconds" class="text-3xl font-bold text-red-600">00</div>
                                        <div class="text-sm text-gray-600 font-medium">Segundos</div>
                                    </div>
                                </div>
                            </div>
                            <div id="countdown-message" class="text-center mt-6 text-lg font-medium text-gray-700"></div>
                        </div>
                        
                        ${isDeadlinePassed ? `
                            <div class="bg-gradient-to-r from-red-50 to-rose-50 rounded-3xl p-8 mb-8 border border-red-200">
                                <h3 class="text-3xl font-playfair font-semibold mb-4 text-red-800">‚è∞ Prazo Encerrado</h3>
                                <p class="text-xl text-red-700">O prazo para confirma√ß√£o foi at√© ${formatDate(currentEvent.confirmation_deadline)}</p>
                            </div>
                        ` : `
                            <div id="rsvp-container">
                                <!-- RSVP content will be populated here -->
                            </div>
                        `}

                        <div id="message-container" class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 mb-8 border border-purple-100">
                            <!-- Message content will be populated here -->
                        </div>

                        <div id="gifts-container" class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-3xl p-8 mb-8 border border-yellow-100">
                            <!-- Gifts content will be populated here -->
                        </div>

                        ${currentEvent.enable_public_wall ? `
                        <div class="bg-gradient-to-br from-slate-50 to-gray-50 rounded-3xl p-8 border border-slate-200">
                            <h3 class="text-3xl font-playfair font-semibold mb-6 text-gray-800">üí¨ Mural de Mensagens</h3>
                            <div id="public-messages-list" class="space-y-6 max-h-96 overflow-y-auto">
                                <!-- Public messages will be loaded here -->
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Start countdown
            startCountdown(currentEvent.event_date);
            
            // Render RSVP and message sections
            if (!isDeadlinePassed) {
                renderRSVPSection(allowCompanion);
            }
            renderMessageSection();
            renderGiftsSection();
            
            // Load public messages
            if (currentEvent.enable_public_wall) {
                loadPublicMessages();
            }
        }

        function renderRSVPSection(allowCompanion, isEditing = false) {
            const container = document.getElementById('rsvp-container');
            
            if (userResponse && !isEditing) {
                const companions = [];
                if (userResponse.companion_name) {
                    const companionNames = userResponse.companion_name.split(',').map(name => name.trim()).filter(name => name);
                    companions.push(...companionNames);
                }
                
                const companionText = companions.length > 0 ? 
                    ` junto com ${companions.join(', ')}` : '';
                
                const statusMessage = userResponse.attendance ? 
                    `‚úÖ Voc√™ confirmou presen√ßa${companionText}!` :
                    '‚ùå Voc√™ informou que n√£o poder√° comparecer.';
                
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-3xl p-8 mb-8 border border-green-200">
                        <h3 class="text-2xl font-playfair font-semibold mb-2">Obrigado pela sua confirma√ß√£o! ‚ú®</h3>
                        <p class="text-lg mb-4">${statusMessage}</p>
                        <button onclick="editResponse()" class="bg-white bg-opacity-50 border border-white border-opacity-30 text-gray-800 px-6 py-2 rounded-lg hover:bg-opacity-70">
                            ‚úèÔ∏è Editar resposta
                        </button>
                    </div>
                `;
            } else {
                const hasDeadline = currentEvent.enable_deadline && currentEvent.confirmation_deadline;
                const existingName = isEditing && userResponse ? userResponse.guest_name : '';
                const existingCompanions = [];
                if (isEditing && userResponse && userResponse.companion_name) {
                    const companionNames = userResponse.companion_name.split(',').map(name => name.trim()).filter(name => name);
                    existingCompanions.push(...companionNames);
                }
                const existingAttendance = isEditing && userResponse ? userResponse.attendance : null;
                
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-3xl p-8 mb-8 border border-blue-100">
                        <h3 class="text-3xl font-playfair font-semibold mb-6 text-gray-800">üìù ${isEditing ? 'Editar ' : ''}Confirma√ß√£o de Presen√ßa</h3>
                        ${hasDeadline ? `<p class="text-lg text-gray-600 mb-6">‚è∞ Confirme at√© ${formatDate(currentEvent.confirmation_deadline)}</p>` : ''}
                        
                        <form id="rsvp-form" class="space-y-6">
                            <div>
                                <label class="block text-lg font-medium text-gray-700 mb-3">Seu nome completo *</label>
                                <input type="text" id="guest-name" required placeholder="Digite seu nome completo" value="${existingName}" class="input text-lg p-4 rounded-xl">
                            </div>

                            ${allowCompanion && currentEvent.companion_limit > 0 ? `
                            <div id="companions-section">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="block text-lg font-medium text-gray-700">Acompanhantes (opcional)</label>
                                    <button type="button" onclick="addCompanionField()" id="add-companion-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-medium">
                                        ‚ûï Adicionar Acompanhante
                                    </button>
                                </div>
                                <div id="companion-fields" class="space-y-3">
                                    <!-- Companion fields will be added here -->
                                </div>
                                <p class="text-sm text-gray-500 mt-2">M√°ximo ${currentEvent.companion_limit} acompanhante${currentEvent.companion_limit > 1 ? 's' : ''} por convidado</p>
                            </div>
                            ` : ''}

                            <div class="text-center">
                                <p class="text-lg font-medium text-gray-700 mb-4">Voc√™ poder√° comparecer ao evento?</p>
                                <div class="flex gap-4 justify-center flex-wrap">
                                    <button type="button" onclick="submitRSVP(true)" id="btn-yes" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-4 rounded-2xl text-lg font-semibold hover:from-green-600 hover:to-emerald-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 ${existingAttendance === true ? 'ring-4 ring-green-300' : ''}">
                                        ‚úÖ Sim, estarei presente!
                                    </button>
                                    <button type="button" onclick="submitRSVP(false)" id="btn-no" class="bg-gradient-to-r from-red-500 to-rose-500 text-white px-8 py-4 rounded-2xl text-lg font-semibold hover:from-red-600 hover:to-rose-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 ${existingAttendance === false ? 'ring-4 ring-red-300' : ''}">
                                        ‚ùå N√£o poderei comparecer
                                    </button>
                                </div>
                            </div>

                            ${isEditing ? `
                            <div class="text-center">
                                <button type="button" onclick="cancelEdit()" class="bg-gray-500 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-gray-600">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                            ` : ''}
                        </form>
                    </div>
                `;

                // Add existing companion fields if editing
                if (isEditing && allowCompanion && currentEvent.companion_limit > 0) {
                    setTimeout(() => {
                        existingCompanions.forEach(companionName => {
                            addCompanionField(companionName);
                        });
                        updateAddCompanionButton();
                    }, 100);
                }
            }
        }

        function renderMessageSection() {
            const container = document.getElementById('message-container');
            
            if (userResponse && userResponse.attendance) {
                if (userResponse.message) {
                    container.innerHTML = `
                        <h3 class="text-3xl font-playfair font-semibold mb-6 text-gray-800">üíå Sua mensagem especial</h3>
                        <div class="bg-white rounded-2xl p-6 mb-6 border border-purple-200">
                            <p class="text-gray-600 mb-4 italic">"${userResponse.message}"</p>
                            <button onclick="editMessage()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                                ‚úèÔ∏è Editar mensagem
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <h3 class="text-3xl font-playfair font-semibold mb-6 text-gray-800">üíå Deixe uma mensagem especial</h3>
                        <p class="text-lg text-gray-600 mb-6">Compartilhe seus sentimentos para este momento especial!</p>
                        
                        <form id="message-form" class="space-y-4">
                            <textarea id="message-text" placeholder="Digite sua mensagem aqui..." class="input text-lg p-4 rounded-xl h-32 resize-none"></textarea>
                            <div class="text-center space-x-4">
                                <button type="button" onclick="submitMessage()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-3 rounded-2xl text-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl">
                                    üíå Enviar mensagem
                                </button>
                                <button type="button" onclick="skipMessage()" class="bg-gray-500 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-gray-600">
                                    ‚è≠Ô∏è Ignorar
                                </button>
                            </div>
                        </form>
                    `;
                }
            } else {
                container.innerHTML = `
                    <h3 class="text-3xl font-playfair font-semibold mb-4 text-gray-800">üíå Mensagens especiais</h3>
                    <p class="text-lg text-gray-600">Confirme sua presen√ßa para deixar uma mensagem especial!</p>
                `;
            }
        }

        function renderGiftsSection() {
            const container = document.getElementById('gifts-container');
            
            if (!currentEvent.enable_gifts || !currentEvent.gift_config) {
                container.style.display = 'none';
                return;
            }

            if (userResponse && userResponse.attendance) {
                const giftConfig = currentEvent.gift_config;
                
                if (giftConfig.type === 'bank') {
                    container.innerHTML = `
                        <h3 class="text-3xl font-playfair font-semibold mb-6 text-gray-800">üéÅ Sugest√£o de Presente</h3>
                        <div class="bg-white rounded-2xl p-6 border border-yellow-200">
                            <div class="whitespace-pre-line text-gray-700 mb-6">${giftConfig.message}</div>
                            ${giftConfig.iban ? `
                            <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold text-gray-800">IBAN: ${giftConfig.iban}</div>
                                        ${giftConfig.holder ? `<div class="text-sm text-gray-600">Titular: ${giftConfig.holder}</div>` : ''}
                                    </div>
                                    <button onclick="copyIban('${giftConfig.iban}')" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 font-semibold">
                                        üìã Copiar IBAN
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                            <div class="text-center mt-6">
                                <button onclick="skipGifts()" class="bg-gray-500 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-gray-600">
                                    ‚è≠Ô∏è Ignorar
                                </button>
                            </div>
                        </div>
                    `;
                } else if (giftConfig.type === 'list') {
                    loadGiftList();
                }
            } else {
                container.innerHTML = `
                    <h3 class="text-3xl font-playfair font-semibold mb-4 text-gray-800">üéÅ Sugest√µes de Presentes</h3>
                    <p class="text-lg text-gray-600">Confirme sua presen√ßa para ver as sugest√µes de presentes!</p>
                `;
            }
        }

        // Companion Management Functions
        function addCompanionField(existingName = '') {
            if (companionCount >= currentEvent.companion_limit) {
                alert(`M√°ximo de ${currentEvent.companion_limit} acompanhante${currentEvent.companion_limit > 1 ? 's' : ''} permitido${currentEvent.companion_limit > 1 ? 's' : ''}.`);
                return;
            }

            companionCount++;
            const companionFields = document.getElementById('companion-fields');
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'flex gap-2 items-center';
            fieldDiv.id = `companion-field-${companionCount}`;
            
            fieldDiv.innerHTML = `
                <input type="text" 
                       id="companion-${companionCount}" 
                       placeholder="Nome do acompanhante ${companionCount}" 
                       value="${existingName}"
                       class="input text-lg p-3 rounded-xl flex-1">
                <button type="button" 
                        onclick="removeCompanionField(${companionCount})" 
                        class="bg-red-500 text-white px-3 py-3 rounded-xl hover:bg-red-600 text-sm">
                    üóëÔ∏è
                </button>
            `;
            
            companionFields.appendChild(fieldDiv);
            updateAddCompanionButton();
        }

        function removeCompanionField(fieldId) {
            const field = document.getElementById(`companion-field-${fieldId}`);
            if (field) {
                field.remove();
                companionCount--;
                updateAddCompanionButton();
            }
        }

        function updateAddCompanionButton() {
            const addBtn = document.getElementById('add-companion-btn');
            if (addBtn) {
                if (companionCount >= currentEvent.companion_limit) {
                    addBtn.style.display = 'none';
                } else {
                    addBtn.style.display = 'block';
                }
            }
        }

        function getCompanionNames() {
            const companions = [];
            for (let i = 1; i <= companionCount; i++) {
                const field = document.getElementById(`companion-${i}`);
                if (field && field.value.trim()) {
                    companions.push(field.value.trim());
                }
            }
            return companions;
        }

        // RSVP Functions
        async function submitRSVP(attendance) {
            const guestName = document.getElementById('guest-name').value.trim();
            const companions = getCompanionNames();
            const companionName = companions.length > 0 ? companions.join(', ') : null;

            if (!guestName) {
                alert('Por favor, digite seu nome completo.');
                return;
            }

            try {
                // Check max limit for confirmations
                if (attendance && currentEvent.enable_max_limit && currentEvent.max_confirmations) {
                    const { data: confirmedRsvps } = await supabase
                        .from('rsvps')
                        .select('*')
                        .eq('wedding_id', currentEvent.id)
                        .eq('attendance', true);

                    const confirmedCount = confirmedRsvps ? confirmedRsvps.length : 0;
                    if (confirmedCount >= currentEvent.max_confirmations) {
                        alert('Desculpe, o limite m√°ximo de confirma√ß√µes foi atingido.');
                        return;
                    }
                }

                if (userResponse) {
                    // Update existing response
                    const { data, error } = await supabase
                        .from('rsvps')
                        .update({
                            guest_name: guestName,
                            companion_name: companionName,
                            attendance: attendance
                        })
                        .eq('id', userResponse.id)
                        .select()
                        .single();

                    if (error) throw error;
                    userResponse = data;
                } else {
                    // Create new response
                    const { data, error } = await supabase
                        .from('rsvps')
                        .insert({
                            wedding_id: currentEvent.id,
                            guest_name: guestName,
                            companion_name: companionName,
                            attendance: attendance
                        })
                        .select()
                        .single();

                    if (error) throw error;
                    userResponse = data;
                    localStorage.setItem(`guest_${currentEvent.id}`, guestName);
                }

                // Reset companion count
                companionCount = 0;

                renderRSVPSection(urlParams.get('companion') !== 'no');
                renderMessageSection();

                alert(attendance ? 'üéâ Obrigado! Sua presen√ßa foi confirmada!' : 'üòî Obrigado por nos informar.');

            } catch (error) {
                console.error('Error submitting RSVP:', error);
                alert('Erro ao enviar confirma√ß√£o. Tente novamente.');
            }
        }

        function editResponse() {
            companionCount = 0; // Reset companion count
            renderRSVPSection(urlParams.get('companion') !== 'no', true);
            renderMessageSection();
        }

        function cancelEdit() {
            companionCount = 0; // Reset companion count
            renderRSVPSection(urlParams.get('companion') !== 'no', false);
            renderMessageSection();
        }

        // Message Functions
        async function submitMessage() {
            const messageText = document.getElementById('message-text').value.trim();
            
            if (!messageText) {
                alert('Por favor, digite uma mensagem.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('rsvps')
                    .update({ message: messageText })
                    .eq('id', userResponse.id);

                if (error) throw error;

                userResponse.message = messageText;
                renderMessageSection();
                
                if (currentEvent.enable_public_wall) {
                    loadPublicMessages();
                }

                alert('üíå Mensagem enviada com sucesso!');

            } catch (error) {
                console.error('Error submitting message:', error);
                alert('Erro ao enviar mensagem. Tente novamente.');
            }
        }

        function editMessage() {
            const container = document.getElementById('message-container');
            container.innerHTML = `
                <h3 class="text-3xl font-playfair font-semibold mb-6 text-gray-800">üíå Editar sua mensagem</h3>
                
                <form id="edit-message-form" class="space-y-4">
                    <textarea id="edit-message-text" class="input text-lg p-4 rounded-xl h-32 resize-none">${userResponse.message}</textarea>
                    <div class="text-center space-x-4">
                        <button type="button" onclick="updateMessage()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-2xl font-semibold hover:from-purple-600 hover:to-pink-600">
                            ‚úÖ Salvar altera√ß√µes
                        </button>
                        <button type="button" onclick="renderMessageSection()" class="bg-gray-500 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-gray-600">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </form>
            `;
        }

        async function updateMessage() {
            const messageText = document.getElementById('edit-message-text').value.trim();
            
            if (!messageText) {
                alert('Por favor, digite uma mensagem.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('rsvps')
                    .update({ message: messageText })
                    .eq('id', userResponse.id);

                if (error) throw error;

                userResponse.message = messageText;
                renderMessageSection();
                
                if (currentEvent.enable_public_wall) {
                    loadPublicMessages();
                }

                alert('üíå Mensagem atualizada com sucesso!');

            } catch (error) {
                console.error('Error updating message:', error);
                alert('Erro ao atualizar mensagem. Tente novamente.');
            }
        }

        // Gift Functions
        function skipMessage() {
            renderGiftsSection();
        }

        function skipGifts() {
            const container = document.getElementById('gifts-container');
            container.style.display = 'none';
        }

        function copyIban(iban) {
            navigator.clipboard.writeText(iban).then(() => {
                alert('IBAN copiado para a √°rea de transfer√™ncia!');
            }).catch(() => {
                alert('Erro ao copiar IBAN. Tente selecionar e copiar manualmente.');
            });
        }

        async function loadGiftList() {
            const container = document.getElementById('gifts-container');
            const giftConfig = currentEvent.gift_config;
            
            if (!giftConfig.items || giftConfig.items.length === 0) {
                container.innerHTML = `
                    <h3 class="text-3xl font-playfair font-semibold mb-4 text-gray-800">üéÅ Lista de Presentes</h3>
                    <p class="text-lg text-gray-600">Nenhum presente foi adicionado √† lista ainda.</p>
                `;
                return;
            }

            try {
                // Get existing gift selections
                const { data: selections } = await supabase
                    .from('gift_selections')
                    .select('*')
                    .eq('wedding_id', currentEvent.id);

                const selectedGifts = selections || [];
                
                let giftListHtml = `
                    <h3 class="text-3xl font-playfair font-semibold mb-6 text-gray-800">üéÅ Lista de Presentes</h3>
                    <p class="text-lg text-gray-600 mb-6">Escolha um presente da nossa lista de sugest√µes!</p>
                    <div class="space-y-4">
                `;

                giftConfig.items.forEach((item, index) => {
                    const selectedCount = selectedGifts.filter(s => s.gift_name === item.name).length;
                    const remainingQuantity = item.quantity - selectedCount;
                    const isAvailable = remainingQuantity > 0;
                    const userSelected = selectedGifts.find(s => s.gift_name === item.name && s.guest_name === userResponse.guest_name);

                    giftListHtml += `
                        <div class="bg-white rounded-2xl p-6 border ${isAvailable ? 'border-yellow-200' : 'border-gray-300'} ${!isAvailable ? 'opacity-60' : ''}">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <h4 class="text-xl font-semibold text-gray-800 mb-2">${item.name}</h4>
                                    <div class="text-sm text-gray-600">
                                        ${isAvailable ? 
                                            `Dispon√≠vel: ${remainingQuantity} de ${item.quantity}` : 
                                            'Esgotado'
                                        }
                                    </div>
                                    ${userSelected ? '<div class="text-green-600 font-semibold mt-2">‚úÖ Voc√™ escolheu este presente</div>' : ''}
                                </div>
                                <div class="ml-4">
                                    ${userSelected ? 
                                        `<button onclick="unselectGift('${item.name}')" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-semibold">
                                            ‚ùå Cancelar escolha
                                        </button>` :
                                        (isAvailable ? 
                                            `<button onclick="selectGift('${item.name}')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold">
                                                üéÅ Escolher
                                            </button>` :
                                            `<button disabled class="bg-gray-400 text-white px-4 py-2 rounded-lg cursor-not-allowed">
                                                üòî Esgotado
                                            </button>`
                                        )
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });

                giftListHtml += `
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="skipGifts()" class="bg-gray-500 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-gray-600">
                            ‚è≠Ô∏è Ignorar lista
                        </button>
                    </div>
                `;

                container.innerHTML = giftListHtml;

            } catch (error) {
                console.error('Error loading gift list:', error);
                container.innerHTML = `
                    <h3 class="text-3xl font-playfair font-semibold mb-4 text-gray-800">üéÅ Lista de Presentes</h3>
                    <p class="text-lg text-red-600">Erro ao carregar lista de presentes.</p>
                `;
            }
        }

        async function selectGift(giftName) {
            try {
                const { error } = await supabase
                    .from('gift_selections')
                    .insert({
                        wedding_id: currentEvent.id,
                        guest_name: userResponse.guest_name,
                        gift_name: giftName
                    });

                if (error) throw error;

                alert('üéÅ Presente escolhido com sucesso!');
                loadGiftList(); // Reload the list

            } catch (error) {
                console.error('Error selecting gift:', error);
                alert('Erro ao escolher presente. Tente novamente.');
            }
        }

        async function unselectGift(giftName) {
            try {
                const { error } = await supabase
                    .from('gift_selections')
                    .delete()
                    .eq('wedding_id', currentEvent.id)
                    .eq('guest_name', userResponse.guest_name)
                    .eq('gift_name', giftName);

                if (error) throw error;

                alert('Escolha de presente cancelada.');
                loadGiftList(); // Reload the list

            } catch (error) {
                console.error('Error unselecting gift:', error);
                alert('Erro ao cancelar escolha. Tente novamente.');
            }
        }

        async function loadPublicMessages() {
            try {
                const { data: messages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .eq('attendance', true)
                    .not('message', 'is', null)
                    .neq('message', '')
                    .order('created_at', { ascending: false });

                const messagesList = document.getElementById('public-messages-list');
                
                if (messages && messages.length > 0) {
                    messagesList.innerHTML = messages.map(msg => `
                        <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-gray-800 text-lg">${msg.guest_name}</h4>
                                <span class="text-sm text-gray-500">${formatDate(msg.created_at)}</span>
                            </div>
                            <p class="text-gray-600 leading-relaxed italic">"${msg.message}"</p>
                        </div>
                    `).join('');
                } else {
                    messagesList.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üíå</div>
                            <p class="text-xl text-gray-500">Ainda n√£o h√° mensagens no mural</p>
                            <p class="text-gray-400 mt-2">Seja o primeiro a deixar uma mensagem especial!</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading public messages:', error);
            }
        }

        // Countdown Timer
        function startCountdown(eventDate) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const targetDate = new Date(eventDate).getTime();

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown-message').innerHTML = 'üéâ <strong>O evento chegou!</strong>';
                    document.getElementById('countdown-timer').innerHTML = '<div class="text-center text-4xl">üéâ</div>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('days').textContent = days.toString().padStart(2, '0');
                document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');

                // Update message based on time remaining
                let message = '';
                if (days > 30) {
                    message = 'üóìÔ∏è Ainda temos tempo para nos preparar!';
                } else if (days > 7) {
                    message = 'üìÖ O evento est√° se aproximando!';
                } else if (days > 1) {
                    message = '‚è∞ √öltimos dias para se preparar!';
                } else if (days === 1) {
                    message = 'üö® <strong>Amanh√£ √© o grande dia!</strong>';
                } else if (hours > 1) {
                    message = 'üî• <strong>Hoje √© o dia! Faltam poucas horas!</strong>';
                } else {
                    message = '‚ö° <strong>O evento est√° come√ßando!</strong>';
                }

                document.getElementById('countdown-message').innerHTML = message;

                // Add pulse animation when less than 24 hours
                if (days === 0) {
                    document.getElementById('countdown-timer').classList.add('countdown-pulse');
                }

            }, 1000);
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application...');
            
            if (clienteParam) {
                // Guest mode - load event site
                document.getElementById('main-header').classList.add('guest-header');
                loadEventSite(clienteParam);
            } else {
                // Admin mode - setup field toggles and check session
                setupFieldToggles();
                
                const session = loadSession();
                if (session) {
                    currentEvent = session;
                    currentUser = session;
                    loadDashboard();
                    showDashboard();
                } else {
                    showHome();
                }
            }
        });

    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972ac465c24a77e0',t:'MTc1NTc4NTk4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
