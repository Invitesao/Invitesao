<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invites - Sistema de Confirma√ß√£o de Presen√ßa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 50;
        }
        .mobile-container {
            padding-bottom: 80px;
        }
        @media (min-width: 768px) {
            .mobile-nav { display: none; }
            .mobile-container { padding-bottom: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Mobile Navigation -->
    <div class="mobile-nav md:hidden">
        <div class="flex justify-around py-2">
            <button onclick="showSection('home')" class="flex flex-col items-center p-2 text-gray-600 hover:text-purple-600">
                <span class="text-xl">üè†</span>
                <span class="text-xs">In√≠cio</span>
            </button>
            <button onclick="showSection('about')" class="flex flex-col items-center p-2 text-gray-600 hover:text-purple-600">
                <span class="text-xl">‚ÑπÔ∏è</span>
                <span class="text-xs">Sobre</span>
            </button>
            <button onclick="showSection('contact')" class="flex flex-col items-center p-2 text-gray-600 hover:text-purple-600">
                <span class="text-xl">üìû</span>
                <span class="text-xs">Contacto</span>
            </button>
            <button onclick="showSection('login')" class="flex flex-col items-center p-2 text-gray-600 hover:text-purple-600">
                <span class="text-xl">üë§</span>
                <span class="text-xs">Login</span>
            </button>
        </div>
    </div>

    <!-- Desktop Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-40 hidden md:block">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-purple-600">Invites</h1>
                </div>
                <div class="flex space-x-6">
                    <a href="#" onclick="showSection('home')" class="text-gray-700 hover:text-purple-600 transition-colors">Menu</a>
                    <a href="#" onclick="showSection('about')" class="text-gray-700 hover:text-purple-600 transition-colors">Sobre N√≥s</a>
                    <a href="#" onclick="showSection('contact')" class="text-gray-700 hover:text-purple-600 transition-colors">Contacto</a>
                </div>
                <div class="flex space-x-3">
                    <button onclick="showSection('login')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">Login</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="mobile-container">
        <!-- Home Section -->
        <div id="home-section" class="section">
            <!-- Mobile Header -->
            <div class="md:hidden bg-white shadow-sm p-4 sticky top-0 z-30">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold text-purple-600">Invites</h1>
                </div>
            </div>

            <div class="gradient-bg text-white py-12 px-4">
                <div class="max-w-lg mx-auto text-center">
                    <h1 class="text-3xl md:text-5xl font-bold mb-4">Sistema de Confirma√ß√£o</h1>
                    <p class="text-lg md:text-xl mb-6">Crie p√°ginas personalizadas para seus eventos</p>
                    <button onclick="showSection('register')" class="w-full md:w-auto bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">Criar Conta Gratuita</button>
                </div>
            </div>

            <div class="max-w-4xl mx-auto py-8 px-4">
                <div class="grid gap-6">
                    <div class="bg-white p-6 rounded-lg card-shadow">
                        <div class="text-center">
                            <div class="text-3xl mb-3">üéâ</div>
                            <h3 class="text-lg font-semibold mb-2">Eventos Personalizados</h3>
                            <p class="text-gray-600 text-sm">Crie p√°ginas √∫nicas para casamentos, anivers√°rios e outros eventos especiais</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg card-shadow">
                        <div class="text-center">
                            <div class="text-3xl mb-3">üì±</div>
                            <h3 class="text-lg font-semibold mb-2">Links Personalizados</h3>
                            <p class="text-gray-600 text-sm">Gere links espec√≠ficos com e sem acompanhantes para diferentes convidados</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg card-shadow">
                        <div class="text-center">
                            <div class="text-3xl mb-3">üìä</div>
                            <h3 class="text-lg font-semibold mb-2">Gest√£o Completa</h3>
                            <p class="text-gray-600 text-sm">Acompanhe confirma√ß√µes, mensagens e gerencie todos os aspectos do seu evento</p>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- About Section -->
        <div id="about-section" class="section hidden">
            <div class="md:hidden bg-white shadow-sm p-4 sticky top-0 z-30">
                <h2 class="text-xl font-bold text-center">Sobre N√≥s</h2>
            </div>
            <div class="max-w-4xl mx-auto py-8 px-4">
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h2 class="text-2xl font-bold mb-4 hidden md:block">Sobre N√≥s</h2>
                    <p class="text-gray-700 mb-4" id="about-content">
                        O Invites √© uma plataforma inovadora que simplifica a organiza√ß√£o de eventos atrav√©s de um sistema inteligente de confirma√ß√£o de presen√ßa. Nossa miss√£o √© tornar a gest√£o de convidados mais eficiente e elegante.
                    </p>
                    <p class="text-gray-700">
                        Com anos de experi√™ncia em tecnologia e eventos, desenvolvemos uma solu√ß√£o completa que atende desde pequenas celebra√ß√µes at√© grandes eventos corporativos.
                    </p>
                </div>
            </div>
        </div>

        <!-- Contact Section -->
        <div id="contact-section" class="section hidden">
            <div class="md:hidden bg-white shadow-sm p-4 sticky top-0 z-30">
                <h2 class="text-xl font-bold text-center">Contacto</h2>
            </div>
            <div class="max-w-4xl mx-auto py-8 px-4">
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h2 class="text-2xl font-bold mb-4 hidden md:block">Contacto</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Informa√ß√µes de Contacto</h3>
                            <div class="space-y-2" id="contact-info">
                                <p class="flex items-center text-sm"><span class="font-semibold mr-2">WhatsApp:</span> +244 959 823 409</p>
                                <p class="flex items-center text-sm"><span class="font-semibold mr-2">Hor√°rio:</span> Segunda a Sexta, 8h √†s 18h</p>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Entre em Contacto</h3>
                            <p class="text-gray-600 text-sm">Para d√∫vidas ou suporte, entre em contacto atrav√©s do WhatsApp acima.</p>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Register Section -->
        <div id="register-section" class="section hidden">
            <div class="md:hidden bg-white shadow-sm p-4 sticky top-0 z-30">
                <h2 class="text-xl font-bold text-center">Criar Conta</h2>
            </div>
            <div class="max-w-md mx-auto py-8 px-4">
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h2 class="text-2xl font-bold text-center mb-6 hidden md:block">Criar Nova Conta</h2>
                    <form id="register-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nome Completo</label>
                            <input type="text" id="full-name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Seu nome completo" required>
                        </div>
                        


                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Nome de Usu√°rio</label>
                                <input type="text" id="username" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Seu usu√°rio" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Senha</label>
                                <input type="password" id="password" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Sua senha" required>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">Criar Conta</button>
                    </form>

                    <div id="account-created" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-2">Conta Criada com Sucesso!</h3>
                        <p class="text-green-700 mb-3 text-sm">Sua solicita√ß√£o foi enviada para an√°lise. Entre em contacto com a Invites para receber seu token de acesso.</p>
                        <button onclick="showTokenSection()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Inserir Token</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Token Section -->
        <div id="token-section" class="section hidden">
            <div class="md:hidden bg-white shadow-sm p-4 sticky top-0 z-30">
                <h2 class="text-xl font-bold text-center">Token de Acesso</h2>
            </div>
            <div class="max-w-md mx-auto py-8 px-4">
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h2 class="text-2xl font-bold text-center mb-6 hidden md:block">Token de Acesso</h2>
                    
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">Como obter seu token?</h3>
                        <p class="text-blue-700 text-sm mb-2">1. Entre em contacto connosco via WhatsApp: <strong>+244 959 823 409</strong></p>
                        <p class="text-blue-700 text-sm mb-2">2. Informe o nome de usu√°rio: <strong id="pending-username"></strong></p>
                        <p class="text-blue-700 text-sm mb-2">3. Receba seu token √∫nico (formato: INV-XXXXXXXXXX)</p>
                        <p class="text-blue-700 text-sm">4. Insira o token abaixo para ativar sua conta</p>
                    </div>

                    <form id="token-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Token de Acesso</label>
                            <input type="text" id="access-token" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="INV-XXXXXXXXXX" pattern="INV-[A-Z0-9]{12}" title="Formato: INV-XXXXXXXXXX" required>
                            <p class="text-xs text-gray-500 mt-1">Formato esperado: INV-XXXXXXXXXX</p>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">Validar Token</button>
                    </form>

                    <div id="token-error" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-700 text-sm">Token inv√°lido. Verifique o token e tente novamente.</p>
                    </div>

                    <div id="token-success" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-2">Token Validado!</h3>
                        <p class="text-green-700 text-sm mb-3">Sua conta foi ativada com sucesso. Agora pode criar seus eventos.</p>
                        <button onclick="proceedToLogin()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Continuar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Event Section -->
        <div id="create-event-section" class="section hidden">
            <div class="md:hidden bg-white shadow-sm p-4 sticky top-0 z-30">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Criar Evento</h2>
                    <button onclick="logout()" class="text-sm bg-red-100 px-3 py-1 rounded-full">Sair</button>
                </div>
            </div>
            <div class="max-w-2xl mx-auto py-8 px-4">
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h2 class="text-2xl font-bold text-center mb-6 hidden md:block">Criar Novo Evento</h2>
                    <form id="create-event-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nome do Evento</label>
                            <input type="text" id="event-title" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Ex: Casamento Jo√£o & Maria" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Descri√ß√£o do Evento (Opcional)</label>
                            <textarea id="event-description" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Descreva seu evento..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Data do Evento</label>
                                <input type="date" id="event-date" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Prazo para Confirma√ß√£o (Opcional)</label>
                                <input type="date" id="confirmation-deadline" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Limite M√°ximo de Confirma√ß√µes (Opcional)</label>
                                <input type="number" id="max-confirmations" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Ex: 150">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Limite de Acompanhantes</label>
                                <input type="number" id="companion-limit" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Ex: 2" value="1" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Sistema de Presentes</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="gift-type" value="none" class="mr-2" checked>
                                    <span class="text-sm">N√£o usar sistema de presentes</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="gift-type" value="bank" class="mr-2">
                                    <span class="text-sm">Transfer√™ncia banc√°ria</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="gift-type" value="list" class="mr-2">
                                    <span class="text-sm">Lista de presentes</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">Criar Evento</button>
                    </form>

                    <div id="event-created" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-2">Evento Criado!</h3>
                        <p class="text-green-700 mb-3 text-sm">Seu evento foi criado com sucesso. Acesse o painel para gerenciar.</p>
                        <button onclick="loadUserDashboard()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Ir para Painel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Section -->
        <div id="login-section" class="section hidden">
            <div class="md:hidden bg-white shadow-sm p-4 sticky top-0 z-30">
                <h2 class="text-xl font-bold text-center">Login</h2>
            </div>
            <div class="max-w-md mx-auto py-8 px-4">
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h2 class="text-2xl font-bold text-center mb-6 hidden md:block">Login</h2>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nome de Usu√°rio</label>
                            <input type="text" id="login-username" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Senha</label>
                            <input type="password" id="login-password" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" required>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">Entrar</button>
                    </form>
                    <div class="mt-4 text-center">
                        <button onclick="showSection('register')" class="text-purple-600 text-sm hover:underline">N√£o tem conta? Criar agora</button>
                    </div>
                </div>
            </div>
        </div>



        <!-- User Dashboard -->
        <div id="user-dashboard" class="section hidden">
            <div class="bg-white shadow-sm p-4 sticky top-0 z-30">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Meus Eventos</h2>
                    <div class="flex space-x-2">
                        <button onclick="showSection('create-event')" class="bg-green-600 text-white px-3 py-1 rounded text-sm">+ Evento</button>
                        <button onclick="logout()" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Sair</button>
                    </div>
                </div>
            </div>

            <div class="max-w-6xl mx-auto py-6 px-4">
                <!-- Events List -->
                <div id="user-events-list" class="mb-6">
                    <!-- Events will be populated here -->
                </div>

                <!-- Event Details (shown when event is selected) -->
                <div id="event-details" class="hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg card-shadow text-center">
                        <h3 class="text-sm font-semibold mb-1">Confirmados</h3>
                        <p class="text-2xl font-bold text-green-600" id="confirmed-count">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg card-shadow text-center">
                        <h3 class="text-sm font-semibold mb-1">Recusados</h3>
                        <p class="text-2xl font-bold text-red-600" id="declined-count">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg card-shadow text-center">
                        <h3 class="text-sm font-semibold mb-1">Total</h3>
                        <p class="text-2xl font-bold text-blue-600" id="total-rsvps">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg card-shadow text-center">
                        <h3 class="text-sm font-semibold mb-1">Acompanhantes</h3>
                        <p class="text-2xl font-bold text-purple-600" id="total-companions">0</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white rounded-lg p-4 card-shadow">
                        <h3 class="text-lg font-semibold mb-4">Links do Evento</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Link COM Acompanhante</label>
                                <div class="flex">
                                    <input type="text" id="link-with-companion" class="flex-1 p-2 border rounded-l-lg bg-gray-50 text-xs" readonly>
                                    <button onclick="copyLink('link-with-companion')" class="bg-purple-600 text-white px-3 py-2 rounded-r-lg hover:bg-purple-700 text-xs">Copiar</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Link SEM Acompanhante</label>
                                <div class="flex">
                                    <input type="text" id="link-without-companion" class="flex-1 p-2 border rounded-l-lg bg-gray-50 text-xs" readonly>
                                    <button onclick="copyLink('link-without-companion')" class="bg-purple-600 text-white px-3 py-2 rounded-r-lg hover:bg-purple-700 text-xs">Copiar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-4 card-shadow">
                        <h3 class="text-lg font-semibold mb-4">Configura√ß√µes</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-description" class="mr-3" checked>
                                <span class="text-sm">Mostrar descri√ß√£o do evento</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-deadline" class="mr-3" checked>
                                <span class="text-sm">Definir prazo para confirma√ß√£o</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-max-limit" class="mr-3" checked>
                                <span class="text-sm">Definir limite m√°ximo</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-public-wall" class="mr-3" checked>
                                <span class="text-sm">Mural p√∫blico de mensagens</span>
                            </label>
                        </div>
                        <button onclick="saveEventSettings()" class="mt-4 w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">Salvar Configura√ß√µes</button>
                    </div>

                    <div class="bg-white rounded-lg p-4 card-shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Sistema de Presentes</h3>
                            <label class="flex items-center">
                                <input type="checkbox" id="enable-gifts" class="mr-2" onchange="toggleGiftSystem()">
                                <span class="text-sm">Ativar Presentes</span>
                            </label>
                        </div>
                        
                        <div id="gift-system-config" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Tipo de Sistema</label>
                                <select id="gift-system-type" class="w-full p-2 border rounded-lg" onchange="toggleGiftType()">
                                    <option value="none">Desativado</option>
                                    <option value="bank">Transfer√™ncia Banc√°ria</option>
                                    <option value="list">Lista de Presentes</option>
                                </select>
                            </div>

                            <!-- Bank Transfer Configuration -->
                            <div id="bank-config" class="hidden space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Mensagem Personalizada</label>
                                    <textarea id="bank-message" rows="6" class="w-full p-2 border rounded-lg text-sm" placeholder="Digite sua mensagem...">Querido(a) convidado(a)!
Caso queira nos presentear, agradecemos
desde j√° o seu lindo gesto e gostar√≠amos
que o fizesse por transfer√™ncia banc√°ria.
para o IBAN indicado abaixo:

AO. 7210158
Titular Diogo dos santos Ingl√™s

Muito obrigado(a)!
Deus lhe aben√ßoe sempre!</textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">IBAN</label>
                                        <input type="text" id="bank-iban" class="w-full p-2 border rounded-lg text-sm" value="AO. 7210158">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Nome do Titular</label>
                                        <input type="text" id="bank-holder" class="w-full p-2 border rounded-lg text-sm" value="Diogo dos santos Ingl√™s">
                                    </div>
                                </div>
                            </div>

                            <!-- Gift List Configuration -->
                            <div id="list-config" class="hidden space-y-3">
                                <div class="flex justify-between items-center">
                                    <label class="block text-sm font-medium">Lista de Presentes</label>
                                    <button onclick="addGiftItem()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">+ Adicionar</button>
                                </div>
                                <div id="gift-items-list" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Gift items will be populated here -->
                                </div>
                            </div>

                            <button onclick="saveGiftSettings()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">Salvar Configura√ß√µes</button>
                        </div>
                    </div>

                    <!-- Gift Statistics -->
                    <div id="gift-stats" class="bg-white rounded-lg p-4 card-shadow hidden">
                        <h3 class="text-lg font-semibold mb-4">Estat√≠sticas de Presentes</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-3 bg-green-50 rounded-lg">
                                <p class="text-2xl font-bold text-green-600" id="gifts-chosen">0</p>
                                <p class="text-sm text-green-700">Presentes Escolhidos</p>
                            </div>
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <p class="text-2xl font-bold text-blue-600" id="gifts-available">0</p>
                                <p class="text-sm text-blue-700">Ainda Dispon√≠veis</p>
                            </div>
                        </div>
                        <div id="gift-choices-list" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Gift choices will be populated here -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-4 card-shadow">
                        <h3 class="text-lg font-semibold mb-4">Confirma√ß√µes Recentes</h3>
                        <div id="recent-rsvps-list" class="space-y-3">
                            <!-- RSVPs will be populated here -->
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Guest RSVP Page -->
        <div id="guest-rsvp" class="section hidden">
            <div class="min-h-screen gradient-bg flex items-center justify-center px-4">
                <div class="max-w-lg w-full">
                    <!-- Countdown Timer -->
                    <div id="countdown-timer" class="bg-white rounded-lg p-4 card-shadow mb-4 text-center hidden">
                        <p class="text-sm text-gray-600 mb-2">Tempo restante para confirma√ß√£o:</p>
                        <div class="flex justify-center space-x-4 text-lg font-bold">
                            <div class="text-center">
                                <div id="days" class="text-2xl text-purple-600">00</div>
                                <div class="text-xs text-gray-500">DIAS</div>
                            </div>
                            <div class="text-center">
                                <div id="hours" class="text-2xl text-purple-600">00</div>
                                <div class="text-xs text-gray-500">HORAS</div>
                            </div>
                            <div class="text-center">
                                <div id="minutes" class="text-2xl text-purple-600">00</div>
                                <div class="text-xs text-gray-500">MIN</div>
                            </div>
                            <div class="text-center">
                                <div id="seconds" class="text-2xl text-purple-600">00</div>
                                <div class="text-xs text-gray-500">SEG</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="text-center mb-6">
                            <h1 class="text-2xl md:text-3xl font-bold mb-2" id="rsvp-event-title">Evento</h1>
                            <p class="text-lg text-gray-600 mb-2" id="rsvp-event-date">Data</p>
                            <p class="text-sm text-gray-500" id="rsvp-event-description">Descri√ß√£o</p>
                        </div>
                        
                        <form id="rsvp-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Seu Nome Completo</label>
                                <input type="text" id="guest-name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Confirma√ß√£o de Presen√ßa</label>
                                <select id="attendance-status" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                    <option value="">Selecione uma op√ß√£o</option>
                                    <option value="true">Confirmo minha presen√ßa</option>
                                    <option value="false">N√£o poderei comparecer</option>
                                </select>
                            </div>

                            <div id="companion-section" class="hidden">
                                <label class="block text-sm font-medium mb-2">Acompanhantes</label>
                                <div id="companion-inputs">
                                    <!-- Companion inputs will be generated here -->
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Mensagem (Opcional)</label>
                                <textarea id="guest-message" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Deixe uma mensagem carinhosa..."></textarea>
                            </div>

                            <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">Confirmar Presen√ßa</button>
                        </form>
                    </div>

                    <!-- Gift Section -->
                    <div id="gift-section" class="hidden bg-white rounded-lg p-6 card-shadow mt-4">
                        <div class="text-center mb-6">
                            <div class="text-3xl mb-3">üéÅ</div>
                            <h3 class="text-xl font-bold mb-2">Presentes</h3>
                            <p class="text-gray-600 text-sm">Se desejar nos presentear, escolha uma das op√ß√µes abaixo</p>
                        </div>

                        <!-- Bank Transfer Option -->
                        <div id="bank-gift-option" class="hidden">
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <pre id="bank-gift-message" class="text-sm text-gray-700 whitespace-pre-wrap font-sans"></pre>
                            </div>
                            <div class="flex mb-4">
                                <input type="text" id="display-iban" class="flex-1 p-2 border rounded-l-lg bg-gray-50 text-sm" readonly>
                                <button onclick="copyIban()" class="bg-purple-600 text-white px-4 py-2 rounded-r-lg hover:bg-purple-700 text-sm">Copiar IBAN</button>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="skipGifts()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">Ignorar</button>
                                <button onclick="confirmGiftChoice()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Obrigado!</button>
                            </div>
                        </div>

                        <!-- Gift List Option -->
                        <div id="list-gift-option" class="hidden">
                            <div class="space-y-3 mb-4 max-h-60 overflow-y-auto" id="available-gifts">
                                <!-- Gift items will be populated here -->
                            </div>
                            <button onclick="skipGifts()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">Ignorar Presentes</button>
                        </div>
                    </div>

                    <!-- Success Message -->
                    <div id="success-message" class="hidden bg-white rounded-lg p-6 card-shadow mt-4 text-center">
                        <div class="text-4xl mb-3">üéâ</div>
                        <h3 class="text-xl font-bold mb-2">Confirma√ß√£o Enviada!</h3>
                        <p class="text-gray-600">Obrigado por confirmar sua presen√ßa. Aguardamos voc√™ no evento!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 text-center">
        <p class="text-sm">¬© 2025 Invites - Sistema de Confirma√ß√£o de Presen√ßa</p>
    </footer>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ybbhynfttwogkdsnqmvu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliYmh5bmZ0dHdvZ2tkc25xbXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY3MDIsImV4cCI6MjA3MTI1MjcwMn0.LPMGW_OPKiwTEKhyzl_v2Snb9nVeZg0wP4Ot6zKrCn0';
        
        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let currentEvent = null;
        let isAdmin = false;

        // Site content (can be moved to database later)
        const siteContent = {
            about: "O Invites √© uma plataforma inovadora que simplifica a organiza√ß√£o de eventos atrav√©s de um sistema inteligente de confirma√ß√£o de presen√ßa. Nossa miss√£o √© tornar a gest√£o de convidados mais eficiente e elegante.",
            contact: "WhatsApp: +244 959 823 409\nHor√°rio: Segunda a Sexta, 8h √†s 18h"
        };

        // Admin panel data structure - all data that admin needs access to
        const adminDataStructure = {
            // User management
            users: {
                table: 'users',
                fields: ['id', 'username', 'full_name', 'password', 'token', 'is_active', 'created_at', 'last_login'],
                actions: ['view', 'edit', 'activate', 'deactivate', 'delete', 'reset_password', 'regenerate_token']
            },
            
            // Event management
            events: {
                table: 'events',
                fields: ['id', 'user_id', 'title', 'description', 'event_date', 'confirmation_deadline', 'max_confirmations', 'companion_limit', 'custom_url', 'enable_description', 'enable_deadline', 'enable_max_limit', 'enable_public_wall', 'enable_gifts', 'gift_config', 'created_at'],
                actions: ['view', 'edit', 'delete', 'duplicate', 'export_rsvps', 'view_statistics']
            },
            
            // RSVP management
            rsvps: {
                table: 'rsvps',
                fields: ['id', 'wedding_id', 'guest_name', 'companion_name', 'attendance', 'message', 'created_at'],
                actions: ['view', 'edit', 'delete', 'export']
            },
            
            // Gift selections
            gift_selections: {
                table: 'gift_selections',
                fields: ['id', 'event_id', 'guest_name', 'gift_name', 'selection_type', 'created_at'],
                actions: ['view', 'edit', 'delete']
            },
            
            // Notifications
            admin_notifications: {
                table: 'admin_notifications',
                fields: ['id', 'type', 'user_id', 'username', 'full_name', 'token', 'created_at', 'is_read', 'priority', 'data'],
                actions: ['view', 'mark_read', 'delete', 'bulk_actions']
            },
            
            // Activity logs
            admin_activity_logs: {
                table: 'admin_activity_logs',
                fields: ['id', 'action', 'data', 'timestamp', 'ip_address', 'user_agent'],
                actions: ['view', 'export', 'filter']
            },
            
            // System statistics
            system_statistics: {
                table: 'system_statistics',
                fields: ['id', 'action', 'event_id', 'user_id', 'timestamp', 'date'],
                actions: ['view', 'generate_reports', 'export']
            },
            
            // Site content management
            site_content: {
                table: 'site_content',
                fields: ['id', 'section', 'content', 'updated_at', 'updated_by'],
                actions: ['view', 'edit']
            }
        };

        // Admin functions that will be accessible from admin panel
        const adminFunctions = {
            // User management
            async getUserList(filters = {}) {
                let query = supabaseClient.from('users').select('*');
                if (filters.active !== undefined) query = query.eq('is_active', filters.active);
                if (filters.search) query = query.or(`username.ilike.%${filters.search}%,full_name.ilike.%${filters.search}%`);
                return await query.order('created_at', { ascending: false });
            },
            
            async activateUser(userId) {
                const result = await supabaseClient.from('users').update({ is_active: true }).eq('id', userId);
                if (!result.error) {
                    await logAdminActivity('user_activated', { user_id: userId, admin_action: true });
                }
                return result;
            },
            
            async deactivateUser(userId) {
                const result = await supabaseClient.from('users').update({ is_active: false }).eq('id', userId);
                if (!result.error) {
                    await logAdminActivity('user_deactivated', { user_id: userId, admin_action: true });
                }
                return result;
            },
            
            async regenerateUserToken(userId) {
                const newToken = generateUniqueToken();
                const result = await supabaseClient.from('users').update({ token: newToken }).eq('id', userId);
                if (!result.error) {
                    await logAdminActivity('token_regenerated', { user_id: userId, new_token: newToken, admin_action: true });
                }
                return { ...result, token: newToken };
            },
            
            // Event management
            async getEventList(filters = {}) {
                let query = supabaseClient.from('events').select('*, users(username, full_name)');
                if (filters.user_id) query = query.eq('user_id', filters.user_id);
                if (filters.date_from) query = query.gte('event_date', filters.date_from);
                if (filters.date_to) query = query.lte('event_date', filters.date_to);
                return await query.order('created_at', { ascending: false });
            },
            
            async getEventStatistics(eventId) {
                const [rsvps, gifts] = await Promise.all([
                    supabaseClient.from('rsvps').select('*').eq('wedding_id', eventId),
                    supabaseClient.from('gift_selections').select('*').eq('event_id', eventId)
                ]);
                
                const confirmed = rsvps.data?.filter(r => r.attendance === true).length || 0;
                const declined = rsvps.data?.filter(r => r.attendance === false).length || 0;
                const companions = rsvps.data?.filter(r => r.companion_name).length || 0;
                
                return {
                    total_rsvps: rsvps.data?.length || 0,
                    confirmed,
                    declined,
                    companions,
                    gifts_selected: gifts.data?.length || 0
                };
            },
            
            // System statistics
            async getSystemStats(dateRange = 30) {
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - dateRange);
                
                const [users, events, rsvps, activities] = await Promise.all([
                    supabaseClient.from('users').select('created_at').gte('created_at', startDate.toISOString()),
                    supabaseClient.from('events').select('created_at').gte('created_at', startDate.toISOString()),
                    supabaseClient.from('rsvps').select('created_at').gte('created_at', startDate.toISOString()),
                    supabaseClient.from('system_statistics').select('*').gte('timestamp', startDate.toISOString())
                ]);
                
                return {
                    new_users: users.data?.length || 0,
                    new_events: events.data?.length || 0,
                    new_rsvps: rsvps.data?.length || 0,
                    total_activities: activities.data?.length || 0,
                    daily_breakdown: this.generateDailyBreakdown(activities.data || [])
                };
            },
            
            generateDailyBreakdown(activities) {
                const breakdown = {};
                activities.forEach(activity => {
                    const date = activity.date || activity.timestamp.split('T')[0];
                    if (!breakdown[date]) {
                        breakdown[date] = { registrations: 0, events: 0, rsvps: 0, tokens: 0 };
                    }
                    switch(activity.action) {
                        case 'user_registration': breakdown[date].registrations++; break;
                        case 'event_creation': breakdown[date].events++; break;
                        case 'rsvp_submission': breakdown[date].rsvps++; break;
                        case 'token_validation': breakdown[date].tokens++; break;
                    }
                });
                return breakdown;
            },
            
            // Notifications
            async getNotifications(filters = {}) {
                let query = supabaseClient.from('admin_notifications').select('*');
                if (filters.unread_only) query = query.eq('is_read', false);
                if (filters.type) query = query.eq('type', filters.type);
                return await query.order('created_at', { ascending: false });
            },
            
            async markNotificationRead(notificationId) {
                return await supabaseClient.from('admin_notifications').update({ is_read: true }).eq('id', notificationId);
            }
        };

        // Token generation and validation functions
        function generateUniqueToken() {
            const timestamp = Date.now().toString();
            const random = Math.random().toString(36).substring(2, 15);
            const hash = btoa(timestamp + random).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12);
            return `INV-${hash.toUpperCase()}`;
        }

        async function sendAdminNotification(userData, token) {
            try {
                // Store notification in database for admin panel access
                const notification = {
                    type: 'new_account',
                    user_id: userData.id,
                    username: userData.username,
                    full_name: userData.full_name,
                    token: token,
                    created_at: new Date().toISOString(),
                    is_read: false,
                    priority: 'high',
                    data: {
                        user_data: userData,
                        action_required: 'token_validation',
                        whatsapp_message: `üîî Nova conta criada no Invites!\n\nUsu√°rio: ${userData.username}\nNome: ${userData.full_name}\nToken: ${token}\n\nAcesse o painel admin para gerenciar.`
                    }
                };
                
                // Insert notification into admin_notifications table for panel access
                const { data, error } = await supabaseClient
                    .from('admin_notifications')
                    .insert([notification]);
                
                if (error) {
                    console.error('Erro ao salvar notifica√ß√£o:', error);
                }
                
                // Also create admin activity log
                await logAdminActivity('new_account_request', {
                    user_id: userData.id,
                    username: userData.username,
                    full_name: userData.full_name,
                    token: token,
                    timestamp: new Date().toISOString()
                });
                
                console.log('Notifica√ß√£o salva para painel admin:', notification);
                return true;
            } catch (err) {
                console.error('Erro ao enviar notifica√ß√£o:', err);
                return false;
            }
        }

        // Admin activity logging for panel access
        async function logAdminActivity(action, data) {
            try {
                const activity = {
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString(),
                    ip_address: 'client_side', // Will be updated by admin panel
                    user_agent: navigator.userAgent
                };
                
                await supabaseClient
                    .from('admin_activity_logs')
                    .insert([activity]);
            } catch (err) {
                console.error('Erro ao registrar atividade:', err);
            }
        }

        // System statistics for admin panel
        async function updateSystemStats(action, eventId = null, userId = null) {
            try {
                const statsUpdate = {
                    action: action,
                    event_id: eventId,
                    user_id: userId,
                    timestamp: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0] // For daily stats
                };
                
                await supabaseClient
                    .from('system_statistics')
                    .insert([statsUpdate]);
            } catch (err) {
                console.error('Erro ao atualizar estat√≠sticas:', err);
            }
        }

        // Navigation functions
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            const targetSection = document.getElementById(sectionName + '-section') || 
                                 document.getElementById(sectionName + '-dashboard') ||
                                 document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('animate-fade-in');
            }
            
            if (sectionName === 'about') {
                loadSiteContent();
            }
        }

        // Token section functions
        function showTokenSection() {
            showSection('token');
            
            // Check if we have stored username
            const pendingUsername = localStorage.getItem('pending_username');
            if (pendingUsername) {
                document.getElementById('pending-username').textContent = pendingUsername;
            }
        }

        function proceedToLogin() {
            if (currentUser) {
                loadUserDashboard();
            } else {
                showSection('login');
            }
        }

        // Load site content
        function loadSiteContent() {
            document.getElementById('about-content').textContent = siteContent.about;
            document.getElementById('contact-info').innerHTML = siteContent.contact.split('\n').map(line => `<p class="text-sm">${line}</p>`).join('');
        }

        // Generate automatic URL from event title
        function generateCustomUrl(title) {
            return title.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove accents
                .replace(/[^a-z0-9\s-]/g, '') // Remove special chars
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Replace multiple hyphens with single
                .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                + '-' + Date.now().toString().slice(-6); // Add timestamp for uniqueness
        }

        // Registration form handler (creates user account and generates unique token)
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            
            // Generate unique token
            const uniqueToken = generateUniqueToken();
            
            const formData = {
                full_name: document.getElementById('full-name').value,
                username: username,
                password: document.getElementById('password').value,
                token: uniqueToken,
                is_active: false
            };
            
            try {
                // Insert user into Supabase
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert([formData])
                    .select();
                
                if (error) {
                    if (error.code === '23505') {
                        alert('Nome de usu√°rio j√° existe');
                    } else {
                        alert('Erro ao criar conta: ' + error.message);
                    }
                    return;
                }
                
                // Store user data for token section
                localStorage.setItem('pending_username', username);
                localStorage.setItem('pending_user_id', data[0].id);
                localStorage.setItem('generated_token', uniqueToken);
                
                document.getElementById('pending-username').textContent = username;
                
                // Send notification to admin and log activity
                await sendAdminNotification(data[0], uniqueToken);
                await updateSystemStats('user_registration', null, data[0].id);
                
                document.getElementById('account-created').classList.remove('hidden');
                this.reset();
            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            }
        });

        // Create event form handler
        document.getElementById('create-event-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const eventTitle = document.getElementById('event-title').value;
            const customUrl = generateCustomUrl(eventTitle);
            
            const giftType = document.querySelector('input[name="gift-type"]:checked').value;
            let giftConfig = null;
            let enableGifts = false;

            if (giftType === 'bank') {
                enableGifts = true;
                giftConfig = {
                    type: 'bank',
                    message: 'Querido(a) convidado(a)!\nCaso queira nos presentear, agradecemos\ndesde j√° o seu lindo gesto e gostar√≠amos\nque o fizesse por transfer√™ncia banc√°ria.\npara o IBAN indicado abaixo:\n\nAO. 7210158\nTitular Diogo dos santos Ingl√™s\n\nMuito obrigado(a)!\nDeus lhe aben√ßoe sempre!',
                    iban: 'AO. 7210158',
                    holder: 'Diogo dos santos Ingl√™s'
                };
            } else if (giftType === 'list') {
                enableGifts = true;
                giftConfig = {
                    type: 'list',
                    items: []
                };
            }

            const formData = {
                user_id: currentUser.id,
                title: eventTitle,
                description: document.getElementById('event-description').value || null,
                event_date: document.getElementById('event-date').value,
                confirmation_deadline: document.getElementById('confirmation-deadline').value || null,
                max_confirmations: parseInt(document.getElementById('max-confirmations').value) || null,
                companion_limit: parseInt(document.getElementById('companion-limit').value) || 1,
                custom_url: customUrl,
                enable_description: !!document.getElementById('event-description').value,
                enable_deadline: !!document.getElementById('confirmation-deadline').value,
                enable_max_limit: !!document.getElementById('max-confirmations').value,
                enable_public_wall: true,
                enable_gifts: enableGifts,
                gift_config: giftConfig
            };
            
            try {
                // Insert event into Supabase
                const { data, error } = await supabaseClient
                    .from('events')
                    .insert([formData])
                    .select();
                
                if (error) {
                    if (error.code === '23505') {
                        alert('URL personalizada j√° existe');
                    } else {
                        alert('Erro ao criar evento: ' + error.message);
                    }
                    return;
                }
                
                currentEvent = data[0];
                
                // Log event creation for admin panel
                await logAdminActivity('event_created', {
                    event_id: data[0].id,
                    user_id: currentUser.id,
                    event_title: data[0].title,
                    event_date: data[0].event_date,
                    custom_url: data[0].custom_url,
                    timestamp: new Date().toISOString()
                });
                await updateSystemStats('event_creation', data[0].id, currentUser.id);
                
                document.getElementById('event-created').classList.remove('hidden');
                this.reset();
            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            }
        });

        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();
                
                if (error || !data) {
                    alert('Credenciais inv√°lidas');
                    return;
                }
                
                // Check if user has valid token and is active
                if (!data.is_active || !data.token) {
                    localStorage.setItem('pending_username', username);
                    localStorage.setItem('pending_user_id', data.id);
                    document.getElementById('pending-username').textContent = username;
                    showTokenSection();
                    return;
                }
                
                currentUser = data;
                saveUserSession(data);
                loadUserDashboard();
            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            }
        });

        // Token form handler
        document.getElementById('token-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const enteredToken = document.getElementById('access-token').value.trim();
            const pendingUsername = localStorage.getItem('pending_username');
            const pendingUserId = localStorage.getItem('pending_user_id');
            
            if (!pendingUsername || !pendingUserId) {
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                showSection('login');
                return;
            }
            
            try {
                // Get user data to validate token
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', pendingUserId)
                    .single();
                
                if (userError || !userData) {
                    alert('Erro ao validar token. Tente novamente.');
                    return;
                }
                
                // Validate token
                if (userData.token !== enteredToken) {
                    document.getElementById('token-error').classList.remove('hidden');
                    document.getElementById('token-success').classList.add('hidden');
                    return;
                }
                
                // Token is valid, activate user account
                const { data: updatedUser, error: updateError } = await supabaseClient
                    .from('users')
                    .update({ is_active: true })
                    .eq('id', pendingUserId)
                    .select()
                    .single();
                
                if (updateError) {
                    alert('Erro ao ativar conta: ' + updateError.message);
                    return;
                }
                
                // Clear error and show success
                document.getElementById('token-error').classList.add('hidden');
                document.getElementById('token-success').classList.remove('hidden');
                
                // Store activated user and save session
                currentUser = updatedUser;
                saveUserSession(updatedUser);
                
                // Log token validation for admin panel
                await logAdminActivity('token_validated', {
                    user_id: updatedUser.id,
                    username: updatedUser.username,
                    token: enteredToken,
                    timestamp: new Date().toISOString()
                });
                await updateSystemStats('token_validation', null, updatedUser.id);
                
                // Clear pending data from localStorage
                localStorage.removeItem('pending_username');
                localStorage.removeItem('pending_user_id');
                localStorage.removeItem('generated_token');
                
            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            }
        });



        // Load user dashboard
        async function loadUserDashboard() {
            showSection('user-dashboard');
            
            try {
                // Load user's events
                const { data: events, error } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar eventos:', error);
                    return;
                }
                
                const container = document.getElementById('user-events-list');
                container.innerHTML = '';
                
                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg p-6 card-shadow text-center">
                            <div class="text-4xl mb-3">üéâ</div>
                            <h3 class="text-lg font-semibold mb-2">Nenhum evento criado</h3>
                            <p class="text-gray-600 mb-4">Crie seu primeiro evento para come√ßar a receber confirma√ß√µes!</p>
                            <button onclick="showSection('create-event')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Criar Primeiro Evento</button>
                        </div>
                    `;
                    return;
                }
                
                // Show events list
                events.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-lg p-4 card-shadow mb-4 cursor-pointer hover:shadow-lg transition-shadow';
                    div.onclick = () => selectEvent(event);
                    
                    const eventDate = new Date(event.event_date);
                    const isUpcoming = eventDate > new Date();
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold mb-1">${event.title}</h3>
                                <p class="text-sm text-gray-600 mb-2">${eventDate.toLocaleDateString('pt-BR')}</p>
                                ${event.description ? `<p class="text-xs text-gray-500 mb-2">${event.description}</p>` : ''}
                                <div class="flex items-center space-x-4 text-xs">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">ID: ${event.custom_url}</span>
                                    <span class="${isUpcoming ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} px-2 py-1 rounded">
                                        ${isUpcoming ? 'Ativo' : 'Finalizado'}
                                    </span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-purple-600" id="event-stats-${event.id}">Carregando...</p>
                                <p class="text-xs text-gray-500">confirma√ß√µes</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                    
                    // Load stats for this event
                    loadEventStats(event.id);
                });
                
            } catch (err) {
                console.error('Erro de conex√£o:', err);
            }
        }

        // Load stats for a specific event
        async function loadEventStats(eventId) {
            try {
                const { data: rsvps, error } = await supabaseClient
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', eventId);
                
                if (!error && rsvps) {
                    const confirmed = rsvps.filter(r => r.attendance === true).length;
                    const total = rsvps.length;
                    document.getElementById(`event-stats-${eventId}`).textContent = `${confirmed}/${total}`;
                }
            } catch (err) {
                console.error('Erro ao carregar stats:', err);
            }
        }

        // Select an event to view details
        function selectEvent(event) {
            currentEvent = event;
            
            // Hide events list and show event details
            document.getElementById('user-events-list').style.display = 'none';
            document.getElementById('event-details').classList.remove('hidden');
            
            // Generate event links - clean URLs without showing main site
            const baseUrl = window.location.origin + window.location.pathname;
            document.getElementById('link-with-companion').value = `${baseUrl}?event=${currentEvent.custom_url}&companion=true`;
            document.getElementById('link-without-companion').value = `${baseUrl}?event=${currentEvent.custom_url}&companion=false`;
            
            // Load settings
            document.getElementById('enable-description').checked = currentEvent.enable_description || false;
            document.getElementById('enable-deadline').checked = currentEvent.enable_deadline || false;
            document.getElementById('enable-max-limit').checked = currentEvent.enable_max_limit || false;
            document.getElementById('enable-public-wall').checked = currentEvent.enable_public_wall || false;
            document.getElementById('enable-gifts').checked = currentEvent.enable_gifts || false;
            
            // Load gift configuration
            loadGiftConfiguration();
            
            updateUserStats();
            loadRecentRSVPs();
            
            // Load gift statistics if gifts are enabled
            if (currentEvent.enable_gifts) {
                document.getElementById('gift-stats').classList.remove('hidden');
                loadGiftStatistics();
            }
            
            // Add back button
            const backButton = document.createElement('button');
            backButton.className = 'mb-4 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600';
            backButton.textContent = '‚Üê Voltar aos Eventos';
            backButton.onclick = () => {
                document.getElementById('user-events-list').style.display = 'block';
                document.getElementById('event-details').classList.add('hidden');
                currentEvent = null;
            };
            
            const eventDetails = document.getElementById('event-details');
            if (!eventDetails.querySelector('button')) {
                eventDetails.insertBefore(backButton, eventDetails.firstChild);
            }
        }



        // Update user statistics
        async function updateUserStats() {
            try {
                const { data: rsvps, error } = await supabaseClient
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id);
                
                if (error) {
                    console.error('Erro ao carregar RSVPs:', error);
                    return;
                }
                
                const confirmed = rsvps.filter(r => r.attendance === true).length;
                const declined = rsvps.filter(r => r.attendance === false).length;
                const companions = rsvps.filter(r => r.companion_name).length;
                
                document.getElementById('confirmed-count').textContent = confirmed;
                document.getElementById('declined-count').textContent = declined;
                document.getElementById('total-rsvps').textContent = rsvps.length;
                document.getElementById('total-companions').textContent = companions;
            } catch (err) {
                console.error('Erro de conex√£o:', err);
            }
        }



        // Load recent RSVPs for user
        async function loadRecentRSVPs() {
            try {
                const { data: rsvps, error } = await supabaseClient
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    console.error('Erro ao carregar RSVPs:', error);
                    return;
                }
                
                const container = document.getElementById('recent-rsvps-list');
                container.innerHTML = '';
                
                rsvps.forEach(rsvp => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-sm">${rsvp.guest_name}</p>
                                ${rsvp.companion_name ? `<p class="text-xs text-gray-600">+ ${rsvp.companion_name}</p>` : ''}
                                ${rsvp.message ? `<p class="text-xs text-gray-500 mt-1">"${rsvp.message}"</p>` : ''}
                            </div>
                            <span class="text-xs px-2 py-1 rounded ${rsvp.attendance ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${rsvp.attendance ? 'Confirmado' : 'Recusado'}
                            </span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (err) {
                console.error('Erro de conex√£o:', err);
            }
        }



        // Save event settings
        async function saveEventSettings() {
            try {
                const { data, error } = await supabaseClient
                    .from('events')
                    .update({
                        enable_description: document.getElementById('enable-description').checked,
                        enable_deadline: document.getElementById('enable-deadline').checked,
                        enable_max_limit: document.getElementById('enable-max-limit').checked,
                        enable_public_wall: document.getElementById('enable-public-wall').checked,
                        enable_gifts: document.getElementById('enable-gifts').checked
                    })
                    .eq('id', currentEvent.id)
                    .select();
                
                if (error) {
                    alert('Erro ao salvar configura√ß√µes: ' + error.message);
                    return;
                }
                
                currentEvent = data[0];
                
                // Log settings change for admin panel
                await logAdminActivity('event_settings_updated', {
                    event_id: currentEvent.id,
                    user_id: currentUser.id,
                    settings: {
                        enable_description: data[0].enable_description,
                        enable_deadline: data[0].enable_deadline,
                        enable_max_limit: data[0].enable_max_limit,
                        enable_public_wall: data[0].enable_public_wall,
                        enable_gifts: data[0].enable_gifts
                    },
                    timestamp: new Date().toISOString()
                });
                
                alert('Configura√ß√µes salvas com sucesso!');
            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            }
        }

        // Copy link function
        function copyLink(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            input.setSelectionRange(0, 99999);
            document.execCommand('copy');
            
            // Show feedback
            const button = input.nextElementSibling;
            const originalText = button.textContent;
            button.textContent = 'Copiado!';
            button.classList.add('bg-green-600');
            button.classList.remove('bg-purple-600');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-600');
                button.classList.add('bg-purple-600');
            }, 2000);
        }

        // Gift management functions
        function toggleGiftSystem() {
            const enabled = document.getElementById('enable-gifts').checked;
            const configSection = document.getElementById('gift-system-config');
            const statsSection = document.getElementById('gift-stats');
            
            if (enabled) {
                configSection.classList.remove('hidden');
                if (currentEvent && currentEvent.gift_config) {
                    statsSection.classList.remove('hidden');
                    loadGiftStatistics();
                }
            } else {
                configSection.classList.add('hidden');
                statsSection.classList.add('hidden');
            }
        }

        function toggleGiftType() {
            const type = document.getElementById('gift-system-type').value;
            document.getElementById('bank-config').classList.add('hidden');
            document.getElementById('list-config').classList.add('hidden');
            
            if (type === 'bank') {
                document.getElementById('bank-config').classList.remove('hidden');
            } else if (type === 'list') {
                document.getElementById('list-config').classList.remove('hidden');
                loadGiftItems();
            }
        }

        function loadGiftConfiguration() {
            const giftConfig = currentEvent.gift_config;
            if (!giftConfig) {
                document.getElementById('gift-system-type').value = 'none';
                return;
            }

            document.getElementById('gift-system-type').value = giftConfig.type;
            
            if (giftConfig.type === 'bank') {
                document.getElementById('bank-config').classList.remove('hidden');
                document.getElementById('bank-message').value = giftConfig.message || '';
                document.getElementById('bank-iban').value = giftConfig.iban || '';
                document.getElementById('bank-holder').value = giftConfig.holder || '';
            } else if (giftConfig.type === 'list') {
                document.getElementById('list-config').classList.remove('hidden');
                loadGiftItems();
            }
        }

        function loadGiftItems() {
            const container = document.getElementById('gift-items-list');
            container.innerHTML = '';
            
            const giftConfig = currentEvent.gift_config;
            if (!giftConfig || !giftConfig.items) return;
            
            giftConfig.items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 p-2 border rounded-lg';
                div.innerHTML = `
                    <input type="text" value="${item.name}" class="flex-1 p-1 border rounded text-sm" onchange="updateGiftItem(${index}, 'name', this.value)">
                    <input type="number" value="${item.quantity}" class="w-16 p-1 border rounded text-sm" min="1" onchange="updateGiftItem(${index}, 'quantity', this.value)">
                    <button onclick="removeGiftItem(${index})" class="bg-red-500 text-white px-2 py-1 rounded text-xs">√ó</button>
                `;
                container.appendChild(div);
            });
        }

        function addGiftItem() {
            if (!currentEvent.gift_config) {
                currentEvent.gift_config = { type: 'list', items: [] };
            }
            if (!currentEvent.gift_config.items) {
                currentEvent.gift_config.items = [];
            }
            
            currentEvent.gift_config.items.push({ name: 'Novo presente', quantity: 1 });
            loadGiftItems();
        }

        function updateGiftItem(index, field, value) {
            if (field === 'quantity') {
                value = parseInt(value) || 1;
            }
            currentEvent.gift_config.items[index][field] = value;
        }

        function removeGiftItem(index) {
            currentEvent.gift_config.items.splice(index, 1);
            loadGiftItems();
        }

        async function saveGiftSettings() {
            try {
                const type = document.getElementById('gift-system-type').value;
                let giftConfig = null;
                
                if (type === 'bank') {
                    giftConfig = {
                        type: 'bank',
                        message: document.getElementById('bank-message').value,
                        iban: document.getElementById('bank-iban').value,
                        holder: document.getElementById('bank-holder').value
                    };
                } else if (type === 'list') {
                    giftConfig = currentEvent.gift_config;
                }
                
                const { data, error } = await supabaseClient
                    .from('events')
                    .update({
                        enable_gifts: type !== 'none',
                        gift_config: giftConfig
                    })
                    .eq('id', currentEvent.id)
                    .select();
                
                if (error) {
                    alert('Erro ao salvar configura√ß√µes de presentes: ' + error.message);
                    return;
                }
                
                currentEvent = data[0];
                alert('Configura√ß√µes de presentes salvas com sucesso!');
            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            }
        }

        // Guest gift functions
        function copyIban() {
            const input = document.getElementById('display-iban');
            input.select();
            input.setSelectionRange(0, 99999);
            document.execCommand('copy');
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Copiado!';
            button.classList.add('bg-green-600');
            button.classList.remove('bg-purple-600');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-600');
                button.classList.add('bg-purple-600');
            }, 2000);
        }

        function skipGifts() {
            document.getElementById('gift-section').style.display = 'none';
            document.getElementById('success-message').classList.remove('hidden');
            addEditButton();
        }

        function confirmGiftChoice() {
            document.getElementById('gift-section').style.display = 'none';
            document.getElementById('success-message').classList.remove('hidden');
            addEditButton();
        }

        async function selectGift(itemName) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const eventUrl = urlParams.get('event');
                
                // Get event data
                const { data: event, error: eventError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('custom_url', eventUrl)
                    .single();
                
                if (eventError) {
                    alert('Erro ao carregar evento');
                    return;
                }
                
                // Save gift selection to database
                const { data, error } = await supabaseClient
                    .from('gift_selections')
                    .insert([{
                        event_id: event.id,
                        guest_name: document.getElementById('guest-name').value,
                        gift_name: itemName,
                        selection_type: 'list'
                    }]);
                
                if (error) {
                    console.error('Erro ao salvar sele√ß√£o:', error);
                }
                
                document.getElementById('gift-section').style.display = 'none';
                document.getElementById('success-message').classList.remove('hidden');
                addEditButton();
                
            } catch (err) {
                alert('Erro ao selecionar presente: ' + err.message);
            }
        }

        async function confirmGiftChoice() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const eventUrl = urlParams.get('event');
                
                // Get event data
                const { data: event, error: eventError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('custom_url', eventUrl)
                    .single();
                
                if (eventError) {
                    alert('Erro ao carregar evento');
                    return;
                }
                
                // Save bank transfer selection
                const { data, error } = await supabaseClient
                    .from('gift_selections')
                    .insert([{
                        event_id: event.id,
                        guest_name: document.getElementById('guest-name').value,
                        gift_name: 'Transfer√™ncia Banc√°ria',
                        selection_type: 'bank'
                    }]);
                
                if (error) {
                    console.error('Erro ao salvar sele√ß√£o:', error);
                }
                
                document.getElementById('gift-section').style.display = 'none';
                document.getElementById('success-message').classList.remove('hidden');
                
            } catch (err) {
                alert('Erro ao confirmar presente: ' + err.message);
            }
        }

        async function loadGiftStatistics() {
            try {
                const { data: selections, error } = await supabaseClient
                    .from('gift_selections')
                    .select('*')
                    .eq('event_id', currentEvent.id);
                
                if (error) {
                    console.error('Erro ao carregar estat√≠sticas:', error);
                    return;
                }
                
                const giftConfig = currentEvent.gift_config;
                let totalAvailable = 0;
                let totalChosen = selections.length;
                
                if (giftConfig && giftConfig.type === 'list') {
                    totalAvailable = giftConfig.items.reduce((sum, item) => sum + item.quantity, 0);
                    
                    // Load detailed gift choices
                    const container = document.getElementById('gift-choices-list');
                    container.innerHTML = '';
                    
                    // Group selections by gift name
                    const selectionsByGift = {};
                    selections.forEach(selection => {
                        if (!selectionsByGift[selection.gift_name]) {
                            selectionsByGift[selection.gift_name] = [];
                        }
                        selectionsByGift[selection.gift_name].push(selection);
                    });
                    
                    // Show each gift item with selections
                    giftConfig.items.forEach(item => {
                        const selectedCount = selectionsByGift[item.name] ? selectionsByGift[item.name].length : 0;
                        const remaining = item.quantity - selectedCount;
                        
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-2 border rounded-lg';
                        div.innerHTML = `
                            <div>
                                <p class="font-semibold text-sm">${item.name}</p>
                                <p class="text-xs text-gray-600">${selectedCount} escolhido(s) de ${item.quantity}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded ${remaining > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${remaining} restante(s)
                            </span>
                        `;
                        container.appendChild(div);
                    });
                } else if (giftConfig && giftConfig.type === 'bank') {
                    totalAvailable = '‚àû';
                    
                    const container = document.getElementById('gift-choices-list');
                    container.innerHTML = `
                        <div class="p-3 border rounded-lg">
                            <p class="font-semibold text-sm">Transfer√™ncias Banc√°rias</p>
                            <p class="text-xs text-gray-600">${totalChosen} pessoa(s) escolheram esta op√ß√£o</p>
                        </div>
                    `;
                }
                
                document.getElementById('gifts-chosen').textContent = totalChosen;
                document.getElementById('gifts-available').textContent = totalAvailable === '‚àû' ? '‚àû' : (totalAvailable - totalChosen);
                
            } catch (err) {
                console.error('Erro ao carregar estat√≠sticas:', err);
            }
        }

        async function showGiftSection(giftConfig, eventId) {
            document.getElementById('gift-section').classList.remove('hidden');
            
            if (giftConfig.type === 'bank') {
                document.getElementById('bank-gift-option').classList.remove('hidden');
                document.getElementById('list-gift-option').classList.add('hidden');
                document.getElementById('bank-gift-message').textContent = giftConfig.message;
                document.getElementById('display-iban').value = giftConfig.iban;
            } else if (giftConfig.type === 'list') {
                document.getElementById('list-gift-option').classList.remove('hidden');
                document.getElementById('bank-gift-option').classList.add('hidden');
                
                // Get current gift selections to check availability
                const { data: selections, error } = await supabaseClient
                    .from('gift_selections')
                    .select('*')
                    .eq('event_id', eventId);
                
                const selectionsByGift = {};
                if (selections) {
                    selections.forEach(selection => {
                        if (!selectionsByGift[selection.gift_name]) {
                            selectionsByGift[selection.gift_name] = 0;
                        }
                        selectionsByGift[selection.gift_name]++;
                    });
                }
                
                const container = document.getElementById('available-gifts');
                container.innerHTML = '';
                
                giftConfig.items.forEach(item => {
                    const selectedCount = selectionsByGift[item.name] || 0;
                    const remaining = item.quantity - selectedCount;
                    
                    if (remaining > 0) {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 border rounded-lg';
                        div.innerHTML = `
                            <div>
                                <span class="text-sm font-medium">${item.name}</span>
                                <p class="text-xs text-gray-600">${remaining} dispon√≠vel(is)</p>
                            </div>
                            <button onclick="selectGift('${item.name}')" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700">Escolher</button>
                        `;
                        container.appendChild(div);
                    } else {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 border rounded-lg opacity-50';
                        div.innerHTML = `
                            <div>
                                <span class="text-sm font-medium">${item.name}</span>
                                <p class="text-xs text-gray-600">Esgotado</p>
                            </div>
                            <button disabled class="bg-gray-400 text-white px-3 py-1 rounded text-sm cursor-not-allowed">Indispon√≠vel</button>
                        `;
                        container.appendChild(div);
                    }
                });
                
                // If no gifts available, show message
                if (container.children.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-4 text-gray-600">
                            <p class="text-sm">Todos os presentes j√° foram escolhidos.</p>
                            <p class="text-xs mt-1">Obrigado pelo interesse!</p>
                        </div>
                    `;
                }
            }
        }

        // RSVP form handler
        document.getElementById('rsvp-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const urlParams = new URLSearchParams(window.location.search);
            const eventUrl = urlParams.get('event');
            
            if (!eventUrl) {
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center px-4">
                        <div class="bg-white rounded-lg p-6 text-center max-w-md">
                            <div class="text-4xl mb-4">‚ùå</div>
                            <h2 class="text-xl font-bold mb-2">Link Inv√°lido</h2>
                            <p class="text-gray-600">Este link n√£o √© v√°lido.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            try {
                // Get event by custom_url
                const { data: event, error: eventError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('custom_url', eventUrl)
                    .single();
                
                if (eventError || !event) {
                    document.body.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center px-4">
                            <div class="bg-white rounded-lg p-6 text-center max-w-md">
                                <div class="text-4xl mb-4">‚ùå</div>
                                <h2 class="text-xl font-bold mb-2">Evento n√£o encontrado</h2>
                                <p class="text-gray-600">Este evento n√£o existe ou foi removido.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Collect companion names
                const companionInputs = document.querySelectorAll('#companion-inputs input');
                const companions = Array.from(companionInputs)
                    .map(input => input.value.trim())
                    .filter(name => name.length > 0);

                const guestName = document.getElementById('guest-name').value;
                const rsvpData = {
                    wedding_id: event.id,
                    guest_name: guestName,
                    companion_name: companions.length > 0 ? companions.join(', ') : null,
                    attendance: document.getElementById('attendance-status').value === 'true',
                    message: document.getElementById('guest-message').value || null
                };
                
                // Check if this guest already has an RSVP
                const { data: existingRsvp, error: checkError } = await supabaseClient
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', event.id)
                    .eq('guest_name', guestName)
                    .single();
                
                let result;
                if (existingRsvp) {
                    // Update existing RSVP
                    result = await supabaseClient
                        .from('rsvps')
                        .update(rsvpData)
                        .eq('id', existingRsvp.id);
                } else {
                    // Insert new RSVP
                    result = await supabaseClient
                        .from('rsvps')
                        .insert([rsvpData]);
                }
                
                if (result.error) {
                    document.body.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center px-4">
                            <div class="bg-white rounded-lg p-6 text-center max-w-md">
                                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                                <h2 class="text-xl font-bold mb-2">Erro ao Enviar</h2>
                                <p class="text-gray-600">N√£o foi poss√≠vel enviar sua confirma√ß√£o. Tente novamente.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Save to localStorage for persistence
                localStorage.setItem(`rsvp_${eventUrl}`, JSON.stringify(rsvpData));
                
                // Log RSVP for admin panel statistics
                await logAdminActivity('rsvp_submitted', {
                    event_id: event.id,
                    guest_name: rsvpData.guest_name,
                    attendance: rsvpData.attendance,
                    has_companion: !!rsvpData.companion_name,
                    companion_count: rsvpData.companion_name ? rsvpData.companion_name.split(', ').length : 0,
                    timestamp: new Date().toISOString()
                });
                await updateSystemStats('rsvp_submission', event.id, null);
                
                // Check if gifts are enabled and show gift section
                if (event.enable_gifts && event.gift_config && rsvpData.attendance) {
                    document.getElementById('rsvp-form').parentElement.style.display = 'none';
                    document.getElementById('countdown-timer').style.display = 'none';
                    await showGiftSection(event.gift_config, event.id);
                } else {
                    // Show success message directly
                    document.getElementById('rsvp-form').parentElement.style.display = 'none';
                    document.getElementById('countdown-timer').style.display = 'none';
                    document.getElementById('success-message').classList.remove('hidden');
                    
                    // Add edit button to success message
                    addEditButton();
                }
                
            } catch (err) {
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center px-4">
                        <div class="bg-white rounded-lg p-6 text-center max-w-md">
                            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                            <h2 class="text-xl font-bold mb-2">Erro de Conex√£o</h2>
                            <p class="text-gray-600">Verifique sua conex√£o e tente novamente.</p>
                        </div>
                    </div>
                `;
            }
        });

        // Handle attendance status change
        document.getElementById('attendance-status').addEventListener('change', function() {
            const companionSection = document.getElementById('companion-section');
            const urlParams = new URLSearchParams(window.location.search);
            const allowCompanion = urlParams.get('companion') === 'true';
            
            if (this.value === 'true' && allowCompanion) {
                companionSection.classList.remove('hidden');
                // Only generate inputs if container is empty (not editing)
                if (document.getElementById('companion-inputs').children.length === 0) {
                    generateCompanionInputs();
                }
            } else {
                companionSection.classList.add('hidden');
                document.getElementById('companion-inputs').innerHTML = '';
            }
        });

        let companionCount = 0;

        function generateCompanionInputs() {
            const container = document.getElementById('companion-inputs');
            
            // Add button to add companions
            if (container.children.length === 0) {
                const addButton = document.createElement('div');
                addButton.className = 'mb-3';
                addButton.innerHTML = `
                    <button type="button" onclick="addCompanionInput()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">
                        + Adicionar Acompanhante
                    </button>
                `;
                container.appendChild(addButton);
            }
        }

        function addCompanionInput() {
            const container = document.getElementById('companion-inputs');
            const companionLimit = window.currentEventData?.companion_limit || 1;
            
            // Count current companion inputs (excluding the add button)
            const currentInputs = container.querySelectorAll('input').length;
            
            if (currentInputs >= companionLimit) {
                alert(`Limite m√°ximo de ${companionLimit} acompanhante(s) atingido.`);
                return;
            }
            
            companionCount++;
            const div = document.createElement('div');
            div.className = 'mb-2 flex items-center space-x-2';
            div.id = `companion-${companionCount}`;
            div.innerHTML = `
                <input type="text" 
                       name="companion-${companionCount}" 
                       class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-purple-500 text-sm" 
                       placeholder="Nome do acompanhante">
                <button type="button" onclick="removeCompanionInput(${companionCount})" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm">
                    √ó
                </button>
            `;
            
            // Insert before the add button
            const addButton = container.querySelector('div');
            container.insertBefore(div, addButton);
        }

        function removeCompanionInput(id) {
            const element = document.getElementById(`companion-${id}`);
            if (element) {
                element.remove();
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            currentEvent = null;
            isAdmin = false;
            
            // Clear session data
            clearUserSession();
            
            // Reset event details view
            document.getElementById('user-events-list').style.display = 'block';
            document.getElementById('event-details').classList.add('hidden');
            
            showSection('home');
        }

        // Countdown timer function
        function startCountdown(deadline) {
            const countdownTimer = document.getElementById('countdown-timer');
            const daysEl = document.getElementById('days');
            const hoursEl = document.getElementById('hours');
            const minutesEl = document.getElementById('minutes');
            const secondsEl = document.getElementById('seconds');
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = new Date(deadline).getTime() - now;
                
                if (distance < 0) {
                    countdownTimer.innerHTML = '<p class="text-red-600 font-semibold">Prazo para confirma√ß√£o expirado</p>';
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                daysEl.textContent = days.toString().padStart(2, '0');
                hoursEl.textContent = hours.toString().padStart(2, '0');
                minutesEl.textContent = minutes.toString().padStart(2, '0');
                secondsEl.textContent = seconds.toString().padStart(2, '0');
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
            countdownTimer.classList.remove('hidden');
        }

        // Functions for editing responses
        function addEditButton() {
            const successMessage = document.getElementById('success-message');
            if (!successMessage.querySelector('.edit-button')) {
                const editButton = document.createElement('button');
                editButton.className = 'edit-button mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors';
                editButton.textContent = 'Editar Resposta';
                editButton.onclick = editResponse;
                successMessage.appendChild(editButton);
            }
        }

        function editResponse() {
            // Hide success message and show form again
            document.getElementById('success-message').classList.add('hidden');
            document.getElementById('rsvp-form').parentElement.style.display = 'block';
            document.getElementById('countdown-timer').style.display = 'block';
            
            // Load existing data
            loadExistingRsvp();
        }

        async function loadExistingRsvp() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventUrl = urlParams.get('event');
            
            // Try to load from localStorage first
            const savedData = localStorage.getItem(`rsvp_${eventUrl}`);
            if (savedData) {
                const rsvpData = JSON.parse(savedData);
                populateForm(rsvpData);
                return;
            }
            
            // If not in localStorage, try to load from database
            try {
                const { data: event, error: eventError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('custom_url', eventUrl)
                    .single();
                
                if (eventError || !event) return;
                
                // Get existing RSVP by guest name (we'll need to ask for name first)
                const guestName = prompt('Digite seu nome para carregar sua resposta anterior:');
                if (!guestName) return;
                
                const { data: rsvp, error: rsvpError } = await supabaseClient
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', event.id)
                    .eq('guest_name', guestName)
                    .single();
                
                if (rsvp) {
                    populateForm(rsvp);
                    // Save to localStorage for future use
                    localStorage.setItem(`rsvp_${eventUrl}`, JSON.stringify(rsvp));
                }
            } catch (err) {
                console.error('Erro ao carregar RSVP:', err);
            }
        }

        function populateForm(rsvpData) {
            // Fill basic fields
            document.getElementById('guest-name').value = rsvpData.guest_name || '';
            document.getElementById('attendance-status').value = rsvpData.attendance ? 'true' : 'false';
            document.getElementById('guest-message').value = rsvpData.message || '';
            
            // Trigger attendance change to show/hide companion section
            document.getElementById('attendance-status').dispatchEvent(new Event('change'));
            
            // Fill companion data if exists
            if (rsvpData.companion_name && rsvpData.attendance) {
                const companions = rsvpData.companion_name.split(', ').filter(name => name.trim());
                const container = document.getElementById('companion-inputs');
                
                // Clear existing inputs
                container.innerHTML = '';
                
                // Add the "Add Companion" button first
                generateCompanionInputs();
                
                // Add companion inputs with data
                companions.forEach((companionName, index) => {
                    addCompanionInput();
                    // Find the last added input and set its value
                    const inputs = container.querySelectorAll('input');
                    if (inputs[inputs.length - 1]) {
                        inputs[inputs.length - 1].value = companionName;
                    }
                });
            }
        }

        // Session persistence functions
        function saveUserSession(user) {
            localStorage.setItem('current_user', JSON.stringify(user));
            localStorage.setItem('session_timestamp', Date.now().toString());
        }

        function loadUserSession() {
            const userData = localStorage.getItem('current_user');
            const timestamp = localStorage.getItem('session_timestamp');
            
            if (!userData || !timestamp) return null;
            
            // Check if session is still valid (24 hours)
            const sessionAge = Date.now() - parseInt(timestamp);
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours
            
            if (sessionAge > maxAge) {
                clearUserSession();
                return null;
            }
            
            return JSON.parse(userData);
        }

        function clearUserSession() {
            localStorage.removeItem('current_user');
            localStorage.removeItem('session_timestamp');
        }

        // Check for pending token session
        function checkPendingTokenSession() {
            const pendingUsername = localStorage.getItem('pending_username');
            const pendingUserId = localStorage.getItem('pending_user_id');
            
            if (pendingUsername && pendingUserId) {
                document.getElementById('pending-username').textContent = pendingUsername;
                showTokenSection();
                return true;
            }
            return false;
        }

        // Check for RSVP link on page load
        window.addEventListener('load', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventUrl = urlParams.get('event');
            
            // Check for existing user session first
            if (!eventUrl) {
                const savedUser = loadUserSession();
                if (savedUser && savedUser.is_active) {
                    currentUser = savedUser;
                    loadUserDashboard();
                    return;
                }
                
                // Check for pending token session
                if (checkPendingTokenSession()) {
                    return;
                }
            }
            
            if (eventUrl) {
                // Hide all navigation and main site elements for guest pages
                document.querySelector('nav').style.display = 'none';
                document.querySelector('.mobile-nav').style.display = 'none';
                document.querySelector('footer').style.display = 'none';
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                
                try {
                    const { data: event, error } = await supabaseClient
                        .from('events')
                        .select('*')
                        .eq('custom_url', eventUrl)
                        .single();
                    
                    if (error || !event) {
                        document.body.innerHTML = `
                            <div class="min-h-screen flex items-center justify-center px-4">
                                <div class="bg-white rounded-lg p-6 text-center max-w-md">
                                    <div class="text-4xl mb-4">‚ùå</div>
                                    <h2 class="text-xl font-bold mb-2">Evento n√£o encontrado</h2>
                                    <p class="text-gray-600">O link que voc√™ acessou n√£o √© v√°lido ou o evento n√£o existe mais.</p>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    document.getElementById('rsvp-event-title').textContent = event.title;
                    document.getElementById('rsvp-event-date').textContent = new Date(event.event_date).toLocaleDateString('pt-BR');
                    
                    if (event.enable_description && event.description) {
                        document.getElementById('rsvp-event-description').textContent = event.description;
                    } else {
                        document.getElementById('rsvp-event-description').style.display = 'none';
                    }
                    
                    // Store event data globally for companion limit access
                    window.currentEventData = event;
                    
                    // Start countdown if deadline is set
                    if (event.enable_deadline && event.confirmation_deadline) {
                        startCountdown(event.confirmation_deadline);
                    }
                    
                    showSection('guest-rsvp');
                    
                    // Check if there's existing RSVP data and show appropriate view
                    const savedData = localStorage.getItem(`rsvp_${eventUrl}`);
                    if (savedData) {
                        const rsvpData = JSON.parse(savedData);
                        
                        // Show success message with edit option
                        document.getElementById('rsvp-form').parentElement.style.display = 'none';
                        document.getElementById('countdown-timer').style.display = 'none';
                        document.getElementById('success-message').classList.remove('hidden');
                        
                        // Update success message text
                        const successMessage = document.getElementById('success-message');
                        successMessage.querySelector('h3').textContent = 'Resposta J√° Enviada!';
                        successMessage.querySelector('p').textContent = `Ol√° ${rsvpData.guest_name}! Sua resposta j√° foi registrada. Voc√™ pode edit√°-la se necess√°rio.`;
                        
                        addEditButton();
                    }
                    
                } catch (err) {
                    document.body.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center px-4">
                            <div class="bg-white rounded-lg p-6 text-center max-w-md">
                                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                                <h2 class="text-xl font-bold mb-2">Erro de Conex√£o</h2>
                                <p class="text-gray-600">N√£o foi poss√≠vel carregar o evento. Tente novamente mais tarde.</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                loadSiteContent();
            }
        });

        // Initialize
        loadSiteContent();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972c08e2a50077e0',t:'MTc1NTc5OTI3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
