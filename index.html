<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesAO - Sistema de Confirmação de Presença</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        body.guest-mode {
            background: white;
        }

        body.version-noiva {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
        }

        body.version-noiva .btn-primary {
            background: linear-gradient(135deg, #ff9a9e 0%, #f093fb 100%);
        }

        body.version-noiva .stats-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #f093fb 100%);
        }

        body.version-noiva .logo h1 {
            color: #ff6b9d;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 1.6em;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .event-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .event-cover {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .event-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .countdown {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 300px;
            margin: 0 auto;
        }

        .countdown-item {
            background: white;
            border: 1px solid #dee2e6;
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .countdown-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
            line-height: 1;
        }

        .countdown-label {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .response-section {
            text-align: center;
            margin: 30px 0;
        }

        .response-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .response-btn {
            padding: 15px 30px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .response-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .response-btn:hover {
            border-color: #667eea;
        }

        .guest-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .response-status {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .response-status.negative {
            background: #ffeaea;
            border-color: #f44336;
        }

        .top-nav {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .back-nav {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stats-number {
            font-size: 3em;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            display: block;
        }

        .stats-label {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 500;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 15px 0;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
        }

        .companions-section {
            margin-top: 15px;
        }

        .companion-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .companion-item input {
            flex: 1;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 14px;
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .admin-container {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .response-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .response-btn {
                padding: 12px 20px;
            }
            
            .top-nav {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
                justify-content: center;
            }
            
            .back-nav {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
            }
            
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Guest Event View -->
        <div id="guestView" class="container">
            <div class="top-nav" id="topNav">
                <button class="btn btn-primary btn-small" onclick="showLogin()" id="loginBtn">Login</button>
                <button class="btn btn-secondary btn-small hidden" onclick="goToProfile()" id="profileBtn">Perfil</button>
                <button class="btn btn-secondary btn-small hidden" onclick="logout()" id="logoutBtn">Sair</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="guestContent">
                    <div style="text-align: center; padding: 40px;">
                        <h2>🎉 Bem-vindo ao InvitesAO</h2>
                        <p style="margin: 20px 0; color: #666;">Sistema de confirmação de presença para seus eventos especiais.</p>
                        <button class="btn btn-primary" onclick="showLogin()">Fazer Login</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginView" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="backToMain()">← Voltar</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="loginNotification"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Nome de Usuário</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 20px;">
                        <input type="checkbox" id="rememberLogin">
                        <label for="rememberLogin">Lembrar dados</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
                <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerView" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="backToMain()">← Voltar</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="registerNotification"></div>
                <form id="registerForm">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>Nome de Usuário</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="registerPhone" placeholder="922131116" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Criar Conta</button>
                </form>
                <button class="btn btn-secondary" onclick="showLogin()">Já tenho conta</button>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- User Dashboard -->
        <div id="userDashboard" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="logout()">← Sair</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>Meus Eventos</h1>
                </div>
                <div id="userNotification"></div>
                <button class="btn btn-primary" onclick="showCreateEvent()">Criar Novo Evento</button>
                <div id="userEvents"></div>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Create/Edit Event -->
        <div id="createEventView" class="container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="showUserDashboard()">← Voltar</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1 id="eventFormTitle">Criar Evento</h1>
                </div>
                <div id="eventNotification"></div>
                <form id="eventForm">
                    <div class="form-group">
                        <label>Nome do Evento</label>
                        <input type="text" id="eventName" required>
                    </div>
                    <div class="form-group">
                        <label>Data do Evento</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label>Data Limite para Confirmação</label>
                        <input type="date" id="eventDeadline" required>
                    </div>
                    <div class="form-group">
                        <label>Limite de Confirmações (0 = sem limite)</label>
                        <input type="number" id="eventLimit" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label>Máximo de Acompanhantes por Convidado</label>
                        <input type="number" id="maxCompanions" min="0" max="20" value="5">
                    </div>
                    <div class="form-group">
                        <label>Descrição</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Versão do Site</label>
                        <select id="siteVersion">
                            <option value="noivos">🤵 Versão dos Noivos (Azul/Roxo)</option>
                            <option value="noiva">💐 Versão da Noiva (Rosa)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Evento</button>
                </form>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="admin-container hidden">
            <div class="back-nav">
                <button class="btn btn-secondary btn-small" onclick="logout()">← Sair</button>
            </div>
            <div class="admin-header">
                <h1>🔧 Painel Administrativo</h1>
            </div>
            <div id="adminNotification"></div>
            
            <div class="admin-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalUsers">0</div>
                    <div class="stats-label">👥 Usuários Totais</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="pendingUsers">0</div>
                    <div class="stats-label">⏳ Aguardando Aprovação</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalEvents">0</div>
                    <div class="stats-label">🎉 Eventos Criados</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalResponses">0</div>
                    <div class="stats-label">📝 Confirmações</div>
                </div>
            </div>

            <div class="card">
                <h3>⏳ Solicitações Pendentes</h3>
                <div id="pendingRequests"></div>
            </div>

            <div class="card">
                <h3>👥 Gerenciar Usuários</h3>
                <div id="userManagement"></div>
            </div>

            <div class="card">
                <h3>🎉 Todos os Eventos</h3>
                <div id="allEvents"></div>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="passwordModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>🔐 Confirmação de Segurança</h3>
                <p id="modalMessage">Para continuar, digite sua senha:</p>
                <div class="form-group">
                    <label>Sua Senha</label>
                    <input type="password" id="modalPassword">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="confirmPasswordAction()">Confirmar</button>
                    <button class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://jqdrxvnnbkeepdnrzndv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxZHJ4dm5uYmtlZXBkbnJ6bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDk5NTAsImV4cCI6MjA3MTU4NTk1MH0.k0sGvCvzZra3up5RTlJqFDu8FleeYvBr8EGqf5q-G3Q';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global Variables
        let currentUser = null;
        let currentEvent = null;
        let editingEventId = null;
        let currentAttending = null;
        let pendingAction = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSavedLogin();
            await loadEventFromUrl();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
        }

        // Check Saved Login
        async function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            const savedCredentials = localStorage.getItem('savedCredentials');
            
            if (savedCredentials) {
                try {
                    const credentials = JSON.parse(savedCredentials);
                    document.getElementById('loginUsername').value = credentials.username || '';
                    document.getElementById('loginPassword').value = credentials.password || '';
                    document.getElementById('rememberLogin').checked = true;
                } catch (error) {
                    localStorage.removeItem('savedCredentials');
                }
            }
            
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (user.isAdmin) {
                        currentUser = user;
                        return;
                    }
                    
                    const { data: dbUser } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (dbUser && dbUser.approved && dbUser.active) {
                        currentUser = dbUser;
                        localStorage.setItem('currentUser', JSON.stringify(dbUser));
                    } else {
                        localStorage.removeItem('currentUser');
                    }
                } catch (error) {
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // Load Event from URL
        async function loadEventFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');
            const version = urlParams.get('version');
            
            if (version === 'noiva') {
                document.body.classList.add('version-noiva');
            }
            
            if (eventId) {
                document.body.classList.add('guest-mode');
                await loadGuestEvent(eventId);
            } else {
                updateTopNav();
            }
        }

        // Load Guest Event
        async function loadGuestEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                if (event.active === false) {
                    document.getElementById('guestContent').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2>⚠️ Evento Inativo</h2>
                            <p style="color: #666;">Este evento foi temporariamente desativado.</p>
                        </div>
                    `;
                    return;
                }

                currentEvent = event;
                
                if (event.site_version === 'noiva') {
                    document.body.classList.add('version-noiva');
                }
                
                await renderGuestEvent(event);
                updateTopNav();
            } catch (error) {
                document.getElementById('guestContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>❌ Evento não encontrado</h2>
                        <p style="color: #666;">O link pode estar incorreto ou o evento foi removido.</p>
                    </div>
                `;
            }
        }

        // Render Guest Event
        async function renderGuestEvent(event) {
            const now = new Date();
            const eventDate = new Date(event.event_date);
            const deadline = new Date(event.deadline);
            
            let coverHtml = '';
            if (event.cover_enabled && event.cover_url) {
                const posX = event.cover_position_x || 50;
                const posY = event.cover_position_y || 50;
                coverHtml = `
                    <div class="event-cover">
                        <img src="${event.cover_url}" alt="Capa do evento" style="object-position: ${posX}% ${posY}%;">
                    </div>
                `;
            }

            const guestResponse = await getGuestResponse(event.id);
            let responseSection = '';

            if (guestResponse) {
                const statusClass = guestResponse.attending ? '' : 'negative';
                const statusText = guestResponse.attending ? '✅ Presença confirmada!' : '❌ Você informou que não comparecerá';
                
                let companionInfo = '';
                if (guestResponse.attending && guestResponse.companions > 0) {
                    companionInfo = `<p><strong>Acompanhantes:</strong> ${guestResponse.companions}</p>`;
                    if (guestResponse.companion_names && guestResponse.companion_names.length > 0) {
                        companionInfo += `<p><strong>Nomes:</strong> ${guestResponse.companion_names.join(', ')}</p>`;
                    }
                }
                
                responseSection = `
                    <div class="response-status ${statusClass}">
                        <h3>${statusText}</h3>
                        <p><strong>Nome:</strong> ${guestResponse.guest_name}</p>
                        ${companionInfo}
                        <p style="margin-top: 15px;">Obrigado pela confirmação!</p>
                    </div>
                `;
            } else if (now <= deadline) {
                responseSection = `
                    <div class="guest-form">
                        <div class="response-section">
                            <h3>Confirma Presença?</h3>
                            <p style="margin-bottom: 20px;">Favor confirmar até ${formatDate(deadline)}</p>
                            <div class="response-buttons">
                                <button class="response-btn" onclick="selectAttendance(true)">SIM</button>
                                <button class="response-btn" onclick="selectAttendance(false)">NÃO</button>
                            </div>
                        </div>
                        <div id="guestDetailsForm" class="hidden">
                            <div class="form-group">
                                <label>Você é convidado(a) do(a):</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="guestType" value="noivo">
                                        <span>Noivo</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="guestType" value="noiva">
                                        <span>Noiva</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Seu nome completo</label>
                                <input type="text" id="guestName" required>
                            </div>
                            <div id="companionsSection" class="companions-section hidden">
                                <div class="form-group">
                                    <label>Acompanhantes</label>
                                    <div id="companionsList"></div>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="addCompanion()">+ Adicionar Acompanhante</button>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="submitResponse()">Confirmar</button>
                        </div>
                    </div>
                `;
            } else {
                responseSection = `
                    <div class="notification error">
                        <h3>Prazo Expirado</h3>
                        <p>O prazo para confirmação de presença já expirou.</p>
                    </div>
                `;
            }

            document.getElementById('guestContent').innerHTML = `
                ${coverHtml}
                <h2 style="text-align: center; margin-bottom: 20px;">${event.name}</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <strong>Data: ${formatDate(eventDate)}</strong>
                </div>
                ${event.description ? `<p style="margin-bottom: 20px; text-align: center; color: #666;">${event.description}</p>` : ''}
                
                <div class="countdown" id="countdown"></div>
                
                ${responseSection}
            `;

            startCountdown(eventDate);
        }

        // Start Countdown
        function startCountdown(eventDate) {
            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) return;

            function updateCountdown() {
                const now = new Date().getTime();
                const eventTime = eventDate.getTime();
                const distance = eventTime - now;

                if (distance < 0) {
                    countdownElement.innerHTML = '<h3>🎉 O evento já começou!</h3>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `
                    <div class="countdown-grid">
                        <div class="countdown-item">
                            <span class="countdown-number">${days}</span>
                            <span class="countdown-label">dias</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${hours}</span>
                            <span class="countdown-label">horas</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${minutes}</span>
                            <span class="countdown-label">min</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${seconds}</span>
                            <span class="countdown-label">seg</span>
                        </div>
                    </div>
                `;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // Select Attendance
        function selectAttendance(attending) {
            currentAttending = attending;
            
            // Update button styles
            document.querySelectorAll('.response-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            
            const detailsForm = document.getElementById('guestDetailsForm');
            const companionsSection = document.getElementById('companionsSection');
            
            detailsForm.classList.remove('hidden');
            
            if (attending && currentEvent.max_companions > 0) {
                companionsSection.classList.remove('hidden');
            } else {
                companionsSection.classList.add('hidden');
            }
        }

        // Add Companion
        function addCompanion() {
            const companionsList = document.getElementById('companionsList');
            const currentCompanions = companionsList.children.length;
            
            if (currentCompanions >= currentEvent.max_companions) {
                showNotification(`Máximo de ${currentEvent.max_companions} acompanhante(s) permitido.`, 'error');
                return;
            }
            
            const companionDiv = document.createElement('div');
            companionDiv.className = 'companion-item';
            companionDiv.innerHTML = `
                <input type="text" placeholder="Nome do acompanhante" class="companion-input">
                <button type="button" class="btn btn-small btn-danger" onclick="removeCompanion(this)">Remover</button>
            `;
            
            companionsList.appendChild(companionDiv);
        }

        // Remove Companion
        function removeCompanion(button) {
            button.parentElement.remove();
        }

        // Submit Response
        async function submitResponse() {
            const guestName = document.getElementById('guestName').value.trim();
            const guestTypeRadio = document.querySelector('input[name="guestType"]:checked');

            if (!guestName) {
                showNotification('Por favor, informe seu nome.', 'error');
                return;
            }

            if (!guestTypeRadio) {
                showNotification('Por favor, selecione se você é convidado do noivo ou da noiva.', 'error');
                return;
            }

            const guestType = guestTypeRadio.value;
            let companions = 0;
            let companionNames = [];

            if (currentAttending && currentEvent.max_companions > 0) {
                const companionInputs = document.querySelectorAll('.companion-input');
                companionInputs.forEach(input => {
                    if (input.value && input.value.trim()) {
                        companionNames.push(input.value.trim());
                    }
                });
                companions = companionNames.length;
            }

            try {
                const responseData = {
                    event_id: currentEvent.id,
                    guest_name: guestName,
                    guest_type: guestType,
                    attending: currentAttending,
                    companions: companions,
                    companion_names: companionNames,
                    created_at: new Date().toISOString()
                };

                const { data: existingResponse } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .eq('guest_name', guestName)
                    .single();

                if (existingResponse) {
                    const { error } = await supabase
                        .from('responses')
                        .update(responseData)
                        .eq('event_id', currentEvent.id)
                        .eq('guest_name', guestName);
                    
                    if (error) throw error;
                    showNotification('Resposta atualizada com sucesso!', 'success');
                } else {
                    const { error } = await supabase
                        .from('responses')
                        .insert([responseData]);
                    
                    if (error) throw error;
                    
                    const message = currentAttending 
                        ? 'Presença confirmada, obrigado!'
                        : 'Resposta enviada, obrigado!';
                    showNotification(message, 'success');
                }

                const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
                responses[currentEvent.id] = responseData;
                localStorage.setItem('eventResponses', JSON.stringify(responses));

                setTimeout(async () => {
                    await renderGuestEvent(currentEvent);
                }, 2000);
            } catch (error) {
                showNotification('Erro ao salvar resposta: ' + error.message, 'error');
            }
        }

        // Get Guest Response
        async function getGuestResponse(eventId) {
            const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
            const localResponse = responses[eventId];
            
            if (localResponse) {
                try {
                    const { data: dbResponse } = await supabase
                        .from('responses')
                        .select('*')
                        .eq('event_id', eventId)
                        .eq('guest_name', localResponse.guest_name)
                        .single();
                    
                    if (dbResponse) {
                        return localResponse;
                    } else {
                        delete responses[eventId];
                        localStorage.setItem('eventResponses', JSON.stringify(responses));
                        return null;
                    }
                } catch (error) {
                    delete responses[eventId];
                    localStorage.setItem('eventResponses', JSON.stringify(responses));
                    return null;
                }
            }
            
            return null;
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const rememberLogin = document.getElementById('rememberLogin').checked;

            if (rememberLogin) {
                localStorage.setItem('savedCredentials', JSON.stringify({
                    username: username,
                    password: password
                }));
            } else {
                localStorage.removeItem('savedCredentials');
            }

            if (username === 'Invites' && password === '#Invites2025@!!1995') {
                currentUser = { id: 'admin', username: 'Invites', isAdmin: true };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showAdminDashboard();
                return;
            }

            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error || !user) {
                    showNotification('Nome de usuário ou senha incorretos.', 'error', 'loginNotification');
                    return;
                }

                if (!user.approved) {
                    showNotification('Sua conta ainda não foi aprovada pelo administrador.', 'error', 'loginNotification');
                    return;
                }

                if (!user.active) {
                    showNotification('Sua conta foi desativada.', 'error', 'loginNotification');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                if (user.is_moderator) {
                    showAdminDashboard();
                } else {
                    showUserDashboard();
                }
            } catch (error) {
                showNotification('Erro ao fazer login: ' + error.message, 'error', 'loginNotification');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value.trim();

            try {
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (existingUser) {
                    showNotification('Nome de usuário já existe.', 'error', 'registerNotification');
                    return;
                }

                const { error } = await supabase
                    .from('users')
                    .insert([{
                        name,
                        username,
                        phone,
                        password,
                        approved: false,
                        active: true
                    }]);

                if (error) throw error;

                showNotification('Conta criada! Aguarde aprovação do administrador.', 'success', 'registerNotification');
                setTimeout(() => {
                    document.getElementById('registerForm').reset();
                    showLogin();
                }, 3000);
            } catch (error) {
                showNotification('Erro ao criar conta: ' + error.message, 'error', 'registerNotification');
            }
        }

        // User Dashboard Functions
        async function showUserDashboard() {
            hideAllViews();
            document.getElementById('userDashboard').classList.remove('hidden');
            await loadUserEvents();
        }

        async function loadUserEvents() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select(`
                        *,
                        responses(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const eventsHtml = events.map(event => {
                    const responseCount = event.responses?.length || 0;
                    const confirmedCount = event.responses?.filter(r => r.attending).length || 0;
                    const eventUrl = `${window.location.origin}${window.location.pathname}?event=${event.id}`;
                    const statusText = event.active !== false ? 'Ativo' : 'Inativo';
                    const statusClass = event.active !== false ? 'success' : 'danger';
                    
                    return `
                        <div class="event-card">
                            <h3>${event.name} <span class="btn btn-small btn-${statusClass}" style="font-size: 10px; padding: 2px 8px;">${statusText}</span></h3>
                            <p><strong>Data:</strong> ${formatDate(new Date(event.event_date))}</p>
                            <p><strong>Confirmações:</strong> ${confirmedCount}/${event.event_limit === 0 ? '∞' : event.event_limit}</p>
                            <p><strong>Total de respostas:</strong> ${responseCount}</p>
                            <div style="margin: 10px 0;">
                                <p><strong>Link:</strong></p>
                                <small><a href="${eventUrl}" target="_blank" style="word-break: break-all;">${eventUrl}</a></small>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-small btn-secondary" onclick="editEvent('${event.id}')">Editar</button>
                                <button class="btn btn-small btn-primary" onclick="viewResponses('${event.id}')">Respostas</button>
                                <button class="btn btn-small btn-success" onclick="downloadReport('${event.id}')">PDF</button>
                                <button class="btn btn-small ${event.active !== false ? 'btn-danger' : 'btn-success'}" onclick="toggleEventStatus('${event.id}', ${event.active === false})">${event.active !== false ? 'Desativar' : 'Ativar'}</button>
                                <button class="btn btn-small btn-danger" onclick="deleteEventWithPassword('${event.id}')">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('userEvents').innerHTML = eventsHtml || '<p>Nenhum evento criado ainda.</p>';
            } catch (error) {
                showNotification('Erro ao carregar eventos: ' + error.message, 'error', 'userNotification');
            }
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const eventDate = document.getElementById('eventDate').value;
            const deadlineDate = document.getElementById('eventDeadline').value;

            if (!eventDate || !deadlineDate) {
                showNotification('Datas são obrigatórias!', 'error', 'eventNotification');
                return;
            }

            const eventData = {
                name: document.getElementById('eventName').value,
                event_date: `${eventDate}T23:59:00`,
                deadline: `${deadlineDate}T23:59:00`,
                event_limit: parseInt(document.getElementById('eventLimit').value),
                max_companions: parseInt(document.getElementById('maxCompanions').value),
                description: document.getElementById('eventDescription').value,
                site_version: document.getElementById('siteVersion').value,
                user_id: currentUser.id
            };

            try {
                if (editingEventId) {
                    const { error } = await supabase
                        .from('events')
                        .update(eventData)
                        .eq('id', editingEventId);
                    
                    if (error) throw error;
                    showNotification('Evento atualizado!', 'success', 'eventNotification');
                } else {
                    const { error } = await supabase
                        .from('events')
                        .insert([eventData]);
                    
                    if (error) throw error;
                    showNotification('Evento criado!', 'success', 'eventNotification');
                }

                setTimeout(() => {
                    showUserDashboard();
                    editingEventId = null;
                }, 2000);
            } catch (error) {
                showNotification('Erro ao salvar evento: ' + error.message, 'error', 'eventNotification');
            }
        }

        async function editEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                editingEventId = eventId;
                document.getElementById('eventFormTitle').textContent = 'Editar Evento';
                document.getElementById('eventName').value = event.name;
                
                const eventDate = new Date(event.event_date);
                document.getElementById('eventDate').value = eventDate.toISOString().split('T')[0];

                const deadlineDate = new Date(event.deadline);
                document.getElementById('eventDeadline').value = deadlineDate.toISOString().split('T')[0];

                document.getElementById('eventLimit').value = event.event_limit;
                document.getElementById('maxCompanions').value = event.max_companions || 5;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('siteVersion').value = event.site_version || 'noivos';
                
                showCreateEvent();
            } catch (error) {
                showNotification('Erro ao carregar evento: ' + error.message, 'error', 'userNotification');
            }
        }

        async function toggleEventStatus(eventId, activate) {
            try {
                const { error } = await supabase
                    .from('events')
                    .update({ active: activate })
                    .eq('id', eventId);

                if (error) throw error;

                showNotification(`Evento ${activate ? 'ativado' : 'desativado'}!`, 'success', 'userNotification');
                await loadUserEvents();
            } catch (error) {
                showNotification('Erro ao alterar status: ' + error.message, 'error', 'userNotification');
            }
        }

        function deleteEventWithPassword(eventId) {
            showPasswordModal(
                'Para excluir este evento, digite sua senha:',
                async () => await deleteEvent(eventId)
            );
        }

        async function deleteEvent(eventId) {
            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                showNotification('Evento excluído!', 'success', 'userNotification');
                await loadUserEvents();
            } catch (error) {
                showNotification('Erro ao excluir: ' + error.message, 'error', 'userNotification');
            }
        }

        async function viewResponses(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);

                let html = `
                    <div class="card">
                        <h3>📊 ${event.name} - Respostas</h3>
                        <p><strong>Confirmados:</strong> ${attending.length} + ${totalCompanions} acompanhantes = ${attending.length + totalCompanions} total</p>
                        <p><strong>Não comparecerão:</strong> ${notAttending.length}</p>
                        
                        <h4 style="margin-top: 20px; color: #28a745;">✅ Confirmados</h4>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            ${attending.map(r => `
                                <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${r.guest_name}</strong>
                                        <span style="margin-left: 10px; padding: 2px 6px; border-radius: 10px; font-size: 10px; background: ${r.guest_type === 'noivo' ? '#667eea' : '#ff9a9e'}; color: white;">
                                            ${r.guest_type === 'noivo' ? '🤵' : '👰'}
                                        </span>
                                        ${r.companions > 0 ? `<br><small>+ ${r.companions} acompanhante(s)</small>` : ''}
                                        ${r.companion_names && r.companion_names.length > 0 ? `<br><small>Nomes: ${r.companion_names.join(', ')}</small>` : ''}
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="deleteResponseWithPassword('${eventId}', '${r.guest_name}')">🗑️</button>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center;">Nenhuma confirmação.</p>'}
                        </div>
                        
                        <h4 style="margin-top: 20px; color: #dc3545;">❌ Não Comparecerão</h4>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            ${notAttending.map(r => `
                                <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${r.guest_name}</strong>
                                        <span style="margin-left: 10px; padding: 2px 6px; border-radius: 10px; font-size: 10px; background: ${r.guest_type === 'noivo' ? '#667eea' : '#ff9a9e'}; color: white;">
                                            ${r.guest_type === 'noivo' ? '🤵' : '👰'}
                                        </span>
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="deleteResponseWithPassword('${eventId}', '${r.guest_name}')">🗑️</button>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center;">Nenhuma resposta negativa.</p>'}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success btn-small" onclick="downloadReport('${eventId}')">Baixar PDF</button>
                            <button class="btn btn-secondary btn-small" onclick="showUserDashboard()">Voltar</button>
                        </div>
                    </div>
                `;

                document.getElementById('userEvents').innerHTML = html;
            } catch (error) {
                showNotification('Erro ao carregar respostas: ' + error.message, 'error', 'userNotification');
            }
        }

        function deleteResponseWithPassword(eventId, guestName) {
            showPasswordModal(
                `Para eliminar a resposta de ${guestName}, digite sua senha:`,
                async () => await deleteResponse(eventId, guestName)
            );
        }

        async function deleteResponse(eventId, guestName) {
            try {
                const { error } = await supabase
                    .from('responses')
                    .delete()
                    .eq('event_id', eventId)
                    .eq('guest_name', guestName);

                if (error) throw error;

                const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
                if (responses[eventId] && responses[eventId].guest_name === guestName) {
                    delete responses[eventId];
                    localStorage.setItem('eventResponses', JSON.stringify(responses));
                }

                showNotification(`Resposta eliminada!`, 'success', 'userNotification');
                await viewResponses(eventId);
            } catch (error) {
                showNotification('Erro ao eliminar: ' + error.message, 'error', 'userNotification');
            }
        }

        async function downloadReport(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error: responsesError } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('guest_name', { ascending: true });

                if (responsesError) throw responsesError;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('RELATORIO DO EVENTO', 20, 30);

                // Event details
                doc.setFontSize(16);
                doc.text(event.name, 20, 50);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Data do Evento: ${formatDate(new Date(event.event_date))}`, 20, 70);
                doc.text(`Confirmados: ${attending.length} pessoas + ${totalCompanions} acompanhantes = ${attending.length + totalCompanions} total`, 20, 85);
                doc.text(`Nao comparecerao: ${notAttending.length} pessoas`, 20, 100);

                // Confirmed attendees
                let yPos = 120;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('CONFIRMADOS:', 20, yPos);

                yPos += 15;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                attending.forEach((response, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }

                    doc.text(`${index + 1}. ${response.guest_name}`, 20, yPos);
                    if (response.companions > 0) {
                        doc.text(`+ ${response.companions} acompanhante(s)`, 120, yPos);
                        if (response.companion_names && response.companion_names.length > 0) {
                            yPos += 10;
                            doc.text(`   Nomes: ${response.companion_names.join(', ')}`, 25, yPos);
                        }
                    }
                    yPos += 15;
                });

                // Not attending
                if (notAttending.length > 0) {
                    yPos += 20;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('NAO COMPARECERAO:', 20, yPos);

                    yPos += 15;
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');

                    notAttending.forEach((response, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 30;
                        }
                        doc.text(`${index + 1}. ${response.guest_name}`, 20, yPos);
                        yPos += 15;
                    });
                }

                doc.save(`${event.name}_relatorio.pdf`);
            } catch (error) {
                showNotification('Erro ao gerar PDF: ' + error.message, 'error', 'userNotification');
            }
        }

        // Admin Dashboard Functions
        async function showAdminDashboard() {
            hideAllViews();
            document.getElementById('adminDashboard').classList.remove('hidden');
            await loadAdminData();
        }

        async function loadAdminData() {
            try {
                const { data: users } = await supabase.from('users').select('*');
                const { data: events } = await supabase.from('events').select('*');
                const { data: responses } = await supabase.from('responses').select('*');

                const pendingUsers = users?.filter(u => !u.approved) || [];
                const approvedUsers = users?.filter(u => u.approved) || [];

                document.getElementById('totalUsers').textContent = users?.length || 0;
                document.getElementById('pendingUsers').textContent = pendingUsers.length;
                document.getElementById('totalEvents').textContent = events?.length || 0;
                document.getElementById('totalResponses').textContent = responses?.length || 0;

                // Pending requests
                const pendingHtml = pendingUsers.map(user => `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${user.name}</strong><br>
                            <small>@${user.username} • ${user.phone}</small>
                        </div>
                        <div>
                            <button class="btn btn-small btn-success" onclick="approveUser('${user.id}')">Aprovar</button>
                            <button class="btn btn-small btn-danger" onclick="rejectUser('${user.id}')">Rejeitar</button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('pendingRequests').innerHTML = pendingHtml || '<p>Nenhuma solicitação pendente.</p>';

                // User management
                const usersHtml = approvedUsers.map(user => `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${user.name}</strong><br>
                            <small>@${user.username} • ${user.phone}</small>
                            ${user.is_moderator ? '<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">MODERADOR</span>' : ''}
                        </div>
                        <div>
                            <button class="btn btn-small ${user.active ? 'btn-danger' : 'btn-success'}" onclick="toggleUserStatus('${user.id}', ${!user.active})">${user.active ? 'Desativar' : 'Ativar'}</button>
                            ${!user.is_moderator ? `<button class="btn btn-small btn-primary" onclick="toggleModerator('${user.id}', true)">Tornar Moderador</button>` : `<button class="btn btn-small btn-secondary" onclick="toggleModerator('${user.id}', false)">Remover Moderador</button>`}
                        </div>
                    </div>
                `).join('');

                document.getElementById('userManagement').innerHTML = usersHtml || '<p>Nenhum usuário aprovado.</p>';

                // All events
                const eventsHtml = events?.map(event => `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${event.name}</strong><br>
                        <small>Data: ${formatDate(new Date(event.event_date))} • Criado por: ${users?.find(u => u.id === event.user_id)?.name || 'Usuário removido'}</small><br>
                        <small>Status: ${event.active !== false ? 'Ativo' : 'Inativo'}</small>
                    </div>
                `).join('') || '<p>Nenhum evento criado.</p>';

                document.getElementById('allEvents').innerHTML = eventsHtml;
            } catch (error) {
                showNotification('Erro ao carregar dados: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ approved: true })
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usuário aprovado!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao aprovar: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function rejectUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usuário rejeitado!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao rejeitar: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function toggleUserStatus(userId, activate) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ active: activate })
                    .eq('id', userId);

                if (error) throw error;

                showNotification(`Usuário ${activate ? 'ativado' : 'desativado'}!`, 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao alterar status: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function toggleModerator(userId, makeModerator) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ is_moderator: makeModerator })
                    .eq('id', userId);

                if (error) throw error;

                showNotification(`${makeModerator ? 'Moderador adicionado' : 'Moderador removido'}!`, 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao alterar moderador: ' + error.message, 'error', 'adminNotification');
            }
        }

        // Password Modal Functions
        function showPasswordModal(message, action) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalPassword').value = '';
            document.getElementById('passwordModal').classList.remove('hidden');
            pendingAction = action;
            document.getElementById('modalPassword').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            pendingAction = null;
        }

        async function confirmPasswordAction() {
            const password = document.getElementById('modalPassword').value;
            
            if (!password) {
                showNotification('Digite sua senha.', 'error', 'adminNotification');
                return;
            }

            let isValidPassword = false;
            
            if (currentUser.isAdmin && password === '#Invites2025@!!1995') {
                isValidPassword = true;
            } else if (!currentUser.isAdmin) {
                try {
                    const { data: user } = await supabase
                        .from('users')
                        .select('password')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (user && user.password === password) {
                        isValidPassword = true;
                    }
                } catch (error) {
                    console.error('Error verifying password:', error);
                }
            }

            if (!isValidPassword) {
                showNotification('Senha incorreta.', 'error', 'adminNotification');
                return;
            }

            closePasswordModal();
            
            if (pendingAction) {
                await pendingAction();
                pendingAction = null;
            }
        }

        // Navigation Functions
        function hideAllViews() {
            document.querySelectorAll('#app > div').forEach(view => {
                view.classList.add('hidden');
            });
        }

        function showGuestView() {
            hideAllViews();
            document.getElementById('guestView').classList.remove('hidden');
        }

        function showLogin() {
            hideAllViews();
            document.getElementById('loginView').classList.remove('hidden');
        }

        function showRegister() {
            hideAllViews();
            document.getElementById('registerView').classList.remove('hidden');
        }

        function showCreateEvent() {
            hideAllViews();
            document.getElementById('createEventView').classList.remove('hidden');
            document.getElementById('eventFormTitle').textContent = editingEventId ? 'Editar Evento' : 'Criar Evento';
        }

        function backToMain() {
            if (currentEvent) {
                showGuestView();
            } else {
                showGuestView();
            }
        }

        function goToProfile() {
            if (currentUser && currentUser.isAdmin) {
                showAdminDashboard();
            } else if (currentUser && currentUser.approved) {
                showUserDashboard();
            }
        }

        function updateTopNav() {
            const loginBtn = document.getElementById('loginBtn');
            const profileBtn = document.getElementById('profileBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                loginBtn.classList.add('hidden');
                profileBtn.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                profileBtn.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Utility Functions
        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function showNotification(message, type, containerId = 'guestContent') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;

            const existingNotification = container.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            container.insertBefore(notification, container.firstChild);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9758e7d226b677e3',t:'MTc1NjI2OTc4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
