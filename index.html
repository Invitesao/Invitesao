<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesAO - Sistema de Confirmação de Presença</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 1.6em;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .event-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .event-cover {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            background: #f8f9fa;
        }

        .event-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .countdown {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .countdown h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 300px;
            margin: 0 auto;
        }

        .countdown-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .countdown-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
            line-height: 1;
        }

        .countdown-label {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .response-section {
            text-align: center;
            margin: 30px 0;
        }

        .response-question {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .response-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
        }

        .response-buttons .btn {
            font-size: 1em;
            padding: 12px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .guest-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .deadline-text {
            text-align: center;
            font-size: 0.95em;
            color: #666;
            margin: 15px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
        }

        .deadline-date {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 14px;
            margin-top: auto;
        }

        .login-button-top {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .login-button-top .btn {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .back-button .btn {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            font-size: 3em;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            display: block;
        }

        .stats-label {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 500;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .companions-input {
            margin-top: 15px;
        }

        .edit-timer {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .pending-approval {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pending-approval .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .response-status {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .response-status.negative {
            background: #ffeaea;
            border-color: #f44336;
        }

        .companions-names {
            margin-top: 15px;
        }

        .companions-names input {
            margin-bottom: 10px;
        }

        .cover-container {
            position: relative;
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            cursor: move;
        }

        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: move;
            user-select: none;
            transition: transform 0.1s ease;
        }

        .position-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
        }

        .page-title {
            font-size: 1.3em !important;
            margin-bottom: 20px;
        }

        /* Version-specific styles */
        .version-noivos {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .version-noiva {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
        }

        .version-noiva .btn-primary {
            background: linear-gradient(135deg, #ff9a9e 0%, #f093fb 100%);
        }

        .version-noiva .btn-primary:hover {
            box-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
        }

        .version-noiva .stats-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #f093fb 100%);
        }

        .version-noiva .countdown {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
        }

        .version-noiva input:focus, 
        .version-noiva textarea:focus, 
        .version-noiva select:focus {
            border-color: #ff9a9e;
            box-shadow: 0 0 0 3px rgba(255, 154, 158, 0.1);
        }

        .version-noiva .logo h1 {
            color: #ff6b9d;
        }

        .version-noivos .logo h1 {
            color: #667eea;
        }

        @media (min-width: 768px) {
            .admin-container {
                padding: 40px;
            }
            
            .container {
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Guest Event View -->
        <div id="guestView" class="container">
            <div class="login-button-top" id="loginButtonTop">
                <button class="btn btn-primary" onclick="showLogin()">Login</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="guestContent">
                    <div style="text-align: center; padding: 40px;">
                        <h2>🎉 Bem-vindo ao InvitesAO</h2>
                        <p style="margin: 20px 0; color: #666;">Sistema de confirmação de presença para seus eventos especiais.</p>
                        <button class="btn btn-primary" onclick="showLogin()">Fazer Login</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginView" class="container hidden">
            <div class="back-button">
                <button class="btn btn-secondary" onclick="backToEvent()">← Voltar</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="loginNotification"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Nome de Usuário</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
                <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerView" class="container hidden">
            <div class="back-button">
                <button class="btn btn-secondary" onclick="backToEvent()">← Voltar</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div id="registerNotification"></div>
                <form id="registerForm">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>Nome de Usuário</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="registerPhone" placeholder="922131116" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Criar Conta</button>
                </form>
                <button class="btn btn-secondary" onclick="showLogin()">Já tenho conta</button>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Pending Approval Screen -->
        <div id="pendingView" class="container hidden">
            <div class="back-button">
                <button class="btn btn-secondary" onclick="logout()">← Voltar</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1>🎉 InvitesAO</h1>
                </div>
                <div class="pending-approval">
                    <div class="spinner"></div>
                    <h3>Aguardando Aprovação</h3>
                    <p>Sua conta foi criada com sucesso!<br>Aguarde a aprovação do administrador.</p>
                </div>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- User Dashboard -->
        <div id="userDashboard" class="container hidden">
            <div class="back-button">
                <button class="btn btn-secondary" onclick="logout()">← Sair</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1 class="page-title">Meus Eventos</h1>
                </div>
                <div id="userNotification"></div>
                <button class="btn btn-primary" onclick="showCreateEvent()">Criar Novo Evento</button>
                <div id="userEvents"></div>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Create/Edit Event -->
        <div id="createEventView" class="container hidden">
            <div class="back-button">
                <button class="btn btn-secondary" onclick="showUserDashboard()">← Voltar</button>
            </div>
            <div class="card">
                <div class="logo">
                    <h1 id="eventFormTitle" class="page-title">Criar Evento</h1>
                </div>
                <div id="eventNotification"></div>
                <form id="eventForm">
                    <div class="form-group">
                        <label>Nome do Evento</label>
                        <input type="text" id="eventName" required>
                    </div>
                    <div class="form-group">
                        <label>Data do Evento *</label>
                        <input type="date" id="eventDate" required>
                        <div class="checkbox-group" style="margin-top: 10px;">
                            <input type="checkbox" id="eventTimeEnabled">
                            <label for="eventTimeEnabled">Incluir horário</label>
                        </div>
                        <input type="time" id="eventTime" class="hidden" style="margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Data Limite para Confirmação</label>
                        <input type="date" id="eventDeadline" required>
                        <div class="checkbox-group" style="margin-top: 10px;">
                            <input type="checkbox" id="deadlineTimeEnabled">
                            <label for="deadlineTimeEnabled">Incluir horário</label>
                        </div>
                        <input type="time" id="deadlineTime" class="hidden" style="margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Limite de Confirmações</label>
                        <input type="number" id="eventLimit" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Máximo de Acompanhantes por Convidado</label>
                        <input type="number" id="maxCompanions" min="0" max="20" value="5">
                    </div>
                    <div class="form-group">
                        <label>Descrição</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Versão do Site</label>
                        <select id="siteVersion">
                            <option value="noivos">🤵 Versão dos Noivos (Azul/Roxo)</option>
                            <option value="noiva">💐 Versão da Noiva (Rosa)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="eventCoverEnabled">
                            <label for="eventCoverEnabled">Permitir foto de capa</label>
                        </div>
                    </div>
                    <div class="form-group hidden" id="coverUploadGroup">
                        <label>Foto de Capa</label>
                        <input type="file" id="eventCover" accept="image/*" onchange="previewCover()">
                        <div id="coverPreview" class="hidden" style="margin-top: 15px;">
                            <label>Posicionar imagem (arraste para ajustar):</label>
                            <div id="coverContainer" class="cover-container">
                                <img id="coverImage" class="cover-image">
                                <div class="position-indicator">
                                    Arraste para posicionar
                                </div>
                            </div>
                            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="btn btn-small btn-secondary" onclick="resetCoverPosition()">Centralizar</button>
                                <small style="color: #666;">Posição: <span id="positionDisplay">50%, 50%</span></small>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Evento</button>
                </form>
            </div>
            <div class="footer">
                Copyright © invitesAO 2025
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="admin-container hidden">
            <div class="back-button">
                <button class="btn btn-secondary" onclick="logout()">← Sair</button>
            </div>
            <div class="admin-header">
                <h1>🔧 Painel Administrativo</h1>
            </div>
            <div id="adminNotification"></div>
            
            <div class="admin-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalUsers">0</div>
                    <div class="stats-label">👥 Usuários Totais</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="pendingUsers">0</div>
                    <div class="stats-label">⏳ Aguardando Aprovação</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalEvents">0</div>
                    <div class="stats-label">🎉 Eventos Criados</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalResponses">0</div>
                    <div class="stats-label">📝 Confirmações Recebidas</div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.4em;">⏳ Solicitações Pendentes</h3>
                <div id="pendingRequests"></div>
            </div>

            <div class="card" style="margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.4em;">👥 Gerenciar Usuários</h3>
                <div id="userManagement"></div>
            </div>

            <div class="card" style="margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.4em;">🎉 Todos os Eventos</h3>
                <div id="allEvents"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://jqdrxvnnbkeepdnrzndv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxZHJ4dm5uYmtlZXBkbnJ6bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDk5NTAsImV4cCI6MjA3MTU4NTk1MH0.k0sGvCvzZra3up5RTlJqFDu8FleeYvBr8EGqf5q-G3Q';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global Variables
        let currentUser = null;
        let currentEvent = null;
        let editingEventId = null;
        let approvalCheckInterval = null;
        let isEventPage = false;
        let coverPosition = { x: 50, y: 50 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let currentAttending = null;
        let editingResponse = false;
        let currentSiteVersion = 'noivos'; // 'noivos' or 'noiva'

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSavedLogin();
            await loadEventFromUrl();
            setupEventListeners();
        });

        // Check Saved Login
        async function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (user.isAdmin) {
                        currentUser = user;
                        return;
                    }
                    
                    // Verify user still exists and is active
                    const { data: dbUser } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (dbUser && dbUser.approved && dbUser.active) {
                        currentUser = dbUser;
                    } else {
                        localStorage.removeItem('currentUser');
                    }
                } catch (error) {
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // Apply Site Version Styling
        function applySiteVersionStyling() {
            const body = document.body;
            
            // Remove existing version classes
            body.classList.remove('version-noivos', 'version-noiva');
            
            if (currentSiteVersion === 'noiva') {
                body.classList.add('version-noiva');
                // Update logo text
                const logoElements = document.querySelectorAll('.logo h1');
                logoElements.forEach(logo => {
                    logo.innerHTML = '💐 InvitesAO - Noiva';
                });
            } else {
                body.classList.add('version-noivos');
                // Update logo text
                const logoElements = document.querySelectorAll('.logo h1');
                logoElements.forEach(logo => {
                    logo.innerHTML = '🤵 InvitesAO - Noivos';
                });
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
            document.getElementById('eventCoverEnabled').addEventListener('change', toggleCoverUpload);
            document.getElementById('eventTimeEnabled').addEventListener('change', toggleEventTime);
            document.getElementById('deadlineTimeEnabled').addEventListener('change', toggleDeadlineTime);
        }

        // Cover Image Functions
        function previewCover() {
            const file = document.getElementById('eventCover').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const coverImage = document.getElementById('coverImage');
                    coverImage.src = e.target.result;
                    document.getElementById('coverPreview').classList.remove('hidden');
                    setupImageDragging();
                    resetCoverPosition();
                };
                reader.readAsDataURL(file);
            }
        }

        function setupImageDragging() {
            const coverImage = document.getElementById('coverImage');
            const container = document.getElementById('coverContainer');

            coverImage.addEventListener('mousedown', startDrag);
            coverImage.addEventListener('touchstart', startDrag);

            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                dragStart.x = clientX;
                dragStart.y = clientY;

                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchend', stopDrag);
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();

                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                const deltaX = clientX - dragStart.x;
                const deltaY = clientY - dragStart.y;

                const containerRect = container.getBoundingClientRect();

                // Calculate new position as percentage
                const newX = coverPosition.x + (deltaX / containerRect.width) * 100;
                const newY = coverPosition.y + (deltaY / containerRect.height) * 100;

                // Constrain to bounds
                coverPosition.x = Math.max(-50, Math.min(150, newX));
                coverPosition.y = Math.max(-50, Math.min(150, newY));

                updateImagePosition();
                updatePositionDisplay();

                dragStart.x = clientX;
                dragStart.y = clientY;
            }

            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchend', stopDrag);
            }
        }

        function updateImagePosition() {
            const coverImage = document.getElementById('coverImage');
            coverImage.style.objectPosition = `${coverPosition.x}% ${coverPosition.y}%`;
        }

        function updatePositionDisplay() {
            document.getElementById('positionDisplay').textContent = 
                `${Math.round(coverPosition.x)}%, ${Math.round(coverPosition.y)}%`;
        }

        function resetCoverPosition() {
            coverPosition = { x: 50, y: 50 };
            updateImagePosition();
            updatePositionDisplay();
        }

        // Event Functions
        async function loadEventFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');
            const version = urlParams.get('version');
            
            // Set site version based on URL parameter
            if (version === 'noiva') {
                currentSiteVersion = 'noiva';
            } else {
                currentSiteVersion = 'noivos';
            }
            
            // Apply version-specific styling
            applySiteVersionStyling();
            
            if (eventId) {
                isEventPage = true;
                await loadGuestEvent(eventId);
            } else {
                isEventPage = false;
                if (currentUser) {
                    if (currentUser.isAdmin) {
                        showAdminDashboard();
                    } else if (currentUser.approved) {
                        showUserDashboard();
                    } else {
                        showPendingView();
                        startApprovalCheck();
                    }
                } else {
                    showGuestView();
                }
            }
        }

        async function loadGuestEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                if (event.active === false) {
                    document.getElementById('guestContent').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2>⚠️ Evento Inativo</h2>
                            <p style="color: #666;">Este evento foi temporariamente desativado pelo organizador.</p>
                            <button class="btn btn-primary" onclick="showLogin()">Fazer Login</button>
                            <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
                        </div>
                    `;
                    return;
                }

                currentEvent = event;
                
                // Apply event's site version if not specified in URL
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.get('version') && event.site_version) {
                    currentSiteVersion = event.site_version;
                    applySiteVersionStyling();
                }
                
                renderGuestEvent(event);
                showGuestView();
            } catch (error) {
                document.getElementById('guestContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>❌ Evento não encontrado</h2>
                        <p style="color: #666;">O link do evento pode estar incorreto ou o evento foi removido.</p>
                        <button class="btn btn-primary" onclick="showLogin()">Fazer Login</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Criar Conta</button>
                    </div>
                `;
            }
        }

        function renderGuestEvent(event) {
            const now = new Date();
            const eventDate = new Date(event.event_date);
            const deadline = new Date(event.deadline);
            
            let coverHtml = '';
            if (event.cover_enabled && event.cover_url) {
                const posX = event.cover_position_x || 50;
                const posY = event.cover_position_y || 50;
                coverHtml = `
                    <div class="event-cover">
                        <img src="${event.cover_url}" alt="Capa do evento" style="object-position: ${posX}% ${posY}%;">
                    </div>
                `;
            }

            let deadlineStatus = '';
            if (now > deadline) {
                deadlineStatus = '<div class="notification error">Prazo para confirmação expirado</div>';
            }

            const guestResponse = getGuestResponse(event.id);
            let responseSection = '';

            if (guestResponse) {
                const canEdit = canEditResponse(guestResponse.created_at);
                const statusClass = guestResponse.attending ? '' : 'negative';
                const statusText = guestResponse.attending ? '✅ Presença confirmada!' : '❌ Você informou que não comparecerá';
                
                let companionInfo = '';
                if (guestResponse.attending && guestResponse.companions > 0) {
                    companionInfo = `<p><strong>Acompanhantes:</strong> ${guestResponse.companions}</p>`;
                    if (guestResponse.companion_names && guestResponse.companion_names.length > 0) {
                        companionInfo += `<p><strong>Nomes:</strong> ${guestResponse.companion_names.join(', ')}</p>`;
                    }
                }
                
                responseSection = `
                    <div class="response-status ${statusClass}">
                        <h3>${statusText}</h3>
                        <p><strong>Nome:</strong> ${guestResponse.guest_name}</p>
                        ${companionInfo}
                        <p style="margin-top: 15px;">Obrigado pela confirmação!</p>
                        ${canEdit ? `
                            <button class="btn btn-secondary" onclick="editResponse()" style="margin-top: 20px;">Editar Resposta</button>
                            <div class="edit-timer">Você pode editar sua resposta por mais ${getRemainingEditTime(guestResponse.created_at)}</div>
                        ` : ''}
                    </div>
                `;
            } else if (now <= deadline) {
                responseSection = `
                    <div class="guest-form">
                        <div class="form-group">
                            <label>Seu nome completo</label>
                            <input type="text" id="guestName" required>
                        </div>
                        <div class="form-group">
                            <label>Você é convidado de:</label>
                            <select id="guestType" required>
                                <option value="">Selecione...</option>
                                <option value="noivo">🤵 Noivo</option>
                                <option value="noiva">👰 Noiva</option>
                            </select>
                        </div>
                        <div class="response-section">
                            <div class="response-question">Favor confirmar presença até</div>
                            <div class="deadline-date">${formatEventDate(deadline, event.deadline_time_enabled)}</div>
                            <div class="response-buttons" style="margin-top: 20px;">
                                <button class="btn btn-danger" onclick="respondEvent(false)">
                                    ⚫ Não
                                </button>
                                <button class="btn btn-success" onclick="respondEvent(true)">
                                    ⚫ Sim
                                </button>
                            </div>
                        </div>
                        <div class="form-group companions-input hidden" id="companionsGroup">
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                                Este evento permite até ${event.max_companions || 5} acompanhante(s) por pessoa.
                            </p>
                        </div>
                        <div id="responseButtons" class="hidden">
                            <button class="btn btn-primary" onclick="submitResponse()">Confirmar</button>
                            <button class="btn btn-secondary" onclick="cancelResponse()">Cancelar</button>
                        </div>
                    </div>
                `;
            }

            const eventDateFormatted = formatEventDate(eventDate, event.time_enabled);

            document.getElementById('guestContent').innerHTML = `
                ${coverHtml}
                <h2 style="text-align: center; margin-bottom: 20px;">${event.name}</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <strong>📅 Data: ${eventDateFormatted}</strong>
                </div>
                ${event.description ? `<p style="margin-bottom: 20px; text-align: center; color: #666;">${event.description}</p>` : ''}
                
                <div class="countdown" id="countdown"></div>
                
                ${deadlineStatus}
                ${responseSection}
            `;

            startCountdown(eventDate);
        }

        function startCountdown(eventDate) {
            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) return;

            function updateCountdown() {
                const now = new Date().getTime();
                const eventTime = eventDate.getTime();
                const distance = eventTime - now;

                if (distance < 0) {
                    countdownElement.innerHTML = '<h3>🎉 O evento já começou!</h3>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `
                    <h3>⏰ Contagem Regressiva</h3>
                    <div class="countdown-grid">
                        <div class="countdown-item">
                            <span class="countdown-number">${days}</span>
                            <span class="countdown-label">dias</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${hours}</span>
                            <span class="countdown-label">horas</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${minutes}</span>
                            <span class="countdown-label">min</span>
                        </div>
                        <div class="countdown-item">
                            <span class="countdown-number">${seconds}</span>
                            <span class="countdown-label">seg</span>
                        </div>
                    </div>
                `;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        function updateCompanionNames() {
            // Função removida - acompanhantes são definidos pelo organizador
        }

        function respondEvent(attending) {
            const guestName = document.getElementById('guestName').value;
            if (!guestName.trim()) {
                showNotification('Por favor, informe seu nome primeiro.', 'error');
                return;
            }

            currentAttending = attending;
            if (attending && currentEvent.max_companions > 0) {
                document.getElementById('companionsGroup').classList.remove('hidden');
                updateCompanionInputs();
            } else {
                document.getElementById('companionsGroup').classList.add('hidden');
            }
            document.getElementById('responseButtons').classList.remove('hidden');
        }

        function updateCompanionInputs() {
            const maxCompanions = currentEvent.max_companions || 0;
            if (maxCompanions === 0) return;

            const companionsGroup = document.getElementById('companionsGroup');
            const existingInputs = companionsGroup.querySelector('.companions-names');
            
            if (existingInputs) {
                existingInputs.remove();
            }

            const companionsHtml = `
                <div class="companions-names">
                    <label>Quantos acompanhantes você trará? (máximo ${maxCompanions})</label>
                    <select id="companionCount" onchange="updateCompanionNameInputs()" style="margin-bottom: 15px;">
                        <option value="0">Nenhum acompanhante</option>
                        ${Array.from({length: maxCompanions}, (_, i) => 
                            `<option value="${i + 1}">${i + 1} acompanhante${i > 0 ? 's' : ''}</option>`
                        ).join('')}
                    </select>
                    <div id="companionNameInputs"></div>
                </div>
            `;
            
            companionsGroup.insertAdjacentHTML('beforeend', companionsHtml);
        }

        function updateCompanionNameInputs() {
            const count = parseInt(document.getElementById('companionCount').value);
            const container = document.getElementById('companionNameInputs');
            
            if (count === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="margin-top: 15px;"><label>Nome dos acompanhantes:</label>';
            for (let i = 0; i < count; i++) {
                html += `<input type="text" id="companion${i}" placeholder="Nome do ${i + 1}º acompanhante" style="margin-bottom: 10px;">`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }

        async function submitResponse() {
            const guestName = document.getElementById('guestName').value.trim();
            const guestType = document.getElementById('guestType').value;

            if (!guestName) {
                showNotification('Por favor, informe seu nome.', 'error');
                return;
            }

            if (!guestType) {
                showNotification('Por favor, selecione se você é convidado do noivo ou da noiva.', 'error');
                return;
            }

            let companions = 0;
            let companionNames = [];

            if (currentAttending && currentEvent.max_companions > 0) {
                const companionCountElement = document.getElementById('companionCount');
                if (companionCountElement) {
                    companions = parseInt(companionCountElement.value) || 0;
                    
                    // Collect companion names
                    for (let i = 0; i < companions; i++) {
                        const nameInput = document.getElementById(`companion${i}`);
                        if (nameInput && nameInput.value.trim()) {
                            companionNames.push(nameInput.value.trim());
                        }
                    }

                    // Validate that all companion names are provided
                    if (companions > 0 && companionNames.length !== companions) {
                        showNotification('Por favor, informe o nome de todos os acompanhantes.', 'error');
                        return;
                    }
                }
            }

            try {
                const responseData = {
                    event_id: currentEvent.id,
                    guest_name: guestName,
                    guest_type: guestType,
                    attending: currentAttending,
                    companions: companions,
                    companion_names: companionNames,
                    created_at: new Date().toISOString()
                };

                if (editingResponse) {
                    // Update existing response
                    const { error } = await supabase
                        .from('responses')
                        .update(responseData)
                        .eq('event_id', currentEvent.id)
                        .eq('guest_name', guestName);
                    
                    if (error) throw error;
                    editingResponse = false;
                } else {
                    // Insert new response
                    const { error } = await supabase
                        .from('responses')
                        .insert([responseData]);
                    
                    if (error) throw error;
                }

                // Save to localStorage
                const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
                responses[currentEvent.id] = responseData;
                localStorage.setItem('eventResponses', JSON.stringify(responses));

                let message = currentAttending 
                    ? `🎉 Obrigado, ${guestName}! Sua presença foi confirmada.`
                    : `😔 Obrigado por avisar, ${guestName}. Sentiremos sua falta!`;

                if (currentAttending && companions > 0) {
                    message += ` Você confirmou ${companions} acompanhante${companions > 1 ? 's' : ''}.`;
                }

                showNotification(message, 'success');
                setTimeout(() => {
                    renderGuestEvent(currentEvent);
                }, 2000);
            } catch (error) {
                if (error.code === '23505') {
                    showNotification('Você já respondeu a este evento. Use a opção "Editar Resposta" se disponível.', 'error');
                } else {
                    showNotification('Erro ao salvar resposta: ' + error.message, 'error');
                }
            }
        }

        function cancelResponse() {
            document.getElementById('responseButtons').classList.add('hidden');
            document.getElementById('companionsGroup').classList.add('hidden');
            currentAttending = null;
            editingResponse = false;
        }

        function getGuestResponse(eventId) {
            const responses = JSON.parse(localStorage.getItem('eventResponses') || '{}');
            return responses[eventId] || null;
        }

        function canEditResponse(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const hoursPassed = (now - created) / (1000 * 60 * 60);
            return hoursPassed < 24;
        }

        function getRemainingEditTime(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const hoursPassed = (now - created) / (1000 * 60 * 60);
            const hoursRemaining = 24 - hoursPassed;
            
            if (hoursRemaining > 1) {
                return `${Math.floor(hoursRemaining)} horas`;
            } else {
                const minutesRemaining = Math.floor(hoursRemaining * 60);
                return `${minutesRemaining} minutos`;
            }
        }

        function editResponse() {
            const response = getGuestResponse(currentEvent.id);
            if (response && canEditResponse(response.created_at)) {
                // Clear the current form and show the edit form
                const guestNameInput = document.getElementById('guestName');
                if (guestNameInput) {
                    guestNameInput.value = response.guest_name;
                }
                
                currentAttending = response.attending;
                editingResponse = true;
                
                // Show the form again
                const responseSection = `
                    <div class="guest-form">
                        <div class="form-group">
                            <label>Seu nome completo</label>
                            <input type="text" id="guestName" value="${response.guest_name}" required>
                        </div>
                        <div class="response-section">
                            <div class="response-question">Favor confirmar presença até</div>
                            <div class="deadline-date">${formatEventDate(new Date(currentEvent.deadline), currentEvent.deadline_time_enabled)}</div>
                            <div class="response-buttons" style="margin-top: 20px;">
                                <button class="btn btn-danger" onclick="respondEvent(false)">
                                    ⚫ Não
                                </button>
                                <button class="btn btn-success" onclick="respondEvent(true)">
                                    ⚫ Sim
                                </button>
                            </div>
                        </div>
                        <div class="form-group companions-input hidden" id="companionsGroup">
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                                Este evento permite até ${currentEvent.max_companions || 5} acompanhante(s) por pessoa.
                            </p>
                        </div>
                        <div id="responseButtons" class="hidden">
                            <button class="btn btn-primary" onclick="submitResponse()">Confirmar Alteração</button>
                            <button class="btn btn-secondary" onclick="cancelResponse()">Cancelar</button>
                        </div>
                    </div>
                `;
                
                // Find the response status div and replace it
                const responseStatusDiv = document.querySelector('.response-status');
                if (responseStatusDiv) {
                    responseStatusDiv.outerHTML = responseSection;
                }
                
                // Pre-select the current response
                setTimeout(() => {
                    respondEvent(response.attending);
                    
                    // If there were companions, restore them
                    if (response.attending && response.companions > 0) {
                        setTimeout(() => {
                            const companionCountSelect = document.getElementById('companionCount');
                            if (companionCountSelect) {
                                companionCountSelect.value = response.companions;
                                updateCompanionNameInputs();
                                
                                // Fill in companion names
                                setTimeout(() => {
                                    if (response.companion_names && response.companion_names.length > 0) {
                                        response.companion_names.forEach((name, index) => {
                                            const input = document.getElementById(`companion${index}`);
                                            if (input) {
                                                input.value = name;
                                            }
                                        });
                                    }
                                }, 100);
                            }
                        }, 100);
                    }
                }, 100);
            }
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            // Check admin credentials
            if (username === 'Invites' && password === '#Invites2025@!!1995') {
                currentUser = { id: 'admin', username: 'Invites', isAdmin: true };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showAdminDashboard();
                return;
            }

            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error || !user) {
                    showNotification('Nome de usuário ou senha incorretos.', 'error', 'loginNotification');
                    return;
                }

                if (!user.approved) {
                    currentUser = user;
                    showPendingView();
                    startApprovalCheck();
                    return;
                }

                if (!user.active) {
                    showNotification('Sua conta foi desativada. Entre em contato com o administrador.', 'error', 'loginNotification');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showUserDashboard();
            } catch (error) {
                showNotification('Erro ao fazer login: ' + error.message, 'error', 'loginNotification');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUsername').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;

            try {
                // Check if username already exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (existingUser) {
                    showNotification('Nome de usuário já existe. Escolha outro.', 'error', 'registerNotification');
                    return;
                }

                const { error } = await supabase
                    .from('users')
                    .insert([{
                        name,
                        username,
                        phone,
                        password,
                        approved: false,
                        active: true
                    }]);

                if (error) throw error;

                showNotification('Conta criada com sucesso! Aguarde a aprovação do administrador para fazer login.', 'success', 'registerNotification');
                setTimeout(() => {
                    document.getElementById('registerForm').reset();
                    showLogin();
                }, 3000);
            } catch (error) {
                showNotification('Erro ao criar conta: ' + error.message, 'error', 'registerNotification');
            }
        }

        function startApprovalCheck() {
            if (approvalCheckInterval) clearInterval(approvalCheckInterval);
            
            approvalCheckInterval = setInterval(async () => {
                if (!currentUser || currentUser.isAdmin) return;

                try {
                    const { data: user, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();

                    if (error) return;

                    if (user.approved && user.active) {
                        clearInterval(approvalCheckInterval);
                        currentUser = user;
                        showUserDashboard();
                        showNotification('Sua conta foi aprovada! Bem-vindo ao InvitesAO!', 'success', 'userNotification');
                    }
                } catch (error) {
                    console.error('Erro ao verificar aprovação:', error);
                }
            }, 3000); // Check every 3 seconds
        }

        async function logout() {
            if (approvalCheckInterval) clearInterval(approvalCheckInterval);
            currentUser = null;
            localStorage.removeItem('currentUser');
            if (isEventPage) {
                location.reload();
            } else {
                showGuestView();
            }
        }

        function backToEvent() {
            if (isEventPage && currentEvent) {
                renderGuestEvent(currentEvent);
                showGuestView();
            } else {
                showGuestView();
            }
        }

        // User Dashboard Functions
        async function showUserDashboard() {
            hideAllViews();
            document.getElementById('userDashboard').classList.remove('hidden');
            await loadUserEvents();
        }

        async function loadUserEvents() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select(`
                        *,
                        responses(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const eventsHtml = events.map(event => {
                    const responseCount = event.responses?.length || 0;
                    const confirmedCount = event.responses?.filter(r => r.attending).length || 0;
                    const versionParam = event.site_version ? `&version=${event.site_version}` : '';
                    const eventUrl = `${window.location.origin}${window.location.pathname}?event=${event.id}${versionParam}`;
                    const eventDate = event.event_date ? new Date(event.event_date) : null;
                    const statusText = event.active !== false ? 'Ativo' : 'Inativo';
                    const statusClass = event.active !== false ? 'success' : 'danger';
                    const versionText = event.site_version === 'noiva' ? '💐 Noiva' : '🤵 Noivos';
                    
                    return `
                        <div class="event-card">
                            <h3>${event.name} <span class="btn btn-small btn-${statusClass}" style="font-size: 10px; padding: 2px 8px;">${statusText}</span></h3>
                            <p><strong>Data:</strong> ${event.event_date ? formatEventDate(new Date(event.event_date), event.time_enabled) : 'Data não definida'}</p>
                            <p><strong>Versão:</strong> ${versionText}</p>
                            <p><strong>Confirmações:</strong> ${confirmedCount}/${event.event_limit}</p>
                            <p><strong>Total de respostas:</strong> ${responseCount}</p>
                            <div style="margin: 10px 0;">
                                <p><strong>Links dos Convidados:</strong></p>
                                <small><strong>🤵 Noivos:</strong> <a href="${eventUrl}&version=noivos" target="_blank" style="word-break: break-all; font-size: 11px;">${eventUrl}&version=noivos</a></small><br>
                                <small><strong>👰 Noiva:</strong> <a href="${eventUrl}&version=noiva" target="_blank" style="word-break: break-all; font-size: 11px;">${eventUrl}&version=noiva</a></small>
                            </div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-small btn-secondary" onclick="editEvent('${event.id}')">Editar</button>
                                <button class="btn btn-small btn-primary" onclick="viewResponses('${event.id}')">Ver Respostas</button>
                                <button class="btn btn-small btn-success" onclick="downloadReport('${event.id}')">Baixar PDF</button>
                                <button class="btn btn-small btn-secondary" onclick="manageGuests('${event.id}')">Gerenciar Convidados</button>
                                <button class="btn btn-small ${event.active !== false ? 'btn-danger' : 'btn-success'}" onclick="toggleEventStatus('${event.id}', ${event.active === false})">${event.active !== false ? 'Desativar' : 'Ativar'}</button>
                                <button class="btn btn-small btn-danger" onclick="deleteEvent('${event.id}')">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('userEvents').innerHTML = eventsHtml || '<p>Nenhum evento criado ainda.</p>';
            } catch (error) {
                showNotification('Erro ao carregar eventos: ' + error.message, 'error', 'userNotification');
            }
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const eventDate = document.getElementById('eventDate').value;
            const eventTime = document.getElementById('eventTimeEnabled').checked ? document.getElementById('eventTime').value : null;
            const deadlineDate = document.getElementById('eventDeadline').value;
            const deadlineTime = document.getElementById('deadlineTimeEnabled').checked ? document.getElementById('deadlineTime').value : null;

            if (!eventDate) {
                showNotification('A data do evento é obrigatória!', 'error', 'eventNotification');
                return;
            }

            if (!deadlineDate) {
                showNotification('A data limite para confirmação é obrigatória!', 'error', 'eventNotification');
                return;
            }

            const eventDateTime = eventTime ? `${eventDate}T${eventTime}` : `${eventDate}T23:59`;
            const deadlineDateTime = deadlineTime ? `${deadlineDate}T${deadlineTime}` : `${deadlineDate}T23:59`;

            const eventData = {
                name: document.getElementById('eventName').value,
                event_date: eventDateTime,
                deadline: deadlineDateTime,
                time_enabled: document.getElementById('eventTimeEnabled').checked,
                deadline_time_enabled: document.getElementById('deadlineTimeEnabled').checked,
                event_limit: parseInt(document.getElementById('eventLimit').value),
                max_companions: parseInt(document.getElementById('maxCompanions').value),
                description: document.getElementById('eventDescription').value,
                cover_enabled: document.getElementById('eventCoverEnabled').checked,
                cover_position_x: coverPosition.x,
                cover_position_y: coverPosition.y,
                site_version: document.getElementById('siteVersion').value,
                user_id: currentUser.id
            };

            try {
                let coverUrl = null;
                const coverFile = document.getElementById('eventCover').files[0];
                
                if (eventData.cover_enabled && coverFile) {
                    const fileExt = coverFile.name.split('.').pop();
                    const fileName = `${Date.now()}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('event-covers')
                        .upload(fileName, coverFile);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('event-covers')
                        .getPublicUrl(fileName);
                    
                    coverUrl = urlData.publicUrl;
                }

                if (coverUrl) {
                    eventData.cover_url = coverUrl;
                }

                if (editingEventId) {
                    const { error } = await supabase
                        .from('events')
                        .update(eventData)
                        .eq('id', editingEventId);
                    
                    if (error) throw error;
                    showNotification('Evento atualizado com sucesso!', 'success', 'eventNotification');
                } else {
                    const { error } = await supabase
                        .from('events')
                        .insert([eventData]);
                    
                    if (error) throw error;
                    const { data: newEvent } = await supabase
                        .from('events')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (newEvent) {
                        const baseUrl = `${window.location.origin}${window.location.pathname}`;
                        const linkNoivos = `${baseUrl}?event=${newEvent.id}&version=noivos`;
                        const linkNoiva = `${baseUrl}?event=${newEvent.id}&version=noiva`;
                        
                        showNotification(`Evento criado com sucesso!<br><br>
                            <strong>Links gerados:</strong><br>
                            <small><strong>Convidados do Noivo:</strong><br>
                            <a href="${linkNoivos}" target="_blank" style="word-break: break-all;">${linkNoivos}</a></small><br><br>
                            <small><strong>Convidados da Noiva:</strong><br>
                            <a href="${linkNoiva}" target="_blank" style="word-break: break-all;">${linkNoiva}</a></small>`, 'success', 'eventNotification');
                    } else {
                        showNotification('Evento criado com sucesso!', 'success', 'eventNotification');
                    }
                }

                setTimeout(() => {
                    showUserDashboard();
                    editingEventId = null;
                }, 2000);
            } catch (error) {
                showNotification('Erro ao salvar evento: ' + error.message, 'error', 'eventNotification');
            }
        }

        async function editEvent(eventId) {
            try {
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                editingEventId = eventId;
                document.getElementById('eventFormTitle').textContent = 'Editar Evento';
                document.getElementById('eventName').value = event.name;
                
                const eventDate = new Date(event.event_date);
                document.getElementById('eventDate').value = eventDate.toISOString().split('T')[0];
                document.getElementById('eventTimeEnabled').checked = event.time_enabled;
                if (event.time_enabled) {
                    document.getElementById('eventTime').value = eventDate.toTimeString().slice(0, 5);
                }

                const deadlineDate = new Date(event.deadline);
                document.getElementById('eventDeadline').value = deadlineDate.toISOString().split('T')[0];
                document.getElementById('deadlineTimeEnabled').checked = event.deadline_time_enabled;
                if (event.deadline_time_enabled) {
                    document.getElementById('deadlineTime').value = deadlineDate.toTimeString().slice(0, 5);
                }

                document.getElementById('eventLimit').value = event.event_limit;
                document.getElementById('maxCompanions').value = event.max_companions || 5;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventCoverEnabled').checked = event.cover_enabled;
                document.getElementById('siteVersion').value = event.site_version || 'noivos';
                
                // Set cover position
                if (event.cover_position_x !== undefined && event.cover_position_y !== undefined) {
                    coverPosition.x = event.cover_position_x;
                    coverPosition.y = event.cover_position_y;
                }
                
                toggleCoverUpload();
                toggleEventTime();
                toggleDeadlineTime();
                showCreateEvent();
            } catch (error) {
                showNotification('Erro ao carregar evento: ' + error.message, 'error', 'userNotification');
            }
        }

        async function toggleEventStatus(eventId, activate) {
            try {
                const { error } = await supabase
                    .from('events')
                    .update({ active: activate })
                    .eq('id', eventId);

                if (error) throw error;

                showNotification(`Evento ${activate ? 'ativado' : 'desativado'} com sucesso!`, 'success', 'userNotification');
                await loadUserEvents();
            } catch (error) {
                showNotification('Erro ao alterar status do evento: ' + error.message, 'error', 'userNotification');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;

            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                showNotification('Evento excluído com sucesso!', 'success', 'userNotification');
                await loadUserEvents();
            } catch (error) {
                showNotification('Erro ao excluir evento: ' + error.message, 'error', 'userNotification');
            }
        }

        async function manageGuests(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const attending = responses.filter(r => r.attending);

                let html = `
                    <div class="card">
                        <h3>👥 ${event.name} - Gerenciar Convidados</h3>
                        <p><strong>Confirmados:</strong> ${attending.length} pessoas</p>
                        
                        <h4 style="margin-top: 20px; color: #28a745;">✅ Convidados Confirmados</h4>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            ${attending.map(r => `
                                <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${r.guest_name}</strong>
                                        <span style="margin-left: 10px; padding: 2px 6px; border-radius: 10px; font-size: 10px; background: ${r.guest_type === 'noivo' ? '#667eea' : '#ff9a9e'}; color: white;">
                                            ${r.guest_type === 'noivo' ? '🤵 NOIVO' : '👰 NOIVA'}
                                        </span>
                                        ${r.companions > 0 ? `<br><small style="color: #666;">+ ${r.companions} acompanhante(s)</small>` : ''}
                                        <br><small style="color: #666;">Confirmado em: ${formatDate(new Date(r.created_at))}</small>
                                    </div>
                                    <button class="btn btn-small btn-danger" onclick="removeGuest('${eventId}', '${r.guest_name}')">🗑️ Remover</button>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center; color: #666;">Nenhuma confirmação ainda.</p>'}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary btn-small" onclick="showUserDashboard()">Voltar</button>
                        </div>
                    </div>
                `;

                document.getElementById('userEvents').innerHTML = html;
            } catch (error) {
                showNotification('Erro ao carregar convidados: ' + error.message, 'error', 'userNotification');
            }
        }

        async function removeGuest(eventId, guestName) {
            if (!confirm(`Tem certeza que deseja remover ${guestName} da lista de convidados?`)) return;

            try {
                const { error } = await supabase
                    .from('responses')
                    .delete()
                    .eq('event_id', eventId)
                    .eq('guest_name', guestName);

                if (error) throw error;

                showNotification('Convidado removido com sucesso!', 'success', 'userNotification');
                await manageGuests(eventId);
            } catch (error) {
                showNotification('Erro ao remover convidado: ' + error.message, 'error', 'userNotification');
            }
        }

        async function viewResponses(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                const attendingNoivo = attending.filter(r => r.guest_type === 'noivo');
                const attendingNoiva = attending.filter(r => r.guest_type === 'noiva');
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);
                const companionsNoivo = attendingNoivo.reduce((sum, r) => sum + (r.companions || 0), 0);
                const companionsNoiva = attendingNoiva.reduce((sum, r) => sum + (r.companions || 0), 0);

                let html = `
                    <div class="card">
                        <h3>📊 ${event.name} - Respostas</h3>
                        <p><strong>Confirmados:</strong> ${attending.length} pessoas + ${totalCompanions} acompanhantes = ${attending.length + totalCompanions} total</p>
                        <p><strong>Não comparecerão:</strong> ${notAttending.length}</p>
                        <p><strong>Total de respostas:</strong> ${responses.length}</p>
                        <p><strong>Limite do evento:</strong> ${event.event_limit}</p>
                        
                        <h4 style="margin-top: 20px; color: #667eea;">🤵 Convidados do Noivo (${attendingNoivo.length} + ${companionsNoivo} acompanhantes)</h4>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                            ${attendingNoivo.map(r => `
                                <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                    <strong>${r.guest_name}</strong>
                                    ${r.companions > 0 ? ` + ${r.companions} acompanhante(s)` : ''}
                                    <small style="color: #666; display: block;">Confirmado em: ${formatDate(new Date(r.created_at))}</small>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center; color: #666;">Nenhum convidado do noivo confirmado.</p>'}
                        </div>
                        
                        <h4 style="margin-top: 20px; color: #ff9a9e;">👰 Convidados da Noiva (${attendingNoiva.length} + ${companionsNoiva} acompanhantes)</h4>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            ${attendingNoiva.map(r => `
                                <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                    <strong>${r.guest_name}</strong>
                                    ${r.companions > 0 ? ` + ${r.companions} acompanhante(s)` : ''}
                                    <small style="color: #666; display: block;">Confirmado em: ${formatDate(new Date(r.created_at))}</small>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center; color: #666;">Nenhum convidado da noiva confirmado.</p>'}
                        </div>
                        
                        <h4 style="margin-top: 20px; color: #dc3545;">❌ Não comparecerão (${notAttending.length})</h4>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            ${notAttending.map(r => `
                                <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                    <strong>${r.guest_name}</strong>
                                    <small style="color: #666; display: block;">Respondido em: ${formatDate(new Date(r.created_at))}</small>
                                </div>
                            `).join('') || '<p style="padding: 20px; text-align: center; color: #666;">Nenhuma resposta negativa.</p>'}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success btn-small" onclick="downloadReport('${eventId}')">Baixar PDF</button>
                            <button class="btn btn-secondary btn-small" onclick="showUserDashboard()">Voltar</button>
                        </div>
                    </div>
                `;

                document.getElementById('userEvents').innerHTML = html;
            } catch (error) {
                showNotification('Erro ao carregar respostas: ' + error.message, 'error', 'userNotification');
            }
        }

        async function downloadReport(eventId) {
            try {
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                const { data: responses, error: responsesError } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('guest_name', { ascending: true });

                if (responsesError) throw responsesError;

                const attending = responses.filter(r => r.attending);
                const notAttending = responses.filter(r => !r.attending);
                const attendingNoivo = attending.filter(r => r.guest_type === 'noivo');
                const attendingNoiva = attending.filter(r => r.guest_type === 'noiva');
                const totalCompanions = attending.reduce((sum, r) => sum + (r.companions || 0), 0);
                const companionsNoivo = attendingNoivo.reduce((sum, r) => sum + (r.companions || 0), 0);
                const companionsNoiva = attendingNoiva.reduce((sum, r) => sum + (r.companions || 0), 0);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Function to clean text for PDF
                function cleanText(text) {
                    if (!text) return '';
                    return text.toString()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                        .replace(/[^\x00-\x7F]/g, '') // Remove non-ASCII characters
                        .replace(/[^\w\s\-.,!?()]/g, '') // Keep only safe characters
                        .trim();
                }

                // Colors
                const primaryColor = [102, 126, 234]; // #667eea
                const secondaryColor = [118, 75, 162]; // #764ba2
                const successColor = [40, 167, 69]; // #28a745
                const dangerColor = [220, 53, 69]; // #dc3545
                const grayColor = [108, 117, 125]; // #6c757d

                // Header with gradient effect
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('RELATORIO DO EVENTO', 20, 25);

                // Event title
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanText(event.name), 20, 55);

                // Event details box
                doc.setFillColor(248, 249, 250);
                doc.rect(15, 65, 180, 35, 'F');
                doc.setDrawColor(...grayColor);
                doc.rect(15, 65, 180, 35, 'S');

                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...grayColor);
                doc.text('Data do Evento:', 20, 75);
                doc.text('Limite de Participantes:', 20, 85);
                doc.text('Relatorio gerado em:', 20, 95);

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text(formatEventDate(new Date(event.event_date), event.time_enabled), 70, 75);
                doc.text(`${event.event_limit} pessoas`, 85, 85);
                doc.text(formatDate(new Date()), 75, 95);

                // Statistics section
                let yPos = 120;
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('ESTATISTICAS', 20, yPos);

                yPos += 15;
                
                // Stats boxes
                const stats = [
                    { label: 'Confirmados', value: `${attending.length} pessoas`, color: successColor },
                    { label: 'Acompanhantes', value: `${totalCompanions} pessoas`, color: primaryColor },
                    { label: 'Total Presentes', value: `${attending.length + totalCompanions} pessoas`, color: secondaryColor },
                    { label: 'Nao Comparecerao', value: `${notAttending.length} pessoas`, color: dangerColor }
                ];

                stats.forEach((stat, index) => {
                    const x = 20 + (index % 2) * 90;
                    const y = yPos + Math.floor(index / 2) * 25;
                    
                    doc.setFillColor(...stat.color);
                    doc.rect(x, y, 80, 20, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(stat.label, x + 3, y + 8);
                    doc.setFontSize(11);
                    doc.text(stat.value, x + 3, y + 16);
                });

                yPos += 65;

                // Confirmed attendees section - Noivo
                if (attendingNoivo.length > 0) {
                    doc.setFillColor(...primaryColor);
                    doc.rect(15, yPos - 5, 180, 15, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`CONVIDADOS DO NOIVO (${attendingNoivo.length} + ${companionsNoivo} acompanhantes)`, 20, yPos + 5);

                    yPos += 20;

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');

                    attendingNoivo.forEach((response, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 30;
                        }

                        // Alternating row colors
                        if (index % 2 === 0) {
                            doc.setFillColor(248, 249, 250);
                            doc.rect(15, yPos - 3, 180, 12, 'F');
                        }

                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}.`, 20, yPos + 5);
                        doc.text(cleanText(response.guest_name), 30, yPos + 5);

                        if (response.companions > 0) {
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(...primaryColor);
                            doc.text(`+ ${response.companions} acompanhante${response.companions > 1 ? 's' : ''}`, 120, yPos + 5);
                            
                            if (response.companion_names && response.companion_names.length > 0) {
                                doc.setFontSize(8);
                                doc.setTextColor(...grayColor);
                                const cleanNames = response.companion_names.map(name => cleanText(name)).join(', ');
                                doc.text(`(${cleanNames})`, 30, yPos + 10);
                                yPos += 5;
                            }
                        }

                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        yPos += 15;
                    });
                }

                // Confirmed attendees section - Noiva
                if (attendingNoiva.length > 0) {
                    yPos += 10;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }

                    doc.setFillColor(255, 154, 158); // Pink color for noiva
                    doc.rect(15, yPos - 5, 180, 15, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`CONVIDADOS DA NOIVA (${attendingNoiva.length} + ${companionsNoiva} acompanhantes)`, 20, yPos + 5);

                    yPos += 20;

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');

                    attendingNoiva.forEach((response, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 30;
                        }

                        // Alternating row colors
                        if (index % 2 === 0) {
                            doc.setFillColor(248, 249, 250);
                            doc.rect(15, yPos - 3, 180, 12, 'F');
                        }

                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}.`, 20, yPos + 5);
                        doc.text(cleanText(response.guest_name), 30, yPos + 5);

                        if (response.companions > 0) {
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(...primaryColor);
                            doc.text(`+ ${response.companions} acompanhante${response.companions > 1 ? 's' : ''}`, 120, yPos + 5);
                            
                            if (response.companion_names && response.companion_names.length > 0) {
                                doc.setFontSize(8);
                                doc.setTextColor(...grayColor);
                                const cleanNames = response.companion_names.map(name => cleanText(name)).join(', ');
                                doc.text(`(${cleanNames})`, 30, yPos + 10);
                                yPos += 5;
                            }
                        }

                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        yPos += 15;
                    });
                }

                // Not attending section
                if (notAttending.length > 0) {
                    yPos += 10;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }

                    doc.setFillColor(...dangerColor);
                    doc.rect(15, yPos - 5, 180, 15, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`NAO COMPARECERAO (${notAttending.length})`, 20, yPos + 5);

                    yPos += 20;

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');

                    notAttending.forEach((response, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 30;
                        }

                        if (index % 2 === 0) {
                            doc.setFillColor(248, 249, 250);
                            doc.rect(15, yPos - 3, 180, 10, 'F');
                        }

                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}.`, 20, yPos + 5);
                        doc.text(cleanText(response.guest_name), 30, yPos + 5);

                        yPos += 12;
                    });
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFillColor(...grayColor);
                    doc.rect(0, 287, 210, 10, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Gerado por InvitesAO - Sistema de Confirmacao de Presenca', 20, 293);
                    doc.text(`Pagina ${i} de ${pageCount}`, 170, 293);
                }

                const cleanFileName = cleanText(event.name).replace(/\s+/g, '-').toLowerCase() || 'evento';
                doc.save(`relatorio-${cleanFileName}.pdf`);
            } catch (error) {
                showNotification('Erro ao gerar relatório: ' + error.message, 'error', 'userNotification');
            }
        }

        // Admin Functions
        async function showAdminDashboard() {
            hideAllViews();
            document.getElementById('adminDashboard').classList.remove('hidden');
            await loadAdminData();
        }

        async function loadAdminData() {
            try {
                // Load stats
                const { data: users } = await supabase.from('users').select('*');
                const { data: events } = await supabase.from('events').select('*');
                const { data: responses } = await supabase.from('responses').select('*');

                document.getElementById('totalUsers').textContent = users?.length || 0;
                document.getElementById('pendingUsers').textContent = users?.filter(u => !u.approved).length || 0;
                document.getElementById('totalEvents').textContent = events?.length || 0;
                document.getElementById('totalResponses').textContent = responses?.length || 0;

                // Load pending requests
                const pendingUsers = users?.filter(u => !u.approved) || [];
                const pendingHtml = pendingUsers.map(user => `
                    <div style="padding: 20px; border: 2px solid #ffc107; border-radius: 12px; margin-bottom: 15px; background: #fff8e1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <strong style="font-size: 1.1em; color: #333;">${user.name}</strong><br>
                                <small style="color: #666;">👤 @${user.username}</small><br>
                                <small style="color: #666;">📱 ${user.phone}</small>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-small btn-success" onclick="approveUser('${user.id}')">✅ Aprovar</button>
                                <button class="btn btn-small btn-danger" onclick="rejectUser('${user.id}')">❌ Rejeitar</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('pendingRequests').innerHTML = pendingHtml || '<div style="text-align: center; padding: 30px; color: #666; background: #f8f9fa; border-radius: 10px;"><p style="margin: 0; font-size: 1.1em;">✅ Nenhuma solicitação pendente</p><small>Todas as contas foram processadas</small></div>';

                // Load user management
                const approvedUsers = users?.filter(u => u.approved) || [];
                const usersHtml = approvedUsers.map(user => `
                    <div style="padding: 20px; border: 2px solid ${user.active ? '#28a745' : '#dc3545'}; border-radius: 12px; margin-bottom: 15px; background: ${user.active ? '#f8fff8' : '#fff5f5'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <strong style="font-size: 1.1em; color: #333;">${user.name}</strong>
                                <span style="margin-left: 10px; padding: 3px 8px; border-radius: 12px; font-size: 11px; background: ${user.active ? '#28a745' : '#dc3545'}; color: white;">${user.active ? '🟢 ATIVO' : '🔴 INATIVO'}</span><br>
                                <small style="color: #666;">👤 @${user.username}</small><br>
                                <small style="color: #666;">📱 ${user.phone}</small>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="btn btn-small btn-secondary" onclick="loginAsUser('${user.id}')">🔑 Entrar como usuário</button>
                                <button class="btn btn-small ${user.active ? 'btn-danger' : 'btn-success'}" onclick="toggleUserStatus('${user.id}', ${!user.active})">
                                    ${user.active ? '🚫 Desativar' : '✅ Ativar'}
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="viewUserPassword('${user.id}')">👁️ Ver Senha</button>
                                <button class="btn btn-small btn-secondary" onclick="changeUserPassword('${user.id}')">🔐 Alterar Senha</button>
                                <button class="btn btn-small btn-danger" onclick="deleteUser('${user.id}')">🗑️ Eliminar</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('userManagement').innerHTML = usersHtml || '<p>Nenhum usuário aprovado.</p>';

                // Load all events
                const eventsHtml = events?.map(event => {
                    const eventUser = users?.find(u => u.id === event.user_id);
                    return `
                        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>${event.name}</strong><br>
                            <small>Data: ${event.event_date ? formatEventDate(new Date(event.event_date), event.time_enabled) : 'Data não definida'}</small><br>
                            <small>Status: ${event.active !== false ? 'Ativo' : 'Inativo'}</small><br>
                            <small>Criado por: ${eventUser?.name || 'Usuário não encontrado'} (@${eventUser?.username || 'N/A'})</small><br>
                            <button class="btn btn-small btn-primary" onclick="viewEventResponsesAdmin('${event.id}')">Ver Respostas</button>
                            <button class="btn btn-small btn-success" onclick="downloadEventReport('${event.id}')">Baixar PDF</button>
                            <button class="btn btn-small ${event.active !== false ? 'btn-danger' : 'btn-success'}" onclick="toggleEventStatusAdmin('${event.id}', ${event.active === false})">${event.active !== false ? 'Desativar' : 'Ativar'}</button>
                            <button class="btn btn-small btn-danger" onclick="deleteEventAdmin('${event.id}')">Excluir</button>
                        </div>
                    `;
                }).join('') || '<p>Nenhum evento criado.</p>';
                document.getElementById('allEvents').innerHTML = eventsHtml;

            } catch (error) {
                showNotification('Erro ao carregar dados: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ approved: true, active: true })
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usuário aprovado com sucesso!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao aprovar usuário: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function rejectUser(userId) {
            if (!confirm('Tem certeza que deseja rejeitar este usuário?')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usuário rejeitado e removido.', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao rejeitar usuário: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function toggleUserStatus(userId, active) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ active })
                    .eq('id', userId);

                if (error) throw error;

                showNotification(`Usuário ${active ? 'ativado' : 'desativado'} com sucesso!`, 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao alterar status: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function loginAsUser(userId) {
            try {
                const { data: user } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (user) {
                    currentUser = user;
                    showUserDashboard();
                }
            } catch (error) {
                showNotification('Erro ao entrar como usuário: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function viewUserPassword(userId) {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('name, username, password')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                alert(`Dados do usuário ${user.name}:\n\nUsuário: ${user.username}\nSenha: ${user.password}`);
            } catch (error) {
                showNotification('Erro ao buscar senha: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function changeUserPassword(userId) {
            const newPassword = prompt('Digite a nova senha para o usuário:');
            if (!newPassword) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ password: newPassword })
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Senha alterada com sucesso!', 'success', 'adminNotification');
            } catch (error) {
                showNotification('Erro ao alterar senha: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Tem certeza que deseja eliminar este usuário? Esta ação não pode ser desfeita.')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                showNotification('Usuário eliminado com sucesso!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao eliminar usuário: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function viewEventResponsesAdmin(eventId) {
            await viewResponses(eventId);
        }

        async function downloadEventReport(eventId) {
            await downloadReport(eventId);
        }

        async function toggleEventStatusAdmin(eventId, activate) {
            try {
                const { error } = await supabase
                    .from('events')
                    .update({ active: activate })
                    .eq('id', eventId);

                if (error) throw error;

                showNotification(`Evento ${activate ? 'ativado' : 'desativado'} com sucesso!`, 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao alterar status do evento: ' + error.message, 'error', 'adminNotification');
            }
        }

        async function deleteEventAdmin(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;
            
            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                showNotification('Evento excluído com sucesso!', 'success', 'adminNotification');
                await loadAdminData();
            } catch (error) {
                showNotification('Erro ao excluir evento: ' + error.message, 'error', 'adminNotification');
            }
        }

        // View Management Functions
        function hideAllViews() {
            const views = ['guestView', 'loginView', 'registerView', 'pendingView', 'userDashboard', 'createEventView', 'adminDashboard'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
        }

        function showGuestView() {
            hideAllViews();
            document.getElementById('guestView').classList.remove('hidden');
        }

        function showLogin() {
            hideAllViews();
            document.getElementById('loginView').classList.remove('hidden');
        }

        function showRegister() {
            hideAllViews();
            document.getElementById('registerView').classList.remove('hidden');
        }

        function showPendingView() {
            hideAllViews();
            document.getElementById('pendingView').classList.remove('hidden');
        }

        function showCreateEvent() {
            hideAllViews();
            document.getElementById('createEventView').classList.remove('hidden');
            if (!editingEventId) {
                document.getElementById('eventFormTitle').textContent = 'Criar Evento';
                document.getElementById('eventForm').reset();
                document.getElementById('eventTimeEnabled').checked = false;
                document.getElementById('deadlineTimeEnabled').checked = false;
                document.getElementById('coverPreview').classList.add('hidden');
                document.getElementById('maxCompanions').value = 5;
                coverPosition = { x: 50, y: 50 };
                toggleEventTime();
                toggleDeadlineTime();
            }
        }

        function toggleCoverUpload() {
            const enabled = document.getElementById('eventCoverEnabled').checked;
            const uploadGroup = document.getElementById('coverUploadGroup');
            if (enabled) {
                uploadGroup.classList.remove('hidden');
            } else {
                uploadGroup.classList.add('hidden');
                document.getElementById('coverPreview').classList.add('hidden');
            }
        }

        function toggleEventTime() {
            const enabled = document.getElementById('eventTimeEnabled').checked;
            const timeInput = document.getElementById('eventTime');
            if (enabled) {
                timeInput.classList.remove('hidden');
            } else {
                timeInput.classList.add('hidden');
            }
        }

        function toggleDeadlineTime() {
            const enabled = document.getElementById('deadlineTimeEnabled').checked;
            const timeInput = document.getElementById('deadlineTime');
            if (enabled) {
                timeInput.classList.remove('hidden');
            } else {
                timeInput.classList.add('hidden');
            }
        }

        // Utility Functions
        function showNotification(message, type, containerId = 'guestContent') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;

            if (containerId === 'guestContent') {
                container.insertBefore(notification, container.firstChild);
            } else {
                container.innerHTML = `<div class="notification ${type}">${message}</div>`;
            }

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 8000);
        }

        function formatDate(date) {
            return date.toLocaleString('pt-BR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatEventDate(date, includeTime) {
            if (includeTime) {
                return date.toLocaleString('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                return date.toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974e2bd360ad77d7',t:'MTc1NjE1NzIyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
